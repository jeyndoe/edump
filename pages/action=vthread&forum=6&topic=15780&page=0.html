<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Небольшие полезные коды - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Часто во время написания проектов возникают небольшие, но при этом довольно общие задачи, которые потом могут быть использованы в будущем, вот эта тема как раз для этого. В этой теме предлагаю размещать небольшие фрагменты кода,">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a> (+4 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Небольшие полезные коды</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b> .  <b>1</b> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=1.html">2</a> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=2.html">3</a> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=1.html">&gt;&gt;</a></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Vol4ok[/b]','')">Vol4ok</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.1 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.61'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=18950">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 09 февраля 2010 18:42 &middot; Поправил: Vol4ok <br><script type="text/javascript">QU('Vol4ok','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vol4ok" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Часто во время написания проектов возникают небольшие, но при этом довольно общие задачи, которые потом могут быть использованы в будущем, вот эта тема как раз для этого. В этой теме предлагаю размещать небольшие фрагменты кода, которые могут применятся в повседневной практике системного программирования. <br><br>В этом топике можно <br> - размещать только свои коды, а не копировать из общедоступных источников<br> - желательно хорошо протестировать код, прежде чем разместить его. Если вы не уверены, что код работает точно будет работать так как надо на всех ОС и всех процах, то надо пометить - где и каким образом тестировался этот код, или вообще написать что код не тестирован (хорошо подумав при это, стоит ли вообще такой код размещать).<br> - нормально его оформить, чтобы тот кому этот код пригодится смог разобраться в нем быстрее чем писать это же с нуля. Обязательно должны быть описания входных и выходных данных. Крайне приветствуются цели создания кода, основные требования которым он удовлетворяет, и описание того как работает этот код.<br><br>Также приветствуются багфиксы, замечания по коду и варианты оптимизации.<br><br>Итак начну с себя. Недавно столкнулся с необходимостью делать высокоточные паузы в работе кода, в моем случае необходимо было достигать точности десятых милисекунд. В итоге я написал микросекундный таймер<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#define&nbsp;YIELD_LOOP&nbsp;<span class="hl_number">200</span></li><li class="hl_l1">#define&nbsp;get_interval_in_us<span class="hl_char">(</span>_t1_<span class="hl_char">,</span>_t2_<span class="hl_char">,</span>_fq_<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">int</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>_t2_<span class="hl_char">.</span>QuadPart&nbsp;<span class="hl_char">-</span>&nbsp;_t1_<span class="hl_char">.</span>QuadPart<span class="hl_char">)</span><span class="hl_char">*</span><span class="hl_number">1000000</span>&nbsp;<span class="hl_char">/</span>&nbsp;_fq_<span class="hl_char">.</span>QuadPart<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;g_sleep_error&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">1000</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;precision_sleep<span class="hl_char">(</span><span class="hl_function"><b>int</b></span>&nbsp;timeout<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;i<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;sleep_time<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;real_sleep_time<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;t2<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;t1<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;fq<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueryPerformanceCounter<span class="hl_char">(</span><span class="hl_char">&amp;</span>t1<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueryPerformanceFrequency<span class="hl_char">(</span><span class="hl_char">&amp;</span>fq<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>timeout&nbsp;<span class="hl_char">&gt;</span>&nbsp;g_sleep_error<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep_time&nbsp;<span class="hl_char">=</span>&nbsp;timeout&nbsp;<span class="hl_char">-</span>&nbsp;g_sleep_error<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep<span class="hl_char">(</span>sleep_time<span class="hl_char">/</span><span class="hl_number">1000</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueryPerformanceCounter<span class="hl_char">(</span><span class="hl_char">&amp;</span>t2<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;real_sleep_time&nbsp;<span class="hl_char">=</span>&nbsp;get_interval_in_us<span class="hl_char">(</span>t1<span class="hl_char">,</span>t2<span class="hl_char">,</span>fq<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>timeout&nbsp;<span class="hl_char">&lt;</span>&nbsp;real_sleep_time<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_sleep_error&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>real_sleep_time&nbsp;<span class="hl_char">-</span>&nbsp;timeout<span class="hl_char">)</span><span class="hl_char">/</span><span class="hl_number">2</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>g_sleep_error&nbsp;<span class="hl_char">&gt;</span>&nbsp;<span class="hl_number">2000</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_sleep_error&nbsp;<span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;min<span class="hl_char">(</span><span class="hl_char">(</span>timeout&nbsp;<span class="hl_char">-</span>&nbsp;real_sleep_time<span class="hl_char">)</span><span class="hl_char">/</span><span class="hl_number">2</span><span class="hl_char">,</span>&nbsp;g_sleep_error<span class="hl_char">/</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span>get_interval_in_us<span class="hl_char">(</span>t1<span class="hl_char">,</span>t2<span class="hl_char">,</span>fq<span class="hl_char">)</span>&nbsp;<span class="hl_char">&lt;</span>&nbsp;timeout<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;<span class="hl_char">(</span>i<span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;i&lt;YIELD_LOOP;i++)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;YieldProcessor</span><span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Sleep<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueryPerformanceCounter<span class="hl_char">(</span><span class="hl_char">&amp;</span>t2<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br> - timeout - время таймаута в  микросекундах<br><br>код рекомендуется выполнять с повышением точности обыкновенного слипа, например так:<br><br>#include &lt;Mmsystem.h&gt;<br>...<br>timeBeginPeriod(1);<br>precision_sleep(timeout);<br>timeEndPeriod(1);<br><br>Код делает таймауты с микросекундой точностью. Как извесно простой Sleep имеет огромную погрешность, допутим Sleep(1) - в нормальных условиях выполнется около 10-15мс (1,5-2мс при установке timeBeginPeriod(1)). Высокая точность достигается за счет использования цикла опроса высокоточного системного таймера (период &lt;1нс - на современных компах и 300-400нс на более старых). Минимальная погрешность данной функции равна времени вызова QueryPerformanceCounter - которое на современных компах равно 200-300нс, на компах по старше может доходить до микросекунды. Ес-но в условиях нехватки процессорного времени погрешность может значительно возрастать.<br><br>Конечно такой метод измерения сильно грузит проц, поэтому при ожидании более 1мс будет использоваться обыкновенный слип, но поскольку он имеет большую погрешность, то динамически в при многократном вызове, precision_sleep проводит пересчет предельной погрешности слипа, подгоняя его под оптимальное значение, при котором будет сохранена хорошая точность при минимальной нагрузке на процессор. Однако не смотря на это всегда имеется вероятность того что слип превысит предельное время и внесет дополнительную погрешность.<br><br>Код тестировался на 2х ядероном компе с процом core2duo и на старом одноядерном Celeron-е<br>При тестировании интервалов больших 3мс загрузка процессора скачет 1% до 15%, при интервалах больих 10мс в средем чтото около 2-3%. Хуже всего дело обстоит с таймаутами порядка 1мс и менее, загрузка может быть очень большой, так как слип в этом случае не работает, чуть чуть улутшить положение можно если заменить <br>for (i=0;i&lt;YIELD_LOOP;i++)<br>	YieldProcessor();<br>на Sleep(0), будет небольшая потеря точности, на моем компе Sleep(0) работает примерно за 1-2мкс (на старых компах может быть еще больше) когда YIELD_LOOP работает &lt; 1 мкс<br><br>Данный код может быть использован при написании сетевых приложений, например для того чтобы точно регуоировать скорость выходного трафика.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251202&amp;user=18950&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=1" class="addthx" data-post="251202"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Vol4ok[/b]','')">Vol4ok</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.1 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.61'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=18950">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 09 февраля 2010 20:23 <br><script type="text/javascript">QU('Vol4ok','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vol4ok" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<I>DaRKSiDE пишет:<br>Если эти коды будут еще и на асме... будет еще лучше </I><br>Не вижу смысла писать такие вещи на асме, т. к. гимор &gt;&gt; польза.<br><br>Следующим полезным кодом которым бы я хотел поделится, это моя реализация спинлоков (некое отдаленное подобие ядерных, только для юзер мода). Реализации возникла в следствии моих исследований по задаче описанной в <a href="http://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15545" target="_blank">этом топике</a>.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;</li><li class="hl_l1">typedef&nbsp;u_long&nbsp;spin_lock_t<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;initialize_spinlock<span class="hl_char">(</span>spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">*</span><span class="hl_function"><b>lock</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;acquire_spinlock<span class="hl_char">(</span>spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span>InterlockedBitTestAndSet<span class="hl_char">(</span><span class="hl_char">(</span>LONG<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_function">lock</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;release_spinlock<span class="hl_char">(</span>spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InterlockedBitTestAndReset<span class="hl_char">(</span><span class="hl_char">(</span>LONG<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_function">lock</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li>        </ol>
    </div>
</div></div>
<br><br>Как видно реализация простая как грабли, но зато тесты впечатляют. По-скольку наиболее быстрым аналогом спинлоков в версиях Windows &lt;6 яаляется критическая секция, то сравнения производительности проводятся именно с ней.<br><br>------<br>итак, результаты тестирования для 64 потоков на 2х ядерном компе<br><br>для обыкновенных критических секций<br>772.895203 с (суммарное время выполнение всех потоков)<br>12.076488 с     (среднее время выполнения одного потока)<br><br>для критических секций с оптимально подобранным значением spincount<br>354.903735 с<br>5.545371 с<br><br>для моих спинлоков<br>110.581553 с<br>1.727837 с   <br><br>производительность на 220% выше<br><br>--------<br>результаты тестирования для 2х потоков на 2х ядерном компе<br><br>для критических секций с оптимально подобранным значением spincount<br>3.316628 с<br>1.658314 с<br><br>для моих спинлоков<br>1.062527 с<br>0.531264 с<br><br>производительность на 212% выше<br><br>--------<br>результаты тестирования для 64 потоков на 1х ядерном компе<br><br>для критических секций<br>580.160929 с<br>9.065015 с <br><br>для моих спинлоков<br>494.444996<br>7.725703<br><br>производительность на 17% выше<br>--------<br><br>Ес-но использование спинлоков подразумевает короткие обращения к разделяемым ресурсам, иначе их использование не будет оправданным.<br><br>Я к сожалению пока поленился протестить на моих тестах SRW-локи, которые идут в винде начиная с висты, но на компах с ХП, не вижу реально ничего лучше.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251207&amp;user=18950&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=2" class="addthx" data-post="251207"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 11:33 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#3');return false;">#3</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;WINAPI&nbsp;NtSleepEx<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;DurationMs<span class="hl_char">,</span>BOOL&nbsp;Alertable<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;Low<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;Hi<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;MLI<span class="hl_char">=</span>{{<span class="hl_char">-</span><span class="hl_number">10000</span><span class="hl_char">*</span>DurationMs}<span class="hl_char">,</span>{0xFFFFFFFF}}<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtDelayExecution<span class="hl_char">(</span>Alertable<span class="hl_char">,</span><span class="hl_char">(</span>PLARGE_INTEGER<span class="hl_char">)</span><span class="hl_char">&amp;</span>MLI<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">#define&nbsp;NtSleep<span class="hl_char">(</span>_x<span class="hl_char">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtSleepEx<span class="hl_char">(</span>_x<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;WINAPI&nbsp;NtBeep&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;dwFreq<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;dwDuration<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hBeep<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;BeepDevice<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_ATTRIBUTES&nbsp;ObjectAttributes<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IO_STATUS_BLOCK&nbsp;IoStatusBlock<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">&gt;</span><span class="hl_char">=</span>&nbsp;0x25&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwFreq&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">=</span>&nbsp;0x7FFF<span class="hl_char">)</span>&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;0x0&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwDuration&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;0x0<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>Buffer<span class="hl_char">=</span><span class="hl_quote">L&quot;\Device\Beep&quot;</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>Length<span class="hl_char">=</span><span class="hl_number">24</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>MaximumLength<span class="hl_char">=</span><span class="hl_number">26</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeObjectAttributes<span class="hl_char">(</span><span class="hl_char">&amp;</span>ObjectAttributes<span class="hl_char">,</span><span class="hl_char">&amp;</span>BeepDevice<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function"><b>NULL</b></span>&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>NtCreateFile<span class="hl_char">(</span><span class="hl_char">&amp;</span>hBeep<span class="hl_char">,</span>FILE_READ_DATA&nbsp;<span class="hl_char">|</span>&nbsp;FILE_WRITE_DATA<span class="hl_char">,</span><span class="hl_char">&amp;</span>ObjectAttributes<span class="hl_char">,</span><span class="hl_char">&amp;</span>IoStatusBlock<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>FILE_SHARE_REA&nbsp;D&nbsp;<span class="hl_char">|</span>&nbsp;FILE_SHARE_WRITE<span class="hl_char">,</span>FILE_OPEN_IF<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Frequency</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Duration</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEEP_SET_PARAMETERS</span><span class="hl_char">=</span>{{dwFreq}<span class="hl_char">,</span>{dwDuration}}<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>NtDeviceIoControlFile<span class="hl_char">(</span>hBeep<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>IoStatusBlock<span class="hl_char">,</span>&nbsp;0x10000<span class="hl_char">,</span><span class="hl_char">&amp;</span>BEEP_SET_PARAMETERS<span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>BEEP_SET_PARAMETERS<span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;0x0&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span>&nbsp;dwDuration&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;0x0<span class="hl_char">)</span>&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwDuration&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_number">1</span><span class="hl_char">)</span>&nbsp;NtSleepEx<span class="hl_char">(</span>dwDuration<span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtClose</span><span class="hl_char">(</span>hBeep<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span class="hl_function"><b>else</b></span>&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251234&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=3" class="addthx" data-post="251234"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 14:42 &middot; Поправил: multiarc <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#4');return false;">#4</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>выделить&nbsp;и&nbsp;инициализировать&nbsp;блок&nbsp;памяти&nbsp;под&nbsp;код<span class="hl_char">,</span>&nbsp;который&nbsp;будет&nbsp;выполнен&nbsp;по&nbsp;переходу&nbsp;на&nbsp;него&nbsp;из&nbsp;APC<span class="hl_char">,</span>&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>при&nbsp;любом&nbsp;удалённом&nbsp;вызове<span class="hl_char">,</span>&nbsp;либо&nbsp;при&nbsp;инжекте</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>Params<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;ULONG&nbsp;FunctionAddr<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;HANDLE&nbsp;Event<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;ULONG&nbsp;<span class="hl_char">*</span>&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;codesize<span class="hl_char">,</span>i<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_function"><b>code</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_char">,</span><span class="hl_char">*</span>codeaddr<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HMODULE&nbsp;ntdll<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;res<span class="hl_char">,</span>tmp<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>FunctionAddr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Params&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paramcount&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codesize&nbsp;<span class="hl_char">=</span>&nbsp;paramcount<span class="hl_char">*</span><span class="hl_number">5</span><span class="hl_char">+</span><span class="hl_char">(</span>Event<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">?</span><span class="hl_number">17</span><span class="hl_char">:</span><span class="hl_number">57</span><span class="hl_char">)</span><span class="hl_comment">;//13+4(result)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span>codesize<span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_EXECUTE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codeaddr&nbsp;<span class="hl_char">=</span>&nbsp;malloc<span class="hl_char">(</span>codesize<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codeaddr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>codeaddr<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>build&nbsp;params</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;<span class="hl_char">(</span>i<span class="hl_char">=</span>paramcount<span class="hl_char">-</span><span class="hl_number">1</span><span class="hl_comment">;i&gt;=0;i--)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;//push dword</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy<span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>Params<span class="hl_char">[</span>i<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;<span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span><span class="hl_char">(</span>paramcount<span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">*</span><span class="hl_number">5</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>build&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;function</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xE8<span class="hl_comment">;//call near relative address</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy<span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>FunctionAddr<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>build&nbsp;store&nbsp;<span class="hl_registr">eax</span><span class="hl_char">(</span>result<span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;memory</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xA3<span class="hl_comment">;//mov [mem],eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>res&nbsp;<span class="hl_char">=</span>&nbsp;0xCDCDCDCD<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>memcpy<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codeaddr<span class="hl_char">+</span>codesize&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>res<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span>codesize&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy<span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>res<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Event&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>DuplicateHandle<span class="hl_char">(</span>GetCurrentProcess<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>Event<span class="hl_char">,</span>Process<span class="hl_char">,</span><span class="hl_char">&amp;</span>Event<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">FALSE</span><span class="hl_char">,</span>DUPL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ICATE_SAME_ACCESS<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;</span><span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_number">0</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>tmp<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>push</b></span>&nbsp;Event</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>Event<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>call</b></span>&nbsp;NtSetEvent</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xE8<span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ULONG<span class="hl_char">)</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;ZwSetEvent&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span><span class="hl_char">(</span>paramcount<span class="hl_char">+</span><span class="hl_number">5</span><span class="hl_char">)</span><span class="hl_char">*</span><span class="hl_number">5</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codeaddr<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>FunctionAddr<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>push</b></span>&nbsp;Event</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>Event<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>call</b></span>&nbsp;NtClose</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xE8<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ULONG<span class="hl_char">)</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;ZwClose&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span><span class="hl_char">(</span>paramcount<span class="hl_char">+</span><span class="hl_number">7</span><span class="hl_char">)</span><span class="hl_char">*</span><span class="hl_number">5</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>FunctionAddr<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_number">0</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>tmp<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>push</b></span>&nbsp;0xFFFFFFFE&nbsp;<span class="hl_char">(</span>Current&nbsp;Thread<span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x68<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;</span><span class="hl_char">=</span>&nbsp;0xFFFFFFFE<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>tmp<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>call</b></span>&nbsp;NtSuspendThread</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xE8<span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ULONG<span class="hl_char">)</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;ZwSuspendThread&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FunctionAddr&nbsp;</span><span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>codebase<span class="hl_char">+</span><span class="hl_char">(</span>paramcount<span class="hl_char">+</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">*</span><span class="hl_number">5</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span><span class="hl_function">code</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>FunctionAddr<span class="hl_char">,</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xC2<span class="hl_comment">;//retn 0xC0</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">1</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x0C<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">code</span><span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0x00<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>write&nbsp;builded&nbsp;<span class="hl_function">code</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span>codeaddr<span class="hl_char">,</span>codesize<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>free&nbsp;<span class="hl_function">code</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>codeaddr<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>result&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">*</span>result&nbsp;<span class="hl_char">=</span>&nbsp;res<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;codebase<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>инициализирует&nbsp;список&nbsp;выделенных&nbsp;блоков&nbsp;памяти&nbsp;чужого&nbsp;процесса</li><li class="hl_l1">PMEM&nbsp;InitMemoryList<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PMEM&nbsp;MemoryList<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PMEM<span class="hl_char">)</span>malloc<span class="hl_char">(</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>MEM<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DuplicateHandle<span class="hl_char">(</span>GetCurrentProcess<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>Process<span class="hl_char">,</span>GetCurrentProcess<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>Memo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>Process<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">FALSE</span><span class="hl_char">,</span>DUPLICATE_SAME_ACCESS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>count&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MemoryList<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>добавляет&nbsp;к&nbsp;списку&nbsp;элемент</li><li class="hl_l0">BOOL&nbsp;AddMemoryList<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;PMEM&nbsp;MemoryList<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;mem</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">*</span>m<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>realloc<span class="hl_char">(</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems<span class="hl_char">,</span><span class="hl_char">(</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>count<span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>m&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems&nbsp;<span class="hl_char">=</span>&nbsp;m<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems<span class="hl_char">[</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>count<span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;mem<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>count<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>очищает&nbsp;ранее&nbsp;выделенную&nbsp;память&nbsp;в&nbsp;чужом&nbsp;процессе&nbsp;и&nbsp;удаляет&nbsp;список</li><li class="hl_l1">&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;FreeAllMemoryList<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__inout&nbsp;PMEM&nbsp;MemoryList</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;i<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;<span class="hl_char">(</span>i&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;i&lt;MemoryList-&gt;count;i++)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>Process<span class="hl_char">,</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems<span class="hl_char">[</span>i<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>Process<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>MemoryList<span class="hl_char">-</span><span class="hl_char">&gt;</span>mems<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>MemoryList<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>возвращает&nbsp;адрес&nbsp;записанного&nbsp;буфера&nbsp;в&nbsp;чужом&nbsp;процессе</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>с&nbsp;выделением&nbsp;памяти&nbsp;под&nbsp;него</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AllocAndWriteRemoteBuffer<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;LocalBuffer<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;ULONG&nbsp;size</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>Buffer<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span>size<span class="hl_char">,</span>MEM_RESERVE&nbsp;<span class="hl_char">|</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Buffer&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>Buffer<span class="hl_char">,</span>LocalBuffer<span class="hl_char">,</span>size<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Buffer<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>записывает&nbsp;в&nbsp;чужой&nbsp;процесс&nbsp;структуру&nbsp;ANSI_STRING<span class="hl_char">,</span>&nbsp;используя&nbsp;адрес&nbsp;на&nbsp;строку<span class="hl_char">,</span>&nbsp;и&nbsp;возвращает&nbsp;её&nbsp;адрес</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>с&nbsp;выделением&nbsp;памяти&nbsp;под&nbsp;неё</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AllocAndWriteRemoteAnsiString<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AnsiString</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;len<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>String<span class="hl_char">,</span><span class="hl_char">*</span>String_A<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;strlen<span class="hl_char">(</span>AnsiString<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String_A&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>ANSI_STRING<span class="hl_char">)</span><span class="hl_char">+</span>len<span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>String_A&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_A<span class="hl_char">+</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>ANSI_STRING<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String<span class="hl_char">,</span>AnsiString<span class="hl_char">,</span>len<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len<span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String_A<span class="hl_char">,</span><span class="hl_char">&amp;</span>len<span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_A<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>len<span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_A<span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>String<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;String_A<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>записывает&nbsp;в&nbsp;чужой&nbsp;процесс&nbsp;структуру&nbsp;UNICODE_STRING<span class="hl_char">,</span>&nbsp;используя&nbsp;адрес&nbsp;на&nbsp;строку<span class="hl_char">,</span>&nbsp;и&nbsp;возвращает&nbsp;её&nbsp;адрес</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>с&nbsp;выделением&nbsp;памяти&nbsp;под&nbsp;неё</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AllocAndWriteRemoteUnicodeString<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;UnicodeString</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;len<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>String<span class="hl_char">,</span><span class="hl_char">*</span>String_U<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wcslen<span class="hl_char">(</span>UnicodeString<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String_U&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>UNICODE_STRING<span class="hl_char">)</span><span class="hl_char">+</span>len<span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>String_U&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_U<span class="hl_char">+</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>UNICODE_STRING<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String<span class="hl_char">,</span>UnicodeString<span class="hl_char">,</span>len<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len<span class="hl_char">-</span><span class="hl_char">=</span><span class="hl_number">2</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String_U<span class="hl_char">,</span><span class="hl_char">&amp;</span>len<span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len<span class="hl_char">+</span><span class="hl_char">=</span><span class="hl_number">2</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_U<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>len<span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>String_U<span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>String<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;String_U<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>записывает&nbsp;С&nbsp;ANSI&nbsp;строку&nbsp;в&nbsp;чужой&nbsp;процесс</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>с&nbsp;выделением&nbsp;памяти&nbsp;под&nbsp;неё</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AllocAndWriteNullTerminatedAnsiString<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AnsiString</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;len<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;String<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;strlen<span class="hl_char">(</span>AnsiString<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span>len<span class="hl_char">,</span>MEM_RESERVE&nbsp;<span class="hl_char">|</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>String&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String<span class="hl_char">,</span>AnsiString<span class="hl_char">,</span>len<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;String<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>записывает&nbsp;С&nbsp;UNICODE&nbsp;строку&nbsp;в&nbsp;чужой&nbsp;процесс</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>с&nbsp;выделением&nbsp;памяти&nbsp;под&nbsp;неё</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;AllocAndWriteNullTerminatedUnicodeString<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;UnicodeString</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;len<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;String<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wcslen<span class="hl_char">(</span>UnicodeString<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span>len<span class="hl_char">,</span>MEM_RESERVE&nbsp;<span class="hl_char">|</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>String&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>String<span class="hl_char">,</span>UnicodeString<span class="hl_char">,</span>len<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;String<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>реаллоцирует&nbsp;ранее&nbsp;выделенный&nbsp;блок&nbsp;памяти&nbsp;<span class="hl_char">(</span>уменьшает&nbsp;или&nbsp;увеличивает&nbsp;размер&nbsp;блока<span class="hl_char">,</span>&nbsp;с&nbsp;сохранением&nbsp;данных<span class="hl_char">)</span></li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>или&nbsp;создаёт&nbsp;<span class="hl_char">(</span>выделяет<span class="hl_char">)</span>&nbsp;новый&nbsp;блок&nbsp;памяти</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;ReVirtualAlloc<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;Mem<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;oldsize<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;newsize<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;fprotect<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;NewMem<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>oldsize&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;newsize&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;Mem&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Mem<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NewMem&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAlloc<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>newsize<span class="hl_char">,</span>MEM_COMMIT<span class="hl_char">,</span>fprotect<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Mem&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NewMem<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>oldsize&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>oldsize&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">=</span>&nbsp;newsize<span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span>NewMem<span class="hl_char">,</span>Mem<span class="hl_char">,</span>oldsize<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">else</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy</span><span class="hl_char">(</span>NewMem<span class="hl_char">,</span>Mem<span class="hl_char">,</span>newsize<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree<span class="hl_char">(</span>Mem<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NewMem<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>включение<span class="hl_char">/</span>отключение&nbsp;установленной&nbsp;привилегии&nbsp;в&nbsp;процессе</li><li class="hl_l1">BOOL&nbsp;SetPrivilege<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;PrivilegeName<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;BOOL&nbsp;Enabled</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;token<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;cb<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TOKEN_PRIVILEGES&nbsp;tkp<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>OpenProcessToken<span class="hl_char">(</span>GetCurrentProcess<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>TOKEN_ADJUST_PRIVILEGES<span class="hl_char">,</span><span class="hl_char">&amp;</span>token<span class="hl_char">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>LookupPrivilegeValueW<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>PrivilegeName<span class="hl_char">,</span><span class="hl_char">&amp;</span>tkp<span class="hl_char">.</span>Privileges<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">.</span>Luid<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tkp<span class="hl_char">.</span>PrivilegeCount&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Enabled<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tkp<span class="hl_char">.</span>Privileges<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">.</span>Attributes&nbsp;<span class="hl_char">=</span>&nbsp;SE_PRIVILEGE_ENABLED<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tkp<span class="hl_char">.</span>Privileges<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">.</span>Attributes&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>AdjustTokenPrivileges<span class="hl_char">(</span>token<span class="hl_char">,</span><span class="hl_function">FALSE</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>tkp<span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>tkp<span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>cb<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>token<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>получает&nbsp;адрес&nbsp;процедуры&nbsp;в&nbsp;нужной&nbsp;библиотеке&nbsp;в&nbsp;чужом&nbsp;процессе&nbsp;<span class="hl_char">(</span>удалённый&nbsp;аналог&nbsp;kernel32<span class="hl_char">!</span>GetProcAddress<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">FARPROC&nbsp;__stdcall&nbsp;RemoteGetProcAddress<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HMODULE&nbsp;LibraryBase<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;Function</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>funcname_A<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span><span class="hl_function"><b>addr</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FARPROC&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>get&nbsp;function&nbsp;base&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;process&nbsp;address&nbsp;space</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;funcname_A&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteRemoteAnsiString<span class="hl_char">(</span>Process<span class="hl_char">,</span>Function<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>addr</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_function">addr</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>funcname_A<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>calloc<span class="hl_char">(</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Params&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">addr</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>funcname_A<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;LibraryBase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">1</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;funcname_A<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">3</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>addr</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoteCallSystem<span class="hl_char">(</span>Process<span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_quote">&quot;LdrGetProcedureAddress&quot;</span><span class="hl_char">,</span>P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arams<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Params<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">addr</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>funcname_A<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">addr</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251248&amp;user=12469&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=4" class="addthx" data-post="251248"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 15:01 &middot; Поправил: multiarc <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#5');return false;">#5</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>удалённое&nbsp;получение&nbsp;базы&nbsp;модуля&nbsp;с&nbsp;именем&nbsp;<span class="hl_char">(</span>удалённый&nbsp;аналог&nbsp;kernel32<span class="hl_char">!</span>GetModuleHandleW<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">HMODULE&nbsp;RemoteGetDllHandle<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>DllName</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>libname_U<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>lib<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>libpath<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;params<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;len<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>Path<span class="hl_char">,</span><span class="hl_char">*</span>FileName<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;wcslen<span class="hl_char">(</span>DllName<span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Path&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileName&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>FileName&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>SplitPathFileNameW<span class="hl_char">(</span>DllName<span class="hl_char">,</span>Path<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libpath&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteNullTerminatedUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libpath&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libname_U&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteRemoteUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libname_U&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lib&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>&nbsp;PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>lib&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>libname_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libpath&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>libpath<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>calloc<span class="hl_char">(</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>params&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>libname_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libpath&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>libpath<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>lib<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;libpath<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params<span class="hl_char">[</span><span class="hl_number">1</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params<span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;libname_U<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params<span class="hl_char">[</span><span class="hl_number">3</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;lib<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoteCallSystem<span class="hl_char">(</span>Process<span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_quote">&quot;LdrGetDllHandle&quot;</span><span class="hl_char">,</span>params<span class="hl_char">,</span><span class="hl_number">4</span>&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>lib<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>libname_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libpath&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>libpath<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>lib<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>params<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">ULONG&nbsp;InjectLibraryToProcessExRT<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">Library</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>DllHandle<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>PathBufPtr<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>NameBufPtr_U<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">*</span>Params<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HANDLE&nbsp;Process<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;len<span class="hl_char">,</span>fulllen<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>Path<span class="hl_char">,</span><span class="hl_char">*</span>FileName<span class="hl_char">,</span><span class="hl_char">*</span>PATH<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;wcslen<span class="hl_char">(</span><span class="hl_function">Library</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Path&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileName&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>FileName&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>SplitPathFileNameW<span class="hl_char">(</span><span class="hl_function">Library</span><span class="hl_char">,</span>Path<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span style="word-break: break-all">Получить&nbsp;переменную&nbsp;path&nbsp;и&nbsp;передать&nbsp;для&nbsp;подгрузки&nbsp;длл&nbsp;дополнительно&nbsp;с&nbsp;путём&nbsp;местанахождения</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>это&nbsp;нужно&nbsp;для&nbsp;подгрузки&nbsp;например&nbsp;ещё&nbsp;не&nbsp;подгруженой&nbsp;advapi<span class="hl_char">.</span>dll<span class="hl_char">,</span>&nbsp;kernel32<span class="hl_char">.</span>dll</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>используется&nbsp;нативный&nbsp;трэд&nbsp;для&nbsp;внедрения&nbsp;в&nbsp;процесс<span class="hl_char">,</span>&nbsp;т<span class="hl_char">.</span>е<span class="hl_char">.</span>&nbsp;используется&nbsp;только&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ntdll<span class="hl_char">.</span>dll</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;GetEnvironmentVariableW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;PATH&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fulllen&nbsp;<span class="hl_char">=</span>&nbsp;len<span class="hl_char">+</span><span class="hl_char">(</span><span class="hl_char">(</span>wcslen<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PATH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>realloc<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PATH&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;</span><span class="hl_char">=</span>&nbsp;PATH<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PATH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PATH&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetEnvironmentVariableW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;PATH&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span>PATH<span class="hl_char">,</span><span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcscat_s<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;;&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcscat_s<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">,</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PathBufPtr&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteNullTerminatedUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PathBufPtr&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DllHandle&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>DllHandle&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NameBufPtr_U&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteRemoteUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NameBufPtr_U&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>calloc<span class="hl_char">(</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Params&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>NameBufPtr_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;PathBufPtr<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">1</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;NameBufPtr_U<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">3</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;DllHandle<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoteCallSystem<span class="hl_char">(</span>Process<span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_quote">&quot;LdrLoadDll&quot;</span><span class="hl_char">,</span>Params<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>NameBufPtr_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Params<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>так&nbsp;же&nbsp;желательно&nbsp;сделать&nbsp;все&nbsp;вызовы&nbsp;нативными<span class="hl_char">,</span>&nbsp;для&nbsp;возможности&nbsp;инжекта&nbsp;так&nbsp;же&nbsp;в&nbsp;графическую&nbsp;подсистему&nbsp;csrss<span class="hl_char">!</span></li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>Инжект&nbsp;себя&nbsp;в&nbsp;любой&nbsp;<span class="hl_char">(</span>даже&nbsp;привилегированный&nbsp;процесс<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;кроме&nbsp;csrss&nbsp;и&nbsp;тех<span class="hl_char">,</span>&nbsp;что&nbsp;защищены&nbsp;альтернативными&nbsp;методами<span class="hl_char">:</span></li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>неоторые&nbsp;антивирусы<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span>audiodg<span class="hl_char">.</span>exe&nbsp;в&nbsp;Win&nbsp;<span class="hl_number">7</span>&nbsp;и&nbsp;Vista<span class="hl_char">)</span>&nbsp;и&nbsp;т<span class="hl_char">.</span>д<span class="hl_char">.</span></li><li class="hl_l1">ULONG&nbsp;InjectSelfToProcessExRT<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>DllHandle<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>PathBufPtr<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>NameBufPtr_U<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">*</span>Params<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HANDLE&nbsp;Process<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;len<span class="hl_char">,</span>fulllen<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>Path<span class="hl_char">,</span><span class="hl_char">*</span>FileName<span class="hl_char">,</span><span class="hl_char">*</span>PATH<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;wcslen<span class="hl_char">(</span>ModulePath<span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Path&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileName&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>FileName&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>SplitPathFileNameW<span class="hl_char">(</span>ModulePath<span class="hl_char">,</span>Path<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span style="word-break: break-all">Получить&nbsp;переменную&nbsp;path&nbsp;и&nbsp;передать&nbsp;для&nbsp;подгрузки&nbsp;длл&nbsp;дополнительно&nbsp;с&nbsp;путём&nbsp;местанахождения</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>это&nbsp;нужно&nbsp;для&nbsp;подгрузки&nbsp;например&nbsp;ещё&nbsp;не&nbsp;подгруженой&nbsp;advapi<span class="hl_char">.</span>dll<span class="hl_char">,</span>&nbsp;kernel32<span class="hl_char">.</span>dll</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>используется&nbsp;нативный&nbsp;трэд&nbsp;для&nbsp;внедрения&nbsp;в&nbsp;процесс<span class="hl_char">,</span>&nbsp;т<span class="hl_char">.</span>е<span class="hl_char">.</span>&nbsp;используется&nbsp;только&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ntdll<span class="hl_char">.</span>dll</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;<span class="hl_char">=</span>&nbsp;GetEnvironmentVariableW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;PATH&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fulllen&nbsp;<span class="hl_char">=</span>&nbsp;len<span class="hl_char">+</span><span class="hl_char">(</span><span class="hl_char">(</span>wcslen<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&lt;</span><span class="hl_char">&lt;</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PATH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>realloc<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PATH&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;</span><span class="hl_char">=</span>&nbsp;PATH<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PATH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>wchar_t&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>malloc<span class="hl_char">(</span>len<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PATH&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetEnvironmentVariableW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;PATH&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span>PATH<span class="hl_char">,</span><span class="hl_char">(</span>len<span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcscat_s<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;;&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcscat_s<span class="hl_char">(</span>Path<span class="hl_char">,</span>fulllen<span class="hl_char">&gt;</span><span class="hl_char">&gt;</span><span class="hl_number">1</span><span class="hl_char">,</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PathBufPtr&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteNullTerminatedUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free</span><span class="hl_char">(</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>PATH<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PathBufPtr&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Path<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DllHandle&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAllocEx<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span>MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE<span class="hl_char">,</span>PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>DllHandle&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NameBufPtr_U&nbsp;<span class="hl_char">=</span>&nbsp;AllocAndWriteRemoteUnicodeString<span class="hl_char">(</span>Process<span class="hl_char">,</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NameBufPtr_U&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>FileName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>calloc<span class="hl_char">(</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Params&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>NameBufPtr_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx</span><span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;PathBufPtr<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">1</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;NameBufPtr_U<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Params<span class="hl_char">[</span><span class="hl_number">3</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;DllHandle<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoteCallSystem<span class="hl_char">(</span>Process<span class="hl_char">,</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_quote">&quot;LdrLoadDll&quot;</span><span class="hl_char">,</span>Params<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>DllHandle<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>NameBufPtr_U<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>PathBufPtr&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>PathBufPtr<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free<span class="hl_char">(</span>Params<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;RemoteCallApcEx<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Thread<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;FARPROC&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__inout&nbsp;PMEM&nbsp;<span class="hl_char">*</span>MemoryList<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;HANDLE&nbsp;Event<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__out_opt&nbsp;ULONG&nbsp;<span class="hl_char">*</span>&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HMODULE&nbsp;ntdll<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span>&nbsp;InitMemoryList<span class="hl_char">(</span>Process<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>Function<span class="hl_char">,</span>Event<span class="hl_char">,</span>result&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddMemoryList<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList<span class="hl_char">,</span>codebase<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>Thread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ResumeThread<span class="hl_char">(</span>Thread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>apc&nbsp;calls&nbsp;<span class="hl_char">-</span><span class="hl_char">-</span>&nbsp;no&nbsp;wait<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;need&nbsp;alternative&nbsp;path&nbsp;to&nbsp;wait&nbsp;apc&nbsp;to&nbsp;free&nbsp;allocated&nbsp;memory</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>WaitForSingleObject<span class="hl_char">(</span>Thread<span class="hl_char">,</span>INFINITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251250&amp;user=12469&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=5" class="addthx" data-post="251250"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 15:03 <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#6');return false;">#6</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>удалённый&nbsp;вызов<span class="hl_char">,</span>&nbsp;используя&nbsp;APC&nbsp;очередь&nbsp;уже&nbsp;созданного&nbsp;потока&nbsp;<span class="hl_char">(</span>например&nbsp;первый&nbsp;поток&nbsp;приложения<span class="hl_char">)</span></li><li class="hl_l1">BOOL&nbsp;RemoteCallApc<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Thread<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">Library</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__inout&nbsp;PMEM&nbsp;<span class="hl_char">*</span>MemoryList<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;HANDLE&nbsp;Event<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__out_opt&nbsp;ULONG&nbsp;<span class="hl_char">*</span>&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>libaddr<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HMODULE&nbsp;ntdll<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span>&nbsp;InitMemoryList<span class="hl_char">(</span>Process<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>get&nbsp;<span class="hl_function"><b>library</b></span>&nbsp;base&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;process&nbsp;address&nbsp;space</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>need&nbsp;<span class="hl_function">TEST</span><span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">!</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libaddr&nbsp;<span class="hl_char">=</span>&nbsp;RemoteGetDllHandle<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">Library</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libaddr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>eval&nbsp;function&nbsp;address</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>need&nbsp;<span class="hl_function">TEST</span><span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">!</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>RemoteGetProcAddress<span class="hl_char">(</span>&nbsp;Process<span class="hl_char">,</span><span class="hl_char">(</span>HMODULE<span class="hl_char">)</span>libaddr<span class="hl_char">,</span>Function<span class="hl_char">)</span><span class="hl_char">,</span>Event<span class="hl_char">,</span>result<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddMemoryList<span class="hl_char">(</span><span class="hl_char">*</span>MemoryList<span class="hl_char">,</span>codebase<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_char">=</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>Thread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ResumeThread<span class="hl_char">(</span>Thread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>apc&nbsp;calls&nbsp;<span class="hl_char">-</span><span class="hl_char">-</span>&nbsp;no&nbsp;wait<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;need&nbsp;alternative&nbsp;path&nbsp;to&nbsp;wait&nbsp;apc&nbsp;to&nbsp;free&nbsp;allocated&nbsp;memory</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>WaitForSingleObject<span class="hl_char">(</span>Thread<span class="hl_char">,</span>INFINITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">ULONG&nbsp;RemoteCallEx<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;FARPROC&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_char">,</span>StackReserved<span class="hl_char">,</span>StackCommit<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLIENT_ID&nbsp;cid<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HMODULE&nbsp;ntdll<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hthread<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Process&nbsp;<span class="hl_char">=</span>&nbsp;OpenProcess<span class="hl_char">(</span>PROCESS_ALL_ACCESS<span class="hl_char">,</span><span class="hl_function">FALSE</span><span class="hl_char">,</span>ProcessId<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Process&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>eval&nbsp;function&nbsp;address<span class="hl_char">,</span>&nbsp;build&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;process</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>Function<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>result&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Create&nbsp;Thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackReserved&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackCommit&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>NT_SUCCESS<span class="hl_char">(</span>RtlCreateUserThread<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>StackReserved<span class="hl_char">,</span><span class="hl_char">&amp;</span>S&nbsp;tackCommit<span class="hl_char">,</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;RtlExitUserThread&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>ci&nbsp;d<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResumeThread<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObject<span class="hl_char">(</span>hthread<span class="hl_char">,</span>INFINITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>удалённый&nbsp;вызов</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>работает&nbsp;с&nbsp;любыми&nbsp;библиотеками<span class="hl_char">,</span>&nbsp;загруженными&nbsp;в&nbsp;адресное&nbsp;пространство&nbsp;любого&nbsp;процесса</li><li class="hl_l0">ULONG&nbsp;RemoteCall<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">Library</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>libaddr<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_char">,</span>StackReserved<span class="hl_char">,</span>StackCommit<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLIENT_ID&nbsp;cid<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>HMODULE&nbsp;ntdll<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hthread<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Process&nbsp;<span class="hl_char">=</span>&nbsp;OpenProcess<span class="hl_char">(</span>PROCESS_ALL_ACCESS<span class="hl_char">,</span><span class="hl_function">FALSE</span><span class="hl_char">,</span>ProcessId<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>Process&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>get&nbsp;<span class="hl_function"><b>library</b></span>&nbsp;base&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;process&nbsp;address&nbsp;space</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libaddr&nbsp;<span class="hl_char">=</span>&nbsp;RemoteGetDllHandle<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">Library</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>libaddr&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>eval&nbsp;function&nbsp;address<span class="hl_char">,</span>&nbsp;build&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;process</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>RemoteGetProcAddress<span class="hl_char">(</span>&nbsp;Process<span class="hl_char">,</span><span class="hl_char">(</span>HMODULE<span class="hl_char">)</span>libaddr<span class="hl_char">,</span>Function<span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Create&nbsp;Thread</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackReserved&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackCommit&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>NT_SUCCESS<span class="hl_char">(</span>RtlCreateUserThread<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>StackReserved<span class="hl_char">,</span><span class="hl_char">&amp;</span>S&nbsp;tackCommit<span class="hl_char">,</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;RtlExitUserThread&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>ci&nbsp;d<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResumeThread<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObject<span class="hl_char">(</span>hthread<span class="hl_char">,</span>INFINITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">ULONG&nbsp;RemoteCallSystemEx<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;FARPROC&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_char">,</span>StackReserved<span class="hl_char">,</span>StackCommit<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLIENT_ID&nbsp;cid<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hthread<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;state<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>Function<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>result&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Create&nbsp;Thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackReserved&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackCommit&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>NT_SUCCESS<span class="hl_char">(</span>RtlCreateUserThread<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>StackReserved<span class="hl_char">,</span><span class="hl_char">&amp;</span>S&nbsp;tackCommit<span class="hl_char">,</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;RtlExitUserThread&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>ci&nbsp;d<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResumeThread<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObjectEx<span class="hl_char">(</span>hthread<span class="hl_char">,</span>INFINITE<span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetExitCodeThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>state<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>удалённый&nbsp;вызов</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>работает&nbsp;только&nbsp;с&nbsp;библиотеками<span class="hl_char">,</span>&nbsp;которые&nbsp;загружены&nbsp;по&nbsp;одному&nbsp;адресу&nbsp;в&nbsp;разных&nbsp;процессах</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>обычно&nbsp;так&nbsp;загружены&nbsp;все&nbsp;системные&nbsp;библиотеки</li><li class="hl_l1">ULONG&nbsp;RemoteCallSystem<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;HANDLE&nbsp;Process<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">Library</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>&nbsp;Function<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in_opt&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;PVOID&nbsp;<span class="hl_char">*</span>&nbsp;Params<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;paramcount</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span>codebase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;result<span class="hl_char">,</span>StackReserved<span class="hl_char">,</span>StackCommit<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLIENT_ID&nbsp;cid<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;lib<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hthread<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;state<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span>TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;ntdll.dll&quot;</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ntdll&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lib&nbsp;<span class="hl_char">=</span>&nbsp;GetModuleHandleW<span class="hl_char">(</span><span class="hl_function">Library</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>lib&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codebase&nbsp;<span class="hl_char">=</span>&nbsp;RemoteBuildCode<span class="hl_char">(</span>Process<span class="hl_char">,</span>Params<span class="hl_char">,</span>paramcount<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span>GetProcAddress<span class="hl_char">(</span>lib<span class="hl_char">,</span>Fu&nbsp;nction<span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>codebase&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Create&nbsp;Thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackReserved&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackCommit&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>NT_SUCCESS<span class="hl_char">(</span>RtlCreateUserThread<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>StackReserved<span class="hl_char">,</span><span class="hl_char">&amp;</span>S&nbsp;tackCommit<span class="hl_char">,</span>GetProcAddress<span class="hl_char">(</span>ntdll<span class="hl_char">,</span><span class="hl_quote">&quot;RtlExitUserThread&quot;</span><span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>ci&nbsp;d<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Queue&nbsp;Asyncronous&nbsp;Procedure&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;created&nbsp;thread</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwQueueApcThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">(</span>PIO_APC_ROUTINE<span class="hl_char">)</span>codebase<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>start&nbsp;thread&nbsp;<span class="hl_char">(</span>calling&nbsp;APC<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResumeThread<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>waiting&nbsp;to&nbsp;thread&nbsp;finish</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObjectEx<span class="hl_char">(</span>hthread<span class="hl_char">,</span>INFINITE<span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetExitCodeThread<span class="hl_char">(</span>hthread<span class="hl_char">,</span><span class="hl_char">&amp;</span>state<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>reading&nbsp;result</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadProcessMemory<span class="hl_char">(</span>Process<span class="hl_char">,</span><span class="hl_char">(</span>LPCVOID<span class="hl_char">)</span>result<span class="hl_char">,</span><span class="hl_char">&amp;</span>result<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFreeEx<span class="hl_char">(</span>Process<span class="hl_char">,</span>codebase<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>hthread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251251&amp;user=12469&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=6" class="addthx" data-post="251251"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 15:05 <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#7');return false;">#7</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>структура&nbsp;хранящая&nbsp;указатели&nbsp;на&nbsp;выделенные&nbsp;куски&nbsp;памяти&nbsp;в&nbsp;другом&nbsp;процессе<span class="hl_char">,</span>&nbsp;для&nbsp;их&nbsp;последующего&nbsp;завершения</li><li class="hl_l1">typedef&nbsp;struct&nbsp;_MEM</li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;count<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;Process<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">*</span>&nbsp;mems<span class="hl_comment">;</span></li><li class="hl_l0">}&nbsp;MEM<span class="hl_char">,</span><span class="hl_char">*</span>PMEM<span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>опкоды&nbsp;инструкций</li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;mov_esp_eax<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0x89<span class="hl_char">,</span>0x84<span class="hl_char">,</span>0x24}<span class="hl_comment">;//mov dword ptr [esp-(param_c+1)*4], eax</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;mov_esp_ecx<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0x89<span class="hl_char">,</span>0x8C<span class="hl_char">,</span>0x24}<span class="hl_comment">;//mov dword ptr [esp-(param_c+2)*4], ecx</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;mov_ecx_num<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xB9}<span class="hl_comment">;//mov ecx, 5</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;mov_eax_num<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xB8}<span class="hl_comment">;//mov eax, 10</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;jmp_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xE9}<span class="hl_comment">;//jmp addr_rel</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;call_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xE8}<span class="hl_comment">;//call addr_rel</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;jmp_far<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xEA}<span class="hl_comment">;//jmp far addr_abs</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;ret_st<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xC2}<span class="hl_comment">;//ret num</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;ret_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xC3}<span class="hl_comment">;//ret</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;push_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0x68}<span class="hl_comment">;//push dword</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;int_3_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0xCC}<span class="hl_comment">;//int 3</span></li><li class="hl_l1">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;nop_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0x90}<span class="hl_comment">;//nop</span></li><li class="hl_l0">static&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;pushad_<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;{0x60}<span class="hl_comment">;//pushad</span></li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251252&amp;user=12469&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=7" class="addthx" data-post="251252"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Ara[/b]','')">Ara</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/24.jpg" alt=""><br><span class=txtSm>Ранг: 1288.1 <b><u>(!!!!)</u></b>, 273thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.96'>Активность: 1.29<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=24">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 15:36 <br><script type="text/javascript">QU('Ara','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ara" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
норм, готовый конструктор вирусов выложил
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251254&amp;user=24&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=8" class="addthx" data-post="251254"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Vol4ok[/b]','')">Vol4ok</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.1 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.61'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=18950">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 18:21 &middot; Поправил: Vol4ok <br><script type="text/javascript">QU('Vol4ok','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vol4ok" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
Реализация двусвязных списков, аналогичных ядерным, но для юзермода, написаны с использовании моих спинлоков, код которых описан выше. В качестве мануала по использованию можно читать WDK, все входные и выходные данные совпадают<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;</li><li class="hl_l1">typedef&nbsp;struct&nbsp;_list_entry_t&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;_list_entry_t&nbsp;<span class="hl_char">*</span>flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;_list_entry_t&nbsp;<span class="hl_char">*</span>blink<span class="hl_comment">;</span></li><li class="hl_l0">}&nbsp;list_entry_t<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">#define&nbsp;is_list_empty<span class="hl_char">(</span>list_head<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>list_head<span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>list_head<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;initialize_list_head<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">bool&nbsp;remove_entry_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_char">(</span>flink&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;blink<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">list_entry_t<span class="hl_char">*</span>&nbsp;remove_head_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>entry</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>flink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">list_entry_t<span class="hl_char">*</span>&nbsp;remove_tail_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>entry</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;insert_tail_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;blink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blink<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;__forceinline&nbsp;insert_head_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">entry</span><span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;flink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">entry</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;list_head<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flink<span class="hl_char">-</span><span class="hl_char">&gt;</span>blink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_head<span class="hl_char">-</span><span class="hl_char">&gt;</span>flink&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;interlocked_insert_head_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;list_entry<span class="hl_char">,</span>&nbsp;spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acquire_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_head_list<span class="hl_char">(</span>list_head<span class="hl_char">,</span>list_entry<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;interlocked_insert_tail_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;list_entry<span class="hl_char">,</span>&nbsp;spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acquire_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_tail_list<span class="hl_char">(</span>list_head<span class="hl_char">,</span>list_entry<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">list_entry_t<span class="hl_char">*</span>&nbsp;interlocked_remove_head_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acquire_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>entry</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;remove_head_list<span class="hl_char">(</span>list_head<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">list_entry_t<span class="hl_char">*</span>&nbsp;interlocked_remove_tail_list<span class="hl_char">(</span>list_entry_t<span class="hl_char">*</span>&nbsp;list_head<span class="hl_char">,</span>&nbsp;spin_lock_t<span class="hl_char">*</span>&nbsp;<span class="hl_function">lock</span><span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_entry_t<span class="hl_char">*</span>&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acquire_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>entry</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;remove_tail_list<span class="hl_char">(</span>list_head<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_spinlock<span class="hl_char">(</span><span class="hl_function">lock</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>entry</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251265&amp;user=18950&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=9" class="addthx" data-post="251265"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 18:48 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>multiarc</b><br>&gt; так же желательно сделать все вызовы нативными, для возможности инжекта так же в графическую подсистему csrss!<br>Нэйтив юзается изза следующих причин:<br> o Самодостаточный код(вызов непосредственно через шлюзы).<br> o Если не достаточно функционала более высокоуровневого кода.<br>csrss это обычный гуи-процесс.<br>&gt; получает адрес процедуры в нужной библиотеке в чужом процессе<br>Для этого есть системные апи, например <b>RtlQueryProcessDebugInformation()</b>.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251271&amp;user=17964&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=10" class="addthx" data-post="251271"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 10 февраля 2010 23:01 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
Хорош оффтопить уже, ближе к теме давайте, не захламляйте потенциально полезный топик, буду удалять.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251311&amp;user=1556&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=11" class="addthx" data-post="251311"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 февраля 2010 10:22 <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Замудреный юзермодный протектор от удаленных потоков (натив)<br><br><img src="img/attach.gif" alt=""> <a href="./files/3726_10.02.2010_CRACKLAB.rU.tgz">3726_10.02.2010_CRACKLAB.rU.tgz</a> - InjProt.7z
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251335&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=12" class="addthx" data-post="251335"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]Twister[/b]','')">Twister</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 11.1 (новичок)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.42'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=3736">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 февраля 2010 11:15 &middot; Поправил: Twister <br><script type="text/javascript">QU('Twister','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Twister" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<b>HiEndsoft</b><br><br>1. GetProcAddressEx() не учитывает того, что возможен IAT-перехват искомой функции. Если это случится, все пойдет прахом.<br>2. Обработчик NewNtCreateThread() не учитывает того, что в PCLIENT_ID a5 может быть передан NULL. Сами знаете, чем такое закончится.<br>3. Внутри программы сервис NtCreateThread() может быть вызван напрямую в обход ntdll. В этом случае ваш алгоритм не распознает свой поток и прибъет его.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251337&amp;user=3736&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=13" class="addthx" data-post="251337"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 февраля 2010 11:19 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
<b>Clerk</b><br>NtQueryVirtualMemory - тоже функция ничего для получения карты памяти процесса<br><b>Twister</b><br>Панацей не бывает в юзермоде (и даже практически в ядре) + Код делался для собственных целей для псевдозащиты cssrs тонкости там сами понимаете какие. Винду придумали-это хорошо, но идиоты - это плохо.
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251338&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=14" class="addthx" data-post="251338"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]Hellspawn[/b]','')">Hellspawn</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/72.gif" alt=""><br><span class=txtSm>Ранг: 990.2 <font color=red>(<b>! ! !</b>)</font>, 380thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.95'>Активность: 0.68<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=72">Модератор</a><br><font color=blue>Author of DiE</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 февраля 2010 12:32 &middot; Поправил: <a href="action=stats#mods">Модератор</a> <br><script type="text/javascript">QU('Hellspawn','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Hellspawn" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
давайте биже к теме и без перехода на личности <img src="img/smilies/s21.gif" alt="">
<br><br><font size="1"><i>-----<br>[nice coder and reverser]</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251348&amp;user=72&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=15" class="addthx" data-post="251348"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 февраля 2010 13:30 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
Либа для работы с частотниками Mitsubishi по RS485. (сорцы Си 6)<br><br><img src="img/attach.gif" alt=""> <a href="./files/d31f_11.02.2010_CRACKLAB.rU.tgz">d31f_11.02.2010_CRACKLAB.rU.tgz</a> - watersky.7z
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251350&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=16" class="addthx" data-post="251350"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]Valemox[/b]','')">Valemox</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 116.5 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.8'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=18198">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 февраля 2010 00:44 &middot; Поправил: Valemox <br><script type="text/javascript">QU('Valemox','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Valemox" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
<I>HiEndsoft пишет:<br>Замудреный юзермодный протектор от удаленных потоков </I><br><b>HiEndsoft</b>, хотел собрать либ и поюзать, но чота не нашлось ntundoc хидера, мож поделишся?<br>ЗЫ. <b>HiEndsoft</b>, спс
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251382&amp;user=18198&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=17" class="addthx" data-post="251382"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 февраля 2010 01:10 &middot; Поправил: Clerk <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
<b>HiEndsoft</b><br>&gt; NtQueryVirtualMemory - тоже функция ничего для получения карты памяти процесса<br>Согласен, но причём тут это ?<br>&gt; Замудреный юзермодный протектор от удаленных потоков (натив)<br>Сложный != эффективный.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Запуск&nbsp;пользовательского&nbsp;потока&nbsp;в&nbsp;обход&nbsp;перехвата&nbsp;диспетчера&nbsp;APC<span class="hl_char">(</span>R3<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1">&nbsp;o&nbsp;Восстанавливаем&nbsp;RtlpCalloutEntryList<span class="hl_char">,</span>&nbsp;для&nbsp;исключения&nbsp;глобальных&nbsp;VEH<span class="hl_char">.</span></li><li class="hl_l0">&nbsp;o&nbsp;Создаём&nbsp;удалённый&nbsp;поток<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;o&nbsp;Формируем&nbsp;SEH<span class="hl_char">-</span>фрейм<span class="hl_char">.</span></li><li class="hl_l0">&nbsp;o&nbsp;Взводим&nbsp;TF&nbsp;в&nbsp;контексте<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;Поток&nbsp;стартует&nbsp;с&nbsp;взведённым&nbsp;TF<span class="hl_char">.</span>&nbsp;После&nbsp;исполнения&nbsp;первой&nbsp;инструкции&nbsp;диспетчера&nbsp;апк<span class="hl_char">(</span>KiUserApcDispatcher<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;генерируется&nbsp;трассировочное&nbsp;исключение<span class="hl_char">.</span>&nbsp;Управление&nbsp;получает&nbsp;диспетчер&nbsp;исключений<span class="hl_char">(</span>KiUserExceptionDispatch</li><li class="hl_l1">&nbsp;er<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Векторные&nbsp;обработчики&nbsp;не&nbsp;вызываются<span class="hl_char">(</span>RtlCallVectoredExceptionHandlers<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Вызывается&nbsp;установленный&nbsp;</li><li class="hl_l0">&nbsp;SEH<span class="hl_char">.</span>&nbsp;Если&nbsp;диспетчер&nbsp;APC&nbsp;захвачен&nbsp;сплайсингом<span class="hl_char">,</span>&nbsp;останов&nbsp;генерируется&nbsp;после&nbsp;исполнения&nbsp;джампа<span class="hl_char">.</span>&nbsp;Если&nbsp;диспетч</li><li class="hl_l1">&nbsp;ер&nbsp;APC&nbsp;перенаправлен&nbsp;на&nbsp;диспетчер&nbsp;исключений<span class="hl_char">,</span>&nbsp;посредством&nbsp;установки&nbsp;точки&nbsp;останова<span class="hl_char">,</span>&nbsp;прежде&nbsp;будет&nbsp;вызван&nbsp;</li><li class="hl_l0">&nbsp;SEH<span class="hl_char">(</span>если&nbsp;хэндлер&nbsp;установлен&nbsp;как&nbsp;VEH<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1">&nbsp;<span class="hl_char">-</span></li>        </ol>
    </div>
</div></div>
<br>Тэги только у меня не робят, тогда как цитировать ?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251383&amp;user=17964&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=18" class="addthx" data-post="251383"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 февраля 2010 08:20 <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#19');return false;">#19</a> </span><div align=left><br>
<I>Valemox пишет:<br> хотел собрать либ и поюзать, но чота не нашлось ntundoc хидера, мож поделишся? </I><br>в аттаче<br><b>Clerk</b><br>ты прав<br><br><br><img src="img/attach.gif" alt=""> <a href="./files/f3ca_11.02.2010_CRACKLAB.rU.tgz">f3ca_11.02.2010_CRACKLAB.rU.tgz</a> - ntundoc.h
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251386&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=19" class="addthx" data-post="251386"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="20" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 февраля 2010 19:36 &middot; Поправил: Clerk <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#20" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#20');return false;">#20</a> </span><div align=left><br>
<b>Coderess</b><br>Значит я не правильно понял, пенгвинчег <img src="img/smilies/s2.gif" alt=""><br>-<br>Трушный хидер(*avrf, [FLG_APPLICATION_VERIFIER, VerifierDlls]):<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_comment">; Application verifier types needed by provider dlls</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">DLL_PROCESS_VERIFIER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">4</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>comment</b></span>&nbsp;'</li><li class="hl_l1">typedef&nbsp;<span class="hl_function"><b>VOID</b></span>&nbsp;<span class="hl_char">(</span>NTAPI&nbsp;<span class="hl_char">*</span>&nbsp;RTL_VERIFIER_DLL_LOAD_CALLBACK<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PWSTR&nbsp;DllName<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;DllBase<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;DllSize<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Reserved</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">typedef&nbsp;<span class="hl_function"><b>VOID</b></span>&nbsp;<span class="hl_char">(</span>NTAPI&nbsp;<span class="hl_char">*</span>&nbsp;RTL_VERIFIER_DLL_UNLOAD_CALLBACK<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PWSTR&nbsp;DllName<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;DllBase<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;DllSize<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Reserved</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">typedef&nbsp;<span class="hl_function"><b>VOID</b></span>&nbsp;<span class="hl_char">(</span>NTAPI&nbsp;<span class="hl_char">*</span>&nbsp;RTL_VERIFIER_NTDLLHEAPFREE_CALLBACK<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;AllocationBase<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;AllocationSize</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;'</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_comment">; AVrfpNtdllThunks</span></li><li class="hl_l0"><span class="hl_comment">; Ноль в конце списка.</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0">RTL_VERIFIER_THUNK_DESCRIPTOR&nbsp;struct</li><li class="hl_l1">ThunkName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; Имя экспорта.</span></li><li class="hl_l0">ThunkOldAddress&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Адрес экспорта.</span></li><li class="hl_l1">ThunkNewAddress&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Адрес обработчика.</span></li><li class="hl_l0">RTL_VERIFIER_THUNK_DESCRIPTOR&nbsp;<span class="hl_function">ends</span></li><li class="hl_l1">PRTL_VERIFIER_THUNK_DESCRIPTOR&nbsp;typedef&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;RTL_VERIFIER_THUNK_DESCRIPTOR</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_comment">; AVrfpExportDlls</span></li><li class="hl_l0"><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_comment">; Ноль в конце списка.</span></li><li class="hl_l0">RTL_VERIFIER_DLL_DESCRIPTOR&nbsp;struct</li><li class="hl_l1">DllName&nbsp;&nbsp;&nbsp;PWCHAR&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">DllFlags&nbsp;ULONG&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">DllAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">DllThunks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRTL_VERIFIER_THUNK_DESCRIPTOR&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Указатель на массив описателей, ptr AVrfpNtdllThunks</span></li><li class="hl_l1">RTL_VERIFIER_DLL_DESCRIPTOR&nbsp;<span class="hl_function">ends</span></li><li class="hl_l0">PRTL_VERIFIER_DLL_DESCRIPTOR&nbsp;typedef&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;RTL_VERIFIER_DLL_DESCRIPTOR</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_comment">; В InitRoutine.Context возвращается эта структура.</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0">RTL_VERIFIER_PROVIDER_DESCRIPTOR&nbsp;struct</li><li class="hl_l1"><span class="hl_comment">; Filled by verifier provider DLL</span></li><li class="hl_l0"><span style="word-break: break-all">_Length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;</span><span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; 0x1C !</span></li><li class="hl_l1"><span style="word-break: break-all">ProviderDlls&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRTL_VERIFIER_DLL_DESCRIPTOR&nbsp;</span><span class="hl_char">?</span></li><li class="hl_l0">ProviderDllLoadCallback&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; RTL_VERIFIER_DLL_LOAD_CALLBACK</span></li><li class="hl_l1">ProviderDllUnloadCallback&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;<span class="hl_comment">; RTL_VERIFIER_DLL_UNLOAD_CALLBACK</span></li><li class="hl_l0"><span class="hl_comment">; Filled by verifier engine</span></li><li class="hl_l1">VerifierImage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PWSTR&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">VerifierFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">VerifierDebug&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;<span class="hl_char">?</span></li><li class="hl_l0"><span class="hl_comment">;RtlpGetStackTraceAddress	PVOID ?</span></li><li class="hl_l1"><span class="hl_comment">;RtlpDebugPageHeapCreate	PVOID ?</span></li><li class="hl_l0"><span class="hl_comment">;RtlpDebugPageHeapDestroy	PVOID ?</span></li><li class="hl_l1"><span class="hl_comment">; Filled by verifier provider DLL</span></li><li class="hl_l0"><span class="hl_comment">;ProviderNtdllHeapFreeCallback	PVOID ?	; RTL_VERIFIER_NTDLLHEAPFREE_CALLBACK</span></li><li class="hl_l1">RTL_VERIFIER_PROVIDER_DESCRIPTOR&nbsp;<span class="hl_function">ends</span></li><li class="hl_l0">PRTL_VERIFIER_PROVIDER_DESCRIPTOR&nbsp;typedef&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;RTL_VERIFIER_PROVIDER_DESCRIPTOR</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_comment">; Private.</span></li><li class="hl_l1"><span class="hl_comment">; -&gt; [ntdll!AVrfpVerifierProvidersList]</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">PROVIDER_ENTRY&nbsp;struct</li><li class="hl_l0">Link&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&gt;</span></li><li class="hl_l1">DllName&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&gt;</span></li><li class="hl_l0">DllBase&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">EntryPoint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">ExportDlls&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRTL_VERIFIER_DLL_DESCRIPTOR&nbsp;<span class="hl_char">?</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Указатель на массив описателей, ptr AVrfpExportDlls</span></li><li class="hl_l1">Undef1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DD</b></span>&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">Undef2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DD</b></span>&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">PROVIDER_ENTRY&nbsp;<span class="hl_function">ends</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_comment">; Application verifier standard flags</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_FULL_PAGE_HEAP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000001H</span></li><li class="hl_l0">RTL_VRF_FLG_RESERVED_DONOTUSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000002H</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; old RTL_VRF_FLG_LOCK_CHECKS</span></li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_HANDLE_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000004H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_STACK_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000008H</span></li><li class="hl_l1">RTL_VRF_FLG_APPCOMPAT_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000010H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_TLS_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000020H</span></li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_DIRTY_STACKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000040H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_RPC_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000080H</span></li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_COM_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000100H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_DANGEROUS_APIS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000200H</span></li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_RACE_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000400H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_DEADLOCK_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00000800H</span></li><li class="hl_l1">RTL_VRF_FLG_FIRST_CHANCE_EXCEPTION_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00001000H</span></li><li class="hl_l0">RTL_VRF_FLG_VIRTUAL_MEM_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00002000H</span></li><li class="hl_l1"><span style="word-break: break-all">RTL_VRF_FLG_ENABLE_LOGGING&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00004000H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_FAST_FILL_HEAP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00008000H</span></li><li class="hl_l1">RTL_VRF_FLG_VIRTUAL_SPACE_TRACKING&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00010000H</span></li><li class="hl_l0">RTL_VRF_FLG_ENABLED_SYSTEM_WIDE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00020000H</span></li><li class="hl_l1">RTL_VRF_FLG_MISCELLANEOUS_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00020000H</span></li><li class="hl_l0"><span style="word-break: break-all">RTL_VRF_FLG_LOCK_CHECKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">00040000H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_comment">; Application verifier standard stop codes</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">APPLICATION_VERIFIER_INTERNAL_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">80000000H</span></li><li class="hl_l1">APPLICATION_VERIFIER_INTERNAL_WARNING&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">40000000H</span></li><li class="hl_l0"><span style="word-break: break-all">APPLICATION_VERIFIER_NO_BREAK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">20000000H</span></li><li class="hl_l1">APPLICATION_VERIFIER_CONTINUABLE_BREAK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">10000000H</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">APPLICATION_VERIFIER_UNKNOWN_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0001H</span></li><li class="hl_l0"><span style="word-break: break-all">APPLICATION_VERIFIER_ACCESS_VIOLATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0002H</span></li><li class="hl_l1">APPLICATION_VERIFIER_UNSYNCHRONIZED_ACCESS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0003H</span></li><li class="hl_l0">APPLICATION_VERIFIER_EXTREME_SIZE_REQUEST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0004H</span></li><li class="hl_l1"><span style="word-break: break-all">APPLICATION_VERIFIER_BAD_HEAP_HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0005H</span></li><li class="hl_l0">APPLICATION_VERIFIER_SWITCHED_HEAP_HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0006H</span></li><li class="hl_l1"><span style="word-break: break-all">APPLICATION_VERIFIER_DOUBLE_FREE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0007H</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0008H</span></li><li class="hl_l1">APPLICATION_VERIFIER_DESTROY_PROCESS_HEAP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0009H</span></li><li class="hl_l0">APPLICATION_VERIFIER_UNEXPECTED_EXCEPTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000AH</span></li><li class="hl_l1">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_EXCEPTION_RAISED_FOR_HEADER&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000BH</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_EXCEPTION_RAISED_FOR_PROBING&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000CH</span></li><li class="hl_l1">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_HEADER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000DH</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_FREED_HEAP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000EH</span></li><li class="hl_l1">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_SUFFIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">000FH</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_START_STAMP&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0010H</span></li><li class="hl_l1">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_END_STAMP&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0011H</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_HEAP_BLOCK_PREFIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0012H</span></li><li class="hl_l1">APPLICATION_VERIFIER_FIRST_CHANCE_ACCESS_VIOLATION&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0013H</span></li><li class="hl_l0">APPLICATION_VERIFIER_CORRUPTED_HEAP_LIST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0014H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">APPLICATION_VERIFIER_TERMINATE_THREAD_CALL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0100H</span></li><li class="hl_l1">APPLICATION_VERIFIER_STACK_OVERFLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0101H</span></li><li class="hl_l0">APPLICATION_VERIFIER_INVALID_EXIT_PROCESS_CALL&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0102H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">APPLICATION_VERIFIER_EXIT_THREAD_OWNS_LOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0200H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_IN_UNLOADED_DLL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0201H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_IN_FREED_HEAP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0202H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_DOUBLE_INITIALIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0203H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_IN_FREED_MEMORY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0204H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_CORRUPTED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0205H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_INVALID_OWNER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0206H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_INVALID_RECURSION_COUNT&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0207H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_INVALID_LOCK_COUNT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0208H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_OVER_RELEASED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0209H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_NOT_INITIALIZED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0210H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_ALREADY_INITIALIZED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0211H</span></li><li class="hl_l0">APPLICATION_VERIFIER_LOCK_IN_FREED_VMEM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0212H</span></li><li class="hl_l1">APPLICATION_VERIFIER_LOCK_IN_UNMAPPED_MEM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0213H</span></li><li class="hl_l0">APPLICATION_VERIFIER_THREAD_NOT_LOCK_OWNER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0214H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">APPLICATION_VERIFIER_INVALID_HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0300H</span></li><li class="hl_l1">APPLICATION_VERIFIER_INVALID_TLS_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0301H</span></li><li class="hl_l0">APPLICATION_VERIFIER_INCORRECT_WAIT_CALL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0302H</span></li><li class="hl_l1"><span style="word-break: break-all">APPLICATION_VERIFIER_NULL_HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0303H</span></li><li class="hl_l0">APPLICATION_VERIFIER_WAIT_IN_DLLMAIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0304H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">APPLICATION_VERIFIER_COM_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0400H</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_API_IN_DLLMAIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0401H</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_UNHANDLED_EXCEPTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0402H</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_UNBALANCED_COINIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0403H</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_UNBALANCED_OLEINIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0404H</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_UNBALANCED_SWC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0405H</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_NULL_DACL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0406H</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_UNSAFE_IMPERSONATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0407H</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_SMUGGLED_WRAPPER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0408H</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_SMUGGLED_PROXY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0409H</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_CF_SUCCESS_WITH_NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040AH</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_GCO_SUCCESS_WITH_NULL&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040BH</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_OBJECT_IN_FREED_MEMORY&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040CH</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_OBJECT_IN_UNLOADED_DLL&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040DH</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_VTBL_IN_FREED_MEMORY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040EH</span></li><li class="hl_l1">APPLICATION_VERIFIER_COM_VTBL_IN_UNLOADED_DLL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">040FH</span></li><li class="hl_l0">APPLICATION_VERIFIER_COM_HOLDING_LOCKS_ON_CALL&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0410H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">APPLICATION_VERIFIER_RPC_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0500H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">APPLICATION_VERIFIER_INVALID_FREEMEM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0600H</span></li><li class="hl_l1">APPLICATION_VERIFIER_INVALID_ALLOCMEM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0601H</span></li><li class="hl_l0">APPLICATION_VERIFIER_INVALID_MAPVIEW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0602H</span></li><li class="hl_l1">APPLICATION_VERIFIER_PROBE_INVALID_ADDRESS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0603H</span></li><li class="hl_l0">APPLICATION_VERIFIER_PROBE_FREE_MEM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0604H</span></li><li class="hl_l1">APPLICATION_VERIFIER_PROBE_GUARD_PAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0605H</span></li><li class="hl_l0"><span style="word-break: break-all">APPLICATION_VERIFIER_PROBE_NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0606H</span></li><li class="hl_l1">APPLICATION_VERIFIER_PROBE_INVALID_START_OR_SIZE&nbsp;&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0607H</span></li><li class="hl_l0">APPLICATION_VERIFIER_SIZE_HEAP_UNEXPECTED_EXCEPTION&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0618H</span></li>        </ol>
    </div>
</div></div>
<br><b>HiEndsoft</b><br>&gt; колес надо меньше жрать. Я -то по пивку.<br>Сложно понять вас <img src="img/smilies/s13.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251443&amp;user=17964&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=20" class="addthx" data-post="251443"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="21" onfocus="this.blur()" href="JavaScript:di('[b]Vol4ok[/b]','')">Vol4ok</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.1 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.61'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=18950">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 февраля 2010 02:33 <br><script type="text/javascript">QU('Vol4ok','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vol4ok" target="_blank">Личное сообщение</a> &middot;  <a href="#21" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#21');return false;">#21</a> </span><div align=left><br>
Установка, запуск, остановка и удаление драйвера.<br>Код полностью не тестил, возможны мелкие баги.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#include&nbsp;<span class="hl_char">&lt;</span>windows<span class="hl_char">.</span>h<span class="hl_char">&gt;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">SC_HANDLE&nbsp;install_driver<span class="hl_char">(</span><span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>name<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>path<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;h_scm<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;h_svc&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>path&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span>&nbsp;<span class="hl_char">!</span>name<span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;INVALID_HANDLE_VALUE</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_scm&nbsp;<span class="hl_char">=</span>&nbsp;OpenSCManager<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;SC_MANAGER_ALL_ACCESS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>h_scm<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_svc&nbsp;<span class="hl_char">=</span>&nbsp;CreateServiceW<span class="hl_char">(</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_scm</span><span class="hl_char">,</span>name<span class="hl_char">,</span>name<span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS</span><span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_KERNEL_DRIVER</span><span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_DEMAND_START</span><span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ERROR_IGNORE</span><span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>h_svc<span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_svc&nbsp;</span><span class="hl_char">=</span>&nbsp;OpenServiceW<span class="hl_char">(</span>h_scm<span class="hl_char">,</span>&nbsp;name<span class="hl_char">,</span>&nbsp;SERVICE_ALL_ACCESS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle<span class="hl_char">(</span>h_scm<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;h_svc<span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">SC_HANDLE&nbsp;open_driver<span class="hl_char">(</span><span class="hl_function"><b>const</b></span>&nbsp;wchar_t&nbsp;<span class="hl_char">*</span>name<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;h_scm<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SC_HANDLE&nbsp;h_svc&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>name<span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;INVALID_HANDLE_VALUE</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_scm&nbsp;<span class="hl_char">=</span>&nbsp;OpenSCManagerW<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;SC_MANAGER_ALL_ACCESS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>h_scm<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_svc&nbsp;<span class="hl_char">=</span>&nbsp;OpenServiceW<span class="hl_char">(</span>h_scm<span class="hl_char">,</span>&nbsp;name<span class="hl_char">,</span>&nbsp;SERVICE_ALL_ACCESS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle<span class="hl_char">(</span>h_scm<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;h_svc<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>DWORD</b></span>&nbsp;query_status<span class="hl_char">(</span>SC_HANDLE&nbsp;h_svc<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS_PROCESS&nbsp;ssp<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;bytes<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssp<span class="hl_char">.</span>dwCurrentState&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueryServiceStatusEx<span class="hl_char">(</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_svc<span class="hl_char">,</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SC_STATUS_PROCESS_INFO<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">(</span>LPBYTE<span class="hl_char">)</span><span class="hl_char">&amp;</span>ssp<span class="hl_char">,</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>SERVICE_STATUS_PROCESS<span class="hl_char">)</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">&amp;</span>bytes<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ssp<span class="hl_char">.</span>dwCurrentState<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>int</b></span>&nbsp;start_driver<span class="hl_char">(</span>SC_HANDLE&nbsp;h_svc<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>h_svc<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;query_status<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>status&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;SERVICE_RUNNING<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;StartServiceW<span class="hl_char">(</span>h_svc<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>int</b></span>&nbsp;stop_driver<span class="hl_char">(</span>SC_HANDLE&nbsp;h_svc<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_STATUS&nbsp;&nbsp;&nbsp;svc_status<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>h_svc<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;query_status<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>status&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;SERVICE_STOPPED<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ControlService<span class="hl_char">(</span>h_svc<span class="hl_char">,</span>&nbsp;SERVICE_CONTROL_STOP<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>svc_status<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>int</b></span>&nbsp;uninstall_driver<span class="hl_char">(</span>SC_HANDLE&nbsp;h_svc<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;query_status<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>status&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;SERVICE_RUNNING&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span>&nbsp;status&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;SERVICE_PAUSED<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop_driver<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;<span class="hl_char">=</span>&nbsp;DeleteService<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseServiceHandle<span class="hl_char">(</span>h_svc<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;status<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251621&amp;user=18950&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=21" class="addthx" data-post="251621"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="22" onfocus="this.blur()" href="JavaScript:di('[b]SLV[/b]','')">SLV</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 309.8 (мудрец), 21thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.69'>Активность: 0.17<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=663">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 февраля 2010 02:50 <br><script type="text/javascript">QU('SLV','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SLV" target="_blank">Личное сообщение</a> &middot;  <a href="#22" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#22');return false;">#22</a> </span><div align=left><br>
Макросы для памяти <img src="img/smilies/s1.gif" alt=""><br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#define&nbsp;malloc<span class="hl_char">(</span>Size<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span>Size&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_char">(</span>RtlAllocateHeap<span class="hl_char">(</span>GetProcessHeap<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;HEAP_ZERO_MEMORY<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span>SIZE_T<span class="hl_char">)</span><span class="hl_char">(</span>Size<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l1">#define&nbsp;realloc<span class="hl_char">(</span>Mem<span class="hl_char">,</span>&nbsp;Size<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span>Size&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_char">(</span>Mem&nbsp;<span class="hl_char">?</span>&nbsp;RtlReAllocateHeap<span class="hl_char">(</span>GetProcessHeap<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;HEAP_ZERO_MEMORY<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span>PVOID<span class="hl_char">)</span><span class="hl_char">(</span>Mem<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;Size<span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;malloc<span class="hl_char">(</span>Size<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li><li class="hl_l0">#define&nbsp;free<span class="hl_char">(</span>Mem<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span>Mem&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_char">(</span>RtlValidateHeap<span class="hl_char">(</span>GetProcessHeap<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;Mem<span class="hl_char">)</span>&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_char">(</span>RtlFreeHeap<span class="hl_char">(</span>GetProcessHeap<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span>PVOID<span class="hl_char">)</span><span class="hl_char">(</span>Mem<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;Mem&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>Shalom ebanats!</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=251623&amp;user=663&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=22" class="addthx" data-post="251623"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="23" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 февраля 2010 03:02 &middot; Поправил: Clerk <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#23" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#23');return false;">#23</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Редирект&nbsp;ApfnDispatch<span class="hl_char">(</span>KernelCallbackTable<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_comment">; ApfnDispatch:</span></li><li class="hl_l1"><span class="hl_comment">;	  ...</span></li><li class="hl_l0"><span class="hl_comment">;	@Fn1	; (N)</span></li><li class="hl_l1"><span class="hl_comment">;	@Fn2	; (N + 1)</span></li><li class="hl_l0"><span class="hl_comment">;	  ...</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_comment">; [(N), P]:</span></li><li class="hl_l1"><span class="hl_comment">; 	push @Fn1	; x5</span></li><li class="hl_l0"><span class="hl_comment">; 	jmp Stub	; x5</span></li><li class="hl_l1"><span class="hl_comment">; [(N + 1), P + 10]:</span></li><li class="hl_l0"><span class="hl_comment">; 	push @Fn2</span></li><li class="hl_l1"><span class="hl_comment">; 	jmp Stub</span></li><li class="hl_l0"><span class="hl_comment">;	  ...</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_comment">; Stub:</span></li><li class="hl_l1"><span class="hl_comment">;	  ...</span></li><li class="hl_l0"><span class="hl_comment">;	  ret</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">IMAGE_MASK&nbsp;<span class="hl_function"><b>equ</b></span>&nbsp;<span class="hl_number">0FF000000H</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>assume</b></span>&nbsp;<span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_function"><b>nothing</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l1">ApfnQuery&nbsp;<span class="hl_function"><b>proc</b></span>&nbsp;<span class="hl_function"><b>uses</b></span>&nbsp;<span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_registr"><b>esi</b></span>&nbsp;<span class="hl_registr"><b>edi</b></span>&nbsp;ApfnBase<span class="hl_char">:</span>PVOID<span class="hl_char">,</span>&nbsp;ApfnSize<span class="hl_char">:</span>PULONG</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span>TEB<span class="hl_char">.</span>Peb<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>ApfnBase</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>PEB<span class="hl_char">.</span>KernelCallbackTable<span class="hl_char">[</span><span class="hl_registr">ebx</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>STATUS_UNSUCCESSFUL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jz</b></span>&nbsp;Exit</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">cld</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>IMAGE_MASK</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">esi</span></li><li class="hl_l1">@@<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">lodsd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>IMAGE_MASK</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>je</b></span>&nbsp;@b</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_registr"><b>edi</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Размер таблицы в байтах.</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>STATUS_UNSUCCESSFUL</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>ApfnSize</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jz</b></span>&nbsp;Exit</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">esi</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l1">Exit<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">ApfnQuery&nbsp;<span class="hl_function">endp</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">APFN_INFORMATION&nbsp;struct</li><li class="hl_l0">OldApfnBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">ApfnBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">OldApfnSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;<span class="hl_char">?</span></li><li class="hl_l1">ApfnSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; ..Page</span></li><li class="hl_l0">APFN_INFORMATION&nbsp;<span class="hl_function">ends</span></li><li class="hl_l1">PAPFN_INFORMATION&nbsp;typedef&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;APFN_INFORMATION</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">ApfnRedirect&nbsp;<span class="hl_function"><b>proc</b></span>&nbsp;<span class="hl_function"><b>uses</b></span>&nbsp;<span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_registr"><b>esi</b></span>&nbsp;<span class="hl_registr"><b>edi</b></span>&nbsp;Stub<span class="hl_char">:</span>PVOID<span class="hl_char">,</span>&nbsp;ApfnInformation<span class="hl_char">:</span>PAPFN_INFORMATION</li><li class="hl_l0"><span class="hl_function"><b>Local</b></span>&nbsp;Apfn<span class="hl_char">:</span>APFN_INFORMATION</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>invoke</b></span>&nbsp;ApfnQuery<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>addr</b></span>&nbsp;Apfn<span class="hl_char">.</span>OldApfnBase<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>addr</b></span>&nbsp;Apfn<span class="hl_char">.</span>OldApfnSize</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>OldApfnSize</li><li class="hl_l0"><span class="hl_comment">;  s = n + n*2 + n/2</span></li><li class="hl_l1"><span class="hl_comment">;  s = (n/2)*7</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jnz</b></span>&nbsp;Exit</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>shr</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;Apfn<span class="hl_char">.</span>ApfnBase<span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">ecx</span><span class="hl_char">*</span><span class="hl_number">8</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;PAGE_EXECUTE_READWRITE</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>ApfnSize</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;MEM_COMMIT</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>ApfnBase</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;Apfn<span class="hl_char">.</span>ApfnSize<span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_number">0</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;NtCurrentProcess</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>Call</b></span>&nbsp;ZwAllocateVirtualMemory</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>OldApfnSize</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jnz</b></span>&nbsp;Exit</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>ApfnBase</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>Stub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Disp.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>OldApfnBase</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">cld</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>shr</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_number">2</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">*</span><span class="hl_number">5</span></li><li class="hl_l1">@@<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">lodsd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>byte</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">68H</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Push fnXX</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>byte</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">5</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">0E9H</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Jmp Stub</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">6</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_number">10</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_number">10</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>loop</b></span>&nbsp;@b</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span>TEB<span class="hl_char">.</span>Peb<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>Apfn<span class="hl_char">.</span>ApfnBase</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span>Apfn</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>ApfnInformation</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lock</b></span>&nbsp;<span class="hl_function"><b>xchg</b></span>&nbsp;PEB<span class="hl_char">.</span>KernelCallbackTable<span class="hl_char">[</span><span class="hl_registr">ecx</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l0">Exit<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">ApfnRedirect&nbsp;<span class="hl_function">endp</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">.</span><span class="hl_function">data</span></li><li class="hl_l1">CallbackCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;<span class="hl_char">?</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">.</span><span class="hl_function">code</span></li><li class="hl_l0">ApfnStub&nbsp;<span class="hl_function"><b>proc</b></span>&nbsp;C</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>inc</b></span>&nbsp;CallbackCount</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">ApfnStub&nbsp;<span class="hl_function">endp</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>Local</b></span>&nbsp;ApfnInformation<span class="hl_char">:</span>APFN_INFORMATION</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>invoke</b></span>&nbsp;ApfnRedirect<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>addr</b></span>&nbsp;ApfnStub<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>addr</b></span>&nbsp;ApfnInformation</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li>        </ol>
    </div>
</div></div>
<br><noindex><a href="http://indy-vx.narod.ru/log.txt" rel="nofollow" target="_blank">http://indy-vx.narod.ru/log.txt</a></noindex>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=251625&amp;user=17964&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=23" class="addthx" data-post="251625"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="24" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 марта 2010 10:08 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#24" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#24');return false;">#24</a> </span><div align=left><br>
Т.к. пишу в основном в нативе, пригождаются след коды.<br>Натив -аналог SleepEx и Sleep:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;WINAPI&nbsp;NtSleepEx<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;DurationMs<span class="hl_char">,</span>BOOL&nbsp;Alertable<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;Low<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;Hi<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;MLI<span class="hl_char">=</span>{{<span class="hl_char">-</span><span class="hl_number">10000</span><span class="hl_char">*</span>DurationMs}<span class="hl_char">,</span>{0xFFFFFFFF}}<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtDelayExecution<span class="hl_char">(</span>Alertable<span class="hl_char">,</span><span class="hl_char">(</span>PLARGE_INTEGER<span class="hl_char">)</span><span class="hl_char">&amp;</span>MLI<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">#define&nbsp;NtSleep<span class="hl_char">(</span>_x<span class="hl_char">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtSleepEx<span class="hl_char">(</span>_x<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br>Натив -аналог Beep:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;WINAPI&nbsp;NtBeep&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;dwFreq<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;dwDuration<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hBeep<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;BeepDevice<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_ATTRIBUTES&nbsp;ObjectAttributes<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IO_STATUS_BLOCK&nbsp;IoStatusBlock<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">&gt;</span><span class="hl_char">=</span>&nbsp;0x25&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwFreq&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">=</span>&nbsp;0x7FFF<span class="hl_char">)</span>&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;0x0&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwDuration&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;0x0<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>Buffer<span class="hl_char">=</span><span class="hl_quote">L&quot;\Device\Beep&quot;</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>Length<span class="hl_char">=</span><span class="hl_number">24</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeepDevice<span class="hl_char">.</span>MaximumLength<span class="hl_char">=</span><span class="hl_number">26</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeObjectAttributes<span class="hl_char">(</span><span class="hl_char">&amp;</span>ObjectAttributes<span class="hl_char">,</span><span class="hl_char">&amp;</span>BeepDevice<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function"><b>NULL</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>NtCreateFile<span class="hl_char">(</span><span class="hl_char">&amp;</span>hBeep<span class="hl_char">,</span>FILE_READ_DATA&nbsp;<span class="hl_char">|</span>&nbsp;FILE_WRITE_DATA<span class="hl_char">,</span><span class="hl_char">&amp;</span>ObjectAttributes<span class="hl_char">,</span><span class="hl_char">&amp;</span>IoStatusBlock<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>FILE_SHARE_REA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;<span class="hl_char">|</span>&nbsp;FILE_SHARE_WRITE<span class="hl_char">,</span>FILE_OPEN_IF<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Frequency</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Duration</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEEP_SET_PARAMETERS</span><span class="hl_char">=</span>{{dwFreq}<span class="hl_char">,</span>{dwDuration}}<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>NtDeviceIoControlFile<span class="hl_char">(</span>hBeep<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_char">&amp;</span>IoStatusBlock<span class="hl_char">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x10000<span class="hl_char">,</span><span class="hl_char">&amp;</span>BEEP_SET_PARAMETERS<span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>BEEP_SET_PARAMETERS<span class="hl_char">)</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>dwFreq&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;0x0&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span>&nbsp;dwDuration&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;0x0<span class="hl_char">)</span>&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;dwDuration&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_number">1</span><span class="hl_char">)</span>&nbsp;NtSleepEx<span class="hl_char">(</span>dwDuration<span class="hl_char">,</span><span class="hl_function">TRUE</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtClose</span><span class="hl_char">(</span>hBeep<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span class="hl_function"><b>else</b></span>&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>И до кучи аналог MessageBox ч/з csrss(где ico - как и у MessageBox):<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">inline&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;PrintError<span class="hl_char">(</span>PCWSTR&nbsp;ws_caption<span class="hl_char">,</span>PCWSTR&nbsp;ws_description<span class="hl_char">,</span>ULONG&nbsp;ico<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;us_caption<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;us_description<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HARDERROR_RESPONSE&nbsp;he_resp<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlInitUnicodeString<span class="hl_char">(</span><span class="hl_char">&amp;</span>us_error_caption<span class="hl_char">,</span>ws_caption<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlInitUnicodeString<span class="hl_char">(</span><span class="hl_char">&amp;</span>us_error<span class="hl_char">,</span>ws_description<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;args<span class="hl_char">[</span><span class="hl_char">]</span><span class="hl_char">=</span>{<span class="hl_char">(</span>ULONG<span class="hl_char">)</span><span class="hl_char">&amp;</span>us_description<span class="hl_char">,</span><span class="hl_char">(</span>ULONG<span class="hl_char">)</span><span class="hl_char">&amp;</span>us_caption<span class="hl_char">,</span>MB_OK&nbsp;<span class="hl_char">|</span>&nbsp;MB_SETFOREGROUND&nbsp;<span class="hl_char">|</span>&nbsp;ico}<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtRaiseHardError<span class="hl_char">(</span>0x50000018<span class="hl_char">,</span><span class="hl_number">3</span><span class="hl_char">,</span><span class="hl_char">(</span>PUNICODE_STRING<span class="hl_char">)</span><span class="hl_number">3</span><span class="hl_char">,</span><span class="hl_char">(</span>PVOID&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>args<span class="hl_char">,</span>OptionOk<span class="hl_char">,</span><span class="hl_char">&amp;</span>he_resp<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>Здесь только вида &quot;OK&quot;,но можно переделать под OK/Cancel и т.п.<br><br>Вывод отладочного сообщения с форматированием, например в Dbgview (не натив, позаимствовано у мелкософта):<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#ifdef&nbsp;DBG</li><li class="hl_l1"><span class="hl_function"><b>void</b></span>&nbsp;</li><li class="hl_l0">dbgprint<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_function">format</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;pid<span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;va_list&nbsp;vl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;&nbsp;&nbsp;&nbsp;dbgbuf1<span class="hl_char">[</span><span class="hl_number">2048</span><span class="hl_char">]</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbgbuf2<span class="hl_char">[</span><span class="hl_number">2048</span><span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Prepend&nbsp;the&nbsp;process&nbsp;ID&nbsp;to&nbsp;the&nbsp;message</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>&nbsp;<span class="hl_number">0</span>&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;pid&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pid&nbsp;<span class="hl_char">=</span>&nbsp;GetCurrentProcessId<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;EnterCriticalSection<span class="hl_char">(</span><span class="hl_char">&amp;</span>gDebugCritSec<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;va_start<span class="hl_char">(</span>vl<span class="hl_char">,</span>&nbsp;<span class="hl_function">format</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;_vsnprintf<span class="hl_char">(</span>dbgbuf1<span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>dbgbuf1<span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_number">1</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">format</span><span class="hl_char">,</span>&nbsp;vl<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;sprintf<span class="hl_char">(</span>dbgbuf2<span class="hl_char">,</span>&nbsp;<span class="hl_quote">&quot;%lu: %s\r\n&quot;</span><span class="hl_char">,</span>&nbsp;pid<span class="hl_char">,</span>&nbsp;dbgbuf1<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;va_end<span class="hl_char">(</span>vl<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString<span class="hl_char">(</span>dbgbuf2<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;LeaveCriticalSection<span class="hl_char">(</span><span class="hl_char">&amp;</span>gDebugCritSec<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">#endif</li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=253957&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=24" class="addthx" data-post="253957"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="25" onfocus="this.blur()" href="JavaScript:di('[b]SLV[/b]','')">SLV</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 309.8 (мудрец), 21thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.69'>Активность: 0.17<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=663">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 марта 2010 10:22 &middot; Поправил: SLV <br><script type="text/javascript">QU('SLV','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SLV" target="_blank">Личное сообщение</a> &middot;  <a href="#25" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#25');return false;">#25</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL</li><li class="hl_l1">IsThreadActive<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;ULONG&nbsp;ThreadId</li><li class="hl_l1"><span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hThread</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THREAD_BASIC_INFORMATION&nbsp;&nbsp;ThreadInfo<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Temp</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Result&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">=</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hThread&nbsp;<span class="hl_char">=</span>&nbsp;OpenThread<span class="hl_char">(</span>THREAD_QUERY_INFORMATION<span class="hl_char">,</span>&nbsp;<span class="hl_function">FALSE</span><span class="hl_char">,</span>&nbsp;ThreadId<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>hThread<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status&nbsp;<span class="hl_char">=</span>&nbsp;ZwQueryInformationThread<span class="hl_char">(</span>hThread<span class="hl_char">,</span>&nbsp;ThreadBasicInformation<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>ThreadInfo<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>THREAD_BASIC_INFORMATION<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>Temp<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>Status<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Result&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ThreadInfo<span class="hl_char">.</span>ExitStatus&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;STATUS_PENDING<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>hThread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Result<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>Shalom ebanats!</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=253959&amp;user=663&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=25" class="addthx" data-post="253959"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="26" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 марта 2010 18:42 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#26" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#26');return false;">#26</a> </span><div align=left><br>
Выделение по-возможности непрерывного участка памяти в куче (натив)<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">RTL_HEAP_DEFINITION&nbsp;&nbsp;heapParams<span class="hl_comment">;</span></li><li class="hl_l1">memset<span class="hl_char">(</span>&nbsp;<span class="hl_char">&amp;</span>heapParams<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>&nbsp;RTL_HEAP_DEFINITION&nbsp;<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">heapParams<span class="hl_char">.</span>Length&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>&nbsp;RTL_HEAP_DEFINITION&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">ULONG&nbsp;Sz<span class="hl_char">=</span>0x4000<span class="hl_comment">; //Максимально гарантированный непрерывный участок</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_char">(</span>размер&nbsp;минимального&nbsp;фрагмента<span class="hl_char">)</span></li><li class="hl_l1">HANDLE&nbsp;h_heap&nbsp;<span class="hl_char">=</span>&nbsp;RtlCreateHeap<span class="hl_char">(</span>HEAP_ZERO_MEMORY<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>Sz<span class="hl_char">*</span><span class="hl_number">2</span><span class="hl_char">,</span>Sz<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>heapParams&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function">if</span><span class="hl_char">(</span>h_heap<span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_function">NULL</span><span class="hl_char">)</span>&nbsp;{dbgprint<span class="hl_char">(</span><span class="hl_quote">&quot;Error RtlCreateHeap&quot;</span><span class="hl_char">)</span><span class="hl_comment">;}</span></li><li class="hl_l1">ULONG&nbsp;nofrag<span class="hl_char">=</span><span class="hl_number">2</span><span class="hl_comment">; //указывает, что нужно выделять нефрагментированную область</span></li><li class="hl_l0">RtlSetHeapInformation<span class="hl_char">(</span>h_heap<span class="hl_char">,</span>HeapCompatibilityInformation<span class="hl_char">,</span><span class="hl_char">&amp;</span>nofrag<span class="hl_char">,</span>size&nbsp;&nbsp;&nbsp;of<span class="hl_char">(</span>ULONG<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=254000&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=26" class="addthx" data-post="254000"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="27" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 марта 2010 20:45 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#27" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#27');return false;">#27</a> </span><div align=left><br>
<I>HiEndsoft пишет:<br>Выделение по-возможности непрерывного участка памяти в куче (натив) </I><br>Вообще-то любое выделение из кучи всегда возвращает непрерывный участок виртуальной памяти. Иначе и быть не может, т.к. мы получаем 1 указатель.<br>Приведенный тобой код включает использование Low-fragmentation Heap аллокатора, что имеет совсем другой смысл.
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=254006&amp;user=12867&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=27" class="addthx" data-post="254006"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="28" onfocus="this.blur()" href="JavaScript:di('[b]Rockphorr[/b]','')">Rockphorr</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 62.8 (постоянный), 11thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.71'>Активность: 0.06<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=22848">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 марта 2010 22:47 &middot; Поправил: Rockphorr <br><script type="text/javascript">QU('Rockphorr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Rockphorr" target="_blank">Личное сообщение</a> &middot;  <a href="#28" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#28');return false;">#28</a> </span><div align=left><br>
у меня предложение собирать все выложенное в инклуд файл и поставить сыль на него в первом посте <br>имхо для версии 1.0 собрано уже достаточно<br><br>все что выложено выше <br>Clerk<br><br>Ранг: 140.2 (ветеран)<br>Статус: Участник<br><br>	Создано: 10 февраля 2010 18:48:00<br>Цитата Личное сообщение #10<br><br>multiarc<br>&gt; так же желательно сделать все вызовы нативными, для возможности инжекта так же в графическую подсистему csrss!<br>Нэйтив юзается изза следующих причин:<br>o Самодостаточный код(вызов непосредственно через шлюзы).<br>o Если не достаточно функционала более высокоуровневого кода.<br>csrss это обычный гуи-процесс.<br>&gt; получает адрес процедуры в нужной библиотеке в чужом процессе<br>Для этого есть системные апи, например RtlQueryProcessDebugInformation(). <br><br>скопипастил в атач<br><br>зы: копипаститься неахти - то номера то решетки вылезают<br><br><img src="img/attach.gif" alt=""> <a href="./files/adc3_20.03.2010_CRACKLAB.rU.tgz">adc3_20.03.2010_CRACKLAB.rU.tgz</a> - codekit.c.txt
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=254015&amp;user=22848&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=28" class="addthx" data-post="254015"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="29" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 16 марта 2010 11:00 &middot; Поправил: HiEndsoft <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#29" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#29');return false;">#29</a> </span><div align=left><br>
<b>ntldr</b> Извечная тема для споров.<br><b>Rockphorr</b> к модераторам обратись, идея не плохая.<br>Обнаружение изменения в составе устройств на самом высоком уровне (в оконном обработчике очереди сообщений) (здесь - добавление устройства, например вставка флешки):<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">LRESULT&nbsp;CALLBACK&nbsp;WinProc<span class="hl_char">(</span>HWND&nbsp;hwnd<span class="hl_char">,</span>UINT&nbsp;uMsg<span class="hl_char">,</span>&nbsp;WPARAM&nbsp;wParam<span class="hl_char">,</span>&nbsp;LPARAM&nbsp;lParam<span class="hl_char">)</span></li><li class="hl_l1">{&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Произошло&nbsp;изменение&nbsp;в&nbsp;составе&nbsp;устройств</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">if</span><span class="hl_char">(</span>uMsg<span class="hl_char">=</span><span class="hl_char">=</span>WM_DEVICECHANGE<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;{&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Флешка&nbsp;вставлена</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>wParam<span class="hl_char">=</span><span class="hl_char">=</span>DBT_DEVICEARRIVAL<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Проверка&nbsp;на&nbsp;накопитель</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_char">(</span>DEV_BROADCAST_HDR<span class="hl_char">*</span><span class="hl_char">)</span>lParam<span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>dbch_devicetype<span class="hl_char">=</span><span class="hl_char">=</span>DBT_DEVTYP_VOLUME<span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_char">(</span>DEV_BROADCAST_VOLUME<span class="hl_char">*</span><span class="hl_char">)</span>lParam<span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>dbcv_flags<span class="hl_char">!</span><span class="hl_char">=</span>DBTF_MEDIA&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>DEV_BROADCAST_VOLUME<span class="hl_char">*</span><span class="hl_char">)</span>lParam<span class="hl_char">)</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>dbcv_flags<span class="hl_char">!</span><span class="hl_char">=</span>DBTF_NET<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Извлечение&nbsp;имени</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;DriveName<span class="hl_char">[</span><span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">=</span><span class="hl_quote">{'?'</span><span class="hl_char">,</span><span class="hl_quote">':'</span><span class="hl_char">,</span><span class="hl_quote">''</span><span class="hl_char">,</span><span class="hl_quote">'\0'</span>}<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DriveName<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">=</span>FirstDriveFromMask<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_char">(</span>DEV_BROADCAST_VOLUME<span class="hl_char">*</span><span class="hl_char">)</span>lParam<span class="hl_char">)</span><span class="hl_char">-</span>&nbsp;<span class="hl_char">&gt;</span>dbcv_unitmask<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>GetDriveType<span class="hl_char">(</span>DriveName<span class="hl_char">)</span><span class="hl_char">=</span><span class="hl_char">=</span><span class="hl_number">2</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DriveName<span class="hl_char">[</span><span class="hl_number">2</span><span class="hl_char">]</span><span class="hl_char">=</span><span class="hl_quote">'\0'</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>Наши&nbsp;действия<span class="hl_char">,</span>&nbsp;например&nbsp;копирование</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CreateThread<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>LPTHREAD_START_ROUTINE<span class="hl_char">)</span>COPY<span class="hl_char">,</span><span class="hl_char">(</span>LPVOID<span class="hl_char">)</span>DriveNa&nbsp;me<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;return&nbsp;CallWindowProcA<span class="hl_char">(</span><span class="hl_char">(</span>WNDPROC<span class="hl_char">)</span>ResultSWL<span class="hl_char">,</span>hwnd<span class="hl_char">,</span>&nbsp;uMsg<span class="hl_char">,</span>&nbsp;wParam<span class="hl_char">,</span>&nbsp;lParam<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div><br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=254052&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=29" class="addthx" data-post="254052"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="30" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 17 марта 2010 10:19 <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#30" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=15780&amp;page=0#30');return false;">#30</a> </span><div align=left><br>
Native-код, создающий на FAT - FAT32 томе &quot;неудаляемую&quot; папку.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">bool&nbsp;MkNoremoveDir<span class="hl_char">(</span>LPWSTR&nbsp;lpDirPathName<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;NameU<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;DirectoryHandle<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IO_STATUS_BLOCK&nbsp;ioSB<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;flag<span class="hl_char">=</span><span class="hl_function"><b>false</b></span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_ATTRIBUTES&nbsp;ObjAttr</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlInitUnicodeString<span class="hl_char">(</span><span class="hl_char">&amp;</span>NameU<span class="hl_char">,</span>lpDirPathName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlDosPathNameToNtPathName_U<span class="hl_char">(</span>lpDirPathName<span class="hl_char">,</span><span class="hl_char">&amp;</span>NameU<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">_R<span class="hl_char">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeObjectAttributes<span class="hl_char">(</span><span class="hl_char">&amp;</span>ObjAttr<span class="hl_char">,</span><span class="hl_char">&amp;</span>NameU<span class="hl_char">,</span>OBJ_CASE_INSENSITIVE<span class="hl_char">,</span>NU&nbsp;LL<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">if</span><span class="hl_char">(</span>NT_SUCCESS<span class="hl_char">(</span>NtCreateFile&nbsp;<span class="hl_char">(</span><span class="hl_char">&amp;</span>DirectoryHandle<span class="hl_char">,</span>FILE_LIST_DIRECTORY&nbsp;<span class="hl_char">|</span>&nbsp;SYNCHRONIZE&nbsp;<span class="hl_char">|</span>&nbsp;FILE_OPEN_FOR_BACKUP_INTENT<span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">&amp;</span>ObjAttr<span class="hl_char">,</span><span class="hl_char">&amp;</span>ioSB<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span>FILE_ATTRIBUTE_SYSTEM&nbsp;<span class="hl_char">|</span>&nbsp;FILE_ATTRIBUTE_HIDDEN&nbsp;<span class="hl_char">|</span>&nbsp;FILE_ATTRIBUTE_READONLY<span class="hl_char">,</span>FILE_SHARE_READ<span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_CREATE</span><span class="hl_char">,</span>FILE_DIRECTORY_FILE&nbsp;<span class="hl_char">|</span>&nbsp;FILE_SYNCHRONOUS_IO_NONALERT<span class="hl_char">,</span><span class="hl_function">NULL</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NtClose</span><span class="hl_char">(</span>DirectoryHandle<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>flag<span class="hl_char">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{NtBeep<span class="hl_char">(</span><span class="hl_number">9000</span><span class="hl_char">,</span><span class="hl_number">500</span><span class="hl_char">)</span><span class="hl_comment">;return flag;}</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag</span><span class="hl_char">=</span><span class="hl_function"><b>true</b></span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcscat</span><span class="hl_char">(</span>NameU<span class="hl_char">.</span>Buffer<span class="hl_char">,</span><span class="hl_quote">L&quot;\..\&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NameU</span><span class="hl_char">.</span>Length<span class="hl_char">+</span><span class="hl_char">=</span><span class="hl_number">4</span><span class="hl_char">*</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>WCHAR<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;_R</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;flag<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>В аттаче консольная прожка - создает &quot;неудаляемую&quot; папку &quot;autorun.inf&quot; на указанном FAT- диске (может быть полезно для защиты от автозагрузки флешек) .<br><br><br><img src="img/attach.gif" alt=""> <a href="./files/f507_17.03.2010_CRACKLAB.rU.tgz">f507_17.03.2010_CRACKLAB.rU.tgz</a> - NODIR.zip
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=254125&amp;user=13651&amp;forum_n=6&amp;topic=15780&amp;page=0&amp;anchor=30" class="addthx" data-post="254125"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b> .  <b>1</b> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=1.html">2</a> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=2.html">3</a> . <a href="action=vthread&amp;forum=6&amp;topic=15780&amp;page=1.html">&gt;&gt;</a></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Небольшие полезные коды</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#31" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="15780">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=15780" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
