<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Запуск/останов службы Windows - Assembler - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Приветствую всезнающий all. Изучаю один екзешник), взял из него код создания службы, но не могу запустить ее. Она ничего не делает. Просто хочется ее запустить и остановить. Она не стартует. Вычитал, что в структуре">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=40382'>jinoweb</a>, <a target='_blank' href='?action=userinfo&amp;user=26261'>bartolomeo</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Запуск/останов службы Windows - Assembler</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]interst71[/b]','')">interst71</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 3.29'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=42324">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 апреля 2017 16:54 <br><script type="text/javascript">QU('interst71','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=interst71" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24677.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Приветствую всезнающий all. <br>Изучаю один екзешник), взял из него код создания службы, но не могу запустить ее. Она ничего не делает. Просто хочется ее запустить и остановить. Она не стартует. <br>Вычитал, что в структуре SERVICE_TABLE_ENTRY нужно последние два элемента добить нулями, поэтому в windows.inc добавил так:<br><br>SERVICE_TABLE_ENTRYW STRUCT<br><br>lpServiceName DWORD ?<br>lpServiceProc DWORD ?<br>v1 DWORD 0<br>v2 DWORD 0<br>SERVICE_TABLE_ENTRYW ENDS<br><br>Помогите, знающие люди.<br><br>.model flat, stdcall<br>option casemap :none<br>include \masm32\include\windows.inc<br>include \masm32\include\user32.inc<br>include \masm32\include\kernel32.inc<br>include \masm32\include\advapi32.inc<br> <br>includelib \masm32\lib\user32.lib<br>includelib \masm32\lib\kernel32.lib<br>includelib \masm32\lib\advapi32.lib<br> <br>ServiceControlHandler   PROTO :DWORD<br>ServiceMain PROTO :DWORD, :DWORD<br> <br> <br>.data<br> <br> <br>sTable  SERVICE_TABLE_ENTRY  &lt; 0, 0,0,0&gt;<br> <br>ServStat        SERVICE_STATUS      &lt;&gt;<br>sName     BYTE          &quot;TestService&quot;,0<br>hServStat       Dd 0<br>schSCManager    dd   0<br>szFileName      db    &#039;C:\my pro\servises\222.exe&#039;,0<br>hService dd 0<br>stopServiceEvent DWORD 0<br>t1 db &quot;start&quot;,0<br>t2 db &quot;service main&quot;,0<br>displayName db &quot;TestService&quot;,0<br> <br> <br>.code<br>start:<br> <br>  ;  invoke MessageBox, 0, offset t1,offset t1,MB_OK<br> <br> <br>  mov  sTable.lpServiceProc, offset ServiceMain<br>  mov sTable.lpServiceName, offset sName<br>  mov sTable.v1, 0<br>  mov sTable.v2, 0<br> <br>  INVOKE StartServiceCtrlDispatcher, offset sTable<br>  <br>  invoke OpenSCManagerA,NULL,NULL,SC_MANAGER_ALL_ACCESS<br>  test eax,eax<br>  jz exit1<br>  <br>  mov [schSCManager],eax<br>  <br>  invoke CreateServiceA,[schSCManager],offset sName,offset displayName, SERVICE_ALL_ACCESS,SERVICE_WIN32_OWN_PROCESS,SERVICE_AUTO_START,SERVICE_ERROR_NORMAL, offset szFileName,NULL,NULL,NULL,NULL,NULL<br>   mov hService, eax<br> <br>    <br>    test eax,eax<br>    jnz next1<br> <br>    ;Invoke GetLastError<br> <br>    mov edi, 0f01ffh<br>    Invoke OpenService, [schSCManager],offset sName, edi<br> <br>    invoke StartService, eax, NULL, NULL <br>    jmp exit1<br> <br>next1:<br>   invoke StartService, hService, NULL, NULL<br>   invoke CloseServiceHandle, hService<br>  <br>exit1:<br>invoke ExitProcess, NULL<br> <br> <br>ServiceMain proc argc:DWORD, argv:DWORD<br>    <br>    <br>    invoke RegisterServiceCtrlHandler, addr sName,addr ServiceControlHandler<br>    mov hServStat,eax<br>    <br>    mov ServStat.dwServiceType,SERVICE_WIN32_SHARE_PROCESS<br>    mov ServStat.dwControlsAccepted,0<br>    mov ServStat.dwWin32ExitCode,NO_ERROR<br>    mov ServStat.dwServiceSpecificExitCode,NO_ERROR<br>    mov ServStat.dwCheckPoint,0<br>    mov ServStat.dwWaitHint,0<br>    mov ServStat.dwCurrentState,SERVICE_START_PENDING<br>  <br>    invoke SetServiceStatus, hServStat,addr ServStat<br> <br>      mov ServStat.dwCurrentState,SERVICE_RUNNING<br>  <br>    invoke SetServiceStatus,hServStat,addr ServStat<br> <br>;invoke MessageBox, 0, offset t2,offset t2,MB_OK<br>    <br>invoke ExitProcess, NULL<br> <br>ServiceMain endp<br> <br>ServiceControlHandler proc controlcode:DWORD<br>  .IF controlcode==SERVICE_CONTROL_INTERROGATE<br>    jmp next<br>.ELSEIF controlcode==SERVICE_CONTROL_SHUTDOWN || controlcode==SERVICE_CONTROL_STOP<br>    mov ServStat.dwCurrentState,SERVICE_STOP_PENDING<br>    invoke SetServiceStatus,addr hServStat,addr ServStat<br>    invoke SetEvent,addr stopServiceEvent<br>    ret<br>.ELSEIF controlcode==SERVICE_CONTROL_PAUSE<br>    jmp next<br>.ELSEIF controlcode==SERVICE_CONTROL_CONTINUE<br>    jmp next<br>.ENDIF<br> <br>next:<br>invoke SetServiceStatus,hServStat,addr ServStat<br>ret<br> <br>ServiceControlHandler endp<br>end start
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=374066&amp;user=42324&amp;forum_n=6&amp;topic=24677.html&amp;page=0&amp;anchor=1" class="addthx" data-post="374066"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 апреля 2017 17:07 &middot; Поправил: -=AkaBOSS=- <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24677.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<I>interst71 пишет:<br>Она не стартует </I><br>убери нафиг вызов ExitProcess из ServiceMain, будет стартовать)<br><br><I>interst71 пишет:<br>Вычитал, что в структуре SERVICE_TABLE_ENTRY нужно последние два элемента добить нулями </I><br>не совсем правильно.<br>Просто StartServiceCtrlDispatcher принимает адрес не одной структуры, а массива структур SERVICE_TABLE_ENTRY, и конец этого массива определяется по структуре, у которой оба поля забиты нулями.<br><br><I>invoke SetEvent,addr stopServiceEvent</I><br>пытаешься триггерить событие, которое не создал (хэндла нет)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=374068&amp;user=26242&amp;forum_n=6&amp;topic=24677.html&amp;page=0&amp;anchor=2" class="addthx" data-post="374068"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Запуск/останов службы Windows - Assembler</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#3" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="24677">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=24677" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
