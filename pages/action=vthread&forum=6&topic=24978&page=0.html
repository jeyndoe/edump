<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Сериализация вывода Pre-Jit в .NET сбоках с управляемым кодом - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Интересно как работает эта штука. Когда часть методов преобразуется в нативный код и помещается в .NET сборку. Потенциально это может сделать программу более быстрой, если часть ее кода будет заранее скомпилирована. Где бы нарыть">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=40382'>jinoweb</a> (+6 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Сериализация вывода Pre-Jit в .NET сбоках с управляемым кодом</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]jangle[/b]','')">jangle</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/5081.jpg" alt=""><br><span class=txtSm>Ранг: 71.9 (постоянный), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.1'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5081">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 10:22 <br><script type="text/javascript">QU('jangle','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=jangle" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Интересно как работает эта штука. Когда часть методов преобразуется в нативный код и помещается в .NET сборку. Потенциально это может сделать программу более быстрой, если часть ее кода будет заранее скомпилирована. Где бы нарыть доки и примеры использования?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380746&amp;user=5081&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=1" class="addthx" data-post="380746"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]plutos[/b]','')">plutos</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/4773.png" alt=""><br><span class=txtSm>Ранг: 622.6 (<b>!</b>), 521thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.16'>Активность: 0.33<span style='color:green'>&nearr;</span>0.89</span><br>Статус: <a href="action=userinfo&amp;user=4773">Участник</a><br><font color=blue>_Вечный_Студент_</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 10:35 <br><script type="text/javascript">QU('plutos','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=plutos" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Посмотри здесь:http://community.bartdesmet.net/blogs/bart/archive/2005/09/01/3512.aspx
<br><br><font size="1"><i>-----<br>Give me a HANDLE and I will move the Earth.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=380747&amp;user=4773&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=2" class="addthx" data-post="380747"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]jangle[/b]','')">jangle</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/5081.jpg" alt=""><br><span class=txtSm>Ранг: 71.9 (постоянный), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.1'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5081">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 10:50 <br><script type="text/javascript">QU('jangle','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=jangle" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I>plutos пишет:<br>Посмотри здесь </I><br><br>Это описание работы Ngen. А мне интересно, как можно реализовать такую программу:<br>Допустим есть сборка на управляемом коде. Я загружаю ее в утилитку, которая показывает мне список методов в сборке, я отмечаю галками нужные мне, и утилита компилирует их в нативный код, и помещает скомпилированный нативный код в эту же самую сборку. В результате получается, что часть методов в сборке на управляемом коде, а часть на неуправляемом.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380750&amp;user=5081&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=3" class="addthx" data-post="380750"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]Gideon Vi[/b]','')">Gideon Vi</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/2585.jpg" alt=""><br><span class=txtSm>Ранг: 1131.7 <b><u>(!!!!)</u></b>, 447thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.83'>Активность: 0.67<span style='color:red'>&searr;</span>0.2</span><br>Статус: <a href="action=userinfo&amp;user=2585">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:14 &middot; Поправил: Gideon Vi <br><script type="text/javascript">QU('Gideon Vi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Gideon Vi" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Бегло пробежался, вроде оно <noindex><a href="https://www.codeproject.com/Articles/31316/Pre-compile-pre-JIT-your-assembly-on-the-fly-or-tr" rel="nofollow" target="_blank">--&gt; Link &lt;--</a></noindex><br>Это если автоматом. Делать компиляцию и вручную вставлять/вызывать... ну, такое.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380751&amp;user=2585&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=4" class="addthx" data-post="380751"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]jangle[/b]','')">jangle</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/5081.jpg" alt=""><br><span class=txtSm>Ранг: 71.9 (постоянный), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.1'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5081">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:31 &middot; Поправил: jangle <br><script type="text/javascript">QU('jangle','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=jangle" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>Gideon Vi пишет:<br>вроде оно </I><br><br>Нет, там JIT компиляция при старте приложения. А я хочу от нее вообще избавится. По нескольким причинам.<br>JIT-компиляция отнимает время при &quot;холодном старте&quot;, JIT-компилятор плохо оптимизирует код, JIT-не использует многие SSE инструкции и т.п. <br><br>Чтобы можно было взять какой-то метод (допустим считающий FFT на непрерывно идущем потоке звуковых данных) . Получить его IL код из сборки, оттранслировать его в x86 ассемблерные инструкции (используя IL2CPU или подобный компилятор), и встроить полученный бинарник x86 обратно в управляемую сборку. И чтобы JIT больше не заходил в этот метод.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380753&amp;user=5081&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=5" class="addthx" data-post="380753"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Gideon Vi[/b]','')">Gideon Vi</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/2585.jpg" alt=""><br><span class=txtSm>Ранг: 1131.7 <b><u>(!!!!)</u></b>, 447thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.83'>Активность: 0.67<span style='color:red'>&searr;</span>0.2</span><br>Статус: <a href="action=userinfo&amp;user=2585">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:42 <br><script type="text/javascript">QU('Gideon Vi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Gideon Vi" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
поправьте, если не прав, .net не поддерживает asm-вставки.<br><br><I>jangle пишет:<br>встроить полученный бинарник x86 </I><br><br>полученный чем?<br>Я правильно понимаю, ты хочешь декомпилировать отдельные функции на .net, скомпилировать их и вставить обратно? Но если в итоге у тебя есть нативный код (ведь ты же собираешься компилировать декомпилированную функцию?), зачем его обратно корячить в .net? Декомпиляй тогда и остальные функции и компилируй все в native.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380755&amp;user=2585&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=6" class="addthx" data-post="380755"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]jangle[/b]','')">jangle</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/5081.jpg" alt=""><br><span class=txtSm>Ранг: 71.9 (постоянный), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.1'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5081">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:45 &middot; Поправил: jangle <br><script type="text/javascript">QU('jangle','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=jangle" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>Gideon Vi пишет:<br>полученный чем? </I><br><br>Компилятор типа IL2CPU <br><br><I>Я правильно понимаю, ты хочешь декомпилировать отдельные функции на .net, скомпилировать их и вставить обратно?<br></I><br><br>да<br><br><I>Декомпиляй тогда и остальные функции и компилируй все в native. </I><br>К сожалению вроде нет полноценных компиляторов IL в native, которые могут скомпилировать всю сборку.<br><br><b>Добавлено спустя 4 минуты</b><br><I>Gideon Vi пишет:<br>поправьте, если не прав, .net не поддерживает asm-вставки. </I><br><br>В книге  Голдштейн С., Зурбалев Д., Флатов. &quot;Оптимизация приложений на платформе .NET.&quot; есть вот такое описание:<br><br><br>Простейший способ выполнить произвольный машинный код в управляемом приложении (с применением легковесной программной прослойки) заключается в том, чтобы динамически сгенерировать машинный код и затем вызвать его. Ключевым здесь является метод Marshal.GetDelegateForFunctionPointer, ВОЗВращаЮЩИЙ управляемого делегата, указывающего на местоположение в неуправляемой памяти, где может храниться произвольный код. Следующий пример выделяет виртуальную память с флагом защиты execute_readwrite, позволяющим скопировать байты кода в память и затем выполнить их. Как результат, на процессоре Intel i7-860 скорость <b>выполнения увеличивается более чем в два раза!</b>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380756&amp;user=5081&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=7" class="addthx" data-post="380756"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Gideon Vi[/b]','')">Gideon Vi</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/2585.jpg" alt=""><br><span class=txtSm>Ранг: 1131.7 <b><u>(!!!!)</u></b>, 447thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.83'>Активность: 0.67<span style='color:red'>&searr;</span>0.2</span><br>Статус: <a href="action=userinfo&amp;user=2585">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:53 <br><script type="text/javascript">QU('Gideon Vi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Gideon Vi" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<I>jangle пишет:<br>Следующий пример </I><br><br>так а пример? Я такого ещё не встречал.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380758&amp;user=2585&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=8" class="addthx" data-post="380758"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]jangle[/b]','')">jangle</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/5081.jpg" alt=""><br><span class=txtSm>Ранг: 71.9 (постоянный), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.1'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5081">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 декабря 2017 11:57 &middot; Поправил: jangle <br><script type="text/javascript">QU('jangle','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=jangle" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24978.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<I>Gideon Vi пишет:<br>так а пример? </I><br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">[</span>UnmanagedFunctionPointer<span class="hl_char">(</span>CallingConvention<span class="hl_char">.</span><span class="hl_function">StdCall</span><span class="hl_char">)</span><span class="hl_char">]</span>&nbsp;delegate&nbsp;<span class="hl_function"><b>void</b></span>&nbsp;VectorAddDelegate&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>float</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;С<span class="hl_char">,</span>&nbsp;floatU&nbsp;B<span class="hl_char">,</span>&nbsp;<span class="hl_function">float</span><span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;A<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;length<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_char">[</span>Dlllmport<span class="hl_char">(</span><span class="hl_quote">&quot;kernel32.dll&quot;</span><span class="hl_char">,</span>&nbsp;SetLastError&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">true</span><span class="hl_char">)</span><span class="hl_char">]</span>&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;VirtualAlloc<span class="hl_char">(</span>IntPtr&nbsp;IpAddress<span class="hl_char">,</span>&nbsp;UIntPtr&nbsp;dwSize<span class="hl_char">,</span>&nbsp;IntPtr&nbsp;flAllocationType<span class="hl_char">,</span>&nbsp;IntPtr&nbsp;flProtect<span class="hl_char">)</span>&nbsp;<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Следующий&nbsp;массив&nbsp;байтов&nbsp;был&nbsp;получен&nbsp;с&nbsp;помощью&nbsp;ассемблера&nbsp;</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;с&nbsp;поддержкой&nbsp;SSE&nbsp;<span class="hl_char">-</span>&nbsp;это&nbsp;законченная&nbsp;функция<span class="hl_char">,</span>&nbsp;принимающая&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;четыре&nbsp;параметра&nbsp;<span class="hl_char">(</span>три&nbsp;вектора&nbsp;и&nbsp;длину<span class="hl_char">)</span>&nbsp;и&nbsp;складывающая&nbsp;их&nbsp;</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function">byte</span><span class="hl_char">[</span><span class="hl_char">]</span>&nbsp;sseAssemblyBytes&nbsp;<span class="hl_char">=</span>&nbsp;{</li><li class="hl_l0">&nbsp;0x8b<span class="hl_char">,</span>&nbsp;0x5с<span class="hl_char">,</span>&nbsp;0x24<span class="hl_char">,</span>&nbsp;0x10<span class="hl_char">,</span>&nbsp;0x8b<span class="hl_char">,</span>&nbsp;0x74<span class="hl_char">,</span>&nbsp;0x24<span class="hl_char">,</span>&nbsp;0x0c<span class="hl_char">,</span>&nbsp;0x8b<span class="hl_char">,</span>&nbsp;0x7с<span class="hl_char">,</span>&nbsp;0x24<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;0x08<span class="hl_char">,</span>&nbsp;0x8b<span class="hl_char">,</span>&nbsp;0x4с<span class="hl_char">,</span>&nbsp;0x24<span class="hl_char">,</span>&nbsp;0x04<span class="hl_char">,</span>&nbsp;0x31<span class="hl_char">,</span>&nbsp;0xd2<span class="hl_char">,</span>&nbsp;0x0f<span class="hl_char">,</span>&nbsp;0x10<span class="hl_char">,</span>&nbsp;0x0c<span class="hl_char">,</span>&nbsp;0x97<span class="hl_char">,</span>&nbsp;</li><li class="hl_l0">&nbsp;OxOf<span class="hl_char">,</span>&nbsp;0x10<span class="hl_char">,</span>&nbsp;0x04<span class="hl_char">,</span>&nbsp;0x96<span class="hl_char">,</span>&nbsp;OxOf<span class="hl_char">,</span>&nbsp;0x58<span class="hl_char">,</span>&nbsp;0xc8<span class="hl_char">,</span>&nbsp;OxOf<span class="hl_char">,</span>&nbsp;0x11<span class="hl_char">,</span>&nbsp;0x0c<span class="hl_char">,</span>&nbsp;0x91<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;0x83<span class="hl_char">,</span>&nbsp;0xc2<span class="hl_char">,</span>&nbsp;0x04<span class="hl_char">,</span>&nbsp;0x39<span class="hl_char">,</span>&nbsp;Oxda<span class="hl_char">,</span>&nbsp;0x7f<span class="hl_char">,</span>&nbsp;Oxea<span class="hl_char">,</span>&nbsp;0xc2<span class="hl_char">,</span>&nbsp;0x10<span class="hl_char">,</span>&nbsp;0x00&nbsp;}<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">IntPtr&nbsp;codeBuffer&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAlloc<span class="hl_char">(</span>IntPtr<span class="hl_char">.</span>Zero<span class="hl_char">,</span><span class="hl_function"><b>new</b></span>&nbsp;UIntPtr<span class="hl_char">(</span><span class="hl_char">(</span>uint<span class="hl_char">)</span>sseAssemblyBytes<span class="hl_char">.</span>Length<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;0x1000&nbsp;<span class="hl_char">|</span>&nbsp;0x2000<span class="hl_char">,</span>&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;MEM_COMMIT&nbsp;<span class="hl_char">|</span>&nbsp;MEM_RESERVE&nbsp;0x40&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;EXECUTE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;Marshal<span class="hl_char">.</span>Copy<span class="hl_char">(</span>sseAssemblyBytes<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;codeBuffer<span class="hl_char">,</span>&nbsp;sseAssemblyBytes<span class="hl_char">.</span>Length<span class="hl_char">)</span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;VectorAddDelegate&nbsp;addVectors&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>VectorAddDelegate<span class="hl_char">)</span>Marshal<span class="hl_char">.</span>GetDelegateForFunctionPointer<span class="hl_char">(</span>codeBuffer<span class="hl_char">,</span>&nbsp;typeof<span class="hl_char">(</span>VectorAddDelegate<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Теперь&nbsp;для&nbsp;сложения&nbsp;векторов&nbsp;можно&nbsp;использовать&nbsp;<span class="hl_quote">'addVectors'</span><span class="hl_char">!</span></li>        </ol>
    </div>
</div></div>
<br><br><b>Добавлено спустя 38 минут</b><br>Собственно вопрос как встроить неуправляемый код в управляемую сборку.<br><br>Допустим у меня в проекте есть такой класс:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>public</b></span>&nbsp;static&nbsp;class&nbsp;Adder</li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>public</b></span>&nbsp;static&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;AddTwoNumbers<span class="hl_char">(</span><span class="hl_function"><b>int</b></span>&nbsp;first<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;second<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;first&nbsp;<span class="hl_char">+</span>&nbsp;second<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br>В скомпилированной сборке мой класс становится вот таким<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">.</span>method&nbsp;<span class="hl_function"><b>public</b></span>&nbsp;hidebysig&nbsp;static&nbsp;int32&nbsp;&nbsp;AddTwoNumbers<span class="hl_char">(</span>int32&nbsp;first<span class="hl_char">,</span>&nbsp;int32&nbsp;second<span class="hl_char">)</span>&nbsp;cil&nbsp;managed</li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;<span class="hl_function"><b>Code</b></span>&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">9</span>&nbsp;<span class="hl_char">(</span>0x9<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_char">.</span>maxstack&nbsp;&nbsp;<span class="hl_number">2</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_char">.</span>locals&nbsp;init&nbsp;<span class="hl_char">(</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;int32&nbsp;<span class="hl_registr">CS</span><span class="hl_char">$</span><span class="hl_number">1</span><span class="hl_char">$</span><span class="hl_number">0000</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;IL_0000<span class="hl_char">:</span>&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;IL_0001<span class="hl_char">:</span>&nbsp;&nbsp;ldarg<span class="hl_char">.</span><span class="hl_number">0</span></li><li class="hl_l1">&nbsp;&nbsp;IL_0002<span class="hl_char">:</span>&nbsp;&nbsp;ldarg<span class="hl_char">.</span><span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;IL_0003<span class="hl_char">:</span>&nbsp;&nbsp;<span class="hl_function">add</span></li><li class="hl_l1">&nbsp;&nbsp;IL_0004<span class="hl_char">:</span>&nbsp;&nbsp;stloc<span class="hl_char">.</span><span class="hl_number">0</span></li><li class="hl_l0">&nbsp;&nbsp;IL_0005<span class="hl_char">:</span>&nbsp;&nbsp;br<span class="hl_char">.</span>s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IL_0007</li><li class="hl_l1">&nbsp;&nbsp;IL_0007<span class="hl_char">:</span>&nbsp;&nbsp;ldloc<span class="hl_char">.</span><span class="hl_number">0</span></li><li class="hl_l0">&nbsp;&nbsp;IL_0008<span class="hl_char">:</span>&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">}&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;<span class="hl_function"><b>end</b></span>&nbsp;of&nbsp;method&nbsp;Adder<span class="hl_char">:</span><span class="hl_char">:</span>AddTwoNumbers</li>        </ol>
    </div>
</div></div>
<br><br><br>У меня уже заготовлен байтовый массив, где находятся ассемблерные инструкции x86 для сложения двух чисел. Как мне теперь пропатчить готовую сборку<br>и вставить в нее нативный код, чтобы она не утратила работоспособность?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=380759&amp;user=5081&amp;forum_n=6&amp;topic=24978.html&amp;page=0&amp;anchor=9" class="addthx" data-post="380759"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Сериализация вывода Pre-Jit в .NET сбоках с управляемым кодом</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#10" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="24978">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=24978" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
