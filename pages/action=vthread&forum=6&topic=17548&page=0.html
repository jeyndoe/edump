<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>SEH. - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Здрасте. Записываем мы свой сех в системный модуль, например в ntdll. Он вызван не будет. В чём причины и как это обойти ?">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=1288'>UniSoft</a>, <a target='_blank' href='?action=userinfo&amp;user=26261'>bartolomeo</a> (+6 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> SEH.</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 00:30 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Здрасте.<br>Записываем мы свой сех в системный модуль, например в ntdll. Он вызван не будет. В чём причины и как это обойти ?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274001&amp;user=17964&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=1" class="addthx" data-post="274001"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]mak[/b]','')">mak</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3520.jpg" alt=""><br><span class=txtSm>Ранг: 673.3 <font color=magenta>(<b>! !</b>)</font>, 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.48'>Активность: 0.4<span style='color:red'>&searr;</span>0.31</span><br>Статус: <a href="action=userinfo&amp;user=3520">Участник</a><br><font color=blue>CyberMonk</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 02:24 <br><script type="text/javascript">QU('mak','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=mak" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<img src="img/smilies/s1.gif" alt=""> Темы у тебя интересные , но ты их так быстро закрываешь , не у всех так много времени чтобы посмотреть , прошлую тему взял закрыл. Писал бы подробнее , без системного слэнга , читать трудно иногда , хотя код полезный когда вникнешь что ты имел ввиду) <br><br>Что значит записываешь свой сех , на примере той же нтдлл , до финал екзепшн ты же все равно вернешься в нтдлл , нельзя ли это дело перехватить? <br><br>На какой винде ты это делаешь? Может тому виной SEHOP ? Для чего ты ставишь СЕХ? Если можешь , прикладывай с кодом рабочий пример , так удобнее для тех к кому ты обращаешься <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>RE In Progress [!] Coding Hazard [!] Stay Clear of this Cube</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274004&amp;user=3520&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=2" class="addthx" data-post="274004"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 05:02 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<b>mak</b><br>Допустим записываем мы свой сех в кодосекцию, либо вобще определяем как сех любой адрес в этом модуле, который не является системным сех(там нэйтив тоже несколько хэндлеров использует). Такой сех вызван никогда не будет. Вот интересно как это поломать ?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274010&amp;user=17964&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=3" class="addthx" data-post="274010"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]ant_man[/b]','')">ant_man</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.7 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.58'>Активность: 0.01=0.01</span><br>Статус: <a href="action=userinfo&amp;user=921">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 05:32 <br><script type="text/javascript">QU('ant_man','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ant_man" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
структуры EXCEPTION_REGISTRATION должны лежать в своем стеке с выравниванием на DWORD и по-порядку.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274013&amp;user=921&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=4" class="addthx" data-post="274013"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 07:35 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<b>ant_man</b><br>Всё валидно, только адрес сех находится в пределах ntdll.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274017&amp;user=17964&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=5" class="addthx" data-post="274017"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ant_man[/b]','')">ant_man</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.7 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.58'>Активность: 0.01=0.01</span><br>Статус: <a href="action=userinfo&amp;user=921">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 10:23 &middot; Поправил: ant_man <br><script type="text/javascript">QU('ant_man','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ant_man" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
значит SafeSEH<br><br>IMAGE_LOAD_CONFIG_DIRECTORY32_2.SEHandlerTable[SEHandlerCount]
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274021&amp;user=921&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=6" class="addthx" data-post="274021"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=17964" title="03-01-2011 15:17, ранг:204.6" target="_blank">Clerk</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]mak[/b]','')">mak</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3520.jpg" alt=""><br><span class=txtSm>Ранг: 673.3 <font color=magenta>(<b>! !</b>)</font>, 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.48'>Активность: 0.4<span style='color:red'>&searr;</span>0.31</span><br>Статус: <a href="action=userinfo&amp;user=3520">Участник</a><br><font color=blue>CyberMonk</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 14:26 <br><script type="text/javascript">QU('mak','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=mak" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
Тема есть ... <b>Manual Mapping and SEH Handler Validation (aka SafeSEH)</b><br><br>I&#039;m currently in the process of writing a manual mapper and have hit an interesting problem... I noticed that when trying to use exception handling in my manually mapped module the handler would never get called and the process would be terminated. After a bit of scanning through the PE file format I noticed the section on load configuration data and then it became clear the problem was SafeSEH.<br><br>For anyone who does not know what SafeSEH is:<br>msdn.microsoft.com/en-us/library/9a89h429(VS.80).aspx<br>uninformed.org/index.cgi?v=9&amp;a=4&amp;p=7<br><br>Please note that this is different to SEHOP, described here:<br>blogs.technet.com/srd/archive/2009/02/02/preventing-the-exploitation-of-seh-overwrites-with-sehop.aspx<br><br>The problem is that SEH does not work in my manually mapped modules because it fails the checks performed by the exception dispatcher (see Ntdll.RtlIsValidHandler for more information).<br><br>To give you an idea of what&#039;s happening, here&#039;s the pseudocode from the Blackhat 2008 paper &#039;How to Impress Girls with Browser Memory Protection Bypasses&#039;:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;RtlIsValidHandler<span class="hl_char">(</span>handler<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">{&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>handler&nbsp;is&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;an&nbsp;image<span class="hl_char">)</span>&nbsp;{&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>image&nbsp;has&nbsp;the&nbsp;IMAGE_DLLCHARACTERISTICS_NO_SEH&nbsp;flag&nbsp;set<span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>image&nbsp;has&nbsp;a&nbsp;SafeSEH&nbsp;table<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>handler&nbsp;found&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;the&nbsp;table<span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>image&nbsp;is&nbsp;a&nbsp;<span class="hl_char">.</span>NET&nbsp;assembly&nbsp;with&nbsp;the&nbsp;ILonly&nbsp;flag&nbsp;set<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;fall&nbsp;through&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>handler&nbsp;is&nbsp;on&nbsp;a&nbsp;non<span class="hl_char">-</span><span class="hl_function"><b>executable</b></span>&nbsp;page<span class="hl_char">)</span>&nbsp;{&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ExecuteDispatchEnable&nbsp;bit&nbsp;set&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;the&nbsp;process&nbsp;flags<span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ACCESS_VIOLATION<span class="hl_comment">; // enforce DEP even if we have no hardware NX </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>handler&nbsp;is&nbsp;<span class="hl_function"><b>not</b></span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;an&nbsp;image<span class="hl_char">)</span>&nbsp;{&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ImageDispatchEnable&nbsp;bit&nbsp;set&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;the&nbsp;process&nbsp;flags<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;           // don't allow handlers outside of images </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;everything&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;is&nbsp;allowed&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">; </span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br><br>Obviously manually mapped modules will fail the first check, as the handler is not inside an &#039;image&#039; as far as Windows is concerned (from memory it checks to see if the region the handler resides in is marked as MEM_IMAGE), and even if it was, we still wouldn&#039;t be in the relevant list (ntdll.LdrpInvertedFunctionTable) so it doesn&#039;t matter anyway.<br><br>The second check fails because the manually mapped module&#039;s code is marked as executable (obviously). Besides, even if that first check did succeed, the second would fail and an access violation would be raised because ExecuteDispatchEnable is disabled.<br><br>The third check succeeds at first (because the handler is not in an image), but then fails because the ImageDispatchEnable flag is not set.<br><br>So, whilst brainstorming for solutions to this problem with a friend (thanks Greyman!) we came up with a few solutions:<br>Try to enable the ImageDispatchEnable flag. This failed however as every time I tried to set it I got a STATUS_INVALID_PARAMETER error. I dove into the implementation of ntoskrnl.NtSetInformationProcess and found that the responsible function seems to be ntoskrnl.MmSetExecuteOptions. At first glance it seems that you cannot enable or disable that particular flag from usermode. Unless of course I just plain fucked something up when calling it, which is also possible, but unlikely.<br>Hook NtQueryInformationSystem and &#039;lie&#039; to ntdll.RtlIsValidHandler by simply returning the ImageDispatchEnable flag as always set. I have not yet tested this solution but I assume it should work, however I want to avoid it as it&#039;s quite invasive and defeats the purpose of manually mapping to begin with.<br>Implement your own exception dispatcher via VEH. Vectored exception handlers are called before structured exception handlers, so it should/would be possible to register a VEH and perform the necessary dispatching for the manually mapped module. This solution is imo the best one I know of so far, however from both a reliability and performance standpoint I can see it being a potential issue. Plus, it would be an asshole to do the initial implementation (very tedious).<br><br>Does anyone know of any better solutions? So far number 3 seems to be the best, but I&#039;m still hanging out for a better solution...<br><br>Any ideas/suggestsions/etc would be appreciated. Thanks.<br><br><b>Источник</b> www.gamedeception.net/threads/19650-Manual-Mapping-and-SEH-Handler-Validation-(aka-SafeSEH)?p=132697#post132697
<br><br><font size="1"><i>-----<br>RE In Progress [!] Coding Hazard [!] Stay Clear of this Cube</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274036&amp;user=3520&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=7" class="addthx" data-post="274036"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Vamit[/b]','')">Vamit</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/20406.jpg" alt=""><br><span class=txtSm>Ранг: 331.1 (мудрец), 561thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.3'>Активность: 0.19<span style='color:red'>&searr;</span>0.06</span><br>Статус: <a href="action=userinfo&amp;user=20406">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 15:10 <br><script type="text/javascript">QU('Vamit','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vamit" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
Моя проблемка похоже попадает под описанный случай. Имеем следующий код:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>DWORD</b></span>&nbsp;DivLong<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;v1<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;v2<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;v3<span class="hl_char">,</span>&nbsp;<span class="hl_function">DWORD</span><span class="hl_char">&amp;</span>&nbsp;val1<span class="hl_char">,</span>&nbsp;<span class="hl_function">DWORD</span><span class="hl_char">&amp;</span>&nbsp;val2<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;res<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;<span class="hl_function"><b>div</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__try</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;vl1<span class="hl_char">,</span>&nbsp;vl2<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_asm</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>&nbsp;v1</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;v2</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;v3</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>div</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl1<span class="hl_char">,</span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl2<span class="hl_char">,</span>&nbsp;<span class="hl_registr">edx</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">pushfd</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val1&nbsp;<span class="hl_char">=</span>&nbsp;vl1<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val2&nbsp;<span class="hl_char">=</span>&nbsp;vl2<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__except<span class="hl_char">(</span>VmException<span class="hl_char">(</span>GetExceptionCode<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">if</span><span class="hl_char">(</span><span class="hl_char">!</span>v3<span class="hl_char">)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">div</span><span class="hl_char">.</span>LowPart&nbsp;<span class="hl_char">=</span>&nbsp;v2<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">div</span><span class="hl_char">.</span>HighPart&nbsp;<span class="hl_char">=</span>&nbsp;v1<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val1&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_function">div</span><span class="hl_char">.</span>QuadPart&nbsp;<span class="hl_char">/</span>&nbsp;v3<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val2&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">div</span><span class="hl_char">.</span>QuadPart&nbsp;<span class="hl_char">%</span>&nbsp;v3<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;res<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Обработчик&nbsp;исключения</li><li class="hl_l1"><span class="hl_function"><b>int</b></span>&nbsp;VmException<span class="hl_char">(</span><span class="hl_function"><b>int</b></span>&nbsp;n_except<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Pass&nbsp;on&nbsp;most&nbsp;exceptions</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">if</span><span class="hl_char">(</span><span class="hl_char">(</span>n_except&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;STATUS_INTEGER_OVERFLOW<span class="hl_char">)</span>&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;<span class="hl_char">(</span>n_except&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;STATUS_FLOAT_OVERFLOW<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;EXCEPTION_CONTINUE_SEARCH</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Execute&nbsp;some&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;to&nbsp;clean&nbsp;up&nbsp;problem</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;EXCEPTION_EXECUTE_HANDLER<span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>Так вот проблема в том, что если этот код вставлен в exe, то исключение деления на 0 обрабатывается нормально, но если этот код вставлен в dll, то получаем исключение без вызова обработчика.<br>Как сделать, чтобы в dll срабатывал обработчик исключения?
<br><br><font size="1"><i>-----<br>Everything is relative...</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274043&amp;user=20406&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=8" class="addthx" data-post="274043"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Coderess[/b]','')">Coderess</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/16383.jpg" alt=""><br><span class=txtSm>Ранг: 355.4 (мудрец), 55thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.21'>Активность: 0.32<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=16383">Uploader</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 16:24 <br><script type="text/javascript">QU('Coderess','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Coderess" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
VEH нельзя использовать?
<br><br><font size="1"><i>-----<br>Gutta cavat lapidem. Feci, quod potui. Faciant meliora potentes</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274047&amp;user=16383&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=9" class="addthx" data-post="274047"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]ant_man[/b]','')">ant_man</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.7 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.58'>Активность: 0.01=0.01</span><br>Статус: <a href="action=userinfo&amp;user=921">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 16:39 <br><script type="text/javascript">QU('ant_man','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ant_man" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>Vamit</b>, если это твоя dll, то надо убедиться, что она скомпилировалась без флага DllCharacteristics.IMAGE_DLLCHARACTERISTICS_NO_SEH
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274049&amp;user=921&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=10" class="addthx" data-post="274049"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Vamit[/b]','')">Vamit</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/20406.jpg" alt=""><br><span class=txtSm>Ранг: 331.1 (мудрец), 561thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.3'>Активность: 0.19<span style='color:red'>&searr;</span>0.06</span><br>Статус: <a href="action=userinfo&amp;user=20406">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 17:08 <br><script type="text/javascript">QU('Vamit','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vamit" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<I>ant_man пишет:<br>если это твоя dll </I><br>Моя, убедился что DllCharacteristics = 0. Dll является плагином Ольки, может в этом дело?
<br><br><font size="1"><i>-----<br>Everything is relative...</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274052&amp;user=20406&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=11" class="addthx" data-post="274052"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 17:46 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Если try на HLL написан (а это так), должно работать на любой системе и в любом виде ПЕ, проще отладить, начиная с передачи исключения в ринг3 на KiUserExceptionDispatcher, чем гадать.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274053&amp;user=1556&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=12" class="addthx" data-post="274053"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]ELF_7719116[/b]','')">ELF_7719116</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 419.0 (мудрец), 647thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.73'>Активность: 0.46<span style='color:green'>&nearr;</span>0.51</span><br>Статус: <a href="action=userinfo&amp;user=26651">Участник</a><br><font color=blue>&quotТибериумный реверсинг&quot</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 17:51 <br><script type="text/javascript">QU('ELF_7719116','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ELF_7719116" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<b>Vamit</b><br>Насколько я помню &quot;ничто мешает одному SEH-обработчику послать остальные на хрен&quot;... На системных длл&#039;ках система ставит(по крайней мере должна) &quot;свой&quot; обработчик. А вообще если видимых камней нет, может попробовать try явно заменить на:<br>push dword seh_handler <br>push dword [fs:0]<br>mov dword [fs:0], esp
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274054&amp;user=26651&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=13" class="addthx" data-post="274054"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 18:18 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
<b>ant_man</b><br>Верно, респект!<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_comment">; +</span></li><li class="hl_l1"><span class="hl_comment">; Настройка директории конфигурации. Регистрация SEH.</span></li><li class="hl_l0"><span class="hl_comment">; o SysStub - адрес системного стаба(напр. call dword ptr ds:[RtlpStartThreadFunc]).</span></li><li class="hl_l1"><span class="hl_comment">;</span></li><li class="hl_l0">ConfigureConfigDirectory&nbsp;<span class="hl_function"><b>proc</b></span>&nbsp;<span class="hl_function"><b>uses</b></span>&nbsp;<span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_registr"><b>esi</b></span>&nbsp;<span class="hl_registr"><b>edi</b></span>&nbsp;SysStub<span class="hl_char">:</span>PVOID<span class="hl_char">,</span>&nbsp;pZwProtectVirtualMemory<span class="hl_char">:</span>PVOID</li><li class="hl_l1"><span class="hl_function"><b>Local</b></span>&nbsp;RegionAddress<span class="hl_char">:</span>PVOID<span class="hl_char">,</span>&nbsp;RegionSize<span class="hl_char">:</span>ULONG<span class="hl_char">,</span>&nbsp;Protect<span class="hl_char">:</span>ULONG</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span>TEB<span class="hl_char">.</span>Peb<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>PEB<span class="hl_char">.</span>Ldr<span class="hl_char">[</span><span class="hl_registr">eax</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>PEB_LDR_DATA<span class="hl_char">.</span>InLoadOrderModuleList<span class="hl_char">.</span>Flink<span class="hl_char">[</span><span class="hl_registr">eax</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>LDR_DATA_TABLE_ENTRY<span class="hl_char">.</span>InLoadOrderModuleList<span class="hl_char">.</span>Flink<span class="hl_char">[</span><span class="hl_registr">eax</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>LDR_DATA_TABLE_ENTRY<span class="hl_char">.</span>DllBase<span class="hl_char">[</span><span class="hl_registr">eax</span><span class="hl_char">]</span>&nbsp;&nbsp;&nbsp;<span class="hl_comment">; ntdll.dll</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>IMAGE_DOS_HEADER<span class="hl_char">.</span>e_lfanew<span class="hl_char">[</span><span class="hl_registr">ebx</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>assume</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">:</span>PIMAGE_NT_HEADERS</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">]</span><span class="hl_char">.</span>OptionalHeader<span class="hl_char">.</span>DataDirectory<span class="hl_char">.</span>VirtualAddress<span class="hl_char">[</span>IMAGE_DIRECTORY_&nbsp;ENTRY_LOAD_CONFIG&nbsp;&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_DATA_DIRECTORY<span class="hl_char">)</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;RegionAddress<span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_registr">esi</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jz</b></span>&nbsp;Error</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_registr"><b>ebx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; _load_config_used</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>assume</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">:</span>PIMAGE_LOAD_CONFIG_DIRECTORY</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">]</span><span class="hl_char">.</span>_Size<span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_LOAD_CONFIG_DIRECTORY<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jne</b></span>&nbsp;Error</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerCount<span class="hl_char">,</span><span class="hl_number">0</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">]</span><span class="hl_char">.</span>FileHeader<span class="hl_char">.</span>NumberOfSections</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>je</b></span>&nbsp;Error</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jz</b></span>&nbsp;Error</li><li class="hl_l1">Scan<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;IMAGE_SECTION_HEADER<span class="hl_char">.</span>_Name<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_quote">&quot;tad.&quot;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jne</b></span>&nbsp;Next</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;IMAGE_SECTION_HEADER<span class="hl_char">.</span>_Name<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span><span class="hl_char">[</span><span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_quote">&quot;a&quot;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jne</b></span>&nbsp;Next</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>IMAGE_SECTION_HEADER<span class="hl_char">.</span>Characteristics<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>IMAGE_SCN_MEM_WRITE&nbsp;<span class="hl_function"><b>or</b></span>&nbsp;IMAGE_SCN_MEM_READ&nbsp;<span class="hl_function"><b>or</b></span>&nbsp;IMAGE_SCN_CNT_INITIALIZED_DATA</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>IMAGE_SCN_MEM_WRITE&nbsp;<span class="hl_function"><b>or</b></span>&nbsp;IMAGE_SCN_MEM_READ&nbsp;<span class="hl_function"><b>or</b></span>&nbsp;IMAGE_SCN_CNT_INITIALIZED_DATA</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jne</b></span>&nbsp;Error</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>IMAGE_SECTION_HEADER<span class="hl_char">.</span>VirtualSize<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerCount</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_char">(</span>X86_PAGE_SIZE&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">ecx</span><span class="hl_char">*</span><span class="hl_number">4</span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_LOAD_CONFIG_DIRECTORY<span class="hl_char">)</span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>not</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr"><b>eax</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;X86_PAGE_SIZE&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">cld</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>IMAGE_SECTION_HEADER<span class="hl_char">.</span>VirtualAddress<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jb</b></span>&nbsp;Error</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>IMAGE_SECTION_HEADER<span class="hl_char">.</span>VirtualSize<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;RegionSize<span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_LOAD_CONFIG_DIRECTORY<span class="hl_char">)</span><span class="hl_char">/</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>assume</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">:</span>PIMAGE_LOAD_CONFIG_DIRECTORY</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>rep</b></span>&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerTable</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerCount</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerTable<span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>SysStub</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>rep</b></span>&nbsp;<span class="hl_function">movsd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span>RegionAddress</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">stosd</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>inc</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edx</span><span class="hl_char">]</span><span class="hl_char">.</span>SEHandlerCount</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>Protect</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>RegionSize</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;PAGE_READWRITE</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>RegionAddress</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;NtCurrentProcess</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">%</span>APICALL&nbsp;pZwProtectVirtualMemory</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jnz</b></span>&nbsp;Exit</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;IMAGE_NT_HEADERS<span class="hl_char">.</span>OptionalHeader<span class="hl_char">.</span>DataDirectory<span class="hl_char">.</span>VirtualAddress<span class="hl_char">[</span>IMAGE_DIR&nbsp;ECTORY_ENTRY_LOAD_CONFIG&nbsp;&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_DATA_DIRECTORY<span class="hl_char">)</span><span class="hl_char">]</span><span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">edi</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>Protect</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>RegionSize</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;Protect</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>RegionAddress</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;NtCurrentProcess</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">%</span>APICALL&nbsp;pZwProtectVirtualMemory</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;Exit</li><li class="hl_l0">Next<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_SECTION_HEADER<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>dec</b></span>&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jnz</b></span>&nbsp;Scan</li><li class="hl_l0">Error<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>STATUS_UNSUCCESSFUL</li><li class="hl_l0">Exit<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">ConfigureConfigDirectory&nbsp;<span class="hl_function">endp</span></li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=274057&amp;user=17964&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=14" class="addthx" data-post="274057"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 18:20 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
Это даёт возможность зарегать сех, который не принадлежит модулям. Иначе необходимо изменить флаги, которые из юзермода не доступны(единожды можно выполнить насройку при инициализации процесса).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274058&amp;user=17964&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=15" class="addthx" data-post="274058"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 января 2011 18:24 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=17548.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
<b>ELF_7719116</b><br>Ты пишешь неправильные вещи.<br>Во-первых, СЕХ вызывается по цепочке, а он ставит свой обработчик последним, стало быть, вызван он будет первым (не считая хуков и вех).<br>И заменять на асм-вставку явно не стоит, хотя бы потому, что тогда не будут инициализированы поля SEHOP, если он включён.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=274060&amp;user=1556&amp;forum_n=6&amp;topic=17548.html&amp;page=0&amp;anchor=16" class="addthx" data-post="274060"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> SEH.</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=17548" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
