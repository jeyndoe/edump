<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Компиляция С/С++ с фрагментацией процедур и линковка с фрагментацией obj-файлов — что за ключи? - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Попытаюсь без лишних деталей обобщённо описать суть ситуацию и предмет вопроса. Вопрос простой, но у меня не получается описывать его в двух предложениях. (Маленькая заметка: если в описании того, как всё происходит, я где-то не">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=8344'>Magister Yoda</a>, <a target='_blank' href='?action=userinfo&amp;user=50833'>vasilevradislav</a> (+3 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Компиляция С/С++ с фрагментацией процедур и линковка с фрагментацией obj-файлов — что за ключи?</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 февраля 2015 23:12 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Попытаюсь без лишних деталей обобщённо описать суть ситуацию и предмет вопроса. Вопрос простой, но у меня не получается описывать его в двух предложениях. (<i class=x>Маленькая заметка: если в описании того, как всё происходит, я где-то не прав, ткните меня носом, но прежде чем тыкать, дважды проверьте себя — правы ли вы.</i>)<br><br>Я анализировал под дизассемблером/отладчиком некие бинарники (не от нечего делать), и наткнулся на определённую деталь в особенностях того, как они скомпилированы/слинкованы, и мне интересно, как эти особенности повторить (воспроизвести).<br><br>Итак, есть определённый бинарник, написанный на С и С++, про который с очень большой степенью уверенности можно сказать, что для компиляции и линковки использовались Microsoft-овские компилятор (cl.exe) и линкер (link.exe), то есть те же, что шли в составе MSVC++.<br><br>Поскольку есть отладочные символы, я вижу все имена функций/методов, глобальных переменных и констант, таблиц виртуальных функций и прочих внутренностей, а поскольку значительная часть кода написана на С++ и имена подверглись декорированию, я так же отлично вижу, что часть процедур — это методы классов, вижу к каким классам они принадлежат, их аргументы (их количество и тип).<br><br>Наблюдения, если кратко (дальше я поясню более детально), заключаются в следующем:<br>1. Порядок, в котором процедуры размещены в секции кода — он весьма, так скажем, хаотичен. Он выглядит так, как будто все процедуры подверглись переупорядочиванию, то есть порядок, в котором они размещены в секции кода, <b>кардинально </b>отличается от порядка, в котором имплементации процедур размещены в исходниках (кто-то спросит «а почему он должен совпадать?» — см. далее).<br>2. Обычно процедура в скомпилированном виде выглядит весьма компактно, в том смысле, что, глядя на дизасм-листинг, можно с определённостью сказать, что вот здесь у неё начало (точка входа), а здесь — край, и что инструкции, принадлежащие процедуре, занимают <b>непрерывный </b>диапазон байтов в секции кода (то есть внутри процедуры может быть сколько угодно условных и безусловных джампов, но там посреди «тела» процедуры нет включений какого-нибудь мусора, каких-нибудь данных или какой-нибудь другой процедуры или её куска. В этом случае можно говорить о цельных процедурах. Так вот в моём случае весомая доля процедур (где-то 30 %) — фрагментированы, то есть у таких процедур существуют крохотные кусочки (состоящие из обычно из 2—3 инструкций, хотя есть и большие куски), которые оторваны от основного тела процедуры и отнесены от неё <b>очень далеко</b>.<br><br>Второй пункт в разрезе «что вынуждает компилятор поступать именно так, как это линкуется и как заставить компилятор поступить с моим кодом так же?» меня волнует больше, чем первый.<br><br>Теперь поясню пункты. Предполагается, что вы знаете, как осуществляется компиляция (в плане кодогенерации), как генерируются OBJ-файлы (и что у них внутри), как линкер «сшивает» их вместе, какая информация ему доступна и что он может двигать и менять, а что нет. Вернее, знаете, как с этим дела обстоят у MS-овских компилятора и линкера.<br><br>1. «А почему порядок того, как функции располагаются в секции кода, должен соответствовать порядку функций в исходном файле?». А потому, что, в общем-то, если не прилагать дополнительных усилий, то именно так и будет, по крайней мере в случае CL. Если вы возьмёте чистый .c-файл и поместите в него, скажем, 4 функции foo_A(), foo_C(), foo_B(), foo_D() и скомпилируете это с помощью CL в obj, а этот obj загоните в дизассемблер (по ходу поста для демонстрации для определённости я буду использовать <b>dumpbin</b>, который идёт в составе MSVC++ / Platform SDK / DDK), то увидите, что в obj-файле эти процедуры идут именно в таком порядке — компилятор не переставил их алфавитном порядке, а честно положил их в obj в том порядке, в каком они шли в исходнике, ничего не выкинув (выкинуть какую-либо процедуру у него не хватит полномочий, потому что на этапе компиляции он не обладает наперёд информацией о том, понадобится ли та или иная функция, когда генерируемый в данный момент obj-файл будет слинковываться с какими-то другими obj-файлами).<br><br>Можно проверить:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>int</b></span>&nbsp;foo_A<span class="hl_char">(</span><span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;<span class="hl_number">1</span><span class="hl_comment">; } </span></li><li class="hl_l1"><span class="hl_function"><b>int</b></span>&nbsp;foo_C<span class="hl_char">(</span><span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;<span class="hl_number">2</span>&nbsp;<span class="hl_char">+</span>&nbsp;foo_D<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l0"><span class="hl_function"><b>int</b></span>&nbsp;foo_B<span class="hl_char">(</span><span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;<span class="hl_number">3</span>&nbsp;<span class="hl_char">+</span>&nbsp;foo_A<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function"><b>int</b></span>&nbsp;foo_D<span class="hl_char">(</span><span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;<span class="hl_number">4</span><span class="hl_comment">; }</span></li>        </ol>
    </div>
</div></div>
<br><br><b>cl /c test.c /Fotest.obj &amp;&amp; dumpbin /disasm test.obj</b><br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>obj</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">File&nbsp;Type<span class="hl_char">:</span>&nbsp;COFF&nbsp;OBJECT</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_foo_A<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000001</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">01</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000009</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">_foo_C<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000D</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000012</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000012</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">02</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">2</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000015</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000016</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">_foo_B<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000017</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000018</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000001A</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">0000001F</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000001F</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">03</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">3</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000022</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000023</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">_foo_D<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000024</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000025</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000027</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">04</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000002C</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000002D</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br><br><br>Сущности лежат в COFF-файле в том порядке, в каком были в исходнике. Линкеру, конечно, будет известно о каждой сущности (он сможет удовлетворить зависимости других obj-файлов в них), но всё это представляется одним цельным блоком, который линкер не имеет права разрезать: не может вырезать из него функции, не может их раздвигать и сдвигать и переставлять кусочки местами.<br><br>Если тут кто-то засомневается и скажет, мол, как же так «не может», а как же он тогда обеспечивает выравнивание начал процедур по границе параграфа, то я скажу, что выравнивание начал процедур и паддинги между ними (нужно, к пример, 5 байт перед началом функции для hot-patchability) — это задача уровня компилятора, а не линкера. <br><br>Для линкера 4 процедуры из примера выше — это единый кусок, линкер может двигать этот кусок как одно целой, может выравнивать его, но не контент внутри. Выравнивание отдельных процедур выполняет компилятор.<br><br>Попробуем скомпилировать пример выше с двумя противоположенными наборами ключей: /Og /Os /Oy (оптимизация размера) и /Og /Ot (оптимизация скорости — тут-то компилятор и сделает выравнивания).<br><br><b>cl /Og /Os /Oy /c test.c /Fotest.obj &amp;&amp; dumpbin /disasm test.obj</b><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>obj</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">File&nbsp;Type<span class="hl_char">:</span>&nbsp;COFF&nbsp;OBJECT</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_foo_A<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">6A</span>&nbsp;<span class="hl_number">01</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000002</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">_foo_C<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000004</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000009</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000009</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>inc</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>inc</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000B</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">_foo_B<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000C</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000011</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000011</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">03</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">3</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000014</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">_foo_D<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000015</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">6A</span>&nbsp;<span class="hl_number">04</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000017</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000018</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br><br><b>cl /Og /Ot /c test.c /Fotest.obj &amp;&amp; dumpbin /disasm test.obj</b><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>obj</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">File&nbsp;Type<span class="hl_char">:</span>&nbsp;COFF&nbsp;OBJECT</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_foo_A<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">01</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000005</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000006</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000007</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000009</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000C</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000D</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000E</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000F</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">_foo_C<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000010</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000015</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000015</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">02</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">2</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000018</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000019</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000001A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000001B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000001C</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000001D</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000001E</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000001F</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">_foo_B<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000020</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000025</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000025</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">03</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">3</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000028</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000029</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000002A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000002B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000002C</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000002D</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000002E</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000002F</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">_foo_D<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000030</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">04</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000035</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000036</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000037</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000038</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000039</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000003A</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000003B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000003C</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000003D</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000003E</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000003F</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li>        </ol>
    </div>
</div></div>
<br><br>В одном случае получились очень компактные процедуры, а в другом — раздутый код из-за выравнивания во имя быстроты.<br>Итак, убедились: за выравнивание начАл функций отвечает компилятор (руководствуясь ключами), а линкер помещает в выходной файл весь кусок из obj-целиком. <br><br>То, что это единый кусок, можно также сказать, посмотрев на левую колонку в дампах — смещение инструкции относительно начала «куска». Во всех трёх листингах с началом каждой новой функции отсчёт не сбрасывается, а продолжается и доходит в конце до 2Dh, 18h и 3Fh соответственно).<br><br>Разумеется, при таком подходе после линковки в итоговом файле могут остаться функции (да и вообще сущности), которые никому не нужны, может появиться куча дубликатов одной и той же функции (если это была inline-функция), и нельзя менять порядок отдельных сущностей.<br> <br>Чтобы решить эту проблему, сделали подход, который называется <b>function-level-linking</b>. В CL он включается опцией <b>/Gy</b>, и если его включить — каждая отдельная функция будет заключена в отдельный COMDAT (надеюсь, вы знаете, что это такое), и на этапе линковки линкер будет оперировать не одним большим блоком, а отдельны<br><br><b>Добавлено спустя 2 часа 16 минут</b><br>... а отдельными COMDAT-ами, которые он может:<br>(а) Переставлять местами в произвольном порядке,<br>(б) Удалять отдельные функции из выходного файла<br>(в) Сливать вместе одинаковые функции из разных входных obj-файлов (технике <i class=x>COMDAT folding</i>)<br><br>Перекомпилируем изначальный код с ключом <b>/Gy</b>:<br><b>cl /Gy /c test.c /Fotest.obj &amp;&amp; dumpbin /disasm test.obj<br></b><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>obj</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">File&nbsp;Type<span class="hl_char">:</span>&nbsp;COFF&nbsp;OBJECT</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_foo_A<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000001</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">01</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">1</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000009</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">_foo_C<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000001</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000008</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">02</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">2</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000C</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">_foo_B<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000001</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;E8&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_number">00000008</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">83</span>&nbsp;C0&nbsp;<span class="hl_number">03</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">3</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">0000000B</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">0000000C</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">_foo_D<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000000</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000001</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">8B</span>&nbsp;EC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr">esp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000003</span><span class="hl_char">:</span>&nbsp;B8&nbsp;<span class="hl_number">04</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;<span class="hl_number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_number">4</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_number">00000008</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_number">00000009</span><span class="hl_char">:</span>&nbsp;C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br><br>Как минимум, теперь видно, что у каждой функции отсчёт смещения инструкции начинается с нуля относительно начала функции. Каждая функция теперь помещена в отдельный COMDAT, и линкер может распоряжаться с ними по отдельности, убирая, двигая, перегруппировывая. (Я специально не стал использовать ключик /symbols у dumpbin-а, чтобы мой стартовый пост не вырос ещё больше по вертикали, а так этот ключик показал бы эффект /Gy ещё больше).<br><br>Отсюда три важных следствия:<br>(а) Манипуляции на уровне отдельных функций вообще стали возможны как явление.<br>(б) При линковке итогового файла MS-овским линкером ключ <b>/OPT:REF</b> заставит линкер выкинуть все сущности, на которые вообще никто не ссылается (то есть строится граф зависимостей, базовыми узлами которого являются сущности, указанные в директивах <b>/ENTRY</b> и <b>/EXPORT</b>; всё, что не попадает в этот граф — выкидывается).<br>(в) MS-овский линкер позволяет приказать ему поместить сущности внутри секции в любом произвольном порядке с помощью ключика <b>/ORDER</b>.<br><br>Если помните, я начал с того, что в первом пункте сказал, что порядок следования функций в секции кода выглядит очень странным, случайным и запутанным, и на фоне того, что в базовом случае порядок следования функций в итоговом файле повторяет порядок следования функций в файлах-исходниках (и порядок следования объектных файлов на входе линкера), крайне маловероятной выглядит версия, что этот запутанный порядок берёт своё начало из исходников.<br><br>Меняет ли в этой картине что-то тот факт, что у нас есть опции <b>/Gy</b> и <b>/OPT:REF</b> для компилятора и линкера соответственно? Могут ли эти опции кардинально поменять порядок следования процедур в итоговом бинарнике?<br><br>Проведём эксперимент. Сделаем 3 файла-исходника (alpha.c, beta.c, gamma.c) по 4 функции в каждом (с постфиксами _AAAA, _CCCC, _BBBB, _DDDD), при этом в каждом файле оставим одну функцию неиспользуемой, а линкер заставим экспортировать только одну из них (создадим DLL с одним экспортом без DllEntryPoint).<br><br>obj-файлы на вход линкеру подадим в таком порядке: beta.obj gamma.obj alpha.obj<br>Порядок файлов выбран преднамеренно таким, чтобы не повторять алфавитный.<br><br>Кроме того, для каждого .c-файла будут создан .h-файл с прототипами функций, которые будут включены в каждый .c-файл в порядке gamma.h alpha.h beta.h<br><br>Порядок следования прототипов будет таким: _BBBB, _DDDD, _AAAA, _CCCC.<br>Порядок следований реализаций — таким: _AAAA, _CCCC, _BBBB, _DDDD.<br><br>На этой картинке показано, какие есть функции, стрелками показано как они вызывают друг друга:<br><img src="http://share.fire-lines.ru/firehacker/schemes/comdat_refs.png" border="0" align="" alt=""><br>или, при взгляде с другой стороны, кто от кого зависит (кто на кого ссылается).<br>Функции alpha_CCCC, beta_DDDD и gamma_AAAA являются сиротами — от них никто не зависит (никто на них не ссылается).<br><br>alpha.h:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br><br>beta.h<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br><br>gamma.h:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br><br>alpha.c<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;gamma.h&quot;</span></li><li class="hl_l1">#include&nbsp;<span class="hl_quote">&quot;alpha.h&quot;</span></li><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;beta.h&quot;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;beta_BBBB<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">11</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">12</span><span class="hl_char">]</span><span class="hl_comment">; }</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;alpha_DDDD<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">13</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;alpha_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;gamma_BBBB<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">14</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li>        </ol>
    </div>
</div></div>
<br><br>beta.c:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;gamma.h&quot;</span></li><li class="hl_l1">#include&nbsp;<span class="hl_quote">&quot;alpha.h&quot;</span></li><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;beta.h&quot;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;alpha_BBBB<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">21</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;beta_AAAA<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">22</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">23</span><span class="hl_char">]</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;beta_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">24</span><span class="hl_char">]</span><span class="hl_comment">; }</span></li>        </ol>
    </div>
</div></div>
<br><br>gamma.c:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;gamma.h&quot;</span></li><li class="hl_l1">#include&nbsp;<span class="hl_quote">&quot;alpha.h&quot;</span></li><li class="hl_l0">#include&nbsp;<span class="hl_quote">&quot;beta.h&quot;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_AAAA<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">31</span><span class="hl_char">]</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_CCCC<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;alpha_AAAA<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">32</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l0"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_BBBB<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;gamma_DDDD<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">33</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li><li class="hl_l1"><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;gamma_DDDD<span class="hl_char">(</span><span class="hl_function">char</span><span class="hl_char">*</span>&nbsp;p<span class="hl_char">)</span>&nbsp;{&nbsp;return&nbsp;gamma_CCCC<span class="hl_char">(</span>p&nbsp;<span class="hl_char">+</span>&nbsp;p<span class="hl_char">[</span><span class="hl_number">34</span><span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">; }</span></li>        </ol>
    </div>
</div></div>
<br><br>На самом деле я решил ещё добавить [omega.c] с никем не используемой пустой функцией <b>omega_dummy()</b> и подавать omega.obj на вход линкеру предпоследним (перед alpha.obj).<br><br><b>Добавлено спустя 2 часа 16 минут</b><br>Теперь скомпилируем и посмотрим, каким будет порядок следования функций в секции кода полученной DLL. Что является определяющим фактором для этого: порядок, в котором идут прототипы, или же порядок, в котором идут реализации, или же алфавитный порядок имён функций, а кроме того, вносит ли вклад порядок перечисления obj-файлов на вход линкера или играет роль алфавитный порядок имён obj-файлов?<br><br>Сперва скомпилируем без опций /Gy и /OPT:REF и посмотрим на базовый порядок следования функций в секции кода DLL-шки:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>c&nbsp;alpha<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foalpha<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>c&nbsp;beta<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fobeta<span class="hl_char">.</span>obj</li><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>c&nbsp;gamma<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fogamma<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>c&nbsp;omega<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foomega<span class="hl_char">.</span>obj</li><li class="hl_l0">link&nbsp;beta<span class="hl_char">.</span>obj&nbsp;gamma<span class="hl_char">.</span>obj&nbsp;omega<span class="hl_char">.</span>obj&nbsp;alpha<span class="hl_char">.</span>obj&nbsp;<span class="hl_char">/</span>incremental<span class="hl_char">:</span>no&nbsp;<span class="hl_char">/</span>dll&nbsp;<span class="hl_char">/</span>noentry&nbsp;<span class="hl_char">/</span>export<span class="hl_char">:</span>beta_CCCC&nbsp;<span class="hl_char">/</span>debug&nbsp;<span class="hl_char">/</span><span class="hl_function">out</span><span class="hl_char">:</span><span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">dumpbin&nbsp;<span class="hl_char">/</span>disasm&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll&nbsp;<span class="hl_char">|</span>&nbsp;egrep&nbsp;<span class="hl_quote">&quot;^[^ ]+&quot;</span></li>        </ol>
    </div>
</div></div>
<br><br>Вывод:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">File&nbsp;Type<span class="hl_char">:</span>&nbsp;DLL</li><li class="hl_l0">_beta_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_beta_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_beta_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_beta_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_gamma_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_gamma_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_gamma_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_gamma_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_omega_dummy<span class="hl_char">:</span></li><li class="hl_l1">_alpha_AAAA<span class="hl_char">:</span></li><li class="hl_l0">_alpha_CCCC<span class="hl_char">:</span></li><li class="hl_l1">_alpha_BBBB<span class="hl_char">:</span></li><li class="hl_l0">_alpha_DDDD<span class="hl_char">:</span></li>        </ol>
    </div>
</div></div>
<br><br>Итак, делаем вывод, что в отсутствие ключей /Gy и /OPT:REF порядок следования функций в пределах obj-файлов определяется порядком следования реализаций (а не прототипов, и не алфавитным), а в пределах всего целевого файла-образа (DLL-ки) — порядком подачи obj-файлов на вход линкера (а алфавитным порядком имён obj-файлов).<br><br>Так как ключей /Gy и /OPT:REF не было, видно, что неиспользуемые функции не убрались из образа.<br><br>Теперь добавим /Gy, но по прежнему соберём без /OPT:REF — на этот раз линкер может переставлять функции местами, но не может выкидывать их:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;alpha<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foalpha<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;beta<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fobeta<span class="hl_char">.</span>obj</li><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;gamma<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fogamma<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;omega<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foomega<span class="hl_char">.</span>obj</li><li class="hl_l0">link&nbsp;beta<span class="hl_char">.</span>obj&nbsp;gamma<span class="hl_char">.</span>obj&nbsp;omega<span class="hl_char">.</span>obj&nbsp;alpha<span class="hl_char">.</span>obj&nbsp;<span class="hl_char">/</span>incremental<span class="hl_char">:</span>no&nbsp;<span class="hl_char">/</span>dll&nbsp;<span class="hl_char">/</span>noentry&nbsp;<span class="hl_char">/</span>export<span class="hl_char">:</span>beta_CCCC&nbsp;<span class="hl_char">/</span>debug&nbsp;<span class="hl_char">/</span><span class="hl_function">out</span><span class="hl_char">:</span><span class="hl_function">test</span><span class="hl_char">.</span>dll</li>        </ol>
    </div>
</div></div>
<br>Даёт:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">File&nbsp;Type<span class="hl_char">:</span>&nbsp;DLL</li><li class="hl_l0">_beta_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_beta_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_beta_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_beta_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_gamma_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_gamma_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_gamma_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_gamma_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_omega_dummy<span class="hl_char">:</span></li><li class="hl_l1">_alpha_AAAA<span class="hl_char">:</span></li><li class="hl_l0">_alpha_CCCC<span class="hl_char">:</span></li><li class="hl_l1">_alpha_BBBB<span class="hl_char">:</span></li><li class="hl_l0">_alpha_DDDD<span class="hl_char">:</span></li>        </ol>
    </div>
</div></div>
<br><br>Как видно, один только /Gy не меняет картину никак, порядок остаётся тем же, неиспользуемые функции не выкинуты.<br><br>Ключ /OPT:REF без /Gy даёт ту же картину — линкер не может убрать контент omega.obj, потому что не знает, что там только одна функция, от которой никто не зависит.<br><br>Теперь, наконец, включим /Gy для компиляции и /OPT:REF у линкера:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;alpha<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foalpha<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;beta<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fobeta<span class="hl_char">.</span>obj</li><li class="hl_l0"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;gamma<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Fogamma<span class="hl_char">.</span>obj</li><li class="hl_l1"><span class="hl_registr"><b>cl</b></span>&nbsp;<span class="hl_char">/</span>Og&nbsp;<span class="hl_char">/</span>Os&nbsp;<span class="hl_char">/</span>Oy&nbsp;<span class="hl_char">/</span>Gy&nbsp;<span class="hl_char">/</span>c&nbsp;omega<span class="hl_char">.</span>c&nbsp;<span class="hl_char">/</span>Foomega<span class="hl_char">.</span>obj</li><li class="hl_l0">link&nbsp;beta<span class="hl_char">.</span>obj&nbsp;gamma<span class="hl_char">.</span>obj&nbsp;omega<span class="hl_char">.</span>obj&nbsp;alpha<span class="hl_char">.</span>obj&nbsp;<span class="hl_char">/</span>opt<span class="hl_char">:</span>ref&nbsp;<span class="hl_char">/</span>incremental<span class="hl_char">:</span>no&nbsp;<span class="hl_char">/</span>dll&nbsp;<span class="hl_char">/</span>noentry&nbsp;<span class="hl_char">/</span>export<span class="hl_char">:</span>beta_CCCC&nbsp;<span class="hl_char">/</span>debug&nbsp;<span class="hl_char">/</span><span class="hl_function">out</span><span class="hl_char">:</span><span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">dumpbin&nbsp;<span class="hl_char">/</span>disasm&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll&nbsp;<span class="hl_char">|</span>&nbsp;egrep&nbsp;<span class="hl_quote">&quot;^[^ ]+&quot;</span></li>        </ol>
    </div>
</div></div>
<br><br>Вывод:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">File&nbsp;Type<span class="hl_char">:</span>&nbsp;DLL</li><li class="hl_l0">_beta_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_beta_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_beta_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_gamma_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_gamma_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_gamma_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_alpha_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_alpha_BBBB<span class="hl_char">:</span></li><li class="hl_l0">_alpha_DDDD<span class="hl_char">:</span></li>        </ol>
    </div>
</div></div>
<br><br>Видим, что наконец-то линкер ликвидировал неиспользуемые alpha_CCCC, beta_DDDD, gamma_AAAA и omega_dummy.<br><br>Но(!!!), вопреки некоторым ожиданиям, помимо исключения неиспользуемых функций, с порядком следования функций ничего не произошло: функции по-прежнему своим порядком следования повторяют порядок следования obj-файлов на входе линкера и порядок следования реализаций в отдельно взятых исходниках. Линкер просто убирает ненужное, но никак не перегруппировывает и не переставляет местами отдельные функции.<br><br>По крайней мере, можно было бы сделать смелое предположение, что с ключом /opt:ref линкер пойдёт от экспортов: сначала «положит» в секцию кода непосредственно сами экспортируемые функции, потом рекурсивно пойдёт по другим функциям, от которых зависят текущие, и будет класть их, и таким образом порядок следования функций повторил бы порядок обхода графа по красным стрелкам.<br><br><b>Но нет: линкер не переставляет функции местами сам, а сохраняет оригинальный порядок.</b><br><br>Естественно, используя ключ /ORDER можно заставить линкер переставить функции. Теста ради сделаем порядок с упорядочиванием по постфиксам (_AAAA, .... _DDDD):<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">link&nbsp;beta<span class="hl_char">.</span>obj&nbsp;gamma<span class="hl_char">.</span>obj&nbsp;omega<span class="hl_char">.</span>obj&nbsp;alpha<span class="hl_char">.</span>obj&nbsp;<span class="hl_char">/</span>opt<span class="hl_char">:</span>ref&nbsp;<span class="hl_char">/</span>incremental<span class="hl_char">:</span>no&nbsp;<span class="hl_char">/</span>dll&nbsp;<span class="hl_char">/</span>noentry&nbsp;<span class="hl_char">/</span>export<span class="hl_char">:</span>beta_CCCC&nbsp;<span class="hl_char">/</span>debug&nbsp;<span class="hl_char">/</span>order<span class="hl_char">:</span>@func<span class="hl_char">-</span>ord<span class="hl_char">.</span>txt&nbsp;<span class="hl_char">/</span><span class="hl_function">out</span><span class="hl_char">:</span><span class="hl_function">test</span><span class="hl_char">.</span>dll</li>        </ol>
    </div>
</div></div>
<br>даёт:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Dump&nbsp;of&nbsp;file&nbsp;<span class="hl_function">test</span><span class="hl_char">.</span>dll</li><li class="hl_l1">File&nbsp;Type<span class="hl_char">:</span>&nbsp;DLL</li><li class="hl_l0">_alpha_AAAA<span class="hl_char">:</span></li><li class="hl_l1">_beta_AAAA<span class="hl_char">:</span></li><li class="hl_l0">_alpha_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_beta_BBBB<span class="hl_char">:</span></li><li class="hl_l0">_gamma_BBBB<span class="hl_char">:</span></li><li class="hl_l1">_beta_CCCC<span class="hl_char">:</span></li><li class="hl_l0">_gamma_CCCC<span class="hl_char">:</span></li><li class="hl_l1">_alpha_DDDD<span class="hl_char">:</span></li><li class="hl_l0">_gamma_DDDD<span class="hl_char">:</span></li>        </ol>
    </div>
</div></div>
<br><br>Итак, ещё раз: если obj-файлы получены с ключом /Gy, линкер может удалять некоторые функции (при наличии ключа /OPT:REF) и переставлять их местами (при наличии ключа /ORDER и файла с явным указанием порядка). <b>Но сам по себе линкер функции местами не переставляет.</b><br><br>А теперь я возвращаюсь к тому, откуда начал, к первому пункту: в исследуемых бинарниках функции расположены в таком хаотическом порядке, что я никогда не поверю, что этот порядок соответствует порядку их следования в исходниках. Спросите себя сами: если есть проект с 1000 процедур, и есть класс, у которого 10 методов, и эти 10 методов равномерно рассредоточены по всей секции кода и идут вперемешку с методами других классов и обычными функциями, то вы поверите, что этот хаос берёт начало в исходниках? Вот и я не верю. Кроме этого, не особо верится, что при компиляции бинарников авторы зачем-то написали ORDER-файл, где и прописали этот <i class=x>странный </i>порядок следования.<br><br>Итак, мы имеем два не очень вяжущихся между собой факта:<br>(а) В исследуемых файлах функции идут в странном хаотическом порядке.<br>(б) Компилятор мог бы поменять порядок процедур в пределах obj-файла, но по умолчанию этого не делает. Линкер (если obj-файлы скомпилированы с /Gy) мог бы поменять порядок следования процедур в пределах всего бинарника, но по умолчанию этого тоже не делает, оставляя всё как есть.<br><br><b>Вопрос (часть 1): что могло вынудить компилятор и/или линкер перемешать процедуры в итоговом файле? Я не могу точно предположить, на каком этапе — компиляции или линковки — произошло перемешивание, но попробуйте предложить хоть какую-то правдоподобную гипотезу того, как это могло произойти.<br></b><br><br>На самом деле, первый пункт беспокоит меня меньше всего, потому что в худшем случае странный порядок следования процедур можно списать на то, что авторы действительно были настолько упоротыми, что у них в исходных файлах такой бардак, или на то, что они подготовили order-файл и использовали ключ /ORDER, руководствуясь принципом группировки логически связанных функций вместе, так, чтобы при выполнении кода минимизировать число page-fault-ов, вызванных переходом выполнения на страницу, которая вылетела из working-set-а процесса (для такой тонкой оптимизации ключ /ORDER и создавался).<br><br><b>Добавлено спустя 2 часа 17 минут</b><br>Второй пункт намного более серьёзен, потому что для него я не вижу пока никакого решения.<br><br>Если в первом пункте речь идёт о том, что бинарник выглядит так, как будто кто-то провёл хирургию, манипулируя отдельными функциями (переставляя их), то во втором пункте речь идёт о том, что помимо этого секция кода выглядит так, как будто кто-то провёл хирургию ещё и на уровне процедур: разрезая их на куски и перемещая (и перемешивая) отдельные фрагменты процедур друг относительно друга.<br><br>Дело в том, что я наблюдаю приличное количество процедур, у которых маленький кусочек «вырезан» из основного тела и унесён куда-нибудь далеко от самой процедуры.<br><br>Обычно это функции, внутри которых есть ветвление, причём одна из ветвей оказывается очень маленькой (по количеству действий, в которые ветвь выполнения скомпилируется).<br><br>Возьмём для примера такой код на С++:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>int</b></span>&nbsp;foo<span class="hl_char">(</span>boo&nbsp;<span class="hl_char">*</span>x<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">if</span><span class="hl_char">(</span>x<span class="hl_char">-</span><span class="hl_char">&gt;</span>ready&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">else</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<span class="hl_char">-</span><span class="hl_char">&gt;</span>func_a<span class="hl_char">(</span>x<span class="hl_char">-</span><span class="hl_char">&gt;</span>bzz<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<span class="hl_char">-</span><span class="hl_char">&gt;</span>func_b<span class="hl_char">(</span>x<span class="hl_char">-</span><span class="hl_char">&gt;</span>kee<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;x<span class="hl_char">-</span><span class="hl_char">&gt;</span>func_c<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br>Здесь <b>boo </b>— класс, его методы — виртуальные, соглашение — thiscall. Я не компилировал этот кусочек С++-кода, а написал то, во что он скомпилируется, «от руки». <br><br>Самое главное, что здесь есть ветка, которая выполняется при истинности выражения x-&gt;ready == 0 (ветка return 0; ). Вот именно компилируя её, компилятор генерирует условный джамп далеко-далеко за пределы основного тела функции foo — джамп через десятки (если не сотни) других процедур на одну единственную инструкцию (которая, как правило, зануляет какой-нибудь регистр или делает один mov), а затем идёт jmp опять через кучу других процедур обратно в пределы основного тела процедуры foo.<br><br>То есть выглядит это вот так:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">foo<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">esp</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">ebp</span><span class="hl_char">+</span><span class="hl_number">8</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>je</b></span>&nbsp;foo_X&nbsp;&nbsp;&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">-</span>&nbsp;джамп&nbsp;через&nbsp;кучу&nbsp;процедур&nbsp;на&nbsp;крохотный&nbsp;кусочек&nbsp;<span class="hl_char">(</span>см<span class="hl_char">.</span>&nbsp;ниже<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">esi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">+</span><span class="hl_number">8</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">]</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">+</span><span class="hl_number">12d</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">edi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esi</span><span class="hl_char">+</span><span class="hl_number">8</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">esi</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">-</span>&nbsp;возврат&nbsp;из&nbsp;крохотного&nbsp;кусочка&nbsp;происходит&nbsp;сюда</li><li class="hl_l1">&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>retn</b></span>&nbsp;<span class="hl_number">4</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">тут&nbsp;куча&nbsp;других&nbsp;процедур<span class="hl_char">,</span>&nbsp;куча&nbsp;других&nbsp;процедур</li><li class="hl_l1">тут&nbsp;куча&nbsp;других&nbsp;процедур<span class="hl_char">,</span>&nbsp;куча&nbsp;других&nbsp;процедур</li><li class="hl_l0">тут&nbsp;куча&nbsp;других&nbsp;процедур<span class="hl_char">,</span>&nbsp;куча&nbsp;других&nbsp;процедур</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">foo_X<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;<span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l0">&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;<span class="hl_char">&lt;</span>второе_отмеченное_место_выше<span class="hl_char">&gt;</span></li>        </ol>
    </div>
</div></div>
<br><br><br>Таким образом, ради xor eax,eax генерируется джамп чёрти-куда, а потом оттуда осуществляется возврат обычным jmp. <br><br>Основной вопрос здесь состоит в том, <b>чем руководствуется компилятор, когда генерирует огромное множество таких выносных фрагментиков</b>? Большинство фрагментов мелкие: 1—3 инструкции, но попадаются и большие.<br><br>Что заставляет делать компилятор именно так? Какие особенности кода? Какая комбинация ключей командной строки?<br><br>При просмотре бинарника в OllyDbg такие отрезанные выносные фрагменты имеют своё имя (как и рядовые неэкспортируемые функции, видимые благодаря наличию отладочных символов), состоящее из имени функции, к которой относится кусочек, символа подчёркивания и десятеричного числа, в большинстве случаев (но не во всех) соответствующего смещению смещения (именно так) в составе джамп-инструкции, ведущий на крохотный кусочек, относительно начала функции.<br><br>Т.е. если есть отдельно лежащий кусочек «foo_X», на который ведёт джамп-инструкция, начинающаяся по смещению foo+11d, вместо «X» будет число 13 (foo+11d+2, где 2 — размер опкода в составе джамп-инструкции, например 0F85 для JNZ). Правда я не уверен, что символ подчёркивания с числом не добавляет сама OllyDbg.<br><br>Помимо того, как вообще заставить компилятор генерировать такой код, меня волнует вопрос: если использовался function-level linking (ключ /Gy), как на уровне COFF были представлены такие огрызки функций? Неужели компилятор С/С++ оборачивал не функции целиком в COMDAT-ы, а снисходил до того, чтобы упаковывать отдельные кусочки функций в отдельные COMDAT-ы? Разве он такое умеет?<br><br><br><b>Наблюдение №0:</b> Обычно короткие огрызки процедур размещаются после (по направлению роста адресов) основных частей процедур, но бывает, что и до.<br><br><b>Важное наблюдение №1:</b> порядок следования основных частей процедур обычно не соответствует порядку следования огрызков. То есть если в секции кода есть функции: foo, bar, baaz (лежащие в таком порядке), то огрызки могут лежать так: bar_37, foo_19, baaz_74.<br><br><b>Важное наблюдение №2:</b> порядок следования огрызков выглядит намного более логичным, систематизированным и упорядоченным, нежели порядок следования основных частей процедур, к которым эти огрызки относятся. В частности:<br>(а) Для тех из методов CPP-классов, что оказались фрагментированными, всегда сперва идут огрызки public-методов, а затем огрызки private-методов. Основные же части методов лежат как попало.<br>(б) Огрызки лежат компактно, прижато друг к другу, и для огрызков фрагментированных методов классов справедливо, что огрызки сгруппированы по признаку  принадлежности к классу. Если, к примеру, составить большую таблицу, куда выписывать все сущности (и сами процедуры (их точки входа), и огрызки) секции кода в порядке их появления в секции (в порядке роста адресов), и каждой строке присвоить номер, и взять для примера один класс, его методы, а из них взять подмножество фрагментированных методов, то вот что получается:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#1428&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>CSomeClass&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>член<span class="hl_char">,</span>&nbsp;конструктор&nbsp;класса<span class="hl_char">)</span></li><li class="hl_l1">#1440&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethA&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l0">#1441&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethB&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l1">#1442&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethI&nbsp;<span class="hl_char">(</span>private<span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l0">#1450&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethD&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l1">#1457&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethE&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l0">#1617&nbsp;СSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethG&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l1">#1622&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethF&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l0">#1824&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethH&nbsp;<span class="hl_char">(</span>private<span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l1">#1825&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethK&nbsp;<span class="hl_char">(</span>private<span class="hl_char">-</span>метод</li><li class="hl_l0">#1990&nbsp;СSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethJ&nbsp;<span class="hl_char">(</span>private<span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l1">#1993&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethC&nbsp;<span class="hl_char">(</span><span class="hl_function">public</span><span class="hl_char">-</span>метод<span class="hl_char">)</span></li><li class="hl_l0">#1999&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>CSomeClass_120&nbsp;<span class="hl_char">(</span>огрызок&nbsp;конструктора<span class="hl_char">)</span></li><li class="hl_l1">#3456&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethA_17&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethA<span class="hl_char">)</span></li><li class="hl_l0">#3457&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethB_12&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethB<span class="hl_char">)</span></li><li class="hl_l1">#3458&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethC_23&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethC<span class="hl_char">)</span></li><li class="hl_l0">#3459&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethD_93&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethD<span class="hl_char">)</span></li><li class="hl_l1">#3460&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethE_74&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethE<span class="hl_char">)</span></li><li class="hl_l0">#3461&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethF_17&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethF<span class="hl_char">)</span></li><li class="hl_l1">#3462&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethG_17&nbsp;<span class="hl_char">(</span>огрызок&nbsp;<span class="hl_function">public</span><span class="hl_char">-</span>метода&nbsp;MethG<span class="hl_char">)</span></li><li class="hl_l0">#3463&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethH_45&nbsp;<span class="hl_char">(</span>огрызок&nbsp;private<span class="hl_char">-</span>метода&nbsp;MethH<span class="hl_char">)</span></li><li class="hl_l1">#3464&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethI_47&nbsp;<span class="hl_char">(</span>огрызок&nbsp;private<span class="hl_char">-</span>метода&nbsp;MethI<span class="hl_char">)</span></li><li class="hl_l0">#3465&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethJ_36&nbsp;<span class="hl_char">(</span>огрызок&nbsp;private<span class="hl_char">-</span>метода&nbsp;MethJ<span class="hl_char">)</span></li><li class="hl_l1">#3466&nbsp;CSomeClass<span class="hl_char">:</span><span class="hl_char">:</span>MethK_59&nbsp;<span class="hl_char">(</span>огрызок&nbsp;private<span class="hl_char">-</span>метода&nbsp;MethK<span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br><br><br>Обратите внимание, что основные куски реализаций методов класса лежат как попало: public- и private- методы перемешаны, логический порядок методов нарушен (вместо MethC лежит MethI, вместо F и G переставлены местами, J и K переставлены местами), кроме того, набор методов одного и того же класса размазан по большой зоне и чередуется с большим количеством никак не относящихся к классу CSomeClass процедур — методов других классов или вообще «плоских» функций. Так, например, между конструктором и MethA лежит 11 левых процедур, MethA, MethB и MethI лежат компактно друг за другом. затем между MethI и MethD лежит 7 левых процедур, потом между MethD и MethE — ещё 6 левых процедур, потом между MethE и MethG — аж 159 левых процедур, затем между 6 левых процедур между MethG и MethF, потом одна процедура (являющайся просто функцией, не членом класса) между MethF и MethH, MethH и MethK лежат вплотную друг к другу, потом опять идёт 64 левых процедуры, за которыми лежит MethJ, потом 2 левых процедуры и, наконец, MethC. Под левыми процедурами, ещё раз, я подразумеваю процедуры, которе никак не относятся к классу CSomeClass, а являются либо методами других классов, либо вообще не методами, а просто функциями.<br><br>А теперь, если посмотреть на то, как лежат огрызки, то видно, что за исключением огрызка конструктора, огрызки других методов лежат строго друг за другом в правильном порядке, занимают непрерывный диапазон номеров в нашей таблице, и между двумя огрызками не оказывается никаких дырок, занятых чем-либо, не относящимся к классу. И глядя на имена методов, к которым относятся огрызки, я чувствую, что огрызки идут именно в том порядке, в каком методы реализованы в исходнике. Это подтверждается и тем, что сперва идут огрызки public-методов, а затем огрызки private-методов.<br><br>В общем, вырисовывается следующая картина:<br>(1) В перемешивании и перестановке процедур местами замешан всё-таки линкер, а не компилятор.<br>(2) В фрагментации на уровне процедур замешан компилятор, причём огрызки множества функций одного исходника помещаются в один COMDAT, поэтому линкер не может их распотрошить на куски и равномерно размазать по секции кода, разбавив левыми процедурами, что мы видим на примере вышеприведённого класса, где огрызки методов лежат плотно и упорядоченно.<br><br>Остаётся вопрос:<br>Что вынуждает компилятор подобным образом фрагментировать процедуры (какой набор ключей, какой режим компиляции?) и что вынуждает линкер перемешивать процедуры столь странным образом (кроме ключа /ORDER и ручного упорядочивания?).<br><br><b>Добавлено спустя 2 часа 18 минут</b><br>_________<br><br>Некоторые люди, наверное, захотят поковырять сам бинарник. Я конечно, не могу поделиться своим бинарником, но как я уже сказал, он не уникальный в своём роде в плане наблюдаемых эффектов. Каждый может взять ole32.dll своей системы и поковырять её — в ней я наблюдаю те же трюки (как минимум в той версии ole32, которая актуальна для WinXP) , что и в своём бинарнике, к тому же вряд ли кто-то будет сомневаться, что для компиляции ole32.dll использовали MS-овский компилятор и линкер. (И уж точно никто не скажет, что это результат работы криптора или протектора)<br><img src="http://share.fire-lines.ru/firehacker/screenshots/ole32_symbols_chaos.png" border="0" align="" alt=""><br><br><br>На что я надеюсь: возможно кто-то имел удовольствие компилировать большие проекты, написанные на С/С++, а затем сидеть над ними с отладчиком, и сейчас он вспомнит, что в своём коде замечал аналогичные трюки со стороны компилятора/линкера, и в этом случае можно пойти и посмотреть, что за набор ключей и параметров был скормлен компилятору и линкеру.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352447&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=1" class="addthx" data-post="352447"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]VanHelsing[/b]','')">VanHelsing</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 15.5 (новичок), 21thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 8.37'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=31506">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 01:44 <br><script type="text/javascript">QU('VanHelsing','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=VanHelsing" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<b>СУТЬ ПРОБЛЕМЫ НЕ РАСКРЫТА Я СЧИТАЮ -- НАДО БОЛЬШЕ ПОДРОБНЫХ ГРАФИКОВ, БОЛЬШЕ ДИЗАССЕМБЛЕРНОГО ЛИСТИНГА, БОЛЬШЕ ДАМПОВ ПАМЯТИ!!</b> <img src="img/smilies/s5.gif" alt=""> <img src="img/smilies/s5.gif" alt=""> <img src="img/smilies/s5.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352449&amp;user=31506&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=2" class="addthx" data-post="352449"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]plutos[/b]','')">plutos</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/4773.png" alt=""><br><span class=txtSm>Ранг: 622.6 (<b>!</b>), 521thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.16'>Активность: 0.33<span style='color:green'>&nearr;</span>0.89</span><br>Статус: <a href="action=userinfo&amp;user=4773">Участник</a><br><font color=blue>_Вечный_Студент_</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 01:57 &middot; Поправил: plutos <br><script type="text/javascript">QU('plutos','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=plutos" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
VanHelsing конечно же шутит, а если говорить серьезно, то вам бы сократить размер своего поста раз эдак в десять и постараться сформулировать вопросы в их наиболее общем виде без того, чтобы топить суть дела в массе деталей.<br>Ваш пост подкупает тщательностью и аккуратностью в разработке деталей и больше тянет на статью (в хорошем смысле слова!), но разбираться с такой  уймой информации врядли кто-то будет, даже при большом желании.<br><br>Забавно, что сам пост начинается словами: &quot;Попытаюсь без <b>лишних деталей </b>...&quot;
<br><br><font size="1"><i>-----<br>Give me a HANDLE and I will move the Earth.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=352452&amp;user=4773&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=3" class="addthx" data-post="352452"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=26773" title="25-02-2015 23:53, ранг:7.5" target="_blank">Dynamic</a>, <a href="action=userinfo&user=38841" title="26-02-2015 13:50, ранг:0.2" target="_blank">toxanbi</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 05:34 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
тролль и самое главное толку от его вопросов нет, почему, как, зачем, практического смысла в реверсинжиниринге в них нет
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352459&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=4" class="addthx" data-post="352459"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Getorix[/b]','')">Getorix</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1541.jpg" alt=""><br><span class=txtSm>Ранг: 209.5 (наставник), 42thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.28'>Активность: 0.1<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1541">Участник</a><br><font color=blue>WinCE ARM M@sTeR</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 07:08 <br><script type="text/javascript">QU('Getorix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Getorix" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>reversecode пишет:<br>толку от его вопросов нет, почему, как, зачем, практического смысла в реверсинжиниринге в них нет </I><br>Как знать, мож это поможет понять как IDA бинари получаются разными и уникальными <img src="img/smilies/s3.gif" alt="">
<br><br><font size="1"><i>-----<br>Get busy living or get busy dying ©</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=352461&amp;user=1541&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=5" class="addthx" data-post="352461"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ELF_7719116[/b]','')">ELF_7719116</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 419.0 (мудрец), 647thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.73'>Активность: 0.46<span style='color:green'>&nearr;</span>0.51</span><br>Статус: <a href="action=userinfo&amp;user=26651">Участник</a><br><font color=blue>&quotТибериумный реверсинг&quot</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 07:14 <br><script type="text/javascript">QU('ELF_7719116','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ELF_7719116" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<i class=x>Краткость - сестра таланта!</i> © А.П. Чехов
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352462&amp;user=26651&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=6" class="addthx" data-post="352462"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 08:30 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<b>Getorix</b><br>это давно не секрет, но в этом опусе я про иду и намёка не увидел
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352464&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=7" class="addthx" data-post="352464"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]r_e[/b]','')">r_e</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 590.4 (<b>!</b>), 408thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.08'>Активность: 0.36<span style='color:red'>&searr;</span>0.18</span><br>Статус: <a href="action=userinfo&amp;user=11966">Модератор</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 08:37 <br><script type="text/javascript">QU('r_e','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=r_e" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<b>toxanbi</b><br>Ты из академической среди, что-ли?<br>Суть вопросов: как заставить компилятор+линкер побить CFG так, чтобы функции и их части размазало по всему бинарю равномерным слоем?<br><br>Про функции ты и сам ответил - можно использовать ORDER, а файло со списком генерировать на этапе pre-build step.<br>А вот с частями функций сложнее. Если откусанные части - обработчики ошибок (как exception chunks), то старые компиляторы вполне могли генерировать подобный код для них. А если там сосредоточена нормальная логика, то we need to go deeper.
<br><br><font size="1"><i>-----<br>старый пень</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=352465&amp;user=11966&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=8" class="addthx" data-post="352465"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 08:46 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
ToxanBI сразу ясно какая среда <img src="img/smilies/s5.gif" alt=""><br>не как а почему, у него вопросы из разряда &quot;хочу все знать&quot;, почему да почему<br>а практического смысла в этом никакого<br><br><b>Добавлено спустя 14 минут</b><br>Firehacker ? LOL<img src="img/smilies/s5.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352466&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=9" class="addthx" data-post="352466"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 10:10 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
reversecode,<br>&gt;тролль и самое главное толку от его вопросов нет, почему, как, зачем, практического смысла в реверсинжиниринге в них нет <br><br>Боже мой, вы действительно считаете, что я потратил кучу времени чтобы написать столько текста, ради того, чтобы задать бессмысленный вопрос? Практический смысл вопроса очень большой. Я не хотел об этом писать, чтобы не переводить вопрос в русло «а что такое <b>Х</b>?» и обсуждение самой затеи.<br><br>Ну так вот, представьте себе, что есть продукт <b>X</b>, исходники которого закрыты; и многие бы не прочь получить исходники <b>X</b>. А теперь вы приходите на суд общественности, и <i class=x>заявляете, что у вас есть исходники</i> <b>X</b>. Поскольку исходники продукта получены не кражей, а реверс-инженирингом, со стороны сообщества очень резонно задать вопрос: <b>а где гарантия, что реверс-инжениринг проведён правильно и предлагаемые исходники — не отсебятина, а действительно соответствуют продукту X</b>? Плохой, сложный и ненадёжный путь доказательства: написать кучу тестов, которые будут проверять, что скомпилированное из отреверсенных исходников работает так же, как и подленник. Но чтобы поверить результатам этих тестов, надо поверить, что сами тесты написаны идеально, то есть проблема остаётся (придётся доказывать безупречность тестов).<br><br>Есть другой, простой как стальной шарик способ доказать, что исходники 100% соответствуют продукту X: просто скомпилировать эти исходники и сравнить полученный бинарник с оригинальным. Если бинарник, полученный от компиляции исходников, при сравнении окажется байт-к-байту идентичным оригиналу, то может быть лучшим доказательством, что исходники — правильные и действительно соответствуют продукту? Естественно, из сравнения исключаются поля PE-файла, занятые timestamp-ами или паддинги.<br><br>Естественно, для этого надо компилировать исходники тем же компилятором, что использовался в оригинале, собирать тем же линкером, и с теми же ключами. <br><br>Поверьте мне, мой скилл глядя на дизассемблерный листинг писать код на С/С++, который при компиляции порождает точно те же инструкции, что я вижу в дизассемблере, точно в таком же порядке, с точно таким же использованием регистров — очень хорош для того, чтобы я вообще брался за эту задачу. Причём это касается не только плоских процедур, но и классов с множественным виртуальным наследованием и прочими штучками С++. <br><br><br>И, в общем, я отлично справляюсь и всё получается просто превосходно, за исключением, <b>чёрт возьми</b>, двух факторов:<br>1. Мне приходится вручную переставлять процедуры местами при линковке, потому что у меня они идут в хорошем порядке, а в оригинале — в чёрт знает каком.<br>2. Те процедуры, которые в оригинале фрагментированы — в моих руках компилятор генерирует код без этих сумашедших прыжков чёрти-куда через полсекции кода.<br><br>(<i class=x>Только не надо сейчас тащить сюда свои куски ассемблерных листингов и просить меня быстренько написать для них код на С/С++, чтобы проверить мои способности: у меня нет желания и времени кому-то что-то доказывать, я специально изначально скрыл, зачем мне всё это надо, чтобы избекать спекуляций по этому поводу</i>).<br><br>Если бы я мог заставить компилятор и линкер в моим руках вести себя точно так же, как они вели себя при компиляции оригинальных бинарников, было бы просто идеально. Потому что если с порядком следования процедур ещё можно сделать какой-то workaround, то с фрагментацией отделных процедур — не так то просто.<br><br>Да, я прекрасно знаю, что можно сделать очень интеллектуальный диффер двух PE-файлов, который будет для подтверждения эквивалентности двух бинарников строить execution flow graph и сравнивать цепочки инструкций на основе подобчных эффектов их действия, а не тупо сравнивая код побайтно. Но это не так классно, как побайтовое сравнение. В конце-концов, как проще доказать стороннему предвзятому человеку, что твои исходники правильные: сказав ему «возьми и сам сравни побайтово и убедишься», или сказав «смотри, парень, вот мой super sophisticated code differ, натрави на него оригинал и результат компиляции моих исходников, и ты увидишь что мой диффер скажет, что они эквивалентны»? Во втором случае он скажет «ну окей, а где доказательство, что твоя утилита для проверки эквивалентности работает правильно?» и будет прав.<br><br>(Разумеется, всё это нужно не только и не столько для того, чтобы в конце выполненной работы доказать всем, что код соответствует оригинальному бинарнику, сколько для того, чтобы контролировать самого себя по ходу выполнения реверс-инжениринга, а кроме того, работу по реверс-инженирингу можно сделать распределённой — желающие поучаствовать клонируют себе git-репозиторий, реверсят какую-то функцию, отправляют коммит на сервер, а у сервера репозитория стоит триггер, который берёто новые исходники, собирает из них бинарник и сравнивает полученное с оригиналом, и принимает только те коммиты, которые не ломают побайтовую идентичность).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352467&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=10" class="addthx" data-post="352467"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]TryAga1n[/b]','')">TryAga1n</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 262.5 (наставник), 337thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 8.45'>Активность: 0.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=31275">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 10:14 <br><script type="text/javascript">QU('TryAga1n','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=TryAga1n" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
Чувак, извини, но по-моему ты графоман <img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352468&amp;user=31275&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=11" class="addthx" data-post="352468"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 10:20 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
<b>toxanbi</b><br>у тебя асм код перед глазами, смотришь и контролируешь<br><br>вообще после реверса десятков мегабайт уже все четко и понятно с любым бинарником и  такой философией как ты пишешь уже никто не заморачивается<br><br><b>TryAga1n</b><br>второй клерк подрастает, только этот ближе к народу видимо <img src="img/smilies/s5.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352469&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=12" class="addthx" data-post="352469"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 10:47 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<b>r_e</b>,<br>Нет, я не из академической среды. Но и не стоит думать, что если это мой первый пост на этом форуме, то я за дизассемблер и отладчик взялся пару дней назад. Далеко не пару дней, просто свои проблемы я обычно решаю без посторонней помощи.<br><br><i class=x>&gt;Суть вопросов: как заставить компилятор+линкер побить CFG так, чтобы функции и их части размазало по всему бинарю равномерным слоем?</i><br>Верно, но важен не столько факт размазывания, сколько принуждение компилятора и линкера работать так, как они работали при компиляции оргининала (см. выше), чтобы при компиляции отверсенных исходников получить такой же бинарник. Дело в том, что компиляции — процесс детерминистичный, и если много раз компилировать одни и те же исходники тем же самым компилятором с теми же самыми ключами, результат будет всё время один и тот же. Есть, конечно <noindex><a href="https://msdn.microsoft.com/en-us/library/vstudio/e7k32f4k%28v=vs.110%29.aspx" rel="nofollow" target="_blank">profile-guided optimization</a></noindex>, но я подобные трюки (перемешанные процедуры и фрагментация) вижу даже в бинарниках бородатых годов (времен VC5), когда MS-овский компилятор PGO не поддерживал.<br><br><i class=x>&gt;Про функции ты и сам ответил - можно использовать ORDER, а файло со списком генерировать на этапе pre-build step.</i><br>Да, действительно, можно ключом ORDER, но я сомневаюсь, что авторы моего бирарника, равно как и авторы того же ole32 так заморачивались и писали файл, предпопределяющий очень необычный порядок следования. Мне представляется, что какой-то ключик линкера или определённая комбинация ключиков заставляет линкер самостоятельно (основываясь на чём-то) так переставлять процедуры внутри секции. Но, как я в начале сказал, пункт 1 меня не так беспокоит.<br><br><i class=x>&gt;Если откусанные части - обработчики ошибок (как exception chunks), то старые компиляторы вполне могли генерировать подобный код для них.</i><br>Нет, дело конечно же не в исключениях, я же не дурак, чтобы про такое спрашивать. Выносные отрезные кусочки этот как правило зануление eax и джамп на эпилог функции. Или зануление, поп и джамп на эпилог. Или зануление и LEAVE. Или просто одна единственная инструкция RETN.<br><br>Вот несколько кусочков из реального бинарника:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">foo_chunk<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>XOR</b></span>&nbsp;<span class="hl_registr">EAX</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">EAX</span></li><li class="hl_l0"><span class="hl_char">.</span>^&nbsp;&nbsp;<span class="hl_function"><b>JMP</b></span>&nbsp;back_to_foo</li><li class="hl_l1">bar_chunk<span class="hl_char">:</span></li><li class="hl_l0"><span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>XOR</b></span>&nbsp;<span class="hl_registr">EAX</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">EAX</span></li><li class="hl_l1"><span class="hl_char">.</span>^&nbsp;&nbsp;<span class="hl_function"><b>JMP</b></span>&nbsp;back_to_bar</li><li class="hl_l0">baaz_chunk<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>XOR</b></span>&nbsp;<span class="hl_registr">EAX</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">EAX</span></li><li class="hl_l0"><span class="hl_char">.</span>^&nbsp;&nbsp;<span class="hl_function"><b>JMP</b></span>&nbsp;back_to_baaz</li><li class="hl_l1">ololo_chunk<span class="hl_char">:</span></li><li class="hl_l0"><span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>MOV</b></span>&nbsp;<span class="hl_registr">EAX</span><span class="hl_char">,</span>&nbsp;<span class="hl_number">80001001</span></li><li class="hl_l1"><span class="hl_char">.</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>POP</b></span>&nbsp;<span class="hl_registr"><b>ESI</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l0"><span class="hl_char">.</span>&nbsp;&nbsp;&nbsp;<span class="hl_function">RETN</span></li><li class="hl_l1">cuza_chunk<span class="hl_char">:</span></li><li class="hl_l0"><span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>XOR</b></span>&nbsp;<span class="hl_registr">EAX</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">EAX</span></li><li class="hl_l1"><span class="hl_char">.</span>^&nbsp;&nbsp;<span class="hl_function"><b>JMP</b></span>&nbsp;back_to_cuza</li>        </ol>
    </div>
</div></div>
<br>Их там полно, тысячи их. Как видно, одинаковые не слиты, никаким COMDAT-folding&#039;ом не пахнет.<br><br><i class=x>&gt;А если там сосредоточена нормальная логика, то we need to go deeper. </i><br>Как правило это альтернативные эпилоги. Ещё это бывают jump-таблицы для switch-ей, но подобные вещи меня нисколько не удивляют и я их воспроизвожу.<br>Можете найти кучу таких фрагментов в ole32:<br><img src="http://share.fire-lines.ru/firehacker/screenshots/ole32_more_proc_fragmentation.png" border="0" align="" alt=""><br><br>Очевидно, MS-овский сишный компилятор запросто сам генерирует их, но только при определённых обстоятельствах (задача — понять, что за обстоятельства).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352472&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=13" class="addthx" data-post="352472"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 10:59 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
может тебе лучше блог завести? <img src="img/smilies/s5.gif" alt=""> явно же заняться нечем
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352473&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=14" class="addthx" data-post="352473"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:04 <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
reversecode,<br>Есть у меня свой блог, и свой ресурс с 15-летней историей существования. Давайте не будем о личностях; и прекратите лить свою желчь и спускать шуточки. Давайте по делу, нет?<br><br>Вопрос вполне конкретный: встречался ли кто-то и знает ли кто-либо, что за ключи (или их комбинация) заставляет упомянутые инсрументы (cl и link) выдавать результаты, описанные в двух пунктах.<br><br>Пожалуйста, не надо писать комментарии насчёт того, что вы думаете о моём test-driven reverse-engineering подходе, где каждый коммит тестируется на идентичность результирующего бинарника эталонному. Я уж как-нибудь без вас разберусь с методологией разработки.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352474&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=15" class="addthx" data-post="352474"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:08 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
15 летний опыт? мне вас жаль <img src="img/smilies/s4.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352475&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=16" class="addthx" data-post="352475"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:15 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
Во-первых, есть profile-guided optimization. Насколько я помню, она и может дать куски функции отдельно, в частности для статистики бранчей и предсказания наиболее вероятной ветви.<br>Во-вторых, никто не мешает генерить и кормить ORDER полностью автоматически, не вижу в этом никакой сложности для любого числа функций.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352476&amp;user=1556&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=17" class="addthx" data-post="352476"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:22 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
<i class=x>&gt;Во-первых, есть profile-guided optimization, которая и может дать куски функции отдельно.</i><br>В MSVC5? В MSVC6?<br><br>Я же написал выше:<br><I>toxanbi пишет:<br>Есть, конечно <noindex><a href="https://msdn.microsoft.com/en-us/library/vstudio/e7k32f4k%28v=vs.110%29.aspx" rel="nofollow" target="_blank">profile-guided optimization</a></noindex>, но я подобные трюки (перемешанные процедуры и фрагментация) вижу даже в бинарниках бородатых годов (времен VC5), когда MS-овский компилятор PGO не поддерживал. </I><br><br><i class=x>&gt;никто не мешает генерить и кормить ORDER полностью автоматически</i><br>Не спорю, но есть доля сомнения, что именно такой подход использовали авторы моего бинарника и множества других, где я вижу одну и ту же картину. Я же написал выше, что способ /ORDER-ом известен, но ищется что-то автоматическое, возможно недокументированное (у cl и link много недокументированных ключей, возможно использовался один из таких, и кто-нибудь здесь в курсе об этом ключе).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352477&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=18" class="addthx" data-post="352477"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:30 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#19');return false;">#19</a> </span><div align=left><br>
за 15 лет мог бы отреверсить не один бинарник что бы понять что ни один аФФтар не будет заниматься подобной чушью как ORDER<br><br>все компилируют в релизе банальной дефолтовой оптимизацией которая стоит в студии
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352478&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=19" class="addthx" data-post="352478"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="20" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:36 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#20" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#20');return false;">#20</a> </span><div align=left><br>
&gt;все компилируют в релизе банальной дефолтовой оптимизацией которая стоит в студии <br>Ога-ога, особенно когда никакой студии не используется и проект собирается makefile-ом. Ну и можете на досуге собрать студией с дефолтными опциями какой-нибудь проект и посмотреть, будет там такой адский перемес, или функции лягут в том же порядке, как и в исходнике.<br><br>Да и фраза про 15 лет относилась не к опыту реверс-инжениринга, а к возрасту интернет-ресурса, но вам же лишь бы оффтопить, отпуская колкие шуточки.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352479&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=20" class="addthx" data-post="352479"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="21" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:45 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#21" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#21');return false;">#21</a> </span><div align=left><br>
зачем мне проверять то что я и так знаю? конечно в файле все функции будут на перемес<br>более того половину функций заинлайнятся<br>а если собрать этот же проект gcc 3 версии<br>то он выстроит все функции по порядку как они расставлены в соурс файлах<br>а если опять же этот проект собрать gcc 4 версии, то функции будут в перемешку<br>при этом даже никаких заумных опций не надо придумать для компилятора<br><br>занялся бы реальным делом а не сидел не рассуждал о том как правильно пилить дрова, и почему срезы по разному идут, а то дровосеки с тебя угорают <img src="img/smilies/s5.gif" alt=""> <img src="img/smilies/s5.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352480&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=21" class="addthx" data-post="352480"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="22" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 11:51 <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#22" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#22');return false;">#22</a> </span><div align=left><br>
<I>reversecode пишет:<br>зачем мне проверять то что я и так знаю? конечно в файле все функции будут на перемес </I><br>Пруф из самого первого поста (там где alpha.c, beta.c, gamma.c) показывает, что ни компилятор, ни линкер не меняют порядок сдедования функций. Напишите, какого же волшебного ключика из «дефолтной конфигурации MSVC-проекта» там не хватает, чтобы функции перемешались?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352482&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=22" class="addthx" data-post="352482"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="23" onfocus="this.blur()" href="JavaScript:di('[b]VanHelsing[/b]','')">VanHelsing</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 15.5 (новичок), 21thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 8.37'>Активность: 0.04<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=31506">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 16:46 <br><script type="text/javascript">QU('VanHelsing','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=VanHelsing" target="_blank">Личное сообщение</a> &middot;  <a href="#23" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#23');return false;">#23</a> </span><div align=left><br>
<I>reversecode пишет:<br>TryAga1n<br>второй клерк подрастает, только этот ближе к народу видимо   </I><br><br>НОВЫЙ ОДЕПТ, БОЛЬШЕ И ДОБАВИТЬ НЕЧЕГО!!
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352492&amp;user=31506&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=23" class="addthx" data-post="352492"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="24" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 16:56 <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#24" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#24');return false;">#24</a> </span><div align=left><br>
<b>toxanbi</b><br>возьми с гугла хоть один большой кроссплатформенный проект и проверь<br>а с тестами на три пустых функции ничего не поймешь
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352493&amp;user=15381&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=24" class="addthx" data-post="352493"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="25" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 389thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 17:25 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#25" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#25');return false;">#25</a> </span><div align=left><br>
Времена, когда досовские com-файлы после дизассемблирования собирались в полностью идентичный исходному двоичный файл, прошли.<br>Способ контроля хороший, но приходилось повозиться, чтобы всё получилось.<br><br>В данном случае, не получится полностью воспроизвести область данных компилятора при трансляции хотя бы потому, что исходные, авторские строки-имена функций в декомпилируемом файле уже недоступны.<br><br>Не надо ставить перед собой невыполнимые задачи имхо<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352494&amp;user=35473&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=25" class="addthx" data-post="352494"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="26" onfocus="this.blur()" href="JavaScript:di('[b]r_e[/b]','')">r_e</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 590.4 (<b>!</b>), 408thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.08'>Активность: 0.36<span style='color:red'>&searr;</span>0.18</span><br>Статус: <a href="action=userinfo&amp;user=11966">Модератор</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 18:25 <br><script type="text/javascript">QU('r_e','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=r_e" target="_blank">Личное сообщение</a> &middot;  <a href="#26" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#26');return false;">#26</a> </span><div align=left><br>
<b>toxanbi</b><br>Допустим что твой вопрос решается какими-то ключами компилятора + линкера, но что более вероятно подбором правильного компилятора и линкера.<br>Что-то сомневаюсь я что у тебя есть коллекция всех компилей и линкеров. Не факт, кстати, что МС компилит сборки паблик утилитами. По идее у них с перфорса билд сервер должен грабить исходники и собирать все автоматом, но как оно там настроено - хз. И работает ли оно вообще под виндой - большой вопрос.
<br><br><font size="1"><i>-----<br>старый пень</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=352498&amp;user=11966&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=26" class="addthx" data-post="352498"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="27" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 20:37 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#27" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#27');return false;">#27</a> </span><div align=left><br>
<I>dosprog пишет:<br>В данном случае, не получится полностью воспроизвести область данных компилятора при трансляции хотя бы потому, что исходные, авторские строки-имена функций в декомпилируемом файле уже недоступны.<br> </I><br>Не уверен, что правильно понял, что подразумевается под «областью данных компилятора»... речь о совокупном наборе всех данных, которыми располагает компилятор (и исходники, и ключи командной строки и все прочие любые параметры, так или иначе влияющие на процесс компиляции0?<br><br>Утверждение, что авторские строки-имена функций неизвестны, неверное, потому что есть отладочные символы, а значит есть информация об именах, типах возвращаемых значений, аргументах и их типах для функций и членов классов, а равно и для глобальных переменных (располагающихся в секции данных) и констант, попавших в секцию кода (авторы использовали /MERGE:.rdata=.text и объединили секции).<br><br><br><I>r_e пишет:<br>но что более вероятно подбором правильного компилятора и линкера. </I><br>Для начала я хочу разобраться, какая часть «эффектов» обусловлена компилятором, а какая — линкером. Например, я не думаю, что многое зависит от линкера: если только не существует какого-то приватного линкера, по собственной инициативе переставляющего процедуры, остаётся считать, что перестановка местами либо дело рук компилятора (тогда мне пойдёт любая версия линкера), либо результат применения ключа /ORDER (тогда, опять же, линкер особой версии не нужен).<br><br>С компилятором интереснее. Сейчас, например, CL из MSVC6 отлично справляется с задачей: при компиляции отреверсенного кода воспроизводятся даже откровенно идиотские пассажи, типа таких<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">esi</span></li><li class="hl_l1"><span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ebx</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ebx</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">esi</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ecx</span></li>        </ol>
    </div>
</div></div>
<br>не имеющие никакого смысла и пользы (вроде выравнивания последующего блока инструкций ради производительности), являющиеся очевидно недочётами компилятора.<br><br><br><br><I>r_e пишет:<br>Что-то сомневаюсь я что у тебя есть коллекция всех компилей и линкеров. Не факт, кстати, что МС компилит сборки паблик утилитами. </I><br>Я уверен, что MS компилириует внутренности системы тем же тулчейном, каким предлагает пользоваться разработчикам железа для создания драйверов под Windows, то есть тем набором инструментов, что поставляется в DDK, а это принципиально те же инструменты, что идут в составе Platform SDK и VS. То есть задача сводится в худшем случае к нахождению нужного билда инструмента. Уверенность в том, что они следуют постулату «использовать один и тот же компилятор <i class=x>для всего</i>» зиждется на том факте, что есть ряд аспектов, не оговариваемых стандартом (например bitfields memory layout), и чтобы не получить так, что вызывающая и вызываемая функция компилироались компиляторами, имеющими разное представление о том, как одна и та же структура выглядит на уровне байтов и битов, они зареклись использовать один и тот же компилятор. Так что нет, они не комплируют системные DLL с помощью gcc.<br><br>Хотя я не исключаю, что они могли использовать для компиляции приватные билды своих собственных инструментов, которые никогда не выходили в свет. Я об этом думал, я это в уме держу. Но с другой стороны, это же двойная работа: поддерживать одновременно и публичную и приватную версии компилятора. Мне видится, что скорее они работают так: доводят компилятор до ума, тестируют его до посинения, а после того, как доходят до релиза и уверены в достаточной степени, что компилятор не «гонит пургу», — эта релизная версия уходит и в паблик (VS, Platform SDK) и используется для внутренних нужд.<br><br>Кроме того, в утёкших исходниках win2k можно найти много интересной информации о том, как организован процесс билда: и makefile-ы, и соответствующие батники, и даже валяющийся посреди исходников набор всех утитлит (cl, ml, lib, rc, nmake, midl), который, очевидно, точно использовался внутри компании, а не предназначался для публики (не положили же их в каталог с исходниками, зная наперёд, что они утекут в паблик).<br><br>Также можно увидеть, что они не патчат компилятор ради каждой собственной хотелки: так, например, для того, чтобы избавиться от попадания в выходные файлы vftable-ов для абстрактных классов (такие классы имеют vftable, где все ячейки заполненные указателем на _purecall, выводящую то самое грустное сообщение «Pure virtual function call»), они написали на Си маленькую утилитку, которая вырезает из obj-файлов нежелательные сущности, и включили эту утилиту в цепочку компиляции.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352505&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=27" class="addthx" data-post="352505"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="28" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 389thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2015 22:46 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#28" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#28');return false;">#28</a> </span><div align=left><br>
Тут <b>reversecode</b> уже посоветовал взять проект с исходниками и понасиловать его, глядишь, и вопросы отпадут.<br><br>Совет по поводу раздумий о текущих по-разному слезах тоже вполне дельный имхо<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352507&amp;user=35473&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=28" class="addthx" data-post="352507"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="29" onfocus="this.blur()" href="JavaScript:di('[b]soft[/b]','')">soft</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 21.0 (новичок), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.95'>Активность: 0.01<span style='color:green'>&nearr;</span>0.03</span><br>Статус: <a href="action=userinfo&amp;user=12603">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 февраля 2015 00:05 <br><script type="text/javascript">QU('soft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=soft" target="_blank">Личное сообщение</a> &middot;  <a href="#29" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#29');return false;">#29</a> </span><div align=left><br>
<b>toxanbi</b>, если у вас есть pdb, то что вам мешает посмотреть в нем ключи командной строки проекта? например в  TotalCommander через F3 (Ctrl+F) поищите в pdb строки &quot;Yustdafx.h&quot; или &quot;Optimizing Compiler&quot;, а там уже  смотрите ключи типа &quot;... -FD -EHs -EHc -RTC1 -MTd -Ycstdafx.h ...&quot; и настраивайте свой декомпиль  точно также.<br>Еще подобные вещи сильно зависят от версии и патча студии, версию можно подсмотреть в том же pdb на строках типа &quot;C:\Program Files\Microsoft Visual Studio 9.0&quot;, а патч уже экспериментальным путем.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352508&amp;user=12603&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=29" class="addthx" data-post="352508"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="30" onfocus="this.blur()" href="JavaScript:di('[b]toxanbi[/b]','')">toxanbi</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.4 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.37'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=38841">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 февраля 2015 01:11 &middot; Поправил: toxanbi <br><script type="text/javascript">QU('toxanbi','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=toxanbi" target="_blank">Личное сообщение</a> &middot;  <a href="#30" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=23438.html&amp;page=0#30');return false;">#30</a> </span><div align=left><br>
<I>soft пишет:<br>если у вас есть pdb, то что вам мешает посмотреть в нем ключи командной строки проекта? </I><br>Увы, но у меня символы в формате DBG, а не PDB.<br>Это же не обязательное правило, что в PDB можно найти командную строку, использованную для компиляции каждого отдельного исходника. Посмотрел pdb-шку для test.dll (пруф-пример из первого поста, где были alpha.c, beta.c, gamma.c) — никаких следов командной строки с ключами компиляции не обнаружил. Просканировал 16 Гб отладочных символов, скачанных с MS-овского Symbol Storage — из 1789 файлов только в одном(!) файле (unidrv.pdb) нашлись следы командной строки.<br><br><b>Добавлено спустя 18 минут</b><br>Хотя вот, изменив немного поисковой паттерн, нашёл ещё один pdb-файл. Но их по прежнему единицы из тысяч. Попробую ещё поиграть с поисковыми шаблонами.<br><br><b>Добавлено спустя 1 час 1 минуту</b><br><b>soft</b>,<br>Хорошая новость: у меня были символы для трёх разных версий ole32, и в одном из pdb-файлов нашлись следы комадной строки.<br>Плохая новость: это оказалась версия, выдернутая из Win7, а не та, которую я показывал выше на скриншотах (она из XP). И в этой новой семёрочной версии ole32 уже нет такого адского расколбаса с порядком следования процедур, и практически невидно фрагментированных процедур (одну я всё-таки нашёл, но поиск был «на глаз», не автоматизированным).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=352509&amp;user=38841&amp;forum_n=2&amp;topic=23438.html&amp;page=0&amp;anchor=30" class="addthx" data-post="352509"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Компиляция С/С++ с фрагментацией процедур и линковка с фрагментацией obj-файлов — что за ключи?</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#31" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="2">
<input type="hidden" name="topic" value="23438">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=23438" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
