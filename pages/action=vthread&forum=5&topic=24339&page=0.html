<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Как внутри DllMain, определить возврата  из загрузки длл в основной код? - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Пропустил в названии слово &quot;адрес&quot; возврата. Не знаю как исправить на этом форуме. Пишу длл. Внутри ее DllMain, выполняю необходимую работу. Но по выходу из загрузки этой длл хочу удалить ее из памяти процесса. Т.е.">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a>, <a target='_blank' href='?action=userinfo&amp;user=6859'>cppasm</a>, <a target='_blank' href='?action=userinfo&amp;user=55996'>dutyfree</a>, <a target='_blank' href='?action=userinfo&amp;user=28016'>asfa</a> (+6 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> Как внутри DllMain, определить возврата  из загрузки длл в основной код?</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b> .  <b>1</b> . <a href="action=vthread&amp;forum=5&amp;topic=24339&amp;page=1.html">2</a> . <a href="action=vthread&amp;forum=5&amp;topic=24339&amp;page=1.html">&gt;&gt;</a></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2016 18:42 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Пропустил в названии слово &quot;адрес&quot; возврата. Не знаю как исправить на этом форуме.<br>Пишу длл. Внутри ее DllMain, выполняю необходимую работу. Но по выходу из загрузки этой длл хочу удалить ее из памяти процесса. Т.е. если знать адрес возврата в основной код, то туда можно поместить код удаления этой длл, и загрузки оригинальной.  Что я и делаю сейчас, поэтому приходится постоянно искать вручную  адрес возврата , и задавать принудительно. Но хочется находить этот адрес автоматически внутри самой, загружаемой длл.<br>Так вот, можно - ли каким-то образом узнать этот адрес?<br>Изыскания в стеке с помощью ebp, не подходят. Некоторые протекторы рвут связанную цепочку кадров вызова фукций. Да и нет уверенности, что вложенность ф-ций будет постоянной на разных ОС и программах.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367933&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=1" class="addthx" data-post="367933"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2016 19:37 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Никак. Верни ошибку, винда сама отмапит как неудачно загруженную.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367935&amp;user=1556&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=2" class="addthx" data-post="367935"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2016 19:42 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
Так он хотел поковырять код, который вызвал LoadLibrary().<br>Пытается найти то место.<br><br>Но, имхо, надёжного способа нет<br><br>И вообще, идея какая-то стрёмная.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367936&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=3" class="addthx" data-post="367936"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]vovanre[/b]','')">vovanre</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 92.1 (постоянный), 83thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.9'>Активность: 0.11<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=35597">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2016 21:59 <br><script type="text/javascript">QU('vovanre','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=vovanre" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#4');return false;">#4</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;APIENTRY&nbsp;DllMain<span class="hl_char">(</span>&nbsp;HMODULE&nbsp;hModule<span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>DWORD</b></span>&nbsp;&nbsp;ul_reason_for_call<span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;lpReserved</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;payload</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=367946&amp;user=35597&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=4" class="addthx" data-post="367946"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 20:05 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>dosprog пишет:<br>Так он хотел поковырять код, который вызвал LoadLibrary().<br>Пытается найти то место.<br></I><br>Ну да. Именно это мне и надо. Только немного далее идущий код. А это место, скажем так, &quot;отправная точка&quot;. <br>То-есть в первую очередь, при работе в DllMain, в ехе-коде сделать свои изменения, которые мне нужны. Потом подгрузить в ехе-код, код с FreeLybrary(), на борту.<br>По выходу из DllMain, подменить eax, на значение оригинальной длл. Ну и выгрузить свою длл, за ненадобностью.<br>Скажу больше, я уже так и делаю. Но адрес возврата приходится вбивать вручную. Немного неудобно.<br><I>dosprog пишет:<br>И вообще, идея какая-то стрёмная. </I><br>&quot;Можно огласить весь список...Пожалуйста&quot; (Это из нашей комедии, цитата)   <img src="img/smilies/s1.gif" alt=""><br>Поясните, если не трудно. Может есть более продвинутые идеи.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367973&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=5" class="addthx" data-post="367973"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]script_kidis[/b]','')">script_kidis</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/39388.jpg" alt=""><br><span class=txtSm>Ранг: 56.2 (постоянный), 14thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.01'>Активность: 0.12<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=39388">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 21:00 <br><script type="text/javascript">QU('script_kidis','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=script_kidis" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
Может есть более продвинутые идеи.<br><br>да дать чёткое задание необходимый материал и &#036; а всё остальное сделают за вас.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367974&amp;user=39388&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=6" class="addthx" data-post="367974"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 21:31 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
Не может тут быть никаких идей.<br>Я ж говорю, стрёмная затея.<br><br>Но пускай, для конкретной ситуации, при нахождении в dllMain() определён адрес возврата из LoadLibrary(), как - это уже другой вопрос.<br>Пускай он нащупан в стеке сравнением с диапазоном [.401000...fFFffFF].<br><br>Никто не мешает коду DLLMain() в стеке (где найден адрес возврата из LoadLibrary() ) этот адрес возврата уменьшить на 6, ещё выше в стеке в аргументах того вызова LoadLibrary() найти ссылку на имя DLL и изменить ту строку-имя DLL для загрузки, после чего из DLLMain() вернуть FALSE.<br><br>Тогда весь парад завершится возвратом в точку приложения, где &lt;call LoadLibrary()&gt; (повторно, но уже с подкорректированной строкой-именем загружаемой DLL).<br>И ничего в коде клиента менять не потребуется, всё будет прозрачно.<br><br>Только для чего такой цирк может понадобиться, не представляю.<br><br><I>script_kidis пишет:<br>дать чёткое задание необходимый материал и &#036; а всё остальное сделают за вас.  </I><br><br>Это самый надёжный способ. Но нужны Денги. <br>Если есть Денги, то можно даже попривередничать. Повыделываться то есть.<br>Но Денег тогда надо много.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367976&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=7" class="addthx" data-post="367976"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 21:34 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
Потрейсить, в статике может не получится. Адреса возврата может не быть как такового, если стартует новый поток или же завершается.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=367977&amp;user=40990&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=8" class="addthx" data-post="367977"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 21:39 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
Это да. Априорно считали, что библиотека загружается <u>динамически</u> какой-то программой.<br>Иначе - адрес-то возврата будет всё равно, но он будет указывать куда-то в загрузчик OS.<br>Впрочем, выше описанный изврат и в этом случае тоже должен бы сработать.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367978&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=9" class="addthx" data-post="367978"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 21:49 &middot; Поправил: difexacaw <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>dosprog</b><br><br>Теоретически можно очистить рабочий набор(EmptyWorkingSet()) и спустя время снять лог по подкаченным страницам(GetWsChanges()); в этом логе будет последовательность адресов, страницы с которыми были подгружены при возврате. Самый простой способ, но асинхронный.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=367979&amp;user=40990&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=10" class="addthx" data-post="367979"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 22:04 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<I>dosprog пишет:<br>... этот адрес возврата уменьшить на 6, ещё выше в стеке в аргументах того вызова LoadLibrary() найти ссылку на имя DLL и изменить ту строку-имя DLL для загрузки ...</I><br>Неясно, а зачем мне городить подмену имени?<br>Я ж писАл:<br>Внутри моей DllMain, гружу оригинальную dll. Запоминаю ее хэндл - базу загрузки.<br>На точке возврата в основном коде помещаю свой код (вернее вызов &quot;call МойКод&quot;).<br>В моем коде уже есть такое:<br>1. меняю в стеке адрес возврата из моего кода = адрес возврата - Length(&quot;call МойКод&quot;)<br>2. Восстанавливаю код в точке возврата.<br>3. Подменяю значение eax по выходу из моего кода на значение хэндла оригинальной длл.<br>4. Выгружаю свою длл.<br>Мой код возвращается в точку возврата, как-будто загрузилась оригинальная длл.<br><br>Наверное, для полного понимания картины надо добавить, что моя длл лежит в папке с программой, а оригинальная длл лежит в системной папке. Имена у них одинаковые.<br>Ну как-то так.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367980&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=11" class="addthx" data-post="367980"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]RAMZEZzz[/b]','')">RAMZEZzz</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/2753.jpg" alt=""><br><span class=txtSm>Ранг: 85.5 (постоянный), 16thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.77'>Активность: 0.04<span style='color:green'>&nearr;</span>0.05</span><br>Статус: <a href="action=userinfo&amp;user=2753">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 23:50 <br><script type="text/javascript">QU('RAMZEZzz','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=RAMZEZzz" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
<b>Kuzya69</b><br>А прокси dll не подойдет?<br>в своей dll грузите ориг dll и пробрасываете весь экспорт на ориг dll а в dllmain выполняете свой пэйлоад код<br>пример автоматизации создания dll есть <noindex><a href="https://habrahabr.ru/post/139065/" rel="nofollow" target="_blank"> здесь </a></noindex>, на форуме тоже вроде бы когда то пробегало подобное.<br><br>Я успешно использовал такой трюк в 2х или 3х проектах. ну будет в памяти висеть твоя dll, это же не критично?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367984&amp;user=2753&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=12" class="addthx" data-post="367984"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 23:53 <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
ну короч если кто не понял - это всё продолжение <noindex><a href="https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24224&amp;page=0.html" rel="nofollow" target="_blank"><u>вот этого</u></a></noindex> адского изврата.<br><br>сначала ТС пытался разрешить конфликт имён, теперь вот пыттается из своей дллмайн вернуть хендл той_другой_длл<br><br>и всё это потому, что более простой и универсальный путь почему-то показался более сложным.<br><br>по теме - а может, всё-таки стоит попробовать сделать полноценную длл-обёртку, если уж иначе никак?<br>вместо всех этих загрузок-выгрузок.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367985&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=13" class="addthx" data-post="367985"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2016 23:59 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
<I>Kuzya69 пишет:<br>Внутри моей DllMain, гружу оригинальную dll. Запоминаю ее хэндл - базу загрузки.<br>...<br>4. Выгружаю свою длл. </I><br><br>и пипец той оригинальной загруженной DLL.<br><br>Не надо измудряться короче.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367986&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=14" class="addthx" data-post="367986"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 00:21 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
<I>-=AkaBOSS=- пишет:<br>сначала ТС пытался разрешить конфликт имён, теперь вот пыттается из своей дллмайн вернуть хендл той_другой_длл<br><br>и всё это потому, что более простой и универсальный путь почему-то показался более сложным. </I><br>Не, обертка пока работает тоже. Но заметил я одну странность. В основном все ф-ции импортируются в главный код из этой длл через имена. Как-бы пофиг, написал прокладки-обертки, даже для недокументированных АПИ. Ведь нам на параметры наплевать (все параметры и так готовы уже к выполнению, надо только прыжок перенаправить.)<br>Но вот несколько АПИ-ф-ций импортировались через ординал-номер. И тут меня начали мучать очередные сомнения. А если версия длл окажется не той, например обновится. И получим трудно отлавливаемую бяку. Вот и пытаюсь найти более стабильное решение. А новую тему завел, потому, что как-бы вопрос изменился, и не совсем соответствует той теме.<br><I>dosprog пишет:<br>и пипец той оригинальной загруженной DLL. </I><br>Ну почему-же? А если на нее уже несколько ссылок. Ну или на крайняк, могу грузить оригинальную длл не в MainDll, а в &quot;своем коде&quot;. Хотя сейчас,  оригинальная длл, не выгружается вместе с моей длл, почему-то.<br>Но это вопрос не важный сейчас.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367990&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=15" class="addthx" data-post="367990"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 00:31 <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
<I>Kuzya69 пишет:<br>если версия длл окажется не той, например обновится. И получим трудно отлавливаемую бяку </I><br>по-моему, это несложно решить пересчётом хэша<br>хэш не совпал - сообщить пользователю, что все дальнейшие глюки на его совести<br><br>но кмк всё изначально стоило сделать иначе.<br>написать лоадер, которым собственно и внедрять свою длл в процесс.<br>если сильно нужен именно момент загрузки той_самой_длл, тогда хукать LoadLibrary и сравнивать имя, и действовать согласно ситуации.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367991&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=16" class="addthx" data-post="367991"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 00:45 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
<I>-=AkaBOSS=- пишет:<br>написать лоадер, которым собственно и внедрять свою длл в процесс. </I><br>Там уже и так.<br>1. моя длл, пока, является как-бы обработчиком таблицы фиксов. Ну еще там некоторую работу делает.<br>2. сами фиксы размещены в оверлее ехешника. Чтобы длл не зависела от версий самой программы.<br>И еще лоадер добавлять?<br>Длл хочется оставить в конце концов, полностью автономной. Но это позже, когда разработаю единый алгоритм для создания таблицы фиксов.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367992&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=17" class="addthx" data-post="367992"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 00:48 &middot; Поправил: -=AkaBOSS=- <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
в таком случае предлагаю такой изврат:<br>из длл выделять себе память, и писать туда код, который отгрузит твою длл и подгрузить ту_самую_длл<br>но с хэндлом всё равно сложно будет<br><br>лучше всё таки через лодырь.<br>больше свободы в плане действий, и нет необходимости морочиться с обратной подменой длл.<br>вот его как раз можно будет сделать автономным, и внедрять чисто базонезависимый код.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367993&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=18" class="addthx" data-post="367993"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:00 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#19');return false;">#19</a> </span><div align=left><br>
<I>-=AkaBOSS=- пишет:<br>из длл выделять себе память, и писать туда код, который отгрузит твою длл и подгрузить ту_самую_длл<br>но с хэндлом всё равно сложно будет  </I><br>Дык я так и делаю сейчас. У меня вопрос, только как автоматически определять адрес возврата в основной код, находясь в DllMain этой длл-ки.<br>Ну типа избавиться от постоянного поиска адреса возврата вручную. Это мне и в будущем пригодится, когда перестану писать фиксы в оверлей. А эти фиксы сама длл-ка научится вычислять.<br>А какие трудности-то с хэндлом? Вроде в моем случае, все работает. Апишки оригинальной длл работают нормально. Это если я меняю eax в конце загрузки моей длл на хэндл оригинальной длл.<br><I>-=AkaBOSS=- пишет:<br>лучше всё таки через лодырь. </I><br>Ну не очень просто темиду через лодырь патчить. Защита прям лютует, даже не дает АПИ-шки из кернел32 трогать, а в нтдлл страшновато лезть на автомате. А с длл я уже привык. Во первых она грузится, прямо в самый нужный момент, для первого патча.<br>К тому-же хочется как-то какой-то вариант определить. Я не спорю, есть у меня рабочие решения(два), но мне они пока не до конца нравятся. Боюсь, щас забью на это. Будет все работать нормально. А вот в какой-то момент, что-то изменится. Начнет моя реализация глючить, и буду долго вспоминать, где и что я делал. А так когда длл-ку закончу, успокоюсь, что ее уже ненадо мучать, можно будет про нее и забыть.<br>Но это лирика.<br>А советуюсь потому что думаю, может есть что-то, что я не знаю, а оно мне как раз нужно, для решения моего вопроса. Вот и жду, может кто натолкнет на путь истинный.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=367997&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=19" class="addthx" data-post="367997"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="20" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:10 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#20" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#20');return false;">#20</a> </span><div align=left><br>
<b>-=AkaBOSS=-</b><br><br>A. Загрузка модуля по желаемому адресу, что можно сделать на уровне загрузчика(или вручную загрузить, что тоже изврат) - вмешаться в процесс загрузки.<br><br>B. Перезагрузить либу после возврата из загрузчика.<br><br>Есть есчо одна важная деталь, загрузчик может использовать не системный, а левый. В этом случае вариант A не подходит, так же и по причине занятых ресурсов(норм нужно ждать пока поток покинет загрузчик, что бы никаких коллизий не возникло), получается что норм решение только B.<br><br>Выделить стек вызовов обычно просто, но тут наверно сложный случай, возможно он как то шифруется или быть может вм юзается. Необходимо определить критерий, который позволит событие возврата из лодера определить; это может быть выход за пределы загрузочного кода или есчо какие события. Запускайте трассировку из dllmain, хардверную(TF) или через какие софтверные реализации(pin etc).
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368000&amp;user=40990&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=20" class="addthx" data-post="368000"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="21" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:16 <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#21" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#21');return false;">#21</a> </span><div align=left><br>
<I>Kuzya69 пишет:<br>как автоматически определять адрес возврата в основной код, находясь в DllMain этой длл-ки. </I><br>универсального способа точно не найдёшь. инфа 100%<br>можно попробовать перехватить известную точку - возврат из LoadLibrary/LoadLibraryEx/LdrLoadDll (тоесть натурально зацепиться за mov esp, ebp/ret X), но можно наловить косяков если несколько потоков одновременно будут грузить библиотеки.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368001&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=21" class="addthx" data-post="368001"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="22" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:33 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#22" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#22');return false;">#22</a> </span><div align=left><br>
<I>-=AkaBOSS=- пишет:<br>можно попробовать перехватить известную точку - возврат из LoadLibrary/LoadLibraryEx/LdrLoadDll (тоесть натурально зацепиться за mov esp, ebp/ret X), но можно наловить косяков если несколько потоков одновременно будут грузить библиотеки.  </I><br>Ага, уже что-то более близкое к вопросу. Получается надо предусмотреть, чтоб поток был нужный. Теперь надо понять, что по вашему значит &quot;зацепиться за mov esp, ebp/ret X&quot;. <br>Предлагаете прерывание ставить, или просто джамп в свой код на проверку, момента сработки кода? <br>Или как? <br>По каким критериям лучше проверять потоки, что они свои-чужие?<br>С таким я еще не работал. Обычно просто изменения джампов или значений в памяти-регистрах приходится делать, для преодоления защиты.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368003&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=22" class="addthx" data-post="368003"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="23" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:36 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#23" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#23');return false;">#23</a> </span><div align=left><br>
<b>Kuzya69</b><br><br>Если у вас стандартный загрузчик юзается, то почему нельзя снять стек вызовов через например rEbp, если это так, то работает какая то надстройка над кодом, что маловероятно ?
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368005&amp;user=40990&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=23" class="addthx" data-post="368005"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="24" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:45 <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#24" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#24');return false;">#24</a> </span><div align=left><br>
<I>difexacaw пишет:<br>почему нельзя снять стек вызовов </I><br>чуть выше уже мелькало слово темида<br><I>Kuzya69 пишет:<br>Некоторые протекторы рвут связанную цепочку кадров вызова фукций. Да и нет уверенности, что вложенность ф-ций будет постоянной на разных ОС и программах.  </I><br><br><I>Kuzya69 пишет:<br>Теперь надо понять, что по вашему значит &quot;зацепиться за mov esp, ebp/ret X&quot;.  </I><br>я имел в виду не конкретно эпилог функции, но где-то близко к нему.<br>зацепиться - значит выбрать место и перехватить выполнение. уж как это провернуть - не мне решать)<br>можно эксепшн устроить, а можно и аккуратно джампом обойтись.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368006&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=24" class="addthx" data-post="368006"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="25" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:47 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#25" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#25');return false;">#25</a> </span><div align=left><br>
<I>difexacaw пишет:<br>Если у вас стандартный загрузчик юзается, то почему нельзя снять стек вызовов через например rEbp, если это так, то работает какая то надстройка над кодом, что маловероятно ? </I><br>Я ж пару постов назад написал. Темида. Вызывает она эти LoadLibrary из секции ВМ, потом работает эта ВМ через копии библиотек кернел32, адвапи32, и юсер32. У копий этих, базы загрузки иногда меняются. Ну вобщем много косяков. В какой-то из версий программы, вызов был вообще через retn-команду. Вобщем сложно придумать критерий, по которому можно однозначно сказать, что все, это уже закончился вызов LoadLibrary.<br><I>-=AkaBOSS=- пишет:<br>уж как это провернуть - не мне решать) </I><br>Ну, с этим понял, а по какому параметру надежнее потоки разделять, что они свои-чужие? <br>Просто прошу быструю подсказку, я конечно скоро полезу читать про потоки в букварь, но чтобы читая упор делать на нужные параметры.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368007&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=25" class="addthx" data-post="368007"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="26" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 01:52 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#26" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#26');return false;">#26</a> </span><div align=left><br>
Вот как выглядит стек на входе в DllMain, безо всяких фемид:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Это&nbsp;<span class="hl_char">[</span><span class="hl_registr">ESP</span><span class="hl_char">]</span>&nbsp;на&nbsp;входе&nbsp;в&nbsp;DllMain<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_number">0012F8A8</span>&nbsp;&nbsp;&nbsp;<span class="hl_number">7C9011A7</span>&nbsp;&nbsp;&nbsp;&nbsp;RETURN&nbsp;to&nbsp;ntdll<span class="hl_char">.</span><span class="hl_number">7C9011A7</span></li><li class="hl_l1"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;</li><li class="hl_l0"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;</li><li class="hl_l1"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;&nbsp;тут&nbsp;туева&nbsp;хуча&nbsp;всякого&nbsp;в&nbsp;стеке&nbsp;<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_number">0012FFA0</span>&nbsp;&nbsp;<span class="hl_char">|</span><span class="hl_number">7C801DA4</span>&nbsp;&nbsp;&nbsp;&nbsp;RETURN&nbsp;to&nbsp;kernel32<span class="hl_char">.</span><span class="hl_number">7C801DA4</span>&nbsp;from&nbsp;kernel32<span class="hl_char">.</span>LoadLibraryExA</li><li class="hl_l1"><span class="hl_number">0012FFA4</span>&nbsp;&nbsp;<span class="hl_char">|</span><span class="hl_number">00403000</span>&nbsp;&nbsp;&nbsp;&nbsp;ASCII&nbsp;<span class="hl_quote">&quot;dummy.dll&quot;</span></li><li class="hl_l0"><span class="hl_number">0012FFA8</span>&nbsp;&nbsp;<span class="hl_char">|</span><span class="hl_number">00000000</span></li><li class="hl_l1"><span class="hl_number">0012FFAC</span>&nbsp;&nbsp;<span class="hl_char">|</span><span class="hl_number">00000000</span></li><li class="hl_l0"><span class="hl_number">0012FFB0</span>&nbsp;&nbsp;<span class="hl_char">|</span>FFFFFFFF</li><li class="hl_l1"><span class="hl_number">0012FFB4</span>&nbsp;&nbsp;<span class="hl_char">|</span><span class="hl_number">7FFD7000</span></li><li class="hl_l0"><span class="hl_number">0012FFB8</span>&nbsp;&nbsp;<span class="hl_char">\</span><span class="hl_number">0012FFF0</span></li><li class="hl_l1"><span class="hl_number">0012FFBC</span>&nbsp;&nbsp;&nbsp;<span class="hl_number">0040100A</span>&nbsp;&nbsp;&nbsp;&nbsp;RETURN&nbsp;to&nbsp;caller<span class="hl_char">.</span><span class="hl_char">&lt;</span>ModuleEntryPoint<span class="hl_char">&gt;</span><span class="hl_char">+</span><span class="hl_number">0A</span>&nbsp;from&nbsp;<span class="hl_char">&lt;</span><span class="hl_function">JMP</span><span class="hl_char">.</span><span class="hl_char">&amp;</span>kernel32<span class="hl_char">.</span>LoadLibraryA<span class="hl_char">&gt;</span></li><li class="hl_l0"><span class="hl_number">0012FFC0</span>&nbsp;&nbsp;&nbsp;<span class="hl_number">00403000</span>&nbsp;&nbsp;&nbsp;&nbsp;ASCII&nbsp;<span class="hl_quote">&quot;dummy.dll&quot;</span></li><li class="hl_l1"><span class="hl_number">0012FFC4</span>&nbsp;&nbsp;&nbsp;<span class="hl_number">7C816D4F</span>&nbsp;&nbsp;&nbsp;&nbsp;RETURN&nbsp;to&nbsp;kernel32<span class="hl_char">.</span><span class="hl_number">7C816D4F</span>&nbsp;&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_function"><b>RET</b></span>&nbsp;TO&nbsp;DOS<span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">&gt;</span></li>        </ol>
    </div>
</div></div>
<br><br>Если без фемиды - то интересующий адрес (число, попадающее в диапазон [.401000..fFFffFF]), будет вторым таким по счёту в стеке.<br>Если с фемидой - надо определить, каким по счёту (из чисел, попадающих в диапазон [.401000..fFFffFF]), будет этот интересующий адрес.<br>Так и искать.<br><br>Но это жуткий костыль.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368009&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=26" class="addthx" data-post="368009"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="27" onfocus="this.blur()" href="JavaScript:di('[b]Kuzya69[/b]','')">Kuzya69</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 30.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.16'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29098">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 02:07 &middot; Поправил: Kuzya69 <br><script type="text/javascript">QU('Kuzya69','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kuzya69" target="_blank">Личное сообщение</a> &middot;  <a href="#27" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#27');return false;">#27</a> </span><div align=left><br>
<I>dosprog пишет:<br>Но это жуткий костыль. </I><br>Дык я в самом начале написал, что <i class=x><b>Изыскания в стеке с помощью ebp, не подходят.</b></i>. <br>К тому-же нет уверенности, что на всех ОС, этот номер будет один и тот-же. <br>По крайней мере пока меня заинтересовал метод с &quot;просеиванием&quot; потоков в эпилоге функции  LdrLoadDll, а потом, наверное, пошагово шлепать на конец LoadLibraryW. Но надо будет сначала знаний поднабрать про потоки.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368013&amp;user=29098&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=27" class="addthx" data-post="368013"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="28" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 02:13 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#28" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#28');return false;">#28</a> </span><div align=left><br>
<I>Kuzya69 пишет:<br>Дык я в самом начале написал, что Изыскания в стеке с помощью ebp, не подходят..  </I><br><br>Иногда другого выхода нет, <br>тем более, что такие &quot;тупые методы&quot; тоже работают.<br>Более или менее.<br><br>Дополнительное условие нахождения нужного адреса в стеке - это присутствие в следующем слове указателя на аргумент. Аргумент известен.<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368015&amp;user=35473&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=28" class="addthx" data-post="368015"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="29" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 02:20 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#29" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#29');return false;">#29</a> </span><div align=left><br>
Так загрузка заканчивается при возврате из системного лодера(LdrLoadDll()). Нужно только это место, что там дальше не важно. На этом месте можно выгрузиться и загрузить оригинальный модуль. Это стабильный механизм и есть апи для получения стека, RtlWalkFrameChain() etc. Но лучше как и сказал трассировать до нужного места, потому что стек может чем то быть испорчен(в случае протекторов).<br><br>&gt; &quot;просеиванием&quot; потоков в эпилоге функции LdrLoadDll<br><br>В этом случае с потоками никаких проблем не возникает, если конечно код не портить. Хотя конечно можно точку останова туда поставить.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368017&amp;user=40990&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=29" class="addthx" data-post="368017"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="30" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2016 02:30 <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#30" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=24339&amp;page=0#30');return false;">#30</a> </span><div align=left><br>
<I>Kuzya69 пишет:<br>Но надо будет сначала знаний поднабрать про потоки.  </I><br>хинт: TEB.ClientId.UniqueThread
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368018&amp;user=26242&amp;forum_n=5&amp;topic=24339&amp;page=0&amp;anchor=30" class="addthx" data-post="368018"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b> .  <b>1</b> . <a href="action=vthread&amp;forum=5&amp;topic=24339&amp;page=1.html">2</a> . <a href="action=vthread&amp;forum=5&amp;topic=24339&amp;page=1.html">&gt;&gt;</a></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> Как внутри DllMain, определить возврата  из загрузки длл в основной код?</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#31" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="5">
<input type="hidden" name="topic" value="24339">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=24339" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
