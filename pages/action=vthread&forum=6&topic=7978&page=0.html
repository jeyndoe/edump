<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Пишу переходник процедуры hasp, входе процедуру всё умирает... - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Пытаюсь написать переходник процедуры hasp и вставить его в исследуемую прогу. Получается какой то косяк и на входе процедуру всё умирает… Делаю согласно этой доки: С процедурой hasp() используются следующие девять параметров:">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=39467'>hgdagon</a>, <a target='_blank' href='?action=userinfo&amp;user=28016'>asfa</a> (+4 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Пишу переходник процедуры hasp, входе процедуру всё умирает...</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 12:41 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Пытаюсь написать переходник процедуры hasp и вставить его в исследуемую прогу. Получается какой то косяк и на входе процедуру всё умирает… Делаю согласно этой доки:<br><br>С процедурой hasp() используются следующие девять параметров:<br>hasp (Service, SeedCode, PortNum, Password1, Password2, Par1, Par2, Par3, Par4)<br><br>делаю так:<br><br><code>library hsp;<br><br>uses Winprocs;<br><br>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:longint); external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;;<br><br>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:longint); stdcall;<br>begin<br>hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9);<br>end;<br><br>exports _msg;<br><br>begin<br>end.</code><br><br><br>Отлаживаю идой:<br><br>Было (без вызова моей процедуры):<br><br><code>CODE:004AEBF2                 push    offset unk_4CEA1C<br>CODE:004AEBF7                 push    ebx<br>CODE:004AEBF8                 push    offset dword_4CEA14<br>CODE:004AEBFD                 push    offset dword_4CEA10<br>CODE:004AEC02                 mov     eax, ds:dword_4CEA0C<br>CODE:004AEC07                 push    eax<br>CODE:004AEC08                 mov     eax, ds:dword_4CEA08<br>CODE:004AEC0D                 push    eax<br>CODE:004AEC0E                 mov     eax, ds:dword_4CEA00<br>CODE:004AEC13                 push    eax<br>CODE:004AEC14                 mov     eax, ds:dword_4CEA04<br>CODE:004AEC19                 push    eax<br>CODE:004AEC1A                 push    3               ; передаётся 3<br>CODE:004AEC1C                 call    hasp</code><br><br>Захожу в hasp<br><br><code>CODE:004AE3E4 hasp proc near                          ; CODE XREF: sub_4AEB90+42 p<br>CODE:004AE3E4                                         ; sub_4AEBE4+38 p ...<br>CODE:004AE3E4 jmp     ds:__imp_hasp<br>CODE:004AE3E4 hasp endp</code><br><br>прыгаю:<br><br><code>Haspbc32.dll:0033413E haspbc32_hasp:<br>Haspbc32.dll:0033413E push    ebp<br>Haspbc32.dll:0033413F mov     ebp, esp<br>Haspbc32.dll:00334141 push    dword ptr [ebp+28h]<br>Haspbc32.dll:00334144 push    dword ptr [ebp+24h]<br>Haspbc32.dll:00334147 push    dword ptr [ebp+20h]<br>Haspbc32.dll:0033414A push    dword ptr [ebp+1Ch]<br>Haspbc32.dll:0033414D push    dword ptr [ebp+18h]<br>Haspbc32.dll:00334150 push    dword ptr [ebp+14h]<br>Haspbc32.dll:00334153 push    dword ptr [ebp+10h]<br>Haspbc32.dll:00334156 push    dword ptr [ebp+0Ch]<br>Haspbc32.dll:00334159 push    dword ptr [ebp+8]         ; передалась 3<br>Haspbc32.dll:0033415C call    near ptr unk_331120<br>Haspbc32.dll:00334161 add     esp, 24h<br>Haspbc32.dll:00334164 pop     ebp<br>Haspbc32.dll:00334165 retn    24h</code><br><br>После ret-а успешно возвращаемся.<br><br><br>Внедряю свою длл, в отлаживаемой программе заменяю вызов hasp на вызов _msg.<br><br>Стало:<br><br><code>CODE:004AEBF2 push    offset unk_4CEA1C<br>CODE:004AEBF7 push    ebx<br>CODE:004AEBF8 push    offset dword_4CEA14<br>CODE:004AEBFD push    offset dword_4CEA10<br>CODE:004AEC02 mov     eax, ds:dword_4CEA0C<br>CODE:004AEC07 push    eax<br>CODE:004AEC08 mov     eax, ds:dword_4CEA08<br>CODE:004AEC0D push    eax<br>CODE:004AEC0E mov     eax, ds:dword_4CEA00<br>CODE:004AEC13 push    eax<br>CODE:004AEC14 mov     eax, ds:dword_4CEA04<br>CODE:004AEC19 push    eax<br>CODE:004AEC1A push    3                               ; передаётся 3<br>CODE:004AEC1C call    dword ptr ds:_msg</code><br><br>Захожу в _msg<br><br><code>hsp.dll:003DC624 hsp__msg:<br>hsp.dll:003DC624 push    ebp<br>hsp.dll:003DC625 mov     ebp, esp<br>hsp.dll:003DC627 mov     eax, [ebp+14h]<br>hsp.dll:003DC62A push    eax<br>hsp.dll:003DC62B mov     eax, [ebp+18h]<br>hsp.dll:003DC62E push    eax<br>hsp.dll:003DC62F mov     eax, [ebp+1Ch]<br>hsp.dll:003DC632 push    eax<br>hsp.dll:003DC633 mov     eax, [ebp+20h]<br>hsp.dll:003DC636 push    eax<br>hsp.dll:003DC637 mov     eax, [ebp+24h]<br>hsp.dll:003DC63A push    eax<br>hsp.dll:003DC63B mov     eax, [ebp+28h]<br>hsp.dll:003DC63E push    eax<br>hsp.dll:003DC63F mov     ecx, [ebp+10h]<br>hsp.dll:003DC642 mov     edx, [ebp+0Ch]<br>hsp.dll:003DC645 mov     eax, [ebp+8]   ; тут оказывается передаваемая 3<br>hsp.dll:003DC648 call    near ptr unk_3DC61C  ; идём в оригинальный hasp<br>hsp.dll:003DC64D pop     ebp<br>hsp.dll:003DC64E retn    24h</code><br><br>переход<br><br><code>hsp.dll:003DC61C loc_3DC61C:                             ; CODE XREF: hsp.dll:003DC648 p<br>hsp.dll:003DC61C jmp     ds:off_3E06F4</code><br><br>оказались тут:<br><br><code>Haspbc32.dll:0033413E haspbc32_hasp:                          ; DATA XREF: hsp.dll:off_3E06F4 o<br>Haspbc32.dll:0033413E push    ebp<br>Haspbc32.dll:0033413F mov     ebp, esp<br>Haspbc32.dll:00334141 push    dword ptr [ebp+28h]<br>Haspbc32.dll:00334144 push    dword ptr [ebp+24h]<br>Haspbc32.dll:00334147 push    dword ptr [ebp+20h]<br>Haspbc32.dll:0033414A push    dword ptr [ebp+1Ch]<br>Haspbc32.dll:0033414D push    dword ptr [ebp+18h]<br>Haspbc32.dll:00334150 push    dword ptr [ebp+14h]<br>Haspbc32.dll:00334153 push    dword ptr [ebp+10h]<br>Haspbc32.dll:00334156 push    dword ptr [ebp+0Ch]<br>Haspbc32.dll:00334159 push    dword ptr [ebp+8]       ; тут уже не передаётся цифра 3<br>Haspbc32.dll:0033415C call    near ptr unk_331120    ; а тут всё умирает……<br>Haspbc32.dll:00334161 add     esp, 24h<br>Haspbc32.dll:00334164 pop     ebp<br>Haspbc32.dll:00334165 retn    24h</code>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123951&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=1" class="addthx" data-post="123951"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Chingachguk[/b]','')">Chingachguk</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/8962.jpg" alt=""><br><span class=txtSm>Ранг: 113.0 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.51'>Активность: 0.05<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=8962">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 13:26 <br><script type="text/javascript">QU('Chingachguk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Chingachguk" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
hsp.dll:003DC63F mov ecx, [ebp+10h] <br>hsp.dll:003DC642 mov edx, [ebp+0Ch] <br>hsp.dll:003DC645 mov eax, [ebp+8] ; тут оказывается передаваемая 3 <br>hsp.dll:003DC648 call near ptr unk_3DC61C ; идём в оригинальный hasp<br><br>Не очень понял - первые параметры переданы через регистры? Без перехвата вроде все в стеке - ?
<br><br><font size="1"><i>-----<br>The one derivative you manage is the one I abhore (c) Slipknot</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=123957&amp;user=8962&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=2" class="addthx" data-post="123957"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 14:35 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I>Chingachguk пишет:<br>Не очень понял - первые параметры переданы через регистры? </I><br><br>Да, сам не понимаю почему так происходит... Скорее всего проблема закралась именно дельфевском куске. Может нужно как то по-другому объявлять процедуру или не использовать stdcall, а может быть стек корректировать ...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123962&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=3" class="addthx" data-post="123962"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]ssx[/b]','')">ssx</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 352.4 (мудрец), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.96'>Активность: 0.15<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=33">Участник</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 14:52 <br><script type="text/javascript">QU('ssx','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ssx" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<I>Chingachguk пишет:<br>первые параметры переданы через регистры </I><br>fastcall ?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123963&amp;user=33&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=4" class="addthx" data-post="123963"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Chingachguk[/b]','')">Chingachguk</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/8962.jpg" alt=""><br><span class=txtSm>Ранг: 113.0 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.51'>Активность: 0.05<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=8962">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 17:12 <br><script type="text/javascript">QU('Chingachguk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Chingachguk" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Да, надо что-то уточнить чтобы паскаль не считал hasp &quot;своей&quot; и не выделывался... не совсем понятно почему ты вообще в модуле msg об&#039;являешь прототип hasp - ведь разве недостаточно объявить ~&quot;uses hsp&quot; (или как ты написал - &quot;library hsp&quot;) - в самой либе разве нету аналога *.h?
<br><br><font size="1"><i>-----<br>The one derivative you manage is the one I abhore (c) Slipknot</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=123968&amp;user=8962&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=5" class="addthx" data-post="123968"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 февраля 2007 23:45 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>Chingachguk пишет:<br>не совсем понятно почему ты вообще в модуле msg об&#039;являешь прототип hasp  </I><br><br>Я хочу что бы в программе функция hasp не вызывалась. Вместо неё будет вызываться _msg, в которой я реализую всё, что планирую, а далее вызову оригинальную hasp, что бы программа работала. Естественно, что по мере реализации эмулирующих функций буду избавлятся от вызова оригинальной hasp, но это всё только в перспективе.<br><br><I>ssx пишет:<br>fastcall ? </I><br><br>хз. Пробывал по-разному, и safecall делал и без указания вообще...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123983&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=6" class="addthx" data-post="123983"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 февраля 2007 00:06 &middot; Поправил: ToBad <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
В общем у меня получилось… Если кому то интересно, то приведу полный вид того, как это сейчас выглядит.<br><br>Этот участок до внедрения и после остаётся без изменений.<br><br><code>CODE:004AEC19                 push    eax<br>CODE:004AEC1A                 push    3             <br>CODE:004AEC1C                 call    hasp<br>CODE:004AEC21                 cmp     dword ptr [ebx], 0</code><br><br>Вызов приводит нас в:<br><br><code>CODE:004AE3E4 hasp            proc near               ; CODE XREF: sub_4AEB90+42 p<br>CODE:004AE3E4                                         ; sub_4AEBE4+38 p ...<br>CODE:004AE3E4                 jmp     ds:__imp_hasp<br>CODE:004AE3E4 hasp            endp</code><br><br>Тут мы меняем jmp на свой который указывает на _msg. Это позволит не патчить все вызовы hasp. Теперь это так:<br><br><code>CODE:004AE3E4 hasp proc near                          ; CODE XREF: sub_4AEB90+42 p<br>CODE:004AE3E4                                         ; sub_4AEBE4+38 p ...<br>CODE:004AE3E4 jmp     dword ptr ds:_msg<br>CODE:004AE3E4 hasp endp</code><br><br>Теперь вид переходника…<br> <br><code>library hsp;<br><br>uses Winprocs;<br><br>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;;<br><br>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); stdcall;<br>    var p:pointer;<br>begin<br>p:=@hasp;<br>asm<br>push a9<br>push a8<br>push a7<br>push a6<br>push a5<br>push a4<br>push a3<br>push a2<br>push a1<br>call p<br>end;<br>end;<br><br>exports _msg;<br><br>begin<br>end.</code><br><br>При отладке всё выглядит так:<br><br><code>CODE:004AEC19 push    eax<br>CODE:004AEC1A push    3                               ; наша тройка<br>CODE:004AEC1C call    hasp<br>CODE:004AEC21 cmp     dword ptr [ebx], 0</code><br><br>По call попадаем сюда:<br><br><code>CODE:004AE3E4 hasp proc near                          ; CODE XREF: sub_4AEB90+42 p<br>CODE:004AE3E4 jmp     dword ptr ds:_msg<br>CODE:004AE3E4 hasp endp</code><br><br>Потом по jmp сюда:<br><br><code>hsp.dll:003934D0 hsp__msg:<br>hsp.dll:003934D0 push    ebp<br>hsp.dll:003934D1 mov     ebp, esp<br>hsp.dll:003934D3 push    ecx<br>hsp.dll:003934D4 mov     dword ptr [ebp-4], offset unk_3934C8<br>hsp.dll:003934DB push    dword ptr [ebp+28h]<br>hsp.dll:003934DE push    dword ptr [ebp+24h]<br>hsp.dll:003934E1 push    dword ptr [ebp+20h]<br>hsp.dll:003934E4 push    dword ptr [ebp+1Ch]<br>hsp.dll:003934E7 push    dword ptr [ebp+18h]<br>hsp.dll:003934EA push    dword ptr [ebp+14h]<br>hsp.dll:003934ED push    dword ptr [ebp+10h]<br>hsp.dll:003934F0 push    dword ptr [ebp+0Ch]<br>hsp.dll:003934F3 push    dword ptr [ebp+8]   ; тройка тут<br>hsp.dll:003934F6 call    dword ptr [ebp-4]<br>hsp.dll:003934F9 pop     ecx<br>hsp.dll:003934FA pop     ebp<br>hsp.dll:003934FB retn    24h</code><br><br>Call сюда:<br><br><code>hsp.dll:003934C8 loc_3934C8:                             ; DATA XREF: hsp.dll:003934D4 o<br>hsp.dll:003934C8 jmp     ds:off_396108</code><br><br>И после jmp мы в оригинальной Hasp.<br><br><code>Haspbc32.dll:0033413E haspbc32_hasp:                          ; DATA XREF: hsp.dll:off_396108 o<br>Haspbc32.dll:0033413E push    ebp<br>Haspbc32.dll:0033413F mov     ebp, esp<br>Haspbc32.dll:00334141 push    dword ptr [ebp+28h]<br>Haspbc32.dll:00334144 push    dword ptr [ebp+24h]<br>Haspbc32.dll:00334147 push    dword ptr [ebp+20h]<br>Haspbc32.dll:0033414A push    dword ptr [ebp+1Ch]<br>Haspbc32.dll:0033414D push    dword ptr [ebp+18h]<br>Haspbc32.dll:00334150 push    dword ptr [ebp+14h]<br>Haspbc32.dll:00334153 push    dword ptr [ebp+10h]<br>Haspbc32.dll:00334156 push    dword ptr [ebp+0Ch]<br>Haspbc32.dll:00334159 push    dword ptr [ebp+8]   ; тройка опять тут…<br>Haspbc32.dll:0033415C call    near ptr unk_331120<br>Haspbc32.dll:00334161 add     esp, 24h<br>Haspbc32.dll:00334164 pop     ebp<br>Haspbc32.dll:00334165 retn    24h</code><br><br>Всё работает…<br><br>Конечно для меня так и осталось загадкой почему не сработал изначальный вариант, ведь вроде не было грубых ошибок ?<br><br><code>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:longint); stdcall; <br>begin <br>hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9); <br>end;</code><br><br>Я предполагал, что такая конструкция сама собой предполагает корректную передачу параметров, но выходит, ошибался…<br><br>Спасибо всем, кто пытался помочь ! Тему не закрываю, дабы дать возможность высказаться тем, кто знает в чём была ошибка…<br><br>p.s. Если модераторов не затруднит, прошу подредактировать название топика и добавить пропущенное. Предполагалось так: <i class=x>Пишу переходник процедуры hasp, при входе в процедуру всё умирает</i>...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123985&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=7" class="addthx" data-post="123985"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Xserg[/b]','')">Xserg</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 24.9 (новичок)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.7'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7451">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 февраля 2007 00:31 <br><script type="text/javascript">QU('Xserg','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Xserg" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<I>ToBad пишет:<br>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;; <br>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); stdcall; </I><br><br>Правильно будет:<br>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); ); stdcall;  external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;; <br>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); stdcall;<br>или<br>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); ); external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;; <br>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword);<br><br>stdcall – это в какой последовательности запихивать a1…a9 в стек
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123988&amp;user=7451&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=8" class="addthx" data-post="123988"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 февраля 2007 00:50 &middot; Поправил: ToBad <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>Xserg</b> - не много не понял, чем мой вариант в твоём посте отличается от твоего второго. За исключением лишних скобок ? Эта конструкция:<br><br><code>procedure Hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); ); stdcall; external &#039;Haspbc32.dll&#039; name &#039;hasp&#039;;</code><br><br>Работает как нужно ! Теперь можно писать:<br><br><code>procedure _msg(a1,a2,a3,a4,a5,a6,a7,a8,a9:dword); stdcall;<br>begin<br>hasp(a1,a2,a3,a4,a5,a6,a7,a8,a9);<br>end;</code><br><br>И в отладчике будет это:<br><br><code>hsp.dll:003934D0 hsp__msg:<br>hsp.dll:003934D0 push    ebp<br>hsp.dll:003934D1 mov     ebp, esp<br>hsp.dll:003934D3 mov     eax, [ebp+28h]<br>hsp.dll:003934D6 push    eax<br>hsp.dll:003934D7 mov     eax, [ebp+24h]<br>hsp.dll:003934DA push    eax<br>hsp.dll:003934DB mov     eax, [ebp+20h]<br>hsp.dll:003934DE push    eax<br>hsp.dll:003934DF mov     eax, [ebp+1Ch]<br>hsp.dll:003934E2 push    eax<br>hsp.dll:003934E3 mov     eax, [ebp+18h]<br>hsp.dll:003934E6 push    eax<br>hsp.dll:003934E7 mov     eax, [ebp+14h]<br>hsp.dll:003934EA push    eax<br>hsp.dll:003934EB mov     eax, [ebp+10h]<br>hsp.dll:003934EE push    eax<br>hsp.dll:003934EF mov     eax, [ebp+0Ch]<br>hsp.dll:003934F2 push    eax<br>hsp.dll:003934F3 mov     eax, [ebp+8]<br>hsp.dll:003934F6 push    eax<br>hsp.dll:003934F7 call    near ptr unk_3934C8<br>hsp.dll:003934FC pop     ebp<br>hsp.dll:003934FD retn    24h</code><br><br>Параметры передаются правильно и в полном объёме, а не через регистры как у меня в первом посте...<br><b>Xserg</b> - Спасибо !
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=123990&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=9" class="addthx" data-post="123990"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]TretS[/b]','')">TretS</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 38.9 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.21'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1705">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 февраля 2007 01:53 <br><script type="text/javascript">QU('TretS','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=TretS" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
Для передачи параметров черес стек в дельфях используй:<br>Напимер<br>function _SLM_CreateManager(arg1, arg2, arg3, arg4, arg5: DWORD):DWORD; cdecl; external &#039;_sanctuarylib.dll&#039; name &#039;SLM_CreateManager&#039;;<br><br><br>cdtcl
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=124010&amp;user=1705&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=10" class="addthx" data-post="124010"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 февраля 2007 07:16 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=7978.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<I>TretS пишет:<br>Для передачи параметров через стек в дельфях используй: cdtcl</I><br><br>Спасибо !<br><br>Во всём разобрался, тему закрываю, всем ещё раз огромное спасибо за помощь !
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=124240&amp;user=702&amp;forum_n=6&amp;topic=7978.html&amp;page=0&amp;anchor=11" class="addthx" data-post="124240"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Пишу переходник процедуры hasp, входе процедуру всё умирает...</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=7978" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
