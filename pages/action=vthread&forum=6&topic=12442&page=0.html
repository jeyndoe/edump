<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Lcc Win32 - как избавиться от хлама и установить свою точку входа? - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Доброго времени суток! [Запостил также данный вопрос на васм, но там ответов пока нет... может здесь кто знает] Вопрос в следующем. Вот код моего простейшего хелловорда: #include &lt;windows.h&gt; void main() { 	MessageBox(0,">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=1533'>rmn</a>, <a target='_blank' href='?action=userinfo&amp;user=8344'>Magister Yoda</a>, <a target='_blank' href='?action=userinfo&amp;user=50833'>vasilevradislav</a>, <a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a> (+6 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Lcc Win32 - как избавиться от хлама и установить свою точку входа?</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]alexey_k[/b]','')">alexey_k</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 135.2 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.79'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=6716">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 31 июля 2008 15:37 <br><script type="text/javascript">QU('alexey_k','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=alexey_k" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=12442.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Доброго времени суток!<br><br>[Запостил также данный вопрос на васм, но там ответов пока нет... может здесь кто знает]<br><br>Вопрос в следующем. Вот код моего простейшего хелловорда:<br><br><code>#include &lt;windows.h&gt;<br><br>void main()<br>{<br>	MessageBox(0, &quot;hello world&quot;, &quot;(_._)&quot;, MB_OK|MB_ICONINFORMATION);<br>	ExitProcess(0);<br>}</code><br><br>Размер exe получается нормальный - 3.1 кб, но вот пихает lcc туда много лишнего:<br><br><code>mov     eax, large fs:0<br>push    ebp<br>mov     ebp, esp<br>push    0FFFFFFFFh<br>push    offset unk_40201C<br>push    offset sub_40109A<br>push    eax<br>mov     large fs:0, esp<br>sub     esp, 10h<br>push    ebx<br>push    esi<br>push    edi<br>mov     [ebp+var_18], esp<br>push    eax<br>fnstcw  [esp+30h+var_30]<br>or      [esp+30h+var_30], 300h<br>fldcw   [esp+30h+var_30]<br>add     esp, 4<br>push    0<br>push    0<br>push    offset dword_402028<br>push    offset dword_402024<br>push    offset dword_402020<br>call    __GetMainArgs<br>push    dword_402028<br>push    dword_402024<br>push    dword_402020<br>mov     dword_402014, esp<br>call    sub_40129C ; &lt;&lt;-- и только тут будет вызвана ф-ия main<br>add     esp, 18h<br>xor     ecx, ecx<br>mov     [ebp+var_4], ecx<br>push    eax             ; int<br>call    exit</code><br><br>Плюс ко всему в импорте лишнего напихано <img src="img/smilies/s9.gif" alt=""><br><br>в VC подобные траблы просто решаются (изменяем точку входа + отключаем стандартную либу), а вот как подобное сотворить с LCC?<br><br>ЗЫ<br>Код пишется в среде RadASM, lcc 3.2<br><br>Зарание спасибо.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=197368&amp;user=6716&amp;forum_n=6&amp;topic=12442.html&amp;page=0&amp;anchor=1" class="addthx" data-post="197368"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]alexey_k[/b]','')">alexey_k</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 135.2 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.79'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=6716">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 31 июля 2008 21:15 <br><script type="text/javascript">QU('alexey_k','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=alexey_k" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=12442.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Проблема решена.<br>На самом деле lcc (как и borland C++/C++ Builder) не позволяет менять точку входа (кроме случая с DLL), а посему напишим свой startup-код без всякого мусора.<br><br>стандартный стартовый код для сборки EXE лежит в файле lcccrt0s.obj.<br>важный для нас кусок кода (из IDA):<br><code><br>.text:00000219 _mainCRTStartup proc near<br>.text:00000219<br>.text:00000219 var_30          = word ptr -30h<br>.text:00000219 var_18          = dword ptr -18h<br>.text:00000219 var_4           = dword ptr -4<br>.text:00000219<br>.text:00000219                 mov     eax, large fs:0<br>.text:0000021F                 push    ebp<br>.text:00000220                 mov     ebp, esp<br>.text:00000222                 push    0FFFFFFFFh<br>.text:00000224                 push    offset _&#036;ExcepData<br>.text:00000229                 push    offset __except_handler3<br>.text:0000022E                 push    eax<br>.text:0000022F                 mov     large fs:0, esp<br>.text:00000236                 sub     esp, 10h<br>.text:00000239                 push    ebx<br>.text:0000023A                 push    esi<br>.text:0000023B                 push    edi<br>.text:0000023C                 mov     [ebp+var_18], esp<br>.text:0000023F                 push    eax<br>.text:00000240                 fnstcw  [esp+30h+var_30]<br>.text:00000243                 or      [esp+30h+var_30], 300h<br>.text:00000249                 fldcw   [esp+30h+var_30]<br>.text:0000024C                 add     esp, 4<br>.text:0000024F                 push    0<br>.text:00000251                 push    0<br>.text:00000253                 push    offset __environ<br>.text:00000258                 push    offset ___argv<br>.text:0000025D                 push    offset ___argc<br>.text:00000262                 call    __GetMainArgs<br>.text:00000267                 push    __environ<br>.text:0000026D                 push    ___argv<br>.text:00000273                 push    ___argc<br>.text:00000279                 mov     __InitialStack, esp<br>.text:0000027F                 call    _main<br>.text:00000284                 add     esp, 18h<br>.text:00000287                 xor     ecx, ecx<br>.text:00000289                 mov     [ebp+var_4], ecx<br>.text:0000028C                 push    eax<br>.text:0000028D                 call    _exit<br>.text:0000028D _mainCRTStartup endp<br></code><br><br>Самый важный для нас момент - стартовая ф-ия должна носить имя _mainCRTStartup.<br>Всё. Можно приступить к написанию собственного начального кода.<br><br><code>.386P<br>.model flat<br>                <br>ASSUME   CS: FLAT, DS: FLAT, SS: FLAT, ES: FLAT<br><br>;--------------------------------------------------------------------- -<br>; Code segment<br><br>_TEXT           SEGMENT PUBLIC DWORD USE32 PUBLIC &#039;text&#039;<br>_TEXT           ENDS<br><br>;--------------------------------------------------------------------- -<br>; External function definitions<br><br>_TEXT           SEGMENT PUBLIC DWORD USE32 PUBLIC &#039;text&#039;<br><br>EXTRN           _main:NEAR<br><br>_TEXT           ENDS<br><br>;--------------------------------------------------------------------- -<br>; Startup code<br><br>_TEXT           SEGMENT  DWORD USE32 PUBLIC &#039;text&#039;<br><br>                public _mainCRTStartup<br>_mainCRTStartup      PROC NEAR<br><br>               jmp     _main<br><br>_mainCRTStartup      ENDP<br><br>_TEXT           ENDS<br><br>                END     _mainCRTStartup</code><br><br>К0мпелируем это дело в masm32. Получив obj-файл переименовываем в lcccrt0s.obj кидаем в папку с либой lcc (C:\lcc\lib).<br><br>Вот так вот.<br><br>Тему закрываю
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=197406&amp;user=6716&amp;forum_n=6&amp;topic=12442.html&amp;page=0&amp;anchor=2" class="addthx" data-post="197406"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Lcc Win32 - как избавиться от хлама и установить свою точку входа?</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=12442" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
