<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Кривые хуки системных библиотек - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Всем доброго времени суток! Неоднократно встречал не особо умные хуки на системных функциях из kernel32, user32, advapi и т.п. Это когда хук ставится вписыванием long jmp (E9h) в начало функции, что зачастую бывает критично для">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=8344'>Magister Yoda</a>, <a target='_blank' href='?action=userinfo&amp;user=19256'>johnniewalker</a>, <a target='_blank' href='?action=userinfo&amp;user=55914'>Kybyx</a>, <a target='_blank' href='?action=userinfo&amp;user=40607'>vsv1</a>, <a target='_blank' href='?action=userinfo&amp;user=42610'>r0lka</a>, <a target='_blank' href='?action=userinfo&amp;user=28512'>-Sanchez-</a>, <a target='_blank' href='?action=userinfo&amp;user=55550'>testrev1337</a> (+3 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Кривые хуки системных библиотек</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 февраля 2011 22:30 &middot; Поправил: Smon <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Всем доброго времени суток! <img src="img/smilies/s1.gif" alt=""><br>Неоднократно встречал не особо умные хуки на системных функциях из kernel32, user32, advapi и т.п.<br>Это когда хук ставится вписыванием long jmp (E9h) в начало функции, что зачастую бывает критично для совместимости, подобные были например в более ранних версиях KIS и KAV (до 8ки) или в небезызвестном CryptoPro CSP. Адекватные хуки пишутся например в таблицу экспорта библиотеки, через дрова, ну и прочими вариациями.<br>Вопрос - есть ли надёжный и простой способ определения, захучена ли вообще заданная системная библиотека таким костыльным способом или нет? Есть конечно вариант проверять начала всех функций из экспорта (вплоть до дизасма нескольких инструкций) и проверка их на переходы за пределы библиотеки, но это долго и не совсем ясно с реализацией и надёжностью метода - ведь системные библы имеют и форварды друг в друга. Да и медленно это очень. Неужели rku юзает именно такой способ ?<br>PS: вариант мапить &quot;вручную&quot; системные библиотеки в процессе, обрабатывать релоки, и сравнивать crc двух аналогичных секций кода конечно есть, но опять таки он довольно муторен в реализации, хотя похоже и понадежней чем дизасм.
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277887&amp;user=1449&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=1" class="addthx" data-post="277887"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=29292" title="03-06-2011 16:42, ранг:0.0" target="_blank">mikus</a></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 февраля 2011 22:59 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Описать код графом и сравнить его с оригинальным. Иначе никак.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277891&amp;user=17964&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=2" class="addthx" data-post="277891"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=29292" title="03-06-2011 16:42, ранг:0.0" target="_blank">mikus</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]HiEndsoft[/b]','')">HiEndsoft</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 237.0 (наставник), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.74'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=13651">Участник</a><br><font color=blue>sysenter</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 февраля 2011 23:08 <br><script type="text/javascript">QU('HiEndsoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HiEndsoft" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
Что касается паблик RkU, то он очевидно сравнивает 1-е 5 байт с оригиналом, т.к. если поставить джамп дальше он его не увидит.
<br><br><font size="1"><i>-----<br>продавец резиновых утёнков</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277893&amp;user=13651&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=3" class="addthx" data-post="277893"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=29292" title="03-06-2011 16:42, ранг:0.0" target="_blank">mikus</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]PE_Kill[/b]','')">PE_Kill</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3232.gif" alt=""><br><span class=txtSm>Ранг: 793.4 <font color=magenta>(<b>! !</b>)</font>, 568thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.59'>Активность: 0.74<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=3232">Участник</a><br><font color=blue>Шаман</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 08:13 <br><script type="text/javascript">QU('PE_Kill','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=PE_Kill" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
ИМХО только мапить, настраивать релоки и сравнивать первые N байт начала функций.
<br><br><font size="1"><i>-----<br>Yann Tiersen best and do not fuck</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277908&amp;user=3232&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=4" class="addthx" data-post="277908"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=29292" title="03-06-2011 16:42, ранг:0.0" target="_blank">mikus</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Vovan666[/b]','')">Vovan666</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 617.3 (<b>!</b>), 677thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.06'>Активность: 0.54<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5291">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 10:49 <br><script type="text/javascript">QU('Vovan666','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vovan666" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Можно еще проверять Checksum, мало кто ее правит после патча.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277914&amp;user=5291&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=5" class="addthx" data-post="277914"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 11:30 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
Чексам загруженного образа в любом случае не сойдётся, хотя бы из-за релоков.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277915&amp;user=1556&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=6" class="addthx" data-post="277915"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]ELF_7719116[/b]','')">ELF_7719116</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 419.0 (мудрец), 647thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.73'>Активность: 0.46<span style='color:green'>&nearr;</span>0.51</span><br>Статус: <a href="action=userinfo&amp;user=26651">Участник</a><br><font color=blue>&quotТибериумный реверсинг&quot</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 11:39 &middot; Поправил: ELF_7719116 <br><script type="text/javascript">QU('ELF_7719116','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ELF_7719116" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<i class=x>long jmp (E9h) в начало функции, что зачастую бывает критично для совместимости</i><br>Уточнение: В подавляющем случае он ложится на MOV EDI, EDI + открытые кадра стека. Дальше редко кто лезет, чтобы не дисасемблить. На этом можно сыграть.<br>проверять checksum - может неплохая идея(связать ее секцией кода).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277916&amp;user=26651&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=7" class="addthx" data-post="277916"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]ClockMan[/b]','')">ClockMan</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/17432.jpg" alt=""><br><span class=txtSm>Ранг: 568.2 (<b>!</b>), 464thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.99'>Активность: 0.55<span style='color:green'>&nearr;</span>0.57</span><br>Статус: <a href="action=userinfo&amp;user=17432">Участник</a><br><font color=blue>оптимист</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 11:56 <br><script type="text/javascript">QU('ClockMan','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ClockMan" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<I>Smon пишет:<br>Адекватные хуки пишутся например в таблицу экспорта библиотеки </I><br>И высчитываются легко тк обычно указывают за пределы секции кода бибблиотеки,поэтому умный хук ставится по опосля 3-4 комманд ;)
<br><br><font size="1"><i>-----<br>Чтобы правильно задать вопрос, нужно знать большую часть  ответа. Р.Шекли.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277917&amp;user=17432&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=8" class="addthx" data-post="277917"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 12:15 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<I>ClockMan пишет:<br>И высчитываются легко тк обычно указывают за пределы секции кода бибблиотеки,поэтому умный хук ставится по опосля 3-4 комманд ;)  </I><br>Я говорил о подмене адреса в экспорте, а опосля 3-4 команд это те же костыли и грабли что и непосредственно в самое начало.<br><br>Про чексумму тоже уже думал, как раз из за релоков не подходит такой вариант, хотя конечно и можно попробовать переобработать релоки в копии на базу которая прописана в хидере. Похоже вариант с мапом, обработкой релоков и последующим сравнением всё же наиболее правильный и надёжный.
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277918&amp;user=1449&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=9" class="addthx" data-post="277918"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 12:43 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<I>Smon пишет:<br>Неоднократно встречал не особо умные хуки на системных функциях из kernel32, user32, advapi и т.п.Это когда хук ставится вписыванием long jmp (E9h) в начало функции </I><br>Не особо умные - это те разработчики, что ставят такие хуки не обрабатывая rel32 команды и еще те, которые эти хуки пытаются убрать не проверив не похукано ли сверху. Отсюда и проблемы совместимости.<br>На 32х битных виндах начиная с XP SP1 предусмотрен специальный механизм хотпатчей для постановки безопасных хуков сплайсом, для этого заменяем mov edi, edi на jmp &#036;-5, и в нопах находящихся перед функцией прописываем long jmp куда надо.<br><br><I>Smon пишет:<br> Адекватные хуки пишутся например в таблицу экспорта библиотеки, через дрова, ну и прочими вариациями. </I><br>Вот только такие хуки можно ставить лишь в момент загрузки библиотеки. После уже поздно. Еще они не ловят вызов функций библиотеки из её самой же.<br><br><I>Smon пишет:<br>Вопрос - есть ли надёжный и простой способ определения, захучена ли вообще заданная системная библиотека таким костыльным способом или нет? Есть конечно вариант проверять начала всех функций из экспорта (вплоть до дизасма нескольких инструкций) и проверка их на переходы за пределы библиотеки, но это долго и не совсем ясно с реализацией и надёжностью метода </I><br>Реализация тривиальна: идем по одной инструкции вниз до ret или rel32 команды, переходим по jmp rel8, не забываем ограничить число проверяемых команд чтоб не попасть в бесконечный цикл. Кода то тьфу.<br><br><I>Smon пишет:<br>Похоже вариант с мапом, обработкой релоков и последующим сравнением всё же наиболее правильный и надёжный. </I><br>+100, вариант самый правильный и не так сложен как кажется. Только если задача - искать особо хитрые руткиты, то надо озаботиться низкоуровневым чтением файлов с диска, а то туда могут подставлять что надо.
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277920&amp;user=12867&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=10" class="addthx" data-post="277920"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 12:49 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<b>Smon</b><br>&gt; как раз из за релоков не подходит такой вариант<br>Всё подходит, просто нужно дельту пересчитать. Смотрим:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">ULONG</li><li class="hl_l1">LdrRelocateImage&nbsp;<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;PVOID&nbsp;NewBase<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;PUCHAR&nbsp;LoaderName<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;ULONG&nbsp;Success<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;ULONG&nbsp;Conflict<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>IN</b></span>&nbsp;ULONG&nbsp;Invalid</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">*</span><span class="hl_char">+</span><span class="hl_char">+</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">Routine&nbsp;Description<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>This</b></span>&nbsp;routine&nbsp;relocates&nbsp;an&nbsp;image&nbsp;file&nbsp;that&nbsp;was&nbsp;<span class="hl_function"><b>not</b></span>&nbsp;loaded&nbsp;<span class="hl_function"><b>into</b></span>&nbsp;memory</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;the&nbsp;preferred&nbsp;address<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Arguments<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;NewBase&nbsp;<span class="hl_char">-</span>&nbsp;Supplies&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;image&nbsp;base<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;LoaderName&nbsp;<span class="hl_char">-</span>&nbsp;Indicates&nbsp;which&nbsp;loader&nbsp;routine&nbsp;is&nbsp;being&nbsp;called&nbsp;from<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Success&nbsp;<span class="hl_char">-</span>&nbsp;Value&nbsp;to&nbsp;return&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;relocation&nbsp;successful<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Conflict&nbsp;<span class="hl_char">-</span>&nbsp;Value&nbsp;to&nbsp;return&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;can't relocate.</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Invalid&nbsp;<span class="hl_char">-</span>&nbsp;Value&nbsp;to&nbsp;return&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;relocations&nbsp;are&nbsp;invalid<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Return&nbsp;Value<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Success&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;image&nbsp;is&nbsp;relocated<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;Conflict&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;image&nbsp;can't be relocated.</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Invalid&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;image&nbsp;contains&nbsp;invalid&nbsp;fixups<span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">-</span><span class="hl_char">-</span><span class="hl_char">*</span><span class="hl_char">/</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;LONG_PTR&nbsp;Diff<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;TotalCountBytes<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG_PTR&nbsp;VA<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG_PTR&nbsp;OldBase<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;SizeOfBlock<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;FixupVA<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;USHORT&nbsp;<span class="hl_function"><b>Offset</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PUSHORT&nbsp;NextOffset<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_NT_HEADERS&nbsp;NtHeaders<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_BASE_RELOCATION&nbsp;NextBlock<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;RTL_PAGED_CODE<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;NtHeaders&nbsp;<span class="hl_char">=</span>&nbsp;RtlImageNtHeader<span class="hl_char">(</span>&nbsp;NewBase&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>&nbsp;NtHeaders&nbsp;<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OldBase&nbsp;<span class="hl_char">=</span>&nbsp;NtHeaders<span class="hl_char">-</span><span class="hl_char">&gt;</span>OptionalHeader<span class="hl_char">.</span>ImageBase<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Invalid<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Locate&nbsp;the&nbsp;relocation&nbsp;<span class="hl_function">section</span><span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;NextBlock&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_BASE_RELOCATION<span class="hl_char">)</span>RtlImageDirectoryEntryToData<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NewBase<span class="hl_char">,</span>&nbsp;<span class="hl_function">TRUE</span><span class="hl_char">,</span>&nbsp;IMAGE_DIRECTORY_ENTRY_BASERELOC<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>TotalCountBytes<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>NextBlock&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span>&nbsp;<span class="hl_char">!</span>TotalCountBytes<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;The&nbsp;image&nbsp;does&nbsp;<span class="hl_function"><b>not</b></span>&nbsp;contain&nbsp;a&nbsp;relocation&nbsp;table<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;therefore</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;cannot&nbsp;be&nbsp;relocated<span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l1">#if&nbsp;DBG</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint<span class="hl_char">(</span><span class="hl_quote">&quot;%s: Image can't be relocated, no fixup information.\n&quot;</span><span class="hl_char">,</span>&nbsp;LoaderName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">#endif&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;DBG</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Conflict<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;<span class="hl_function"><b>If</b></span>&nbsp;the&nbsp;image&nbsp;has&nbsp;a&nbsp;relocation&nbsp;table<span class="hl_char">,</span>&nbsp;then&nbsp;apply&nbsp;the&nbsp;specified&nbsp;fixup</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;information&nbsp;to&nbsp;the&nbsp;image<span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span>TotalCountBytes<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfBlock&nbsp;<span class="hl_char">=</span>&nbsp;NextBlock<span class="hl_char">-</span><span class="hl_char">&gt;</span>SizeOfBlock<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalCountBytes&nbsp;<span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;SizeOfBlock<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfBlock&nbsp;<span class="hl_char">-</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_BASE_RELOCATION<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfBlock&nbsp;<span class="hl_char">/</span><span class="hl_char">=</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>USHORT<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NextOffset&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PUSHORT<span class="hl_char">)</span><span class="hl_char">(</span><span class="hl_char">(</span>PCHAR<span class="hl_char">)</span>NextBlock&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_BASE_RELOCATION<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VA&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>ULONG_PTR<span class="hl_char">)</span>NewBase&nbsp;<span class="hl_char">+</span>&nbsp;NextBlock<span class="hl_char">-</span><span class="hl_char">&gt;</span>VirtualAddress<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Diff&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PCHAR<span class="hl_char">)</span>NewBase&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_char">(</span>PCHAR<span class="hl_char">)</span>OldBase<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>&nbsp;<span class="hl_char">!</span><span class="hl_char">(</span>NextBlock&nbsp;<span class="hl_char">=</span>&nbsp;LdrProcessRelocationBlock<span class="hl_char">(</span>VA<span class="hl_char">,</span>SizeOfBlock<span class="hl_char">,</span>NextOffset<span class="hl_char">,</span>Diff<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">)</span>&nbsp;{</li><li class="hl_l1">#if&nbsp;DBG</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint<span class="hl_char">(</span><span class="hl_quote">&quot;%s: Unknown base relocation type\n&quot;</span><span class="hl_char">,</span>&nbsp;LoaderName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">#endif</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Invalid<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Success<span class="hl_comment">;</span></li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br>Тоесть смещение для поправки вычисляется на основе базы из хидера, ну это понятно. Значит на время вызова этой функции туда нужно закрузить необходимое значение. Функа не экспортируется, но легко находится по двум инструкция [push 0xC000007B] - [push 0xC0000018] передающим статусы. Тоесть фиксим имя уже загруженного модуля в загрузчике, загружаем его есчо раз через LdrLoadDll(), при этом перехватываем LdrRelocateImage() например установив на неё брейк или протрассировав загрузчик.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277921&amp;user=17964&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=11" class="addthx" data-post="277921"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]PE_Kill[/b]','')">PE_Kill</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3232.gif" alt=""><br><span class=txtSm>Ранг: 793.4 <font color=magenta>(<b>! !</b>)</font>, 568thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.59'>Активность: 0.74<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=3232">Участник</a><br><font color=blue>Шаман</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 13:11 <br><script type="text/javascript">QU('PE_Kill','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=PE_Kill" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
<b>Clerk</b> Зачем такие извращения, если можно свой код нативный написать. Отмапить секции через CreateFileMapping с флагом SEC_IMAGE и пересчитать релоки на нужную базу, там кода то всего ничего.
<br><br><font size="1"><i>-----<br>Yann Tiersen best and do not fuck</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277923&amp;user=3232&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=12" class="addthx" data-post="277923"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 13:12 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<b>ntldr</b><br>&gt; искать особо хитрые руткиты<br>Приличные руткиты патч не юзают и кодосекции не изменяют модулей. Есть большое число способов перехватывать функции так, что ничего не будет обнаружено.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277924&amp;user=17964&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=13" class="addthx" data-post="277924"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 13:17 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
<b>PE_Kill</b><br>Зачем его писать, если он уже есть непосредственно готовый бинарный <img src="img/smilies/s11.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277925&amp;user=17964&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=14" class="addthx" data-post="277925"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 13:31 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
<I>Clerk пишет:<br>Зачем его писать, если он уже есть непосредственно готовый бинарный </I><br>Затем, чтобы работало. Поиск неэкспортируемых функций по сигнатурам это мега-ахтунг, такое допустимо если иначе вообще никак. Я вот даже недокументированные в MSDN функции стараюсь использовать лишь по большой нужде, очень способствует отсутствию проблем.
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277927&amp;user=12867&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=15" class="addthx" data-post="277927"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 13:48 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
<b>ntldr</b><br>&gt; Поиск неэкспортируемых функций по сигнатурам это мега-ахтунг<br>Мегатупость это писать загрузчики, делая всё вручную. И искать не нужно ничего, если используется трассировка загрузчика, то для каждого процедурного ветвления проверять в стеке строку (00 00 00 00 18 00 00 C0 7B 00 00 C0). Тоесть псевдокод более чем прост:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>if</b></span>&nbsp;OPCODE<span class="hl_char">(</span>CONTEXT<span class="hl_char">.</span>rEip<span class="hl_char">)</span>&nbsp;<span class="hl_char">=</span>&nbsp;OPCODE<span class="hl_char">(</span><span class="hl_function"><b>Call</b></span>&nbsp;<span class="hl_function"><b>near</b></span>&nbsp;<span class="hl_function">ptr</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">[</span>CONTEXT<span class="hl_char">.</span>rEsp<span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;0xC000007BC000001800000000</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPTIONAL_HEADER<span class="hl_char">.</span>ImageBase&nbsp;<span class="hl_char">=</span>&nbsp;Delta</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;fi</li><li class="hl_l0">fi</li>        </ol>
    </div>
</div></div>
<br>&gt; Я вот даже недокументированные в MSDN функции стараюсь использовать лишь по большой нужде, очень способствует отсутствию проблем. <br>Вручную работать с пе-форматом это есчо большее зло, так как он может меняться.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=277929&amp;user=17964&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=16" class="addthx" data-post="277929"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 14:02 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
Не буду спорить, пусть каждый делает по своему, представления о качестве кода приходят с опытом написания серьезных программ с фидбеком и нормальным тестированием. Если у вас тысячи пользователей, у всех всё работает и нигде не глючит - честь вам и хвала.
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277930&amp;user=12867&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=17" class="addthx" data-post="277930"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 февраля 2011 15:38 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=17807.html&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
Всё ясно, спасибо всем за участие, закрываю тему <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=277937&amp;user=1449&amp;forum_n=2&amp;topic=17807.html&amp;page=0&amp;anchor=18" class="addthx" data-post="277937"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Кривые хуки системных библиотек</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=17807" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
