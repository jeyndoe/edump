<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Добавление новой секции затирает секцию кода - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Хочу написать упаковщик. К стабу добавляется секция с упакованным имиджем и после запуска стаба этот имидж должен распаковываться в памяти и запускаться. Я взял за основу такой код добавления секции: Code:      ">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b> (+6 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/aspro.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=13&sortBy=0&page=0.html"><b>Протекторы</b></a> <b class=bulletHead>&#8212;&#8250;</b> Добавление новой секции затирает секцию кода</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]ZeroMemory[/b]','')">ZeroMemory</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 7.5 (гость), 1thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 3.86'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=41259">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 октября 2016 22:25 <br><script type="text/javascript">QU('ZeroMemory','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ZeroMemory" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Хочу написать упаковщик. К стабу добавляется секция с упакованным имиджем и после запуска стаба этот имидж должен распаковываться в памяти и запускаться. Я взял за основу такой код добавления секции:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;AddSection<span class="hl_char">(</span>LPTSTR&nbsp;filepath<span class="hl_char">,</span>&nbsp;LPTSTR&nbsp;sectionName<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;sizeOfSection<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;bytesRW<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bEnoughSpace<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SECTION_HEADER&nbsp;newSection<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;i<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;file&nbsp;<span class="hl_char">=</span>&nbsp;CreateFile<span class="hl_char">(</span>filepath<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_READ&nbsp;<span class="hl_char">|</span>&nbsp;GENERIC_WRITE<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPEN_EXISTING<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>file&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;INVALID_HANDLE_VALUE<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;fileSize&nbsp;<span class="hl_char">=</span>&nbsp;GetFileSize<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span>pByte&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAlloc<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>&nbsp;PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;pByte<span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;dos&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_DOS_HEADER<span class="hl_char">)</span>pByte<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_magic&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;IMAGE_DOS_SIGNATURE<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_FILE_HEADER&nbsp;FH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_FILE_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_OPTIONAL_HEADER&nbsp;OH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_OPTIONAL_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_FILE_HEADER<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_SECTION_HEADER&nbsp;SH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;<span class="hl_char">(</span>i&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">; i &lt; sizeof(IMAGE_SECTION_HEADER); i++)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span><span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">&amp;</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span>&nbsp;<span class="hl_char">+</span>&nbsp;i<span class="hl_char">)</span>&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox</span><span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;<span class="hl_quote">&quot;Not enough free space&quot;</span><span class="hl_char">,</span>&nbsp;<span class="hl_quote">&quot;Error&quot;</span><span class="hl_char">,</span>&nbsp;MB_OK<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bEnoughSpace&nbsp;</span><span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory<span class="hl_char">(</span><span class="hl_char">&amp;</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CopyMemory<span class="hl_char">(</span><span class="hl_char">&amp;</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>Name<span class="hl_char">,</span>&nbsp;sectionName<span class="hl_char">,</span>&nbsp;<span class="hl_number">8</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>sizeOfSection<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SectionAlignment<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SectionAlignment<span class="hl_char">,</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>SizeOfRawData&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>sizeOfSection<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>FileAlignment<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>PointerToRawData&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>SizeOfRawData<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>FileAlignment<span class="hl_char">,</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>PointerToRawData<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>Characteristics&nbsp;<span class="hl_char">=</span>&nbsp;0xE00000E0<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">*</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xE00000E0&nbsp;<span class="hl_char">=</span>&nbsp;IMAGE_SCN_MEM_WRITE&nbsp;<span class="hl_char">|</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_CODE&nbsp;&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_UNINITIALIZED_DATA&nbsp;&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_MEM_EXECUTE&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_INITIALIZED_DATA&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_MEM_READ&nbsp;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">*</span><span class="hl_char">/</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetFilePointer<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>PointerToRawData&nbsp;<span class="hl_char">+</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>SizeOfRawData<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;FILE_BEGIN<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetEndOfFile<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SizeOfImage&nbsp;<span class="hl_char">=</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress&nbsp;<span class="hl_char">+</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SizeOfImage&nbsp;<span class="hl_char">=</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress&nbsp;<span class="hl_char">+</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections<span class="hl_char">]</span><span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetFilePointer<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;FILE_BEGIN<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;pByte<span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree<span class="hl_char">(</span>pByte<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">BOOL&nbsp;AddCode<span class="hl_char">(</span><span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span>filepath<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;bytesRW<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;file&nbsp;<span class="hl_char">=</span>&nbsp;CreateFile<span class="hl_char">(</span>filepath<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_READ&nbsp;<span class="hl_char">|</span>&nbsp;GENERIC_WRITE<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPEN_EXISTING<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>file&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;INVALID_HANDLE_VALUE<span class="hl_char">)</span>&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;fileSize&nbsp;<span class="hl_char">=</span>&nbsp;GetFileSize<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span>pByte&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAlloc<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>&nbsp;PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ReadFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;pByte<span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;dos&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_DOS_HEADER<span class="hl_char">)</span>pByte<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_NT_HEADERS&nbsp;nt&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>since&nbsp;we&nbsp;added&nbsp;a&nbsp;<span class="hl_function"><b>new</b></span>&nbsp;<span class="hl_function">section</span><span class="hl_char">,</span>it&nbsp;must&nbsp;be&nbsp;the&nbsp;last&nbsp;<span class="hl_function"><b>section</b></span>&nbsp;added<span class="hl_char">,</span>cause&nbsp;of&nbsp;the&nbsp;<span class="hl_function"><b>code</b></span>&nbsp;inside</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>AddSection&nbsp;function<span class="hl_char">,</span>thus&nbsp;we&nbsp;must&nbsp;get&nbsp;to&nbsp;the&nbsp;last&nbsp;<span class="hl_function"><b>section</b></span>&nbsp;to&nbsp;insert&nbsp;our&nbsp;secret&nbsp;<span class="hl_function"><b>data</b></span>&nbsp;<span class="hl_char">:</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_SECTION_HEADER&nbsp;first&nbsp;<span class="hl_char">=</span>&nbsp;IMAGE_FIRST_SECTION<span class="hl_char">(</span>nt<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_SECTION_HEADER&nbsp;last&nbsp;<span class="hl_char">=</span>&nbsp;first&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_char">(</span>nt<span class="hl_char">-</span><span class="hl_char">&gt;</span>FileHeader<span class="hl_char">.</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;SetFilePointer<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;last<span class="hl_char">-</span><span class="hl_char">&gt;</span>PointerToRawData<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;FILE_BEGIN<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShowNum<span class="hl_char">(</span>last<span class="hl_char">-</span><span class="hl_char">&gt;</span>PointerToRawData<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>char</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_function"><b>str</b></span>&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_quote">&quot;NEW SECTION&quot;</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;WriteFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_function">str</span><span class="hl_char">,</span>&nbsp;strlen<span class="hl_char">(</span><span class="hl_function">str</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree<span class="hl_char">(</span>pByte<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br><br>Проблема в том, что код рассчитан на PE-файлы, в которых между таблицей секций и первой секцией есть пустое пространство для нового заголовка. У меня линкеры создают файлы, в которых таблица секций лежит вплотную к секции кода, поэтому при добавлении нового заголовка секция кода затирается.<br><br>Почему кто-то рассчитывал на то, что будет куда вставлять новый заголовок? Почему пустого места нет?<br><br>Я решил перекраивать дисковый имидж и пишу такой код:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">BOOL&nbsp;AddSection<span class="hl_char">(</span>LPTSTR&nbsp;filepath<span class="hl_char">,</span>&nbsp;LPTSTR&nbsp;sectionName<span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;sizeOfSection<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;bytesRW<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SECTION_HEADER&nbsp;newSection<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;file&nbsp;<span class="hl_char">=</span>&nbsp;CreateFile<span class="hl_char">(</span>filepath<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_READ&nbsp;<span class="hl_char">|</span>&nbsp;GENERIC_WRITE<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPEN_EXISTING<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>file&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;INVALID_HANDLE_VALUE<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;fileSize&nbsp;<span class="hl_char">=</span>&nbsp;GetFileSize<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>BYTE</b></span>&nbsp;<span class="hl_char">*</span>pByte&nbsp;<span class="hl_char">=</span>&nbsp;VirtualAlloc<span class="hl_char">(</span><span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;MEM_COMMIT<span class="hl_char">,</span>&nbsp;PAGE_READWRITE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;pByte<span class="hl_char">,</span>&nbsp;fileSize<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;dos&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_DOS_HEADER<span class="hl_char">)</span>pByte<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_magic&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;IMAGE_DOS_SIGNATURE<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>FALSE</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_FILE_HEADER&nbsp;FH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_FILE_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_OPTIONAL_HEADER&nbsp;OH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_OPTIONAL_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_FILE_HEADER<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_SECTION_HEADER&nbsp;SH&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_NT_HEADERS<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Настроить&nbsp;параметры&nbsp;новой&nbsp;секции</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory<span class="hl_char">(</span><span class="hl_char">&amp;</span>newSection<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CopyMemory<span class="hl_char">(</span><span class="hl_char">&amp;</span>newSection<span class="hl_char">.</span>Name<span class="hl_char">,</span>&nbsp;sectionName<span class="hl_char">,</span>&nbsp;<span class="hl_number">8</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSection<span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>sizeOfSection<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SectionAlignment<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSection<span class="hl_char">.</span>VirtualAddress&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize<span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OH</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>SectionAlignment<span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SH</span><span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSection<span class="hl_char">.</span>SizeOfRawData&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>sizeOfSection<span class="hl_char">,</span>&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>FileAlignment<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSection<span class="hl_char">.</span>PointerToRawData&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>SizeOfRawData<span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OH</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>FileAlignment<span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SH</span><span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>PointerToRawData<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSection<span class="hl_char">.</span>Characteristics&nbsp;<span class="hl_char">=</span>&nbsp;0xE00000E0<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;&nbsp;&nbsp;&nbsp;0xE00000E0&nbsp;<span class="hl_char">=</span>&nbsp;IMAGE_SCN_MEM_WRITE&nbsp;<span class="hl_char">|</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_CODE&nbsp;&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_UNINITIALIZED_DATA&nbsp;&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_MEM_EXECUTE&nbsp;<span class="hl_char">|</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_CNT_INITIALIZED_DATA&nbsp;</span><span class="hl_char">|</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_SCN_MEM_READ&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>SizeOfImage&nbsp;<span class="hl_char">=</span>&nbsp;newSection<span class="hl_char">.</span>VirtualAddress&nbsp;<span class="hl_char">+</span>&nbsp;newSection<span class="hl_char">.</span>Misc<span class="hl_char">.</span>VirtualSize<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetFilePointer<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;FILE_BEGIN<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Записать&nbsp;все&nbsp;до&nbsp;последнего&nbsp;заголовка&nbsp;секций</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile<span class="hl_char">(</span>file<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pByte<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dos<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_lfanew&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">4</span>&nbsp;<span class="hl_char">+</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_FILE_HEADER<span class="hl_char">)</span>&nbsp;<span class="hl_char">+</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FH</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>SizeOfOptionalHeader&nbsp;<span class="hl_char">+</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">(</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Записать&nbsp;заголовок&nbsp;новой&nbsp;секции</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>newSection<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_SECTION_HEADER<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Записать&nbsp;все<span class="hl_char">,</span>&nbsp;начиная&nbsp;с&nbsp;секции&nbsp;кода</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile<span class="hl_char">(</span>file<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span>pByte&nbsp;<span class="hl_char">+</span>&nbsp;GetFilePointer<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;fileSize&nbsp;<span class="hl_char">-</span>&nbsp;GetFilePointer<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>bytesRW<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>file<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree<span class="hl_char">(</span>pByte<span class="hl_char">,</span>&nbsp;<span class="hl_number">0</span><span class="hl_char">,</span>&nbsp;MEM_RELEASE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>TRUE</b></span><span class="hl_comment">;</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br>Алгоритм такой:<br>1. Читаю дсковый имидж в буфер<br>2. На стеке создаю и заполняю хедер новой секции<br>3. В optional header&#039;е увеличиваю размер имиджа, в file header&#039;е увеличиваю количество секций<br>4. Записываю обратно в файл часть буфера до таблицы секций включительно<br>5. Записываю созданный заголовок секции<br>5. Записываю все, что лежало после таблицы секций: то есть секцию кода и остальное<br><br>Примеры программ с добавленной секцией:<br><br>Оригинальный способ, затирающий секцию кода: http://rgho.st/6R8Hycl6s Видно, что после записи строки &quot;NEW SECTION&quot; секция выравнивается нулями<br><br>Мой вариант: http://rgho.st/7wgBqhJSf почему-то секция нулями не выравнивается<br><br>В обеих случаях файл не запускается. Что я делаю не так? Какие поля надо пересчитать после добавления заголовка секции и сдвигания секции кода вниз?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368235&amp;user=41259&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=1" class="addthx" data-post="368235"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]UniSoft[/b]','')">UniSoft</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/1288.png" alt=""><br><span class=txtSm>Ранг: 52.0 (постоянный), 146thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.41'>Активность: 0.03<span style='color:green'>&nearr;</span>0.08</span><br>Статус: <a href="action=userinfo&amp;user=1288">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 октября 2016 23:44 &middot; Поправил: UniSoft <br><script type="text/javascript">QU('UniSoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=UniSoft" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<I>ZeroMemory пишет:<br>Хочу написать упаковщик. ...этот имидж должен распаковываться в памяти и запускаться. </I><br>А вы в курсе, что кроме распаковки нужно еще обработать таблицу релоков, таблицу импорта, TLS Callbacks (если имеется), ...?<br><br><I>ZeroMemory пишет:<br>файл не запускается. Что я делаю не так? </I><br>нельзя просто так сдвинуть данные на размер секции!<br>а как же выравнивание? А PointerToRawData всех остальных секций?<br><br>Изучайте формат PE...<br>https://habrahabr.ru/company/xakep/blog/139138/<br>https://vxheaven.org/0x48k/etc/peload_dll.cpp<br><br><br><b>-=AkaBOSS=-</b><I>-=AkaBOSS=- пишет:<br>RVA? </I><br>Ну да, не правильно выразился... бывает <img src="img/smilies/s2.gif" alt=""> <br>конечно же имелось в виду PointerToRawData
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368238&amp;user=1288&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=2" class="addthx" data-post="368238"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]-=AkaBOSS=-[/b]','')">-=AkaBOSS=-</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/26242.png" alt=""><br><span class=txtSm>Ранг: 150.3 (ветеран), 175thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.88'>Активность: 0.16<span style='color:red'>&searr;</span>0.07</span><br>Статус: <a href="action=userinfo&amp;user=26242">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 01:45 &middot; Поправил: -=AkaBOSS=- <br><script type="text/javascript">QU('-=AkaBOSS=-','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=-=AkaBOSS=-" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
чтоб было проще понять - рассматривайте PEхидер как еще одну секцию.<br>нужно сделать примерно так:<br>1. РазмерА = общий размер пехидера и заголовков секций<br>2. РазмерБ = РазмерА, округлённый вверх до FileAlignment - это фактическое количество данных, которые будут считаны из файла в память<br>3. РазмерВ = (РазмерА+sizeof (IMAGE_SECTION_HEADER)), округляем вверх до FileAlignment - это размер хидера который будет после добавления секции<br>4. если РазмерБ и РазмерВ не равны, значит места не хватит и надо двигать секции.<br>5. соответственно, нужно пройтись по заголовкам всех секций и прибавить к ним разницу между РазмеромВ и РазмеромБ<br>6. разумеется, надо и сами секции физически сдвинуть в файле<br><br><I>ZeroMemory пишет:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">newSection<span class="hl_char">.</span>PointerToRawData&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function">align</span><span class="hl_char">(</span>SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>SizeOfRawData<span class="hl_char">,</span>&nbsp;&nbsp;OH<span class="hl_char">-</span><span class="hl_char">&gt;</span>FileAlignment<span class="hl_char">,</span>&nbsp;SH<span class="hl_char">[</span>FH<span class="hl_char">-</span><span class="hl_char">&gt;</span>NumberOfSections&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">]</span><span class="hl_char">.</span>PointerToRawData<span class="hl_char">)</span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
 </I><br>если уж говорить о возможных багах, то это - их потенциальный источник.<br>порядок секций в пехидере гарантированно отвечает за порядок, в котором они будут располагаться в памяти.<br><b>Но!</b> Секция, расположенная в хидере последней, не обязательно будет последней в файле) В файле они могут располагаться в любом порядке.<br>К тому же, секция может иметь виртуальное представление, но не иметь физического (проще говоря - PointerToRawData и SizeOfRawData могут быть нулевыми)<br>семпл в аттаче<br><img src="img/attach.gif" alt=""> <a href="./files/2209_03.10.2016_EXELAB.rU.tgz">2209_03.10.2016_EXELAB.rU.tgz</a> - test.exe<br><br><br><br><I>UniSoft пишет:<br>А RVA всех остальных секций? </I><br>RVA? <img src="img/smilies/s11.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368252&amp;user=26242&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=3" class="addthx" data-post="368252"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 389thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 02:12 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
VA секции кода чаще всего .401000 при базовом адресе .400000.<br>1000h байтов это 4кб - можно туда слона запихнуть, а не то, что ещё один дескриптор секции.<br>Но перекомпоновать файл понадобится серьёзно.<br><br><br><b>--Добавлено--</b><br><br><I>ZeroMemory пишет:<br>Хочу написать упаковщик.  <br></I><br>Может, лучше ну его на? - UPX вполне справляется.<br>Если уж сильное, стойкое и непреодолимое желание рулить,<br>то можно помучить сорсы UPX&#039;а<br><i class=x><br></i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368256&amp;user=35473&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=4" class="addthx" data-post="368256"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 10:45 &middot; Поправил: difexacaw <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Норм решение это полноценный инфект, тоесть нужно интегрироваться в код, а предыдущий и прочий сохранить в конец файла. Иначе по ровному никак не сделать, ну или не сделать проще, учитывая что у тс модуля формата &quot;минимальный исполняемый файл&quot;.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368268&amp;user=40990&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=5" class="addthx" data-post="368268"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Rainbow[/b]','')">Rainbow</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/13190.jpg" alt=""><br><span class=txtSm>Ранг: 110.8 (ветеран), 104thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.83'>Активность: 0.09<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=13190">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 10:57 <br><script type="text/javascript">QU('Rainbow','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Rainbow" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
Ну кто вам вообще сказал, что PE-хидер должен идти следом за дос-хидером ?.. У структуры IMAGE_DOS_HEADER есть замечательное поле - e_lfanew. А если так, то почему бы, например, не разместить PE-хидер где-нибудь в хвосте ? <img src="img/smilies/s3.gif" alt=""><br><br>P.S. Мыслим шире <img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368272&amp;user=13190&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=6" class="addthx" data-post="368272"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 10:59 &middot; Поправил: difexacaw <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<b>Rainbow</b><br><br>Потому, что такой формат сразу выпилят аверы. Модуль будет запускаться, но станет не рабочим в ав окружении(система уже давно не только загрузчик). Мыслим шире <img src="img/smilies/s2.gif" alt="">
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368273&amp;user=40990&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=7" class="addthx" data-post="368273"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=35473" title="03-10-2016 08:04, ранг:207.9" target="_blank">dosprog</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Rainbow[/b]','')">Rainbow</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/13190.jpg" alt=""><br><span class=txtSm>Ранг: 110.8 (ветеран), 104thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.83'>Активность: 0.09<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=13190">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 11:03 <br><script type="text/javascript">QU('Rainbow','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Rainbow" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
Похоже у кого-то эвристика зашкалила <img src="img/smilies/s1.gif" alt=""><br><br><b>Добавлено спустя 15 минут</b><br>Видимо мне действительно не следовало влезать в эти дела, когда трукодеры с аверными движками сражаются, не совладав с pe-хидером.. <img src="img/smilies/s1.gif" alt=""> I&#039;m sorry <img src="img/smilies/s6.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368274&amp;user=13190&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=8" class="addthx" data-post="368274"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 337.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 12:12 &middot; Поправил: difexacaw <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>Rainbow</b><br><br>Вероятно так. На данный момент проблема формата не разрешима, так как критерий детекта основан на выборке. Ав интегрирован в ось и в лучшем случае он один, наверно вы далеки от этой темы. Такой изврат с форматом не приемлем. Были времена, очень давно когда в ядерном лодере(который мапит образ) было куча багов, это работало, но тогда не было столько ав. Сейчас же проблема не пропатчить модуль, а выполнить это так, чтобы не было реакции ав.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=368277&amp;user=40990&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=9" class="addthx" data-post="368277"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]ZeroMemory[/b]','')">ZeroMemory</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 7.5 (гость), 1thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 3.86'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=41259">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 20:18 <br><script type="text/javascript">QU('ZeroMemory','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ZeroMemory" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<I>UniSoft пишет:<br>А вы в курсе, что кроме распаковки нужно еще обработать таблицу релоков, таблицу импорта, TLS Callbacks (если имеется), ...? </I><br>Да, я знаю, что придется частично реализовать PE-загрузчик, но мне это интересно, хочется разобраться. Я делал инфект в code cave&#039;ы и думал, что уж добавление секции будет проще, но оказалось, что все плохо, и старые способы добавления секции почему-то перестали работать.<br><br>Вот такой у меня исходный файл, над которым я издеваюсь http://rgho.st/8VcqfWmrR
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368301&amp;user=41259&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=10" class="addthx" data-post="368301"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]UniSoft[/b]','')">UniSoft</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/1288.png" alt=""><br><span class=txtSm>Ранг: 52.0 (постоянный), 146thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.41'>Активность: 0.03<span style='color:green'>&nearr;</span>0.08</span><br>Статус: <a href="action=userinfo&amp;user=1288">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 21:02 &middot; Поправил: UniSoft <br><script type="text/javascript">QU('UniSoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=UniSoft" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
DEL
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368302&amp;user=1288&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=11" class="addthx" data-post="368302"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]hash87szf[/b]','')">hash87szf</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 64.9 (постоянный), 47thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.33'>Активность: 0.12<span style='color:red'>&searr;</span>0.02</span><br>Статус: <a href="action=userinfo&amp;user=34301">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 21:11 <br><script type="text/javascript">QU('hash87szf','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=hash87szf" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Пишем упаковщик PE-файлов по шагам. Шаг первый.<br>https://kaimi.io/2012/09/pe-packer-step-by-step-1/<br><br>так для общей инфы
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368303&amp;user=34301&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=12" class="addthx" data-post="368303"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]UniSoft[/b]','')">UniSoft</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/1288.png" alt=""><br><span class=txtSm>Ранг: 52.0 (постоянный), 146thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.41'>Активность: 0.03<span style='color:green'>&nearr;</span>0.08</span><br>Статус: <a href="action=userinfo&amp;user=1288">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 октября 2016 23:01 &middot; Поправил: UniSoft <br><script type="text/javascript">QU('UniSoft','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=UniSoft" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<I>Rainbow пишет:<br>PE-хидер где-нибудь в хвосте ?  </I><br><br><I>difexacaw пишет:<br>Потому, что такой формат сразу выпилят аверы. </I><br><br>так, не спорьте...<br>помыслил шире, и попробовал такой финт, ради &quot;научного&quot; экскремента... <img src="img/smilies/s6.gif" alt=""><br><strike>результат таков, что винда финт не оценила и обозвала такой файл инвалидом... (может я чего пропустил?!)</strike><br>Все же работает такой финт... PE хидер в конце файла...  (пример в аттаче)<br>ну а аверы:<br>https://www.virustotal.com/en/file/d7561462254197ea01664582d453f948883c3c61af664c14cb2c5d1e8abfe712/analysis/1475524456/<br>хотя многим из них и в исходном exe видится угроза (ну и <strike>отупели</strike> обленились же современные аверы):<br>https://www.virustotal.com/en/file/8b13ab5929596517a9078127e5ea5e3c3c037acdaeee31f7f95e270c905e143d/analysis/1475524927/<br><br><img src="img/attach.gif" alt=""> <a href="./files/96e0_04.10.2016_EXELAB.rU.tgz">96e0_04.10.2016_EXELAB.rU.tgz</a> - testPE.rar
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368307&amp;user=1288&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=13" class="addthx" data-post="368307"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]script_kidis[/b]','')">script_kidis</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/39388.jpg" alt=""><br><span class=txtSm>Ранг: 56.2 (постоянный), 14thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 5.01'>Активность: 0.12<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=39388">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 05 октября 2016 22:03 <br><script type="text/javascript">QU('script_kidis','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=script_kidis" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=13&amp;topic=24356.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
да вт жжёт https://www.virustotal.com/ru/file/878a7f472f83765ed2781799f9062f8f81a0fa291d282ef8c6fe58756b0ccafd/analysis/1475693342/
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=368341&amp;user=39388&amp;forum_n=13&amp;topic=24356.html&amp;page=0&amp;anchor=14" class="addthx" data-post="368341"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/aspro.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=13&sortBy=0&page=0.html"><b>Протекторы</b></a> <b class=bulletHead>&#8212;&#8250;</b> Добавление новой секции затирает секцию кода</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#15" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="13">
<input type="hidden" name="topic" value="24356">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=24356" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
