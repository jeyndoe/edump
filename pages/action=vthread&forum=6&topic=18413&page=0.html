<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Подскажите как организовать логику отладчика - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Думаю что много кто тут писал отладчики, поэтому мож кто подскажет. Понимаю что за много лет я уже запарил тут всех подобными вопросами На данный момент хардварные бряки у меня устроены слегка коряво Code:      ">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=1288'>UniSoft</a>, <a target='_blank' href='?action=userinfo&amp;user=55953'>laslo</a>, <a target='_blank' href='?action=userinfo&amp;user=26261'>bartolomeo</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Подскажите как организовать логику отладчика</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 июня 2011 17:22 &middot; Поправил: daFix <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Думаю что много кто тут писал отладчики, поэтому мож кто подскажет. Понимаю что за много лет я<br>уже запарил тут всех подобными вопросами <img src="img/smilies/s1.gif" alt=""><br>На данный момент хардварные бряки у меня устроены слегка коряво<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;__fastcall&nbsp;DebugThread<span class="hl_char">:</span><span class="hl_char">:</span>SingleStepHandler<span class="hl_char">(</span><span class="hl_function"><b>int</b></span>&nbsp;<span class="hl_function">Addr</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>IsMyHWBreak<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function">int</span><span class="hl_char">)</span><span class="hl_function">Addr</span><span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log2<span class="hl_char">(</span><span class="hl_quote">&quot;Handled Hardware Breakpoint at &quot;</span>&nbsp;<span class="hl_char">+</span>&nbsp;IntToHex<span class="hl_char">(</span><span class="hl_function">Addr</span><span class="hl_char">,</span><span class="hl_number">8</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemHwBpByAddr<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function">int</span><span class="hl_char">)</span><span class="hl_function">Addr</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwContinueStatus&nbsp;<span class="hl_char">=</span>&nbsp;DBG_CONTINUE<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoSingleStep<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetHwBp<span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function">int</span><span class="hl_char">)</span><span class="hl_function"><b>Addr</b></span>&nbsp;<span class="hl_char">,</span>EXECUTE<span class="hl_char">,</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">,</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>SSFLAG<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;Log<span class="hl_char">(</span><span class="hl_quote">&quot;SingleStep Breakpoint at &quot;</span>&nbsp;<span class="hl_char">+</span>&nbsp;IntToHex<span class="hl_char">(</span><span class="hl_function">Addr</span><span class="hl_char">,</span><span class="hl_number">8</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSFLAG&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwContinueStatus&nbsp;<span class="hl_char">=</span>&nbsp;DBG_CONTINUE<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log<span class="hl_char">(</span><span class="hl_quote">&quot;Unhandled Hardware Breakpoint at &quot;</span>&nbsp;<span class="hl_char">+</span>&nbsp;IntToHex<span class="hl_char">(</span><span class="hl_function">Addr</span><span class="hl_char">,</span><span class="hl_number">8</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwContinueStatus&nbsp;<span class="hl_char">=</span>&nbsp;DBG_EXCEPTION_NOT_HANDLED<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;}</li>        </ol>
    </div>
</div></div>
<br><br>Тоесть в обработчике делается SingleStep и бряк ставится обратно. Тоесть EIP уже будет стоять на следующей команде после бряка. Это конечно был костыль, но сейчас мне надо как-то избавится от него. Можно конечно не восстанавливать его в обработчике, но очень хотелось бы чтобы они работали как в ольке. Оно вроде и легко на первый взгляд, но пока не нашёл <br>подходящего решения.<br>Буду рад любым свежим мыслям!<br><br><b>ADDED:</b><br>Ну и тогда уже до кучи - выполняются ли другие потоки, если один поток встал на EXCEPTION_BREAKPOINT?
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286679&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=1" class="addthx" data-post="286679"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 июня 2011 21:38 &middot; Поправил: <a href="action=stats#mods">Модератор</a> <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
1. Флаг RF.<br>2. Если без Debug, точно выполняются. Если с ним, судя по всему, нет.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=286703&amp;user=1556&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=2" class="addthx" data-post="286703"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ajax[/b]','')">ajax</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/8830.gif" alt=""><br><span class=txtSm>Ранг: 337.6 (мудрец), 224thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.53'>Активность: 0.21<span style='color:red'>&searr;</span>0.1</span><br>Статус: <a href="action=userinfo&amp;user=8830">Участник</a><br><font color=blue>born to be evil</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 01 июля 2011 00:32 &middot; Поправил: ajax <br><script type="text/javascript">QU('ajax','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ajax" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<b>daFix</b><br>в сырки UGdbg погляди, мож найдешь че интересное
<br><br><font size="1"><i>-----<br>От многой мудрости много скорби, и умножающий знание умножает печаль</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286712&amp;user=8830&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=3" class="addthx" data-post="286712"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 01 июля 2011 14:47 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<b>Archer</b><br>rf вроде какраз то что надо! Но ни как... В обработчике надо возвести 16-й бит и сказать что мы обработали исключение? Очень трудно искать информацию. Я сейчас с телефона <img src="img/smilies/s14.gif" alt=""><br><br><b>ajax</b><br>Спасибо, буду с компа - гляну
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286762&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=4" class="addthx" data-post="286762"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 июля 2011 01:17 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<i class=x>RF — признак маскирования ошибок отладки, при установке значения<br>RF=1 возможные ошибки отладки игнорируются при выполнении следую-<br>щей команды; используется в процессе отладки программ;</i><br><br>Поймали исключение сингл степ, возвели RF флаг, DBG_CONTINUE и вперёд. <br>Вот что происходит при запуске<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Process&nbsp;Created<span class="hl_char">.</span>&nbsp;Id&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">00000DC4</span></li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_function"><b>New</b></span>&nbsp;Process&nbsp;Created<span class="hl_char">.</span>&nbsp;Process&nbsp;Handle&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">00000730</span></li><li class="hl_l1">Process&nbsp;Start&nbsp;Address&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">0052E230</span></li><li class="hl_l0">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">Load&nbsp;<span class="hl_function">library</span><span class="hl_char">:</span></li><li class="hl_l0">ntdll<span class="hl_char">.</span>dll</li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">Load&nbsp;<span class="hl_function">library</span><span class="hl_char">:</span></li><li class="hl_l1">F<span class="hl_char">:</span><span class="hl_char">\</span>WINDOWS<span class="hl_char">\</span>system32<span class="hl_char">\</span>kernel32<span class="hl_char">.</span>dll</li><li class="hl_l0"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">Load&nbsp;<span class="hl_function">library</span><span class="hl_char">:</span></li><li class="hl_l1">F<span class="hl_char">:</span><span class="hl_char">\</span>WINDOWS<span class="hl_char">\</span>system32<span class="hl_char">\</span>VERSION<span class="hl_char">.</span>dll</li><li class="hl_l0">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">Exepton&nbsp;<span class="hl_function">code</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">80000003</span></li><li class="hl_l0">System&nbsp;BreakPiont&nbsp;at&nbsp;<span class="hl_number">7C90120E</span></li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">Load&nbsp;<span class="hl_function">library</span><span class="hl_char">:</span></li><li class="hl_l1">F<span class="hl_char">:</span><span class="hl_char">\</span>WINDOWS<span class="hl_char">\</span>system32<span class="hl_char">\</span>IMM32<span class="hl_char">.</span>DLL</li><li class="hl_l0">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">Exepton&nbsp;<span class="hl_function">code</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">80000004</span></li><li class="hl_l0">Handled&nbsp;Hardware&nbsp;Breakpoint&nbsp;at&nbsp;<span class="hl_number">0052E235</span></li><li class="hl_l1"><span class="hl_number">00000206</span></li><li class="hl_l0"><span class="hl_number">00020206</span></li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">Exepton&nbsp;<span class="hl_function">code</span><span class="hl_char">:</span>&nbsp;C0000005</li><li class="hl_l1">Access&nbsp;violation&nbsp;at&nbsp;address&nbsp;<span class="hl_number">0000E235</span></li><li class="hl_l0">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">Exepton&nbsp;<span class="hl_function">code</span><span class="hl_char">:</span>&nbsp;C0000005</li><li class="hl_l0">Access&nbsp;violation&nbsp;at&nbsp;address&nbsp;<span class="hl_number">0000E235</span></li><li class="hl_l1">Waiting&nbsp;for&nbsp;exeption<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">Process&nbsp;Whas&nbsp;Terminated<span class="hl_char">.</span>&nbsp;Exit&nbsp;<span class="hl_function"><b>Code</b></span>&nbsp;<span class="hl_char">-</span>&nbsp;C0000005</li>        </ol>
    </div>
</div></div>
<br><br>Непонятные числа 00000206 и 00020206 - это EFlag до и после возведения флага<br><br>Глянул UGdbg, много интересного можно там подглядеть, но конкретно по сабжу не нашёл <img src="img/smilies/s4.gif" alt=""><br>Уже бьюсь в истерике
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286842&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=5" class="addthx" data-post="286842"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ajax[/b]','')">ajax</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/8830.gif" alt=""><br><span class=txtSm>Ранг: 337.6 (мудрец), 224thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.53'>Активность: 0.21<span style='color:red'>&searr;</span>0.1</span><br>Статус: <a href="action=userinfo&amp;user=8830">Участник</a><br><font color=blue>born to be evil</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 июля 2011 03:20 &middot; Поправил: ajax <br><script type="text/javascript">QU('ajax','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ajax" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<noindex><a href="http://www.delphisources.ru/pages/faq/base/use_debug_api.html" rel="nofollow" target="_blank">http://www.delphisources.ru/pages/faq/base/use_debug_api.html</a></noindex> ?
<br><br><font size="1"><i>-----<br>От многой мудрости много скорби, и умножающий знание умножает печаль</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286852&amp;user=8830&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=6" class="addthx" data-post="286852"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 июля 2011 09:38 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
А ты тот вообще бит то взвёл? Ты вообще Virtual-8086 mode flag воткнул, походу. Не удивительно тогда, что посыпались такие ошибки.<br>З.Ы. Надо не биться в истерике, а кодес проверять и отлаживать.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=286857&amp;user=1556&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=7" class="addthx" data-post="286857"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Av0id[/b]','')">Av0id</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 516.1 (<b>!</b>), 39thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.38'>Активность: 0.28<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1378">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 июля 2011 08:38 <br><script type="text/javascript">QU('Av0id','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Av0id" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
#define _set_rf(x)    (x.EFlags |= 0x10000)<br>#define _clear_rf(x)  (x.EFlags &amp;= ~0x10000)<br><br>#define _set_trap(x)    (x.EFlags |= 0x100)<br>#define _clear_trap(x)  (x.EFlags &amp;= ~0x100)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=286889&amp;user=1378&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=8" class="addthx" data-post="286889"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]ARCHANGEL[/b]','')">ARCHANGEL</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6336.png" alt=""><br><span class=txtSm>Ранг: 681.5 <font color=magenta>(<b>! !</b>)</font>, 405thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.85'>Активность: 0.42<span style='color:red'>&searr;</span>0.21</span><br>Статус: <a href="action=userinfo&amp;user=6336">Участник</a><br><font color=blue>ALIEN Hack Team</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 июля 2011 12:53 <br><script type="text/javascript">QU('ARCHANGEL','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ARCHANGEL" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<i class=x>Ну и тогда уже до кучи - выполняются ли другие потоки, если один поток встал на EXCEPTION_BREAKPOINT?</i><br><br>Нет.
<br><br><font size="1"><i>-----<br>Stuck to the plan, always think that we would stand up, never ran.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=286903&amp;user=6336&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=9" class="addthx" data-post="286903"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]Rockphorr[/b]','')">Rockphorr</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 62.8 (постоянный), 11thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.71'>Активность: 0.06<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=22848">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 июля 2011 00:31 <br><script type="text/javascript">QU('Rockphorr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Rockphorr" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
на васме есть такой товарисч - крис касперски - так он утверждал что в принципе можно купить сорцы айса от нумеги и допиливать их в свой продукт - как это сделать он не уточнил, но имхо его можно потрясти
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=287738&amp;user=22848&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=10" class="addthx" data-post="287738"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 июля 2011 16:21 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
Сейчас надо закончить несколько проектов, и вернусь к написанию отладчика. <br><br><b>Rockphorr</b><br>Звучит адски, т.к. стрелять по мухам из пушки не целесообразно в моём случае, да и цена там будет не с двумя нулями зелёных<br><br><b>ARCHANGEL</b><br>Верно ли я понял, во время исключения система тормозит все потоки, а при запуске, олька стартует все потоки кроме главного через ResumeThread?
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=287803&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=11" class="addthx" data-post="287803"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 июля 2011 18:25 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Потоки сами разморозятся, когда отладчик скажет, что исключение обработано. Ленно проверить? Ей богу, минут 30 времени максимум.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=287810&amp;user=1556&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=12" class="addthx" data-post="287810"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]ARCHANGEL[/b]','')">ARCHANGEL</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6336.png" alt=""><br><span class=txtSm>Ранг: 681.5 <font color=magenta>(<b>! !</b>)</font>, 405thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.85'>Активность: 0.42<span style='color:red'>&searr;</span>0.21</span><br>Статус: <a href="action=userinfo&amp;user=6336">Участник</a><br><font color=blue>ALIEN Hack Team</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 16 июля 2011 00:35 <br><script type="text/javascript">QU('ARCHANGEL','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ARCHANGEL" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<b>daFix</b><br>Именно. Вызов ContinueDebugEvent снова запустит потоки на выполнение.
<br><br><font size="1"><i>-----<br>Stuck to the plan, always think that we would stand up, never ran.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=287828&amp;user=6336&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=13" class="addthx" data-post="287828"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 00:01 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
Опять понадобился горе-отладчик и решил добить его. <br>Думаю что ошибка кроется в том что я просто работаю с контекстом не того потока.<br><br>	if (IsMyHWBreak((int)Addr))<br>	{<br>		Log(&quot;Handled Hardware Breakpoint at &quot; + IntToHex(Addr,8));<br>		cntxt.ContextFlags = CONTEXT_FULL;<br>		GetThreadContext( pi.hThread, &amp;cntxt);<br>		cntxt.EFlags = cntxt.EFlags |= 1 &lt;&lt; 16;// 0x8000;<br>		SetThreadContext(pi.hThread, &amp;cntxt);<br>                            dwContinueStatus = DBG_CONTINUE;<br>	return 1;<br>}<br><br>pi - это структура PROCESS_INFORMATION, полученная при создании процесса.<br>Если это так, тогда можно объяснить непонятные ошибки при отладке многопоточных приложений. <br>Значит делаем <br>GetThreadContext(OpenThread(DebugEvent.dwThreadId, ..., ...),  &amp;cntxt);<br>так?
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292099&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=14" class="addthx" data-post="292099"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]ARCHANGEL[/b]','')">ARCHANGEL</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6336.png" alt=""><br><span class=txtSm>Ранг: 681.5 <font color=magenta>(<b>! !</b>)</font>, 405thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.85'>Активность: 0.42<span style='color:red'>&searr;</span>0.21</span><br>Статус: <a href="action=userinfo&amp;user=6336">Участник</a><br><font color=blue>ALIEN Hack Team</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 00:05 <br><script type="text/javascript">QU('ARCHANGEL','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ARCHANGEL" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
<b>daFix</b><br><br><i class=x>GetThreadContext(OpenThread(DebugEvent.dwThreadId, ..., ...), &amp;cntxt);</i><br><br>Такой подход жутко тормозит. OpenThread очень медленная, чтоб так её постоянно вызывать. Лучше хранить массив, по которому по известному идентификатору можно найти описатель потока.
<br><br><font size="1"><i>-----<br>Stuck to the plan, always think that we would stand up, never ran.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292100&amp;user=6336&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=15" class="addthx" data-post="292100"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 00:21 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
<b>ARCHANGEL</b><br>Глянул твой исходник, грамотно сделано! Переписываю свой код, возможно пропадут все глюки, которые так часто случаются при отладке, ибо странно что вообще работает <img src="img/smilies/s5.gif" alt="">
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292102&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=16" class="addthx" data-post="292102"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 02:48 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
Проблема не решилась <img src="img/smilies/s15.gif" alt=""><br><br>Сейчас нашёл одну странную странность! SetThreadContext не ставит контекст о_О<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cntxt<span class="hl_char">.</span>ContextFlags&nbsp;<span class="hl_char">=</span>&nbsp;CONTEXT_ALL<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetThreadContext<span class="hl_char">(</span>thr_hndl<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>cntxt<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cntxt<span class="hl_char">.</span>EFlags&nbsp;<span class="hl_char">=</span>&nbsp;cntxt<span class="hl_char">.</span>EFlags&nbsp;<span class="hl_char">|</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">1</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_number">16</span><span class="hl_comment">;  //  0x10000</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetThreadContext<span class="hl_char">(</span>thr_hndl<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>cntxt<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetThreadContext<span class="hl_char">(</span>thr_hndl<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>cntxt<span class="hl_char">)</span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br>Последний GetThreadContext показывает что EFlags ни что не изменился<br>Я опять в тупике
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292104&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=17" class="addthx" data-post="292104"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]Hellspawn[/b]','')">Hellspawn</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/72.gif" alt=""><br><span class=txtSm>Ранг: 990.2 <font color=red>(<b>! ! !</b>)</font>, 380thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.95'>Активность: 0.68<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=72">Модератор</a><br><font color=blue>Author of DiE</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 07:51 <br><script type="text/javascript">QU('Hellspawn','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Hellspawn" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
какой еррор? юзай cntxt.ContextFlags = CONTEXT_CONTROL
<br><br><font size="1"><i>-----<br>[nice coder and reverser]</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292106&amp;user=72&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=18" class="addthx" data-post="292106"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 08:21 &middot; Поправил: bowrouco <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#19');return false;">#19</a> </span><div align=left><br><div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#define&nbsp;EFLAGS_CF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000001L</li><li class="hl_l1">#define&nbsp;EFLAGS_PF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000004L</li><li class="hl_l0">#define&nbsp;EFLAGS_AF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000010L</li><li class="hl_l1">#define&nbsp;EFLAGS_ZF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000040L</li><li class="hl_l0">#define&nbsp;EFLAGS_SF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000080L</li><li class="hl_l1">#define&nbsp;EFLAGS_TF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000100L</li><li class="hl_l0">#define&nbsp;EFLAGS_INTERRUPT_MASK&nbsp;0x00000200L</li><li class="hl_l1">#define&nbsp;EFLAGS_DF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000400L</li><li class="hl_l0">#define&nbsp;EFLAGS_OF_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000800L</li><li class="hl_l1">#define&nbsp;EFLAGS_IOPL_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00003000L</li><li class="hl_l0">#define&nbsp;EFLAGS_NT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00004000L</li><li class="hl_l1">#define&nbsp;EFLAGS_RF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00010000L</li><li class="hl_l0">#define&nbsp;EFLAGS_V86_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00020000L</li><li class="hl_l1">#define&nbsp;EFLAGS_ALIGN_CHECK&nbsp;&nbsp;&nbsp;&nbsp;0x00040000L</li><li class="hl_l0">#define&nbsp;EFLAGS_VIF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00080000L</li><li class="hl_l1">#define&nbsp;EFLAGS_VIP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00100000L</li><li class="hl_l0">#define&nbsp;EFLAGS_ID_MASK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00200000L</li>        </ol>
    </div>
</div></div>
<br>EXIT_ALL macro:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esp</span><span class="hl_char">+</span><span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;MODE_MASK</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_comment">; If the following branch is taken, we are returning to usermode.</span></li><li class="hl_l1"><span class="hl_comment">; If this processor supports the SYSEXIT instruction, the branch</span></li><li class="hl_l0"><span class="hl_comment">; will be adjusted at boot time to use the appropriate code sequence.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_KiSystemCallExitBranch<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jnz</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>short</b></span>&nbsp;_KiSystemCallExit</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Exit to kernel mode from system call, faster than IRETD,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; unwind the frame and branch to return address.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr"><b>edx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; get eip</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr"><b>ecx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; remove CS from stack</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>popfd</b></span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_comment">; restore eflags</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">edx</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_KiSystemCallExit<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>iretd</b></span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_comment">; return</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">_KiSystemCallExit2<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>test</b></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esp</span><span class="hl_char">+</span><span class="hl_number">8</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;EFLAGS_TF</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jne</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>short</b></span>&nbsp;_KiSystemCallExit</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr"><b>edx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; pop EIP</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">esp</span><span class="hl_char">,</span>&nbsp;<span class="hl_number">4</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; Remove CS</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">esp</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>NOT</b></span>&nbsp;EFLAGS_INTERRUPT_MASK&nbsp;<span class="hl_comment">; Disable interrupts in the flags</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">popfd</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr"><b>ecx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; pop ESP</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sti</b></span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_comment">; sysexit does not reload flags</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iSYSEXIT</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">_KiSystemCallExit3<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; AMD</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr"><b>ecx</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_comment">; pop EIP</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">esp</span><span class="hl_char">,</span>&nbsp;<span class="hl_number">8</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">esp</span></li><li class="hl_l0"><span class="hl_comment">;        mov     esp, [esp+8]        ; remove CS &amp; Eflags, get ESP</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iSYSRET</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>endif</b></span>&nbsp;&nbsp;<span class="hl_comment">;; &lt;NoRestoreVolatiles&gt;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>iretd</b></span><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_comment">; return</span></li>        </ol>
    </div>
</div></div>
<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">EFLAGS&nbsp;<span class="hl_char">(</span>CF<span class="hl_char">,</span>&nbsp;PF<span class="hl_char">,</span>&nbsp;AF<span class="hl_char">,</span>&nbsp;ZF<span class="hl_char">,</span>&nbsp;SF<span class="hl_char">,</span>&nbsp;TF<span class="hl_char">,</span>&nbsp;DF<span class="hl_char">,</span>&nbsp;OF<span class="hl_char">,</span>&nbsp;NT<span class="hl_char">)</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">-</span>&nbsp;tempEFLAGS<span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>IF</b></span>&nbsp;OperandSize&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">32</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;THEN&nbsp;EFLAGS<span class="hl_char">(</span>RF<span class="hl_char">,</span>&nbsp;AC<span class="hl_char">,</span>&nbsp;ID<span class="hl_char">)</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">-</span>&nbsp;tempEFLAGS<span class="hl_comment">; FI;</span></li>        </ol>
    </div>
</div></div>
<br><i class=x>Intel® 64 and IA-32 Architectures Software Developer’s Manual V.2A, 3-490</i>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292108&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=19" class="addthx" data-post="292108"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="20" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 08:24 <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#20" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#20');return false;">#20</a> </span><div align=left><br>
<b>Hellspawn</b><br>&gt; какой еррор?<br>STATUS_SUCCESS, очевидно ведь <img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292109&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=20" class="addthx" data-post="292109"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=2777" title="23-09-2011 09:35, ранг:357.0" target="_blank">daFix</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="21" onfocus="this.blur()" href="JavaScript:di('[b]PE_Kill[/b]','')">PE_Kill</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3232.gif" alt=""><br><span class=txtSm>Ранг: 793.4 <font color=magenta>(<b>! !</b>)</font>, 568thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.59'>Активность: 0.74<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=3232">Участник</a><br><font color=blue>Шаман</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 14:04 <br><script type="text/javascript">QU('PE_Kill','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=PE_Kill" target="_blank">Личное сообщение</a> &middot;  <a href="#21" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#21');return false;">#21</a> </span><div align=left><br>
<b>daFix</b> если винда x64 то нужно выровнять контекст, то ли на 4 то ли на 8 байт не помню, я просто VirtualAlloc использовал, без этого на x64 работа с контекстом была невозможна, ну за исключением, когда он случайно на стеке выровненный получался.
<br><br><font size="1"><i>-----<br>Yann Tiersen best and do not fuck</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292125&amp;user=3232&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=21" class="addthx" data-post="292125"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="22" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 14:28 &middot; Поправил: daFix <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#22" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#22');return false;">#22</a> </span><div align=left><br>
<b>PE_Kill</b><br>Объявил эту структуру как локальную и использую в нескольких функциях, вызываемых в разное ремя. Так вот так косяцит только в этом месте, тоесть выравнивание тут точно не поможет. Винда XP 32 бита.<br><br><b>bowrouco</b> прав, все функции возвращают TRUE.<br>Я уже на всякий случай и суспендил поток, потом возобновлял его. Хотя он и так вроде в суспенде лежит<br><br><I>bowrouco пишет:<br>#define EFLAGS_RF             0x00010000L </I><br>Угу, у меня так и есть<br><br><b>Hellspawn</b><br>Делал CONTEXT_CONTROL, разницы нету
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292127&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=22" class="addthx" data-post="292127"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="23" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 20:26 &middot; Поправил: bowrouco <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#23" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#23');return false;">#23</a> </span><div align=left><br>
<b>daFix</b><br>Если не понятно в коде, скажу напрямую. Нет смысла использовать RF. Вы не в ядре, у вас нет привилегий для управления этим флагом(приведу пример, серия из Int 0x2A(CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A...) не трейсится). Этот флаг вообще вам и не нужен.<br><br>Для достижения профита смотрите KeContextToKframes() и обратную её апи, либо спросите там, где вам подробно обьеснят <img src="img/smilies/s2.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292156&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=23" class="addthx" data-post="292156"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="24" onfocus="this.blur()" href="JavaScript:di('[b]ARCHANGEL[/b]','')">ARCHANGEL</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6336.png" alt=""><br><span class=txtSm>Ранг: 681.5 <font color=magenta>(<b>! !</b>)</font>, 405thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.85'>Активность: 0.42<span style='color:red'>&searr;</span>0.21</span><br>Статус: <a href="action=userinfo&amp;user=6336">Участник</a><br><font color=blue>ALIEN Hack Team</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 20:44 <br><script type="text/javascript">QU('ARCHANGEL','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ARCHANGEL" target="_blank">Личное сообщение</a> &middot;  <a href="#24" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#24');return false;">#24</a> </span><div align=left><br>
<b>bowrouco пишет:</b><br><i class=x>Вы не в ядре, у вас нет привилегий для управления этим флагом</i><br><br><b>daFix</b>, вспомните нашу вчерашнюю беседу в аське. <img src="img/smilies/s2.gif" alt=""> И делайте как я предлагал. Всё выйдет.<br><br><i class=x>серия из Int 0x2A(CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A CD 2A...) не трейсится)</i><br><br>Она не <b>не трейсится</b>, она проскакивает, т.е. трейс идёт, но останов сработает на второй инструкции за этой конструкцией, что позволяет использовать способ с TF.
<br><br><font size="1"><i>-----<br>Stuck to the plan, always think that we would stand up, never ran.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292157&amp;user=6336&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=24" class="addthx" data-post="292157"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="25" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 21:02 &middot; Поправил: bowrouco <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#25" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#25');return false;">#25</a> </span><div align=left><br>
<b>ARCHANGEL</b><br>Из за хардварной установки RF на iret при т-процессинге взводится RF, это отлаживает трап до следующей инструкции, а там снова вызов шлюза. Таким образом на данной последовательности трап не генерится. Выше я привёл код, который возвращает управление в юзермод.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292159&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=25" class="addthx" data-post="292159"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=6336" title="23-09-2011 17:19, ранг:352.7" target="_blank">ARCHANGEL</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="26" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 сентября 2011 23:39 <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#26" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#26');return false;">#26</a> </span><div align=left><br>
Другими словами, из Ring3 это не возможно? <img src="img/smilies/s4.gif" alt="">
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292162&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=26" class="addthx" data-post="292162"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="27" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2011 10:45 &middot; Поправил: bowrouco <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#27" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#27');return false;">#27</a> </span><div align=left><br>
<b>daFix</b><br>Да. Флажки корректируются при конвертациях т-фрейма в контекст и обратно. Те, на которые налаживается корректирующая маска нельзя изменить. Есчо и не нужно.<br><br>add:<br>Посмотрел константу для XP, в начале KeContextToKframes() есть следующая конструкция:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>and</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>0x3E0DD7</li><li class="hl_l1"><span class="hl_function"><b>or</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>0x200</li>        </ol>
    </div>
</div></div>
<br>Тоесть в символическом виде:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">rEFlags&nbsp;<span class="hl_char">&amp;</span>&nbsp;<span class="hl_char">(</span>EFLAGS_MASK&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_CF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_PF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_AF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_ZF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_SF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_TF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_DF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_OF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_VM&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_AC&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_VIF&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_VIP&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_ID<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">rEFlags&nbsp;<span class="hl_char">|</span>&nbsp;EFLAGS_IF</li>        </ol>
    </div>
</div></div>
<br>В сурсах это макро SANITIZE_FLAGS:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">#define&nbsp;SANITIZE_FLAGS<span class="hl_char">(</span>eFlags<span class="hl_char">,</span>&nbsp;mode<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">\</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>mode<span class="hl_char">)</span>&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;KernelMode&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_char">\</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>0x00000000L<span class="hl_char">)</span>&nbsp;<span class="hl_char">|</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>eFlags<span class="hl_char">)</span>&nbsp;<span class="hl_char">&amp;</span>&nbsp;0x003f0fd7<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">:</span>&nbsp;<span class="hl_char">\</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>EFLAGS_INTERRUPT_MASK<span class="hl_char">)</span>&nbsp;<span class="hl_char">|</span>&nbsp;<span class="hl_char">(</span><span class="hl_char">(</span>eFlags<span class="hl_char">)</span>&nbsp;<span class="hl_char">&amp;</span>&nbsp;EFLAGS_USER_SANITIZE<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span></li>        </ol>
    </div>
</div></div>
<br><br>Из за RF кстате вы можите думать что из Sysenter управление возвращается на следующую за ней инструкцию. На самом деле это не так.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292181&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=27" class="addthx" data-post="292181"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=2777" title="24-09-2011 10:38, ранг:360.0" target="_blank">daFix</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="28" onfocus="this.blur()" href="JavaScript:di('[b]daFix[/b]','')">daFix</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/2777.gif" alt=""><br><span class=txtSm>Ранг: 529.0 (<b>!</b>), 110thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.75'>Активность: 0.29<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=2777">Участник</a><br><font color=blue>5KRT</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2011 13:59 &middot; Поправил: daFix <br><script type="text/javascript">QU('daFix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=daFix" target="_blank">Личное сообщение</a> &middot;  <a href="#28" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#28');return false;">#28</a> </span><div align=left><br>
Беру свои слова про то что <b>bowrouco</b> &quot;особо ни кому не помогает&quot;, обратно <img src="img/smilies/s1.gif" alt=""><br>Что-же, верну тогда всё на место, пусть будет через SingleStep сделано. От одного глюка с потоками <br>избавился, и этого уже достаточно пока. Спасибо всем кто откликнулся. <br>Тему не закрываю, может потом ещё подниму её. Всёравно ни кто тут не флудит
<br><br><font size="1"><i>-----<br>Research For Food</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292196&amp;user=2777&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=28" class="addthx" data-post="292196"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="29" onfocus="this.blur()" href="JavaScript:di('[b]PE_Kill[/b]','')">PE_Kill</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/3232.gif" alt=""><br><span class=txtSm>Ранг: 793.4 <font color=magenta>(<b>! !</b>)</font>, 568thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.59'>Активность: 0.74<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=3232">Участник</a><br><font color=blue>Шаман</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2011 14:06 <br><script type="text/javascript">QU('PE_Kill','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=PE_Kill" target="_blank">Личное сообщение</a> &middot;  <a href="#29" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#29');return false;">#29</a> </span><div align=left><br>
<I>daFix пишет:<br>Беру свои слова про то что bowrouco &quot;особо ни кому не помогает&quot;, обратно </I><br>Да он походу от степени накуренности отвечает. Сейчас с травой напряг и пишет вполне осмысленно, причем даже вполне соответствует своей квалификации, но вот когда травы много он становится довольно странным чудаком, который заканчивает пребывание на форуме баном.
<br><br><font size="1"><i>-----<br>Yann Tiersen best and do not fuck</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=292199&amp;user=3232&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=29" class="addthx" data-post="292199"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="30" onfocus="this.blur()" href="JavaScript:di('[b]bowrouco[/b]','')">bowrouco</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 47.7 (посетитель), 17thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.01'>Активность: 0.09<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=29629">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2011 21:26 <br><script type="text/javascript">QU('bowrouco','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=bowrouco" target="_blank">Личное сообщение</a> &middot;  <a href="#30" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18413.html&amp;page=0#30');return false;">#30</a> </span><div align=left><br>
<b>PE_Kill</b><br>А есчо у меня есть матчасть, написанная инде под воздействием веществ:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Трап<span class="hl_char">-</span>фрейм<span class="hl_char">.</span></li><li class="hl_l1">Это&nbsp;структура&nbsp;описывающая&nbsp;контекст&nbsp;задачи<span class="hl_char">(</span>состояние&nbsp;процессора<span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Механизмы&nbsp;вызова&nbsp;шлюзов</li><li class="hl_l0">досконально&nbsp;рассмотрены&nbsp;в&nbsp;манах&nbsp;на&nbsp;процессор&nbsp;Intel®&nbsp;<span class="hl_number">64</span>&nbsp;<span class="hl_function"><b>and</b></span>&nbsp;IA<span class="hl_char">-</span><span class="hl_number">32</span>&nbsp;Architectures&nbsp;Software</li><li class="hl_l1">Developer’s&nbsp;Manual&nbsp;v<span class="hl_char">.</span>&nbsp;<span class="hl_number">2</span><span class="hl_char">,</span>&nbsp;<span class="hl_number">3</span><span class="hl_char">.</span>&nbsp;Далее&nbsp;описаны&nbsp;механимы&nbsp;переключения&nbsp;уникальные&nbsp;для&nbsp;NT<span class="hl_char">.</span></li><li class="hl_l0">Трап<span class="hl_char">-</span>фрейм&nbsp;содержит&nbsp;регистры&nbsp;и&nbsp;дополнительную&nbsp;информацию&nbsp;необходимую&nbsp;для&nbsp;изоляции</li><li class="hl_l1">задач&nbsp;–&nbsp;предыдущий&nbsp;режим<span class="hl_char">,</span>&nbsp;указатель&nbsp;на&nbsp;голову&nbsp;цепочки&nbsp;SEH&nbsp;и&nbsp;специальный&nbsp;маркер<span class="hl_char">.</span>&nbsp;Когда</li><li class="hl_l0">вызывается&nbsp;вектор&nbsp;в&nbsp;IDT<span class="hl_char">(</span>хардварные&nbsp;прерывания&nbsp;и&nbsp;исключения<span class="hl_char">)</span>&nbsp;или&nbsp;сискал<span class="hl_char">(</span><span class="hl_function">Sysenter</span><span class="hl_char">/</span><span class="hl_function">Syscall</span><span class="hl_char">)</span></li><li class="hl_l1">состояние&nbsp;задачи&nbsp;сохраняется&nbsp;в&nbsp;ядерном&nbsp;стеке&nbsp;в&nbsp;виде&nbsp;трап<span class="hl_char">-</span>фрейма&nbsp;и&nbsp;окружение&nbsp;меняется&nbsp;на</li><li class="hl_l0">ядерное<span class="hl_char">.</span>&nbsp;Рассмотрим&nbsp;механизм&nbsp;подробно<span class="hl_char">.</span></li><li class="hl_l1">Если&nbsp;вектор&nbsp;в&nbsp;IDT&nbsp;вызывается&nbsp;из&nbsp;юзермода<span class="hl_char">,</span>&nbsp;то&nbsp;процессор&nbsp;переключает&nbsp;стек&nbsp;на&nbsp;ядерный<span class="hl_char">,</span>&nbsp;при&nbsp;этом</li><li class="hl_l0">на&nbsp;дне&nbsp;ядерного&nbsp;стека&nbsp;сохраняется&nbsp;пользовательский&nbsp;стек<span class="hl_char">(</span>предыдущие&nbsp;<span class="hl_registr">Ss</span><span class="hl_char">:</span><span class="hl_registr">Esp</span><span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Ядерный&nbsp;стек</li><li class="hl_l1">описан&nbsp;в&nbsp;сегменте&nbsp;состояния&nbsp;задачи<span class="hl_char">(</span>ядерные&nbsp;<span class="hl_registr">Ss</span><span class="hl_char">:</span><span class="hl_registr">Esp</span><span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Отсюда&nbsp;он&nbsp;и&nbsp;загружаются&nbsp;в&nbsp;процессор<span class="hl_char">.</span></li><li class="hl_l0">Сегмент&nbsp;кода<span class="hl_char">(</span><span class="hl_registr">Cs</span><span class="hl_char">:</span>Eip<span class="hl_char">)</span>&nbsp;на&nbsp;который&nbsp;передаётся&nbsp;управление&nbsp;при&nbsp;вызове&nbsp;вектора&nbsp;описан&nbsp;в</li><li class="hl_l1">дескрипторе&nbsp;прерывания<span class="hl_char">.</span>&nbsp;Так&nbsp;как&nbsp;сегмент&nbsp;кода&nbsp;меняется<span class="hl_char">,</span>&nbsp;то&nbsp;процессор&nbsp;сохраняет&nbsp;его<span class="hl_char">,</span>&nbsp;также&nbsp;и</li><li class="hl_l0">регистр&nbsp;флагов<span class="hl_char">.</span>&nbsp;Это&nbsp;позволяет&nbsp;продолжить&nbsp;исполнение&nbsp;с&nbsp;прерванного&nbsp;места<span class="hl_char">.</span>&nbsp;Часть&nbsp;стека&nbsp;на&nbsp;его</li><li class="hl_l1">дне&nbsp;в&nbsp;которой&nbsp;сохраняются&nbsp;эти&nbsp;регистры&nbsp;называется&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фреймом<span class="hl_char">,</span>&nbsp;так&nbsp;как&nbsp;инструкций&nbsp;<span class="hl_function">IRET</span></li><li class="hl_l0">загружает&nbsp;регистры&nbsp;из&nbsp;этой&nbsp;структуры&nbsp;в&nbsp;процессор<span class="hl_char">:</span></li><li class="hl_l1">ErrCode&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; Код ошибки(селектор, флажки и пр.), передаётся как</span></li><li class="hl_l0">информация&nbsp;про&nbsp;исключение<span class="hl_char">.</span>&nbsp;Не&nbsp;является&nbsp;частью&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фрейма<span class="hl_char">(</span>удаляется&nbsp;при&nbsp;формировании</li><li class="hl_l1">трап<span class="hl_char">-</span>фрейма<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l0">rEip&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; Адрес инструкции следующей за Int, адрес инструкции на</span></li><li class="hl_l1">которой&nbsp;возник&nbsp;фолт&nbsp;или&nbsp;адрес&nbsp;возврата&nbsp;из&nbsp;ловушки<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;это&nbsp;смещение&nbsp;в&nbsp;сегменте&nbsp;кода&nbsp;куда</li><li class="hl_l0">будет&nbsp;передано&nbsp;управление&nbsp;при&nbsp;исполнении&nbsp;<span class="hl_function">Iretd</span><span class="hl_char">.</span></li><li class="hl_l1">rCs&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +4, Селектор сегмента кода в котором вызван вектор и куда</span></li><li class="hl_l0">будет&nbsp;выполнен&nbsp;возврат<span class="hl_char">.</span></li><li class="hl_l1">rEFlags&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +2*4, Регистр флагов на момент вызова вектора.</span></li><li class="hl_l0">rEsp&nbsp;PVOID&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +3*4, Транзитный стек, эти два поля определяют стек на</span></li><li class="hl_l1">момент&nbsp;вызова&nbsp;вектора<span class="hl_char">.</span></li><li class="hl_l0">rSs&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +4*4</span></li><li class="hl_l1"><span class="hl_comment">; Следующие 4 поля сохраняются, если вектор вызван из V8086-mode(VDM).</span></li><li class="hl_l0">rEs&nbsp;ULONG&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +5*4</span></li><li class="hl_l1">rDs&nbsp;ULONG&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +6*4</span></li><li class="hl_l0">rFs&nbsp;ULONG&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +7*4</span></li><li class="hl_l1">rGs&nbsp;ULONG&nbsp;<span class="hl_char">?</span>&nbsp;<span class="hl_comment">; +8*4</span></li><li class="hl_l0">Если&nbsp;вектор&nbsp;вызван&nbsp;из&nbsp;ядра<span class="hl_char">,</span>&nbsp;то&nbsp;стек&nbsp;не&nbsp;переключается&nbsp;и&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фрейм&nbsp;не&nbsp;будет&nbsp;содержать</li><li class="hl_l1">пользовательский&nbsp;стек<span class="hl_char">.</span>&nbsp;ISR&nbsp;выполняется&nbsp;на&nbsp;текущем&nbsp;стеке<span class="hl_char">.</span>&nbsp;Из&nbsp;этого&nbsp;следует&nbsp;важный&nbsp;вывод&nbsp;–&nbsp;при</li><li class="hl_l0">вызове&nbsp;векторов&nbsp;в&nbsp;ядре&nbsp;стек&nbsp;не&nbsp;выравнивается<span class="hl_char">.</span>&nbsp;Из<span class="hl_char">-</span>за&nbsp;этого&nbsp;механизм&nbsp;SEH&nbsp;не&nbsp;будет&nbsp;работать<span class="hl_char">,</span>&nbsp;так</li><li class="hl_l1">как&nbsp;диспетчер&nbsp;проверяет&nbsp;валидность&nbsp;цепочки&nbsp;фреймов<span class="hl_char">,</span>&nbsp;в&nbsp;частности&nbsp;она&nbsp;должна&nbsp;быть&nbsp;выровнена</li><li class="hl_l0">на&nbsp;<span class="hl_number">4</span>&nbsp;байта<span class="hl_char">.</span>&nbsp;Таким&nbsp;образом&nbsp;ядерный&nbsp;стек&nbsp;всегда&nbsp;должен&nbsp;быть&nbsp;выравнен&nbsp;на&nbsp;<span class="hl_number">4</span>&nbsp;байта<span class="hl_char">,</span>&nbsp;тоесть&nbsp;размер</li><li class="hl_l1">стековых&nbsp;фреймов&nbsp;должен&nbsp;быть&nbsp;выравнен&nbsp;на&nbsp;<span class="hl_number">4</span>&nbsp;байта<span class="hl_char">(</span>например&nbsp;нельзя&nbsp;использовать&nbsp;байтовые</li><li class="hl_l0">переменные<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1">Если&nbsp;вектор&nbsp;вызван&nbsp;через&nbsp;сискал<span class="hl_char">(</span>инструкция&nbsp;<span class="hl_function">Sysenter</span><span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;то&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фрейм&nbsp;формируется&nbsp;программно<span class="hl_char">.</span></li><li class="hl_l0">При&nbsp;этом&nbsp;источником&nbsp;ядерного&nbsp;стека&nbsp;является&nbsp;регистр&nbsp;MSR&nbsp;IA32_SYSENTER_ESP<span class="hl_char">(</span>DPC<span class="hl_char">-</span>стек<span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Это</li><li class="hl_l1">общий&nbsp;стек&nbsp;для&nbsp;всех&nbsp;потоков<span class="hl_char">(</span>транзитный<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;исполняемых&nbsp;на&nbsp;данном&nbsp;процессоре<span class="hl_char">.</span>&nbsp;Иначе&nbsp;ушло&nbsp;бы</li><li class="hl_l0">много&nbsp;времени&nbsp;на&nbsp;перезагрузку&nbsp;MSR&nbsp;при&nbsp;планировании<span class="hl_char">.</span>&nbsp;Хэндлер&nbsp;сискалов&nbsp;в&nbsp;начале&nbsp;своей&nbsp;работы</li><li class="hl_l1">переключает&nbsp;DPC<span class="hl_char">-</span>стек&nbsp;на&nbsp;потоковый<span class="hl_char">,</span>&nbsp;беря&nbsp;указатель&nbsp;на&nbsp;него&nbsp;из&nbsp;TSS<span class="hl_char">.</span>&nbsp;Туда&nbsp;адрес&nbsp;дна&nbsp;стека</li><li class="hl_l0">загружается&nbsp;планировщиком&nbsp;из&nbsp;описателя&nbsp;потока<span class="hl_char">(</span>ETHREAD<span class="hl_char">.</span>InitialStack<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_function">IRET</span><span class="hl_char">-</span>фрейм&nbsp;находится&nbsp;в&nbsp;конце&nbsp;трап<span class="hl_char">-</span>фрейма<span class="hl_char">,</span>&nbsp;так&nbsp;как&nbsp;он&nbsp;формируется&nbsp;аппаратно<span class="hl_char">.</span>&nbsp;Далее</li><li class="hl_l0">сохраняются&nbsp;RGP&nbsp;и&nbsp;сегментные&nbsp;регистры<span class="hl_char">.</span>&nbsp;Голова&nbsp;цепочки&nbsp;SEH<span class="hl_char">-</span>фреймов&nbsp;сохраняетсяа&nbsp;начало&nbsp;цепи</li><li class="hl_l1">завершается&nbsp;загрузкой&nbsp;маркера&nbsp;EXCEPTION_CHAIN_END<span class="hl_char">(</span>для&nbsp;исключений&nbsp;цепь&nbsp;не&nbsp;завершается<span class="hl_char">,</span></li><li class="hl_l0">таким&nbsp;образом&nbsp;при&nbsp;рекурсивных&nbsp;вызовах&nbsp;исключений&nbsp;будет&nbsp;развёрнута&nbsp;SEH<span class="hl_char">-</span>цепь&nbsp;предыдущего</li><li class="hl_l1">хэндлера<span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Это&nbsp;позволяет&nbsp;изолировать&nbsp;цепочки&nbsp;SEH&nbsp;разных&nbsp;ISR<span class="hl_char">(</span>манипуляция&nbsp;опциональна<span class="hl_char">,</span></li><li class="hl_l0">изоляция&nbsp;происходит&nbsp;не&nbsp;всегда<span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Формирование&nbsp;трап<span class="hl_char">-</span>фрейма&nbsp;завершается&nbsp;загрузкой&nbsp;в</li><li class="hl_l1">отладочные&nbsp;регистры&nbsp;ядерного&nbsp;контекста<span class="hl_char">(</span>если&nbsp;активен&nbsp;ядерный&nbsp;отладчик<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l0">Трап<span class="hl_char">-</span>фрейм&nbsp;изменяется&nbsp;в&nbsp;версиях<span class="hl_char">,</span>&nbsp;для&nbsp;NT&nbsp;<span class="hl_number">5</span><span class="hl_char">.</span><span class="hl_number">1</span>&nbsp;структура&nbsp;имеет&nbsp;следующий&nbsp;вид<span class="hl_char">:</span></li><li class="hl_l1">typedef&nbsp;struct&nbsp;_KTRAP_FRAME&nbsp;{</li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Следующий&nbsp;два&nbsp;поля&nbsp;образуют&nbsp;стековый&nbsp;фрейм<span class="hl_char">.</span></li><li class="hl_l1">ULONG&nbsp;DbgEbp<span class="hl_comment">; // Ebp – ссылка на следующий стековый фрейм или трап-фрейм.</span></li><li class="hl_l0">ULONG&nbsp;DbgEip<span class="hl_comment">; // +4, Eip – адрес возврата из ISR.</span></li><li class="hl_l1">ULONG&nbsp;DbgArgMark<span class="hl_comment">; // +0x8, Маркер трап-фрейма 0xBADB0D00.</span></li><li class="hl_l0">ULONG&nbsp;DbgArgPointer<span class="hl_comment">; // +0xC, Указатель на параметры сервиса, это ссылка на стек с</span></li><li class="hl_l1">параметрами&nbsp;при&nbsp;входе&nbsp;в&nbsp;сервис<span class="hl_char">(</span>в&nbsp;регистре&nbsp;<span class="hl_registr">Edx</span><span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Резервные&nbsp;поля<span class="hl_char">,</span>&nbsp;используются&nbsp;при&nbsp;изменениях&nbsp;фрейма&nbsp;для&nbsp;восстановления&nbsp;стека<span class="hl_char">.</span></li><li class="hl_l1">ULONG&nbsp;TempSegCs<span class="hl_comment">; // +0x10</span></li><li class="hl_l0">ULONG&nbsp;TempEsp<span class="hl_comment">; // +0x14</span></li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Отладочные&nbsp;регистры<span class="hl_char">.</span></li><li class="hl_l0">ULONG&nbsp;Dr0<span class="hl_comment">; // +0x18</span></li><li class="hl_l1">ULONG&nbsp;Dr1<span class="hl_comment">; // +0x1C</span></li><li class="hl_l0">ULONG&nbsp;Dr2<span class="hl_comment">; // +0x20</span></li><li class="hl_l1">ULONG&nbsp;Dr3<span class="hl_comment">; // +0x24</span></li><li class="hl_l0">ULONG&nbsp;Dr6<span class="hl_comment">; // +0x28</span></li><li class="hl_l1">ULONG&nbsp;Dr7<span class="hl_comment">; // +0x2C</span></li><li class="hl_l0">ULONG&nbsp;SegGs<span class="hl_comment">; // +0x30</span></li><li class="hl_l1">ULONG&nbsp;SegEs<span class="hl_comment">; // +0x34</span></li><li class="hl_l0">ULONG&nbsp;SegDs<span class="hl_comment">; // +0x38</span></li><li class="hl_l1">ULONG&nbsp;<span class="hl_registr"><b>Edx</b></span><span class="hl_comment">; // +0x3C</span></li><li class="hl_l0">ULONG&nbsp;<span class="hl_registr"><b>Ecx</b></span><span class="hl_comment">; // +0x40</span></li><li class="hl_l1">ULONG&nbsp;<span class="hl_registr"><b>Eax</b></span><span class="hl_comment">; // +0x44</span></li><li class="hl_l0">ULONG&nbsp;PreviousPreviousMode<span class="hl_comment">; // +0x48, Предыдущий режим, вычисляется на основе CPL.</span></li><li class="hl_l1">PEXCEPTION_REGISTRATION_RECORD&nbsp;ExceptionList<span class="hl_comment">; // +0x4C, Голова цепочки SEH-фреймов.</span></li><li class="hl_l0">ULONG&nbsp;SegFs<span class="hl_comment">; // +0x50</span></li><li class="hl_l1">ULONG&nbsp;<span class="hl_registr"><b>Edi</b></span><span class="hl_comment">; // +0x54</span></li><li class="hl_l0">ULONG&nbsp;<span class="hl_registr"><b>Esi</b></span><span class="hl_comment">; // +0x58</span></li><li class="hl_l1">ULONG&nbsp;<span class="hl_registr"><b>Ebx</b></span><span class="hl_comment">; // 0x5C</span></li><li class="hl_l0">ULONG&nbsp;<span class="hl_registr"><b>Ebp</b></span><span class="hl_comment">;// +0x60</span></li><li class="hl_l1">ULONG&nbsp;ErrCode<span class="hl_comment">; // +0x64, Информация об исключении.</span></li><li class="hl_l0">Пользовательский&nbsp;сегмент&nbsp;кода<span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фрейм<span class="hl_char">.</span></li><li class="hl_l0">ULONG&nbsp;Eip<span class="hl_comment">; // +0x68</span></li><li class="hl_l1">ULONG&nbsp;SegCs<span class="hl_comment">; // +0x6C</span></li><li class="hl_l0">ULONG&nbsp;EFlags<span class="hl_comment">; // +0x70, Флажки.</span></li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Пользовательский&nbsp;стек<span class="hl_char">.</span></li><li class="hl_l0">ULONG&nbsp;HardwareEsp<span class="hl_comment">; // +0x74</span></li><li class="hl_l1">ULONG&nbsp;HardwareSegSs<span class="hl_comment">; // +0x78</span></li><li class="hl_l0"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Поля&nbsp;заполняются&nbsp;при&nbsp;переключении&nbsp;из&nbsp;V86<span class="hl_char">-</span>режима<span class="hl_char">.</span>&nbsp;Валидность&nbsp;полей&nbsp;определяет&nbsp;флажок</li><li class="hl_l1">EFLAGS_V86_MASK<span class="hl_char">.</span></li><li class="hl_l0">ULONG&nbsp;V86Es<span class="hl_comment">; // +0x7C</span></li><li class="hl_l1">ULONG&nbsp;V86Ds<span class="hl_comment">; // +0x80</span></li><li class="hl_l0">ULONG&nbsp;V86Fs<span class="hl_comment">; // +0x84</span></li><li class="hl_l1">ULONG&nbsp;V86Gs<span class="hl_comment">; // +0x88</span></li><li class="hl_l0">}&nbsp;KTRAP_FRAME<span class="hl_comment">;</span></li><li class="hl_l1">Поле&nbsp;DbgArgMark&nbsp;позволяет&nbsp;находить&nbsp;и&nbsp;идентифицировать&nbsp;трап<span class="hl_char">-</span>фреймы&nbsp;по&nbsp;маркеру</li><li class="hl_l0">0xBADB0D00<span class="hl_char">.</span>&nbsp;В&nbsp;начале&nbsp;трап<span class="hl_char">-</span>фрейма&nbsp;находится&nbsp;стековый&nbsp;фрейм<span class="hl_char">,</span>&nbsp;определить&nbsp;что&nbsp;он&nbsp;является</li><li class="hl_l1">частью&nbsp;трап<span class="hl_char">-</span>фрейма&nbsp;можно&nbsp;проверив&nbsp;маркер<span class="hl_char">.</span>&nbsp;При&nbsp;бактрейсе&nbsp;этот&nbsp;маркер&nbsp;позволяет&nbsp;определить</li><li class="hl_l0">конец&nbsp;SFC<span class="hl_char">.</span></li><li class="hl_l1">Рассмотрим&nbsp;подробно&nbsp;как&nbsp;формируется&nbsp;трап<span class="hl_char">-</span>фрейм<span class="hl_char">.</span></li><li class="hl_l0">KiTrap01<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_comment">; ISR #DB.</span></li><li class="hl_l0"><span class="hl_comment">; Очищается TF, IF(прерывания маскируются).</span></li><li class="hl_l1"><span class="hl_comment">; IRET-фрейм формируется аппаратно, текущий стек(Ss:Esp) загружается из TSS.</span></li><li class="hl_l0"><span class="hl_comment">; [Esp] rEip</span></li><li class="hl_l1"><span class="hl_comment">; [Esp + 4] rCs</span></li><li class="hl_l0"><span class="hl_comment">; [Esp + 2*4] rEFlags</span></li><li class="hl_l1"><span class="hl_comment">; [Esp + 3*4] rEsp</span></li><li class="hl_l0"><span class="hl_comment">; [Esp + 4*4] rSs</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_number">0</span>&nbsp;<span class="hl_comment">; Error code.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>esp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">2</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">0</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ebp</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ebx</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">esi</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">edi</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">fs</span></li><li class="hl_l0"><span class="hl_comment">; До обращения к ядерной памяти за пределами стека должны быть перезагружены</span></li><li class="hl_l1">селекторы<span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>0x30&nbsp;<span class="hl_comment">; KGDT_R0_PCR</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">fs</span><span class="hl_char">,</span><span class="hl_registr"><b>bx</b></span>&nbsp;<span class="hl_comment">; Теперь Fs адресует PCR, прямая адресация недопустима, так как адрес</span></li><li class="hl_l0">блока&nbsp;уникален&nbsp;для&nbsp;каждого&nbsp;процессора<span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_comment">; PCR.ExceptionList - голова цепи SEH.</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_comment">; Сохраняем её в фрейме.</span></li><li class="hl_l1"><span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">esp</span><span class="hl_char">,</span><span class="hl_number">4</span>&nbsp;<span class="hl_comment">; Предыдущий режим определим далее при необходимости.</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">eax</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">edx</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">ds</span></li><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">es</span></li><li class="hl_l1"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">gs</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ax</span><span class="hl_char">,</span>0x23&nbsp;<span class="hl_comment">; KGDT_R3_DATA | RPL_MASK</span></li><li class="hl_l1"><span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">esp</span><span class="hl_char">,</span>0x30&nbsp;<span class="hl_comment">; Остальные поля заполним далее.</span></li><li class="hl_l0"><span class="hl_comment">; Перезагружаем Ds и Es.</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">,</span><span class="hl_registr">ax</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">es</span><span class="hl_char">,</span><span class="hl_registr">ax</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebp</span><span class="hl_char">,</span><span class="hl_registr"><b>esp</b></span>&nbsp;<span class="hl_comment">; Теперь Ebp адресует стековый фрейм, который лежит в начале трап-</span></li><li class="hl_l0">фрейма<span class="hl_char">(</span>маркер&nbsp;позволяет&nbsp;идентифицировать&nbsp;фрейм<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>esp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x70<span class="hl_char">]</span><span class="hl_char">,</span>0x20000&nbsp;<span class="hl_comment">; EFlags &amp; EFLAGS_V86_MASK - проверяем мод, если</span></li><li class="hl_l0">вызов&nbsp;в&nbsp;V86&nbsp;режиме<span class="hl_char">,</span>&nbsp;то&nbsp;корректируем&nbsp;сегментные&nbsp;регистры<span class="hl_char">.</span></li><li class="hl_l1"><span class="hl_function"><b>jnz</b></span>&nbsp;V86_kit1_a</li><li class="hl_l0">TargetLabel<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_function"><b>cld</b></span>&nbsp;<span class="hl_comment">; DF аппаратно не очищается.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x60<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; Ebp</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x68<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; Eip</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0xC<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr">edx</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">ebp</span><span class="hl_char">+</span><span class="hl_number">8</span><span class="hl_char">]</span><span class="hl_char">,</span>0xBADB0D00&nbsp;<span class="hl_comment">; Маркер T-фрейма.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">ebp</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_comment">; DbgEbp</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_comment">; DbgEip</span></li><li class="hl_l0"><span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_function"><b>byte</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span>0x50<span class="hl_char">]</span><span class="hl_char">,</span>0xFF&nbsp;<span class="hl_comment">; PCR.DebugActive</span></li><li class="hl_l1"><span class="hl_function"><b>jnz</b></span>&nbsp;Dr_kit1_a&nbsp;<span class="hl_comment">; Отладчик активен, загружаем ядерный Dr-контекст.</span></li><li class="hl_l0"><span class="hl_comment">; Регистр управления Dr7 не обнуляем, это излишне так как поставить брейк на системное ап</span></li><li class="hl_l1">нельзя<span class="hl_char">(</span>в&nbsp;сервисах&nbsp;проверки&nbsp;диапазона<span class="hl_char">)</span><span class="hl_char">.</span></li><li class="hl_l0">ExitLabel<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_char">.</span><span class="hl_char">.</span>&nbsp;<span class="hl_comment">; T-фрейм сформирован, теперь прерывания могут быть размаскированы.</span></li><li class="hl_l0">V86_kit1_a<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_comment">; Копируем хардварно сохранённые регистры в пользовательскую часть фрейма.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x84<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; V86Fs</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x88<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; V86Gs</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x7C<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; V86Es</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x80<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; V86Ds</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x50<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ax</b></span>&nbsp;<span class="hl_comment">; Fs</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x30<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>bx</b></span>&nbsp;<span class="hl_comment">; Gs</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x34<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>cx</b></span>&nbsp;<span class="hl_comment">; Es</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x38<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>dx</b></span>&nbsp;<span class="hl_comment">; Ds</span></li><li class="hl_l0"><span class="hl_function"><b>jmp</b></span>&nbsp;TargetLabel</li><li class="hl_l1">Dr_kit1_a<span class="hl_char">:</span></li><li class="hl_l0"><span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x70<span class="hl_char">]</span><span class="hl_char">,</span>0x20000&nbsp;<span class="hl_comment">; V86 ?</span></li><li class="hl_l1"><span class="hl_function"><b>jnz</b></span>&nbsp;v86mode</li><li class="hl_l0"><span class="hl_function"><b>test</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x6C<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_number">1</span>&nbsp;<span class="hl_comment">; Cs &amp; MODE_MASK</span></li><li class="hl_l1"><span class="hl_function"><b>je</b></span>&nbsp;ExitLabel&nbsp;<span class="hl_comment">; K-mode; вызов из ядра, отладочный контекст уже загружен.</span></li><li class="hl_l0">v86mode<span class="hl_char">:</span></li><li class="hl_l1"><span class="hl_comment">; Вызов из юзермода. Сохраняем Dr-контекст и загружаем ядерный.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>dr0</li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>dr1</li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>dr2</li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x18<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_comment">; Dr0</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x1C<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ecx</b></span>&nbsp;<span class="hl_comment">; Dr1</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x20<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_comment">; Dr2</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span>dr3</li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>dr6</li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>dr7</li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x24<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_comment">; Dr3</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x28<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>ecx</b></span>&nbsp;<span class="hl_comment">; Dr6</span></li><li class="hl_l1"><span class="hl_function"><b>xor</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>ebp</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x2C<span class="hl_char">]</span><span class="hl_char">,</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_comment">; Dr7</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;dr7<span class="hl_char">,</span><span class="hl_registr"><b>ebx</b></span>&nbsp;<span class="hl_comment">; На время инициализации Dr-контекста регистр управления Dr7</span></li><li class="hl_l0">обнуляем<span class="hl_char">.</span></li><li class="hl_l1">Загружаем&nbsp;ядерный&nbsp;Dr<span class="hl_char">-</span>контекст<span class="hl_char">.</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">fs</span><span class="hl_char">:</span><span class="hl_char">[</span>0x20<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; PKPRCB</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x2F8<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; PRCB.ProcessorState.SpecialRegisters.SrKernelDr0</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x2FC<span class="hl_char">]</span>&nbsp;<span class="hl_comment">; etc.</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;dr0<span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;dr1<span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x300<span class="hl_char">]</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x304<span class="hl_char">]</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;dr2<span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;dr3<span class="hl_char">,</span><span class="hl_registr">ecx</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ebx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x308<span class="hl_char">]</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span><span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;0x30C<span class="hl_char">]</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;dr6<span class="hl_char">,</span><span class="hl_registr">ebx</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;dr7<span class="hl_char">,</span><span class="hl_registr"><b>ecx</b></span>&nbsp;<span class="hl_comment">; Загружаем регистр управления, теперь хардварные брейки работают.</span></li><li class="hl_l1"><span class="hl_function"><b>jmp</b></span>&nbsp;ExitLabel</li><li class="hl_l0">Всякий&nbsp;вход&nbsp;в&nbsp;ядро<span class="hl_char">,</span>&nbsp;будь&nbsp;то&nbsp;исключения<span class="hl_char">,</span>&nbsp;прерывания&nbsp;или&nbsp;сискалы&nbsp;приводит&nbsp;к&nbsp;формированию&nbsp;T<span class="hl_char">-</span></li><li class="hl_l1">фрейма<span class="hl_char">.</span>&nbsp;При&nbsp;возврате&nbsp;из&nbsp;ядра<span class="hl_char">(</span>точнее&nbsp;предыдущей&nbsp;ISR<span class="hl_char">)</span>&nbsp;T<span class="hl_char">-</span>фрейм&nbsp;загружается&nbsp;обратно&nbsp;в</li><li class="hl_l0">процессор<span class="hl_char">.</span>&nbsp;Восстанавливаются&nbsp;голова&nbsp;SEH<span class="hl_char">-</span>цепи<span class="hl_char">,</span>&nbsp;RGP<span class="hl_char">,</span>&nbsp;селекторы&nbsp;и&nbsp;<span class="hl_function">IRET</span><span class="hl_char">-</span>фрейм&nbsp;загружается&nbsp;в</li><li class="hl_l1">процессор<span class="hl_char">.</span>&nbsp;При&nbsp;этом&nbsp;может&nbsp;доставляться&nbsp;APC<span class="hl_char">.</span>&nbsp;В&nbsp;WRK&nbsp;манипуляции&nbsp;трап<span class="hl_char">-</span>фреймами&nbsp;можно</li><li class="hl_l0">посмотреть&nbsp;в&nbsp;файлах&nbsp;kimacro<span class="hl_char">.</span><span class="hl_function"><b>inc</b></span>&nbsp;и&nbsp;trap<span class="hl_char">.</span>asm<span class="hl_char">.</span>&nbsp;Для&nbsp;формирования&nbsp;T<span class="hl_char">-</span>фрейма&nbsp;используются&nbsp;макросы</li><li class="hl_l1">ENTER_<span class="hl_char">*</span><span class="hl_char">,</span>&nbsp;для&nbsp;загрузки&nbsp;его&nbsp;в&nbsp;процессор&nbsp;используется&nbsp;макрос&nbsp;EXIT_ALL<span class="hl_char">.</span></li>        </ol>
    </div>
</div></div>
<br>Это не делает рихтера мной, и не попрёт вам. Но даёт ответы на вопросы тс. Вы же идёте лесом <img src="img/smilies/s3.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=292235&amp;user=29629&amp;forum_n=6&amp;topic=18413.html&amp;page=0&amp;anchor=30" class="addthx" data-post="292235"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Подскажите как организовать логику отладчика</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#31" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="18413">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=18413" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
