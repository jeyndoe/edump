<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Виртуальные адреса WinAPI - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Можно ли при написании программы на ассемблере вызывать WinAPI функции на прямую, а не через таблицу импорта. Если можно, то где взять в Интернете информацию об адресах.">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=132'>YDS</a>, <a target='_blank' href='?action=userinfo&amp;user=41701'>_MBK_</a>, <a target='_blank' href='?action=userinfo&amp;user=44014'>user99</a> (+8 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/green.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=1&sortBy=0&page=0.html"><b>Основной форум</b></a> <b class=bulletHead>&#8212;&#8250;</b> Виртуальные адреса WinAPI</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]b0lt[/b]','')">b0lt</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 4.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.99'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=2205">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 22 ноября 2005 17:39 <br><script type="text/javascript">QU('b0lt','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=b0lt" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Можно ли при написании программы на ассемблере вызывать WinAPI функции на прямую, а не через таблицу импорта. Если можно, то где взять в Интернете информацию об адресах.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43121&amp;user=2205&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=1" class="addthx" data-post="43121"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]xDriver[/b]','')">xDriver</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 45.1 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.71'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=587">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 22 ноября 2005 17:45 <br><script type="text/javascript">QU('xDriver','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=xDriver" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<b>Перехват API функций в Windows NT</b> от MS-Rem на WASMe можно найти.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43123&amp;user=587&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=2" class="addthx" data-post="43123"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Bitfry[/b]','')">Bitfry</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 495.3 (мудрец)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.8'>Активность: 0.3<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=410">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 22 ноября 2005 17:59 <br><script type="text/javascript">QU('Bitfry','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Bitfry" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I>b0lt пишет:
<br>где взять в Интернете информацию об адресах. </I>
<br><img src="img/smilies/s5.gif" alt="">
<br>Прикольно.
<br>
<br>А информацию о PE-формате ты читал? А статьи на васме?
<br>Как минимум надо почитать Рихтера.
<br>
<br>Суть в том, что dll (а API - это не что иное как экспорт dll) не имеют абсолютно постоянного адреса. И даже не смотря на то, что база у них постоянная, адреса будут разные для других версий, компов, систем, дров и  т.п.
<br><br><font size="1"><i>-----<br>Всем привет, я вернулся</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=43128&amp;user=410&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=3" class="addthx" data-post="43128"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]DrGolova[/b]','')">DrGolova</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/301.jpg" alt=""><br><span class=txtSm>Ранг: 199.6 (ветеран), 12thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.84'>Активность: 0.1<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=301">Участник</a><br><font color=blue>www.uinc.ru</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 15:45 <br><script type="text/javascript">QU('DrGolova','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DrGolova" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Видимо он спрашивал как использовать функции LoadLibrary()/GetProcAddress() <img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43400&amp;user=301&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=4" class="addthx" data-post="43400"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Ara[/b]','')">Ara</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/24.jpg" alt=""><br><span class=txtSm>Ранг: 1288.1 <b><u>(!!!!)</u></b>, 273thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.96'>Активность: 1.29<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=24">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 15:56 <br><script type="text/javascript">QU('Ara','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ara" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>DrGolova пишет:
<br>Видимо он спрашивал как использовать функции LoadLibrary()/GetProcAddress() </I>
<br>А как вызвать их, не используя таблицу импорта?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43401&amp;user=24&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=5" class="addthx" data-post="43401"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 16:19 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>Ara пишет:
<br>А как вызвать их, не используя таблицу импорта? </I>
<br>Есть два варианта:
<br>1) разобрать заголовок системной библиотеки и найти их там <img src="img/smilies/s2.gif" alt="">
<br>2) использовать конст. адрес - естесно работать будет только на той же версии ОС <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=43403&amp;user=1449&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=6" class="addthx" data-post="43403"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Ara[/b]','')">Ara</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/24.jpg" alt=""><br><span class=txtSm>Ранг: 1288.1 <b><u>(!!!!)</u></b>, 273thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.96'>Активность: 1.29<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=24">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 16:22 <br><script type="text/javascript">QU('Ara','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ara" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>Smon пишет:
<br>1) разобрать заголовок системной библиотеки и найти их там </I>
<br>Не совсем понятно, что имелось ввиду... Что мы найдем в этом заголовке, &quot;разобрав&quot; его?
<br>
<br>п.2 отпадает по указанным причинам %)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43404&amp;user=24&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=7" class="addthx" data-post="43404"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 16:30 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
Процедура GetAPI_ET_CRC32
<br>;  ------------------------- 
<br>;                          
<br>; Хех, сложное имя? Эта процедура ищет имя API-функции в таблице экспортов 
<br>; KERNEL32 (после небольших изменений она будет работать для любой DLL), но 
<br>; теперь требуется только CRC32 API-функции, а не вся строка <img src="img/smilies/s1.gif" alt="">. Также
<br>; потребуется процедура для получения CRC32 вроде той, которую я привел выше.
<br>;
<br>; на входе:
<br>;        EAX = CRC32 имени функции в формате ASCIIz
<br>; на выходе:
<br>;        EAX = адрес API-функции
<br>;
<br>
<br> GetAPI_ET_CRC32 proc
<br>        xor     edx,edx
<br>        xchg    eax,edx                         ; Помещаем CRC32 функции в EDX
<br>        mov     word ptr [ebp+Counter],ax       ; Сбрасываем счетчик
<br>        mov     esi,3Ch
<br>        add     esi,[ebp+kernel]                ; Получае PE-заголовок KERNEL32
<br>        lodsw
<br>        add     eax,[ebp+kernel]                ; Нормализуем
<br>
<br>        mov     esi,[eax+78h]                   ; Получаем указатель на
<br>        add     esi,1Ch                         ; таблицу экспортов
<br>        add     esi,[ebp+kernel]
<br>
<br>        lea     edi,[ebp+AddressTableVA]        ; Указатель на таблицу адресов
<br>        lodsd                                   ; Получаем значение AddressTable
<br>        add     eax,[ebp+kernel]                ; Нормализуем
<br>        stosd                                   ; И сохраняем в ее переменной
<br>
<br>        lodsd                                   ; Получаем значение NameTable 
<br>        add     eax,[ebp+kernel]                ; Нормализуем
<br>        push    eax                             ; Помещаем ее на стек
<br>        stosd                                   ; Сохраняем в ее переменной
<br>
<br>        lodsd                                   ; Получаем значение OrdinalTable
<br>        add     eax,[ebp+kernel]                ; Нормализуем
<br>        stosd                                   ; Сохраняем
<br>
<br>        pop     esi                             ; ESI = NameTable VA
<br>
<br> @?_3:  push    esi                             ; Снова сохраняем
<br>        lodsd                                   ; Получ. указ. на имя API-ф-ции
<br>        add     eax,[ebp+kernel]                ; Нормализуем
<br>        xchg    edi,eax                         ; Сохраняем указатель в EDI
<br>        mov     ebx,edi                         ; И в EBX
<br>
<br>        push    edi                             ; Сохраняем EDI
<br>        xor     al,al                           ; Доходим до NULL&#039;а
<br>        scasb                                   ; Это конец имени API-функции
<br>        jnz     &#036;-1                             
<br>        pop     esi                             ; ESI = Указ. на имя API-ф-ции
<br>
<br>        sub     edi,ebx                         ; EDI = Размер имени API-ф-ции
<br>
<br>        push    edx                             ; Сохраняем CRC32 функции
<br>        call    CRC32                           ; Получаем текущий CRC функции
<br>        pop     edx                             ; Восстанавливаем CRC32 функции
<br>        cmp     edx,eax                         ; Они совпадают?
<br>        jz      @?_4                            ; Если да, это то, что нам надо
<br>
<br>        pop     esi                             ; Восст. указ. на имя функции
<br>        add     esi,4                           ; Переходим к следующему
<br>        inc     word ptr [ebp+Counter]          ; И увеличиваем знач. счетчика
<br>        jmp     @?_3                            ; Получаем следующую API-ф-цию!
<br> @?_4:
<br>        pop     esi                             ; Убираем мусор из стека
<br>        movzx   eax,word ptr [ebp+Counter]      ; AX = счетчик
<br>        shl     eax,1                           ; *2 (это массив слов)
<br>        add     eax,dword ptr [ebp+OrdinalTableVA] ; Нормализуем
<br>        xor     esi,esi                         ; Очищаем ESI
<br>        xchg    eax,esi                         ; ESI = Указ. на ординал; EAX=0
<br>        lodsw                                   ; В AX получаем ординал
<br>        shl     eax,2                           ; И с его помощью переходим к
<br>        add     eax,dword ptr [ebp+AddressTableVA] ; AddressTable (массив
<br>        xchg    esi,eax                         ; двойных слов)
<br>        lodsd                                   ; Получаем адресс API RVA
<br>        add     eax,[ebp+kernel]                ; и нормализуем!! Все!
<br>        ret
<br> GetAPI_ET_CRC32 endp
<br>
<br> AddressTableVA dd      00000000h               ;&#92;
<br> NameTableVA    dd      00000000h               ; &amp;rt; В ЭТОМ ПОРЯДКЕ!!
<br> OrdinalTableVA dd      00000000h               ;/
<br>
<br> kernel         dd      0BFF70000h              ; Подгоните под свои нужды ;)
<br> Counter        dw      0000h
<br>;---[ CUT HERE ]-------------------------------------------------------------
<br>
<br>Далее следует эквивалентный код, но работающий с таблицей импортов. Таким образом вы сможете написать перпроцессный резидент с помощью одних только CRC32 имен API-функций ;). 
<br>
<br>
<br>;---[ CUT HERE ]-------------------------------------------------------------
<br>;
<br>; Процедура GetAPI_IT_CRC32
<br>;  -------------------------
<br>;
<br>; Эта процедура ищет в таблице импортов API-функция, CRC32 которой совпадает
<br>; с переданным процедуре. Это полезно для создания перпроцессных резидентов
<br>; (смотри главу &quot;Перпроцессная резидентность&quot; в данном туториале).
<br>;
<br>; на входе:
<br>;        EAX = CRC32 имени API-функции в формате ASCIIz
<br>; на выходе:
<br>;        EAX = адрес API-функции
<br>;        EBX = указатель на адрес API-функции в таблице импортов
<br>;        CF  = устанавливаем, если вызов функции не удался
<br>;
<br>
<br> GetAPI_IT_CRC32 proc
<br>        mov     dword ptr [ebp+TempGA_IT1],eax  ; Сохранить CRC32 API-функции
<br>        ; на будущее
<br>
<br>        mov     esi,dword ptr [ebp+imagebase]   ; ESI = база образа
<br>        add     esi,3Ch                         ; Получ. указ. на PE-заголовок
<br>        lodsw                                   ; AX = тот указатель
<br>        cwde                                    ; Очищаем MSW EAX&#039;а
<br>        add     eax,dword ptr [ebp+imagebase]   ; Нормализуем указатель
<br>        xchg    esi,eax                         ; ESI = такой указатель
<br>        lodsd                                   ; Получаем DWORD
<br>
<br>        cmp     eax,&quot;EP&quot;                        ; Это метка PE?
<br>        jnz     nopes                           ; Нет... duh!
<br>
<br>        add     esi,7Ch                         ; ESI = PE-заголовок+80h
<br>        lodsd                                   ; Ищем .idata
<br>        push    eax
<br>        lodsd                                   ; Получаем размер
<br>        mov     ecx,eax
<br>        pop     esi
<br>        add     esi,dword ptr [ebp+imagebase]   ; Нормализуем
<br>
<br> SearchK32:
<br>        push    esi                             ; Сохраняем ESI в стек
<br>        mov     esi,[esi+0Ch]                   ; ESI = указатель на имя
<br>        add     esi,dword ptr [ebp+imagebase]   ; Нормализуем
<br>        lea     edi,[ebp+K32_DLL]               ; Указатель на &#039;KERNEL32.dll&#039;
<br>        mov     ecx,K32_Size                    ; Размер строки
<br>        cld                                     ; Очищаем флаг направления
<br>        push    ecx                             ; Сохраняем ECX
<br>        rep     cmpsb                           ; Сохраняем байты
<br>        pop     ecx                             ; Восстанавливаем ECX
<br>        pop     esi                             ; Восстанавливаем ESI
<br>        jz      gotcha                          ; Были ли они равны? Черт...
<br>        add     esi,14h                         ; Получаем другое поле
<br>        jmp     SearchK32                       ; И ищем снова
<br> gotcha:
<br>        cmp     byte ptr [esi],00h              ; Это OriginalFirstThunk 0?
<br>        jz      nopes                           ; Проклятье, если так...
<br>        mov     edx,[esi+10h]                   ; Получаем FirstThunk
<br>        add     edx,dword ptr [ebp+imagebase]   ; Нормализуем
<br>        lodsd                                   ; Получаем его
<br>        or      eax,eax                         ; Это 0?
<br>        jz      nopes                           ; Проклятье...
<br>
<br>        xchg    edx,eax                         ; Получаем указатель на него
<br>        add     edx,[ebp+imagebase]
<br>        xor     ebx,ebx
<br> loopy:
<br>        cmp     dword ptr [edx+00h],00h         ; Последний RVA?
<br>        jz      nopes                           ; Проклятье...
<br>        cmp     byte ptr  [edx+03h],80h         ; Ординал?
<br>        jz      reloop                          ; Проклятье...
<br>
<br>        mov     edi,[edx]                       ; Получаем указатель на
<br>        add     edi,dword ptr [ebp+imagebase]   ; импортированную API-функцию
<br>        inc     edi
<br>        inc     edi
<br>        mov     esi,edi                         ; ESI = EDI
<br>
<br>        pushad                                  ; Сохраняем все регистры
<br>        eosz_edi                                ; В EDI получаем конец строки
<br>        sub     edi,esi                         ; EDI = размер имени функции
<br>
<br>        call    CRC32
<br>        mov     [esp+18h],eax                   ; В ECX - результат после POPAD
<br>        popad
<br>
<br>        cmp     dword ptr [ebp+TempGA_IT1],ecx  ; CRC32 данной API-функции
<br>        jz      wegotit                         ; совпадает с той, которая
<br>        ; нам нужна?
<br> reloop:
<br>        inc     ebx                             ; Если, совершаем следующий
<br>        add     edx,4                           ; проход и ищем нужную функцию
<br>        ; в таблице импортов
<br>        loop    loopy
<br> wegotit:
<br>        shl     ebx,2                           ; Умножаем на 4
<br>        add     ebx,eax                         ; Добавляем FirstThunk
<br>        mov     eax,[ebx]                       ; EAX = адрес API-функции
<br>        test    al,00h                          ; Пересечение: избегаем STC <img src="img/smilies/s1.gif" alt="">
<br>        org     &#036;-1
<br> nopes:
<br>        stc
<br>        ret
<br> GetAPI_IT_CRC32 endp
<br>
<br> TempGA_IT1     dd      00000000h
<br> imagebase      dd      00400000h
<br> K32_DLL        db      &quot;KERNEL32.dll&quot;,0
<br> K32_Size       equ     &#036;-offset K32_DLL
<br>
<br>;---[ CUT HERE ]------------------------------------
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=43408&amp;user=1449&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=8" class="addthx" data-post="43408"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 16:31 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
CRC32 некоторых API-функций: 
<br>
<br>
<br> Имя API-функции        CRC32        Имя API-функции        CRC32
<br> ---------------        -----        ---------------        -----
<br> CreateFileA            08C892DDFh   CloseHandle            068624A9Dh
<br> FindFirstFileA         0AE17EBEFh   FindNextFileA          0AA700106h
<br> FindClose              0C200BE21h   CreateFileMappingA     096B2D96Ch
<br> GetModuleHandleA       082B618D4h   GetProcAddress         0FFC97C1Fh
<br> MapViewOfFile          0797B49ECh   UnmapViewOfFile        094524B42h
<br> GetFileAttributesA     0C633D3DEh   SetFileAttributesA     03C19E536h
<br> ExitProcess            040F57181h   SetFilePointer         085859D42h
<br> SetEndOfFile           059994ED6h   DeleteFileA            0DE256FDEh
<br> GetCurrentDirectoryA   0EBC6C18Bh   SetCurrentDirectoryA   0B2DBD7DCh
<br> GetWindowsDirectoryA   0FE248274h   GetSystemDirectoryA    0593AE7CEh
<br> LoadLibraryA           04134D1ADh   GetSystemTime          075B7EBE8h
<br> CreateThread           019F33607h   WaitForSingleObject    0D4540229h
<br> ExitThread             0058F9201h   GetTickCount           0613FD7BAh
<br> FreeLibrary            0AFDF191Fh   WriteFile              021777793h
<br> GlobalAlloc            083A353C3h   GlobalFree             05CDF6B6Ah
<br> GetFileSize            0EF7D811Bh   ReadFile               054D8615Ah
<br> GetCurrentProcess      003690E66h   GetPriorityClass       0A7D0D775h
<br> SetPriorityClass       0C38969C7h   FindWindowA            085AB3323h
<br> PostMessageA           086678A04h   MessageBoxA            0D8556CF7h
<br> RegCreateKeyExA        02C822198h   RegSetValueExA         05B9EC9C6h
<br> MoveFileA              02308923Fh   CopyFileA              05BD05DB1h
<br> GetFullPathNameA       08F48B20Dh   WinExec                028452C4Fh
<br> CreateProcessA         0267E0B05h   _lopen                 0F2F886E3h
<br> MoveFileExA            03BE43958h   CopyFileExA            0953F2B64h
<br> OpenFile               068D8FC46h
<br>
<br>Эт Бельцебу накатал, который Билли =)
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=43409&amp;user=1449&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=9" class="addthx" data-post="43409"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]Smon[/b]','')">Smon</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 500.5 (<b>!</b>), 8thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.33'>Активность: 0.23<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 16:34 <br><script type="text/javascript">QU('Smon','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Smon" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<I>Ara пишет:
<br>Не совсем понятно, что имелось ввиду... Что мы найдем в этом заголовке, &quot;разобрав&quot; его? </I>
<br>Адрес таблицы экспортов <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>&quotПусть видят, что мы не шутим. Стволы для понта, ножи для дела&quot Lock, Stock &amp Two Smoking Barrels</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=43411&amp;user=1449&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=10" class="addthx" data-post="43411"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Mordred[/b]','')">Mordred</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 39.3 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.76'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=2766">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 ноября 2005 17:58 <br><script type="text/javascript">QU('Mordred','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Mordred" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
Если есть возможность, найди выпуск &quot;Хакер&quot; за август 2005го. Там есть неплохая статейка на эту тему, правда не на асме, а на С++, но идею имхо можно заюзать...<img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43428&amp;user=2766&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=11" class="addthx" data-post="43428"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]b0lt[/b]','')">b0lt</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 4.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.99'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=2205">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 ноября 2005 15:45 <br><script type="text/javascript">QU('b0lt','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=b0lt" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=1&amp;topic=3304.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Спасибо всем за ответы. Тему можно закрыть.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=43580&amp;user=2205&amp;forum_n=1&amp;topic=3304.html&amp;page=0&amp;anchor=12" class="addthx" data-post="43580"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/green.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=1&sortBy=0&page=0.html"><b>Основной форум</b></a> <b class=bulletHead>&#8212;&#8250;</b> Виртуальные адреса WinAPI</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=3304" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
