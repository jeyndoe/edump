<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Обработка TLS - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Возникли проблемы с обработкой TLS загружаемого образа. Перед обработкой TLS я проделал такие шаги: 1) Загрузил дисковый PE-образ в память 2) Выделил память в куче и спроецировал туда секции и заголовки 3) Обработал релоки и">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=40382'>jinoweb</a>, <a target='_blank' href='?action=userinfo&amp;user=26261'>bartolomeo</a>, <a target='_blank' href='?action=userinfo&amp;user=1533'>rmn</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Обработка TLS</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Aoizora[/b]','')">Aoizora</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.98'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=42828">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 01 августа 2017 23:13 <br><script type="text/javascript">QU('Aoizora','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Aoizora" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Возникли проблемы с обработкой TLS загружаемого образа. Перед обработкой TLS я проделал такие шаги:<br><br>1) Загрузил дисковый PE-образ в память<br>2) Выделил память в куче и спроецировал туда секции и заголовки<br>3) Обработал релоки и импорт<br><br>Теперь надо обработать TLS, если он имеется. Я написал такой код:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">bool&nbsp;LoadPE_DirectoryExists<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">,</span>&nbsp;unsigned&nbsp;long&nbsp;id<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_char">(</span>ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pPeHdr<span class="hl_char">-</span><span class="hl_char">&gt;</span>OptionalHeader<span class="hl_char">.</span>NumberOfRvaAndSizes&nbsp;<span class="hl_char">-</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">&gt;</span><span class="hl_char">=</span>&nbsp;id</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">&amp;</span><span class="hl_char">&amp;</span>&nbsp;ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pPeHdr<span class="hl_char">-</span><span class="hl_char">&gt;</span>OptionalHeader<span class="hl_char">.</span>DataDirectory<span class="hl_char">[</span>id<span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">bool&nbsp;LoadPE_HasTLS<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;LoadPE_DirectoryExists<span class="hl_char">(</span>ctx<span class="hl_char">,</span>&nbsp;IMAGE_DIRECTORY_ENTRY_TLS<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>DWORD</b></span>&nbsp;LoadPE_GetTLS<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">)</span></li><li class="hl_l0">{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pPeHdr<span class="hl_char">-</span><span class="hl_char">&gt;</span>OptionalHeader<span class="hl_char">.</span>DataDirectory<span class="hl_char">[</span>IMAGE_DIRECTORY_ENTRY_TLS<span class="hl_char">]</span><span class="hl_char">.</span>VirtualAddress<span class="hl_comment">;</span></li><li class="hl_l0">}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;LoadPE_ProcessTLS<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>LoadPE_HasTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_DIRECTORY32&nbsp;tls&nbsp;<span class="hl_char">=</span>&nbsp;PIMAGE_TLS_DIRECTORY32<span class="hl_char">(</span>ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pbRealImageBase&nbsp;<span class="hl_char">+</span>&nbsp;LoadPE_GetTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;StartAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>StartAddressOfRawData&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;EndAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>EndAddressOfRawData&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;CallbackAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>AddressOfCallBacks&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;Callbacks: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_CALLBACK<span class="hl_char">*</span>&nbsp;cb_addr&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_TLS_CALLBACK&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pbRealImageBase&nbsp;<span class="hl_char">+</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>AddressOfCallBacks<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>cb_addr<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;cb_addr&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">}</li>        </ol>
    </div>
</div></div>
<br><br>Пытался исправить его и написал так:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;LoadPE_ProcessTLS<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>LoadPE_HasTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_DIRECTORY32&nbsp;tls&nbsp;</span><span class="hl_char">=</span>&nbsp;PIMAGE_TLS_DIRECTORY32<span class="hl_char">(</span>ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pbRealImageBase&nbsp;<span class="hl_char">+</span>&nbsp;LoadPE_GetTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;StartAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>StartAddressOfRawData&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;EndAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>EndAddressOfRawData&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;CallbackAddress: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>AddressOfCallBacks&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;Callbacks: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_CALLBACK<span class="hl_char">*</span>&nbsp;cb_addr&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_TLS_CALLBACK&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>AddressOfCallBacks<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>cb_addr<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;cb_addr&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">DWORD</span><span class="hl_char">*</span>&nbsp;lpDataBlock&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>__readfsdword<span class="hl_char">(</span>0x2C<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>hex&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_char">*</span>lpDataBlock&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;data_begin&nbsp;<span class="hl_char">=</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>StartAddressOfRawData<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;data_end&nbsp;<span class="hl_char">=</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>EndAddressOfRawData<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;i&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span>data_begin&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;data_end<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_char">*</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">*</span><span class="hl_char">)</span>data_begin&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot; at &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;data_begin&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lpDataBlock</span><span class="hl_char">[</span>i<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;data_begin<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_begin&nbsp;</span><span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br>Но при вычислении условия цикла программа крашится. Что у меня не так?<br><br>Кроме того, я не до конца понимаю механизм работы TLS, хотя сегодня и прочитал несколько статей. В директории TLS имеется структура с указателями на данные и на массив адресов коллбэков. Коллбэки вызываются загрузчиком, а что делать с адресами данных? Где и для чего выделять память под индекс? Блок данных можно получить при помощи _readfswdord(0x2C). Что с ним делать дальше?<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Обработка&nbsp;TLS<span class="hl_char">.</span></li><li class="hl_l1">Освежим&nbsp;в&nbsp;памяти&nbsp;структуру&nbsp;этой&nbsp;каталога<span class="hl_char">:</span></li><li class="hl_l0">StartAddressOfRawData</li><li class="hl_l1">EndAddressOfRawData</li><li class="hl_l0">AddressOfIndex</li><li class="hl_l1">AddressOfCallbacks</li><li class="hl_l0">SizeOfZeroFill</li><li class="hl_l1">Characteristics</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">Нам&nbsp;интересны&nbsp;первые&nbsp;три&nbsp;поля<span class="hl_char">.</span>&nbsp;Первые&nbsp;два&nbsp;указывают&nbsp;на&nbsp;сами&nbsp;данные&nbsp;<span class="hl_char">-</span>&nbsp;это&nbsp;статические&nbsp;и&nbsp;глобальные&nbsp;переменные<span class="hl_char">,</span>&nbsp;которые&nbsp;необходимо&nbsp;сделать&nbsp;уникальными&nbsp;для&nbsp;каждого&nbsp;потока&nbsp;в&nbsp;текущем&nbsp;процессе<span class="hl_char">.</span>&nbsp;Создаем&nbsp;секцию&nbsp;<span class="hl_char">.</span>tls&nbsp;для&nbsp;данных&nbsp;размера&nbsp;EndAddressOfRawData&nbsp;<span class="hl_char">-</span>&nbsp;StartAddressOfRawData<span class="hl_char">,</span>&nbsp;чтобы&nbsp;загрузчик&nbsp;выделил&nbsp;необходимую&nbsp;память&nbsp;для&nbsp;их&nbsp;размещения<span class="hl_char">.</span>&nbsp;Сами&nbsp;данные&nbsp;не&nbsp;копируем&nbsp;<span class="hl_char">(</span>обычно&nbsp;эти&nbsp;переменные&nbsp;равны&nbsp;нулю<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;так&nbsp;как&nbsp;это&nbsp;может&nbsp;послужить&nbsp;сигнатурой&nbsp;для&nbsp;детекта<span class="hl_char">.</span>&nbsp;Третье&nbsp;поле&nbsp;AddressOfIndex&nbsp;<span class="hl_char">-</span>&nbsp;это&nbsp;адрес<span class="hl_char">,</span>&nbsp;куда&nbsp;загрузчик&nbsp;запишет&nbsp;индекс&nbsp;блока&nbsp;данных&nbsp;потока<span class="hl_char">,</span>&nbsp;создаваемого&nbsp;при&nbsp;запуске&nbsp;программы<span class="hl_char">,</span>&nbsp;этот&nbsp;индекс<span class="hl_char">,</span>&nbsp;соответсвенно&nbsp;будет&nbsp;равен&nbsp;нулю<span class="hl_char">.</span>&nbsp;В&nbsp;это&nbsp;поле&nbsp;необходимо&nbsp;поместить&nbsp;адрес&nbsp;из&nbsp;секции&nbsp;данных<span class="hl_char">.</span></li><li class="hl_l0">После&nbsp;загрузки&nbsp;защищаемого&nbsp;файла<span class="hl_char">,</span>&nbsp;мы&nbsp;находим&nbsp;его&nbsp;секцию&nbsp;TLS<span class="hl_char">.</span>&nbsp;Первым&nbsp;делом&nbsp;нужно&nbsp;найти&nbsp;указатель&nbsp;на&nbsp;блок&nbsp;данных<span class="hl_char">,</span>&nbsp;чтобы&nbsp;скопировать&nbsp;реальные&nbsp;данные<span class="hl_char">.</span>&nbsp;Указатель&nbsp;на&nbsp;массив&nbsp;адресов&nbsp;<span class="hl_char">(</span>адресов&nbsp;блоков&nbsp;данных<span class="hl_char">)</span>&nbsp;можно&nbsp;получить&nbsp;из&nbsp;структуры&nbsp;TIB<span class="hl_char">,</span>&nbsp;адрес&nbsp;TIB&nbsp;находится&nbsp;в&nbsp;сегментном&nbsp;регистре&nbsp;<span class="hl_registr">FS</span><span class="hl_char">.</span>&nbsp;Сам&nbsp;указатель&nbsp;на&nbsp;массив&nbsp;адресов&nbsp;находится&nbsp;по&nbsp;смещению&nbsp;<span class="hl_number">2ch</span><span class="hl_char">,</span>&nbsp;то&nbsp;есть&nbsp;нам&nbsp;нужно&nbsp;выполнить&nbsp;следующий&nbsp;код<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">FS</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_number">2ch</span><span class="hl_char">]</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;prt&nbsp;<span class="hl_char">[</span><span class="hl_registr"><b>edi</b></span>&nbsp;<span class="hl_char">+</span>&nbsp;Index&nbsp;<span class="hl_char">*</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;но&nbsp;помня<span class="hl_char">,</span>&nbsp;что&nbsp;индекс&nbsp;первого&nbsp;потока&nbsp;равен&nbsp;нулю<span class="hl_char">,</span>&nbsp;получаем<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">FS</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_number">2ch</span><span class="hl_char">]</span></li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">edi</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>dword</b></span>&nbsp;prt&nbsp;<span class="hl_char">[</span><span class="hl_registr">edi</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">После&nbsp;копирования&nbsp;данных&nbsp;необходимо&nbsp;проверить&nbsp;наличие&nbsp;функций&nbsp;обратного&nbsp;вызова&nbsp;<span class="hl_char">(</span>TLS&nbsp;callbacks<span class="hl_char">)</span><span class="hl_char">.</span>&nbsp;Функция&nbsp;обратного&nbsp;вызова&nbsp;имеет&nbsp;тот&nbsp;же&nbsp;прототип&nbsp;что&nbsp;и&nbsp;DllMain<span class="hl_char">:</span></li><li class="hl_l1">typedef&nbsp;<span class="hl_function"><b>VOID</b></span>&nbsp;<span class="hl_char">(</span>NTAPI&nbsp;<span class="hl_char">*</span>PIMAGE_TLS_CALLBACK<span class="hl_char">)</span>&nbsp;<span class="hl_char">(</span></li><li class="hl_l0">PVOID&nbsp;DllHandle<span class="hl_char">,</span>&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;дескриптор&nbsp;модуля</li><li class="hl_l1"><span class="hl_function"><b>DWORD</b></span>&nbsp;Reason<span class="hl_char">,</span>&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;причина&nbsp;вызова</li><li class="hl_l0">PVOID&nbsp;Reserved&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;зарезервировано</li><li class="hl_l1"><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">При&nbsp;вызове&nbsp;функции&nbsp;обратного&nbsp;вызова&nbsp;необходимо&nbsp;передать&nbsp;параметр&nbsp;Reason&nbsp;равным&nbsp;DLL_PROCESS_ATTACH</span><span class="hl_char">.</span>&nbsp;На&nbsp;это&nbsp;обработака&nbsp;TLS&nbsp;заканчивается<span class="hl_char">.</span></li>        </ol>
    </div>
</div></div>
<br><br>Что копировать, откуда и куда? Непонятно.<br><br>&gt;Третье поле AddressOfIndex - это адрес, куда загрузчик запишет индекс блока данных потока<br>Какого блока данных? Как получить его адрес?<br><br>&gt;создаваемого при запуске программы, этот индекс, соответсвенно будет равен нулю<br>А потом как будет меняться этот индекс?<br><br>&gt;В это поле необходимо поместить адрес из секции данных<br>Секция данных большая, какой именно адрес?<br><br>&gt;Первым делом нужно найти указатель на блок данных, чтобы скопировать реальные данные<br>Копировать откуда и куда?<br><br>&gt;Указатель на массив адресов (адресов блоков данных) можно получить из структуры TIB<br>Ок, получил. Что с ним делать?<br><br>&gt;но помня, что индекс первого потока равен нулю, получаем<br>А если потоков много, кто будет именять индекс?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=377748&amp;user=42828&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=1" class="addthx" data-post="377748"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Vamit[/b]','')">Vamit</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/20406.jpg" alt=""><br><span class=txtSm>Ранг: 331.1 (мудрец), 561thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.3'>Активность: 0.19<span style='color:red'>&searr;</span>0.06</span><br>Статус: <a href="action=userinfo&amp;user=20406">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 августа 2017 08:41 <br><script type="text/javascript">QU('Vamit','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Vamit" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Почитайте инфу от разработчика сей штуки, тогда вам станет ясно что за данные и для чего. <noindex><a href="https://msdn.microsoft.com/en-us/library/6yh4a9k1.aspx" rel="nofollow" target="_blank">--&gt; Link &lt;--</a></noindex>
<br><br><font size="1"><i>-----<br>Everything is relative...</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=377752&amp;user=20406&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=2" class="addthx" data-post="377752"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Aoizora[/b]','')">Aoizora</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.98'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=42828">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 августа 2017 12:58 <br><script type="text/javascript">QU('Aoizora','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Aoizora" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
Прочитал <noindex><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686749(v=vs.85).aspx" rel="nofollow" target="_blank">эту статью</a></noindex> и мало что понял.<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>void</b></span>&nbsp;LoadPE_ProcessTLS<span class="hl_char">(</span>LoadPE_CONTEXT<span class="hl_char">*</span>&nbsp;ctx<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>LoadPE_HasTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_DIRECTORY32&nbsp;tls&nbsp;</span><span class="hl_char">=</span>&nbsp;PIMAGE_TLS_DIRECTORY32<span class="hl_char">(</span>ctx<span class="hl_char">-</span><span class="hl_char">&gt;</span>pbRealImageBase&nbsp;<span class="hl_char">+</span>&nbsp;LoadPE_GetTLS<span class="hl_char">(</span>ctx<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot;Callbacks: &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_TLS_CALLBACK<span class="hl_char">*</span>&nbsp;cb_addr&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PIMAGE_TLS_CALLBACK&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>AddressOfCallBacks<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">*</span>cb_addr<span class="hl_char">+</span><span class="hl_char">+</span><span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;cb_addr&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PTEB&nbsp;teb&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">(</span>PTEB<span class="hl_char">)</span>__readfsdword<span class="hl_char">(</span>0x18<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;teb<span class="hl_char">-</span><span class="hl_char">&gt;</span>ThreadLocalStoragePointer&nbsp;<span class="hl_char">=</span>&nbsp;HeapAlloc<span class="hl_char">(</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetProcessHeap</span><span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_char">,</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HEAP_ZERO_MEMORY</span><span class="hl_char">,</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tls</span><span class="hl_char">-</span><span class="hl_char">&gt;</span>EndAddressOfRawData&nbsp;<span class="hl_char">-</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>StartAddressOfRawData</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;data_begin&nbsp;<span class="hl_char">=</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>StartAddressOfRawData<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;data_end&nbsp;<span class="hl_char">=</span>&nbsp;tls<span class="hl_char">-</span><span class="hl_char">&gt;</span>EndAddressOfRawData<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>while</b></span>&nbsp;<span class="hl_char">(</span>data_begin&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;data_end<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>cout&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_char">*</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">*</span><span class="hl_char">)</span>data_begin&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_quote">&quot; at &quot;</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;data_begin&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;<span class="hl_function">std</span><span class="hl_char">:</span><span class="hl_char">:</span>endl<span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">(</span><span class="hl_char">(</span><span class="hl_function"><b>DWORD</b></span>&nbsp;<span class="hl_char">*</span><span class="hl_char">)</span>teb<span class="hl_char">-</span><span class="hl_char">&gt;</span>ThreadLocalStoragePointer<span class="hl_char">)</span><span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;data_begin<span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_begin&nbsp;</span><span class="hl_char">+</span><span class="hl_char">=</span>&nbsp;<span class="hl_number">4</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br><br>Я получил таблицу TLS-слотов из TEB и в нулевой ячейке выделил память для необходимого числа переменных. Скорее всего, я что-то сделал не так.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=377753&amp;user=42828&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=3" class="addthx" data-post="377753"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 338.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 06 августа 2017 02:07 &middot; Поправил: difexacaw <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Эта задача не может быть корректно решена. Это частный случай Run-PE через реинит процесса. Вы можите только эмулировать среду(TLS), но такая обработка не полноценна. Для норм реализации загрузчик должен быть вызван повторно, для такого вызова должны быть сброшены его переменные. И первый облом при этом происходит на установке соединения с csrss <noindex><a href="https://yadi.sk/d/a0n1noAB3Fa3pM" rel="nofollow" target="_blank">--&gt; Link &lt;--</a></noindex><br><br>STATUS_PORT_CONNECTION_REFUSED
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=377790&amp;user=40990&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=4" class="addthx" data-post="377790"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Aoizora[/b]','')">Aoizora</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.98'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=42828">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 06 августа 2017 22:02 <br><script type="text/javascript">QU('Aoizora','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Aoizora" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
&gt;Эта задача не может быть корректно решена. Это частный случай Run-PE через реинит процесса<br><br>Ты путаешь понятия. RunPE это инжект в другой процесс, иначе называется process hollowing.<br>Я пишу код, который проецирует PE-файл на адресное пространство того же процесса. Хотя я согласен насчет того, что такой загрузчик реализуется рекурсивно: например, для того, чтобы этим же загрузчиком загрузить необходимые DLL (ведь подразумевается, что другого загрузчика нет, а DLL грузить надо).
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=377799&amp;user=42828&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=5" class="addthx" data-post="377799"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 338.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 06 августа 2017 23:14 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<b>Aoizora</b><br><br>Нет, не путаю. Это вы не понимаете - что бы запустить полноценную обработку некоторых механизмов, нужно рестартить загрузчик. Тоесть если он уже отработал, то механизм уже не запустить или это можно сделать сложным путём, доставать интернал структуры из модуля. В случае с тлс эмулировать его видимо лучший способ.
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=377801&amp;user=40990&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=6" class="addthx" data-post="377801"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Aoizora[/b]','')">Aoizora</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.0 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.98'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=42828">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 06 августа 2017 23:58 <br><script type="text/javascript">QU('Aoizora','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Aoizora" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
Эмуляция TLS? Каким образом это реализуется?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=377802&amp;user=42828&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=7" class="addthx" data-post="377802"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]difexacaw[/b]','')">difexacaw</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/40990.png" alt=""><br><span class=txtSm>Ранг: 338.5 (мудрец), 348thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 4.02'>Активность: 2.11<span style='color:green'>&nearr;</span>2.42</span><br>Статус: <a href="action=userinfo&amp;user=40990">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 августа 2017 03:40 <br><script type="text/javascript">QU('difexacaw','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=difexacaw" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=24827.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<b>Aoizora</b><br><br>Это как вы и делаете, тоесть не система это всё обрабатывает.<br><br>Я тут покопался, получается следующее. В 10-ке тлс обрабатывается при загрузке модуля LdrpSnapModule -&gt; LdrpDoPostSnapWork -&gt; LdrHandleTlsData, таким образом вызываются тлс колбеки при обычной загрузке, даже если exe не содержит тлс. Аналогично в 7 и 8.<br><br>Это значит что если загрузчик сделан грамотно, как обёртка над системным загрузчиком, то тлс механизм поддерживается без проблем. Иначе можно попробовать вызвать принудительно загрузочные апи для обработки тлс.<br><br><img src="img/attach.gif" alt=""> <a href="./files/9a91_07.08.2017_EXELAB.rU.tgz">9a91_07.08.2017_EXELAB.rU.tgz</a> - Tls.zip
<br><br><font size="1"><i>-----<br>vx</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=377806&amp;user=40990&amp;forum_n=6&amp;topic=24827.html&amp;page=0&amp;anchor=8" class="addthx" data-post="377806"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=4773" title="07-08-2017 01:04, ранг:250.5" target="_blank">plutos</a></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Обработка TLS</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#9" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="24827">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=24827" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
