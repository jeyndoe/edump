<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Как организовать синхронизацию сортированных записей в TList со списком в TListView? - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Пишу небольшую серверную часть которая должна принимать от клиентов некое число и отображать всех подключенных в ListView табличке в отсортированном виде. Все коннекты хранятся в списке который сортируется и обновляется по мере">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b> (+2 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Как организовать синхронизацию сортированных записей в TList со списком в TListView?</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 02:43 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Пишу небольшую серверную часть которая должна принимать от клиентов некое число и отображать всех подключенных в ListView табличке в отсортированном виде. Все коннекты хранятся в списке который сортируется и обновляется по мере отключения, подключения и передачи данных клиентами. Всё работает сносно, но очень не нравится мне синхронизация сортированных записей в TList с TListView. Сделал как сумел, но чувствую есть способы грамотнее и красивее. Очень прошу подсказать как реализовать всё это без постоянной очистки и регенерации ListView. Сейчас по таймеру вызываю Refresh...<br>Вот код:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">type</li><li class="hl_l1">&nbsp;&nbsp;PConnects&nbsp;<span class="hl_char">=</span>&nbsp;^TConnects<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;TConnects&nbsp;<span class="hl_char">=</span>&nbsp;record</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;IP<span class="hl_char">:</span>&nbsp;ShortString<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ThreadID<span class="hl_char">:</span>&nbsp;Cardinal<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;Connection<span class="hl_char">:</span>&nbsp;TidTCPServerConnection<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;Info<span class="hl_char">:</span>&nbsp;shortstring<span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">var&nbsp;conn<span class="hl_char">:</span>&nbsp;TList<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">procedure&nbsp;TForm1<span class="hl_char">.</span>FormCreate<span class="hl_char">(</span>Sender<span class="hl_char">:</span>&nbsp;TObject<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">conn<span class="hl_char">:</span><span class="hl_char">=</span>TList<span class="hl_char">.</span>Create<span class="hl_comment">; // Создаём список</span></li><li class="hl_l1">IdTCPServer1<span class="hl_char">.</span>Active<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_function"><b>true</b></span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>End</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">procedure&nbsp;TForm1<span class="hl_char">.</span>IdTCPServer1Connect<span class="hl_char">(</span>AThread<span class="hl_char">:</span>&nbsp;TIdPeerThread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">var&nbsp;ConAux<span class="hl_char">:</span>&nbsp;PConnects<span class="hl_comment">;</span></li><li class="hl_l0">begin</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetMem<span class="hl_char">(</span>ConAux<span class="hl_char">,</span><span class="hl_function">SizeOf</span><span class="hl_char">(</span>TConnects<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConAux<span class="hl_char">.</span>ThreadID<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;AThread<span class="hl_char">.</span>ThreadID<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConAux<span class="hl_char">.</span>Connection<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;AThread<span class="hl_char">.</span>Connection<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConAux<span class="hl_char">.</span>IP<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;AThread<span class="hl_char">.</span>Connection<span class="hl_char">.</span>Socket<span class="hl_char">.</span>Binding<span class="hl_char">.</span>PeerIP<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AThread<span class="hl_char">.</span><span class="hl_function">Data</span><span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;TObject<span class="hl_char">(</span>ConAux<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn<span class="hl_char">.</span><span class="hl_function">Add</span><span class="hl_char">(</span>ConAux<span class="hl_char">)</span><span class="hl_comment">; // Добавляем в список</span></li><li class="hl_l1"><span class="hl_function"><b>End</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">procedure&nbsp;TForm1<span class="hl_char">.</span>IdTCPServer1Disconnect<span class="hl_char">(</span>AThread<span class="hl_char">:</span>&nbsp;TIdPeerThread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">var&nbsp;ConAux<span class="hl_char">:</span>&nbsp;PConnects<span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ConAux<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;PConnects<span class="hl_char">(</span>AThread<span class="hl_char">.</span><span class="hl_function">Data</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">try</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn<span class="hl_char">.</span>Remove<span class="hl_char">(</span>ConAux<span class="hl_char">)</span><span class="hl_comment">; // Удаляем из списка</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AThread<span class="hl_char">.</span><span class="hl_function">Data</span><span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;nil<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;finally</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FreeMem<span class="hl_char">(</span>ConAux<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">procedure&nbsp;TForm1<span class="hl_char">.</span>IdTCPServer1Execute<span class="hl_char">(</span>AThread<span class="hl_char">:</span>&nbsp;TIdPeerThread<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">var&nbsp;ConAux<span class="hl_char">:</span>PConnects<span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">ConAux<span class="hl_char">:</span><span class="hl_char">=</span>PConnects<span class="hl_char">(</span>AThread<span class="hl_char">.</span><span class="hl_function">Data</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">ConAux<span class="hl_char">.</span>Connection<span class="hl_char">.</span>ReadBuffer<span class="hl_char">(</span>x<span class="hl_char">,</span><span class="hl_number">4</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">ConAux<span class="hl_char">.</span>Info<span class="hl_char">:</span><span class="hl_char">=</span>inttostr<span class="hl_char">(</span>x<span class="hl_char">)</span><span class="hl_comment">; // Строка переданная клиентом. По ней сортировка.</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Сортировка&nbsp;по&nbsp;Info</li><li class="hl_l0">function&nbsp;CompareNames<span class="hl_char">(</span>Item1<span class="hl_char">,</span>&nbsp;Item2<span class="hl_char">:</span>&nbsp;Pointer<span class="hl_char">)</span><span class="hl_char">:</span>&nbsp;Integer<span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;Result<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;CompareText<span class="hl_char">(</span>TConnects<span class="hl_char">(</span>Item1^<span class="hl_char">)</span><span class="hl_char">.</span>Info<span class="hl_char">,</span>TConnects<span class="hl_char">(</span>Item2^<span class="hl_char">)</span><span class="hl_char">.</span>Info<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">Procedure&nbsp;Refesh<span class="hl_char">(</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">var&nbsp;&nbsp;it<span class="hl_char">:</span>TListItem<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i<span class="hl_char">:</span>integer<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;ConAux<span class="hl_char">:</span>PConnects<span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">conn<span class="hl_char">.</span>Sort<span class="hl_char">(</span>@CompareNames<span class="hl_char">)</span><span class="hl_comment">; // Сортировали список</span></li><li class="hl_l1">form1<span class="hl_char">.</span>ListView1<span class="hl_char">.</span>Clear<span class="hl_comment">; // Отчистили ListView</span></li><li class="hl_l0">&nbsp;&nbsp;for&nbsp;i<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span>&nbsp;to&nbsp;conn<span class="hl_char">.</span>Count<span class="hl_char">-</span><span class="hl_number">1</span>&nbsp;do</li><li class="hl_l1">&nbsp;&nbsp;begin</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">try</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConAux<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;PConnects<span class="hl_char">(</span>conn<span class="hl_char">[</span>i<span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<span class="hl_char">:</span><span class="hl_char">=</span>form1<span class="hl_char">.</span>listview1<span class="hl_char">.</span>Items<span class="hl_char">.</span><span class="hl_function"><b>Add</b></span><span class="hl_comment">; // Добавили строку</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<span class="hl_char">.</span>caption<span class="hl_char">:</span><span class="hl_char">=</span>ConAux<span class="hl_char">.</span>IP<span class="hl_char">+</span><span class="hl_quote">' '</span><span class="hl_char">+</span>ConAux<span class="hl_char">.</span>Info<span class="hl_comment">; // Записали IP и значение</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finally</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=244201&amp;user=702&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=1" class="addthx" data-post="244201"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]sendersu[/b]','')">sendersu</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 512.7 (<b>!</b>), 360thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.57'>Активность: 0.27<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=14629">Модератор</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 03:22 &middot; Поправил: sendersu <br><script type="text/javascript">QU('sendersu','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=sendersu" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Несколько замечаний<br>1) зачем таймер? да и не безопасно так делать (у таймера ведь свой поток?)<br>2) предложение - вызивать treeview Refresh() после апдейта списка conn в методах OnConnect()/OnDisconnect()<br>3) в самом Refresh - есть варанты:<br><br>а) очистка/заполнение - как у тебя, но я б добавил вызов BeginUpdate()/EndUpdate() на form1.listview1.Items (глянь хелп зачем)<br>б) ребилд листа без варианта а - надо пробежаться по айтемах дерева, что пропало - удалить, что появилось в листе - добавить. Begin/EndUpdate() тоже надо<br><br>4) зачем try/finally в цикле в Refresh?<br>5) идея - добавить иконку в дерево для каждого елеме. зеленая - есть конект, красная - конец/оборвался (на следующем апдейте дерева - удалять)<br><br>P.S. под деревом (treeview) надо читать listview, сорри
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244203&amp;user=14629&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=2" class="addthx" data-post="244203"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 14:40 &middot; Поправил: ToBad <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I><b>sendersu</b> пишет:<br>1) зачем таймер? да и не безопасно так делать (у таймера ведь свой поток?) </I><br><br>Данные постоянно меняются у клиентов, но по протоколу они передают их только по запросу сервера. По этому таймер нужен, ровно как и внеплановый опрос по кнопке будет присутствовать. Почему не безопасно? Тут насколько я понимаю и так сервером создаются потоки для каждого клиента...<br><br><I><b>sendersu</b> пишет:<br>но я б добавил вызов BeginUpdate()/EndUpdate() </I><br><br>Отличный совет!!! Я даже не знал об этих методах.... <img src="img/smilies/s4.gif" alt=""> <br><br><I><b>sendersu</b> пишет:<br>предложение - вызывать treeview Refresh() после апдейта списка conn в методах OnConnect()/OnDisconnect() </I><br><br>Да, так и делаю, просто выкинул лишнее для наглядности когда постил.<br><br><I><b>sendersu</b> пишет:<br>ребилд листа без варианта а - надо пробежаться по айтемах дерева, что пропало - удалить, что появилось в листе - добавить. Begin/EndUpdate() тоже надо </I><br><br>Не совсем понял, ещё один Begin/EndUpdate()? На TList что-ли который Conn?<br><br><I><b>sendersu</b> пишет:<br>зачем try/finally в цикле в Refresh? </I><br><br>Х.з. try/except поставлю, в момент прохода по листу может дисконнект одного из клиентов произойти...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244237&amp;user=702&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=3" class="addthx" data-post="244237"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]sendersu[/b]','')">sendersu</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 512.7 (<b>!</b>), 360thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.57'>Активность: 0.27<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=14629">Модератор</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 15:28 <br><script type="text/javascript">QU('sendersu','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=sendersu" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<I>ToBad пишет:<br>Данные постоянно меняются у клиентов, но по протоколу они передают их только по запросу сервера. По этому таймер нужен, ровно как и внеплановый опрос по кнопке будет присутствовать. Почему не безопасно? Тут насколько я понимаю и так сервером создаются потоки для каждого клиента...<br></I><br>да, есть такой подход - один клиент - один поток, но не понимаю другого, в теории клиент запрашивает данные, а сервер (слуга) - обслуживает запрос и возвращает ответ. Ты наверное имеешь ввиду обмен информацией по уже установленному дочернему конекте, да?<br>То есть список не только для показа активых конектов но и еще атрибутов взаимодействия?<br><br><I>ToBad пишет:<br>sendersu пишет:ребилд листа без варианта а - надо пробежаться по айтемах дерева, что пропало - удалить, что появилось в листе - добавить. Begin/EndUpdate() тоже надо Не совсем понял, ещё один Begin/EndUpdate()? На TList что-ли который Conn? </I><br><br>имел в виду то же что и в 3а пункте.<br><br><br><I>Х.з. try/except поставлю, в момент прохода по листу может дисконнект одного из клиентов произойти...<br> </I><br>дык в етом и весь нюанс, ситуация: мы ребилдим список,  и в етот классный момент у нас происходит доваление новых данных -&gt; здесь возможно все, от креша до неправильного отображения данных<br>поетому, следует подумать о блокировке общего ресурса, а именно - списка Conn<br>методов -много
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244242&amp;user=14629&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=4" class="addthx" data-post="244242"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 17:10 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I><b>sendersu</b> пишет:<br>То есть список не только для показа активых конектов но и еще атрибутов взаимодействия? </I><br><br>Интересуют только активные коннекты.<br><br><I><b>sendersu</b> пишет:<br>дык в етом и весь нюанс, ситуация: мы ребилдим список, и в етот классный момент у нас происходит доваление новых данных -&gt; здесь возможно все, от креша до неправильного отображения данных<br>поетому, следует подумать о блокировке общего ресурса, а именно - списка Conn<br>методов -много </I><br><br>Да, это может стать проблемой. Буду придерживать флажками убиение элемента списка при дисконнекте и добавление при коннекте если происходит refresh а так же придерживать refresh при входе в коннект/дисконнект. Так наверное?<br><br>По ходу появился ещё вопрос. Сейчас у меня по протоколу есть только возвращение числа клиентом. Существует функция Reask, которая посылает каждому клиенту команду. Послали 5 - клиент вернул свое число. Теперь я добавляю команду 4, получив её клиент инкрементирует у себя число и пришлёт его в ответ. В TConnects добавил Cmd. Если не установлено в 4, то принимает значение 5. Я обрабатываю клики на листвьюв так:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">procedure&nbsp;TForm1<span class="hl_char">.</span>ListView1Click<span class="hl_char">(</span>Sender<span class="hl_char">:</span>&nbsp;TObject<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">var&nbsp;ConAux<span class="hl_char">:</span>PConnects<span class="hl_comment">;</span></li><li class="hl_l0">begin</li><li class="hl_l1"><span class="hl_function"><b>if</b></span>&nbsp;ListView1<span class="hl_char">.</span>ItemIndex<span class="hl_char">&lt;</span><span class="hl_char">&gt;</span><span class="hl_char">-</span><span class="hl_number">1</span>&nbsp;then&nbsp;begin</li><li class="hl_l0">ConAux<span class="hl_char">:</span><span class="hl_char">=</span>PConnects<span class="hl_char">(</span>conn<span class="hl_char">[</span>ListView1<span class="hl_char">.</span>ItemIndex<span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">showmessage<span class="hl_char">(</span><span class="hl_quote">'К посылке команды всё готово'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">ConAux<span class="hl_char">.</span>cmd<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">4</span><span class="hl_comment">; // Установить команду инкримента.</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br>Когда будет расширен функционал вместо месседжа будет диалоговое окно. В данном примере вывод окна сделан для того, что бы можно было убить клиента и только потом послать команду. Когда клиент жив, при следующем Reask я отправляю 4 и получаю ответ, всё происходит нормально, но если клиента закрыть, смещение индексов в списке мне не страшно, так как я запомнил не индекс перед входом в месседж или диалог, а ConAux нужного мне элемента, однако я не могу сделать так:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>ConAux<span class="hl_char">.</span>Connection<span class="hl_char">=</span>nil<span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>or</b></span>&nbsp;<span class="hl_char">(</span>ConAux<span class="hl_char">=</span>nil<span class="hl_char">)</span>&nbsp;then&nbsp;showmessage<span class="hl_char">(</span><span class="hl_quote">'error connection closed'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br>а следовательно и знать, что выставляю ConAux.cmd:=4; для уже мертвого соединения...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244259&amp;user=702&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=5" class="addthx" data-post="244259"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 18:11 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
При чём здесь вообще низкоуровневое и околокрекинговое программирование? Ты создаёшь кучу топиков по кодингу, половина из которых под тематику не попадает вообще никаким боком, заканчивай уже.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244267&amp;user=1556&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=6" class="addthx" data-post="244267"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]progopis[/b]','')">progopis</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 101.0 (ветеран), 344thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.11'>Активность: 1.15<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=2449">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 ноября 2009 18:19 &middot; Поправил: <a href="action=stats#mods">Модератор</a> <br><script type="text/javascript">QU('progopis','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=progopis" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
По многочисленным жалобам (обойдёмся без ников) тему переношу. В следующий раз такое лучше создавать в оффтопе.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244269&amp;user=2449&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=7" class="addthx" data-post="244269"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]sendersu[/b]','')">sendersu</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 512.7 (<b>!</b>), 360thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.57'>Активность: 0.27<span style='color:red'>&searr;</span>0.04</span><br>Статус: <a href="action=userinfo&amp;user=14629">Модератор</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 ноября 2009 02:45 <br><script type="text/javascript">QU('sendersu','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=sendersu" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<I>ToBad пишет:<br>Да, это может стать проблемой. Буду придерживать флажками убиение элемента списка при дисконнекте и добавление при коннекте если происходит refresh а так же придерживать refresh при входе в коннект/дисконнект. Так наверное? </I><br><br>я советую не играться в кошки-мышки а использовать обекты синхронизации ОС - или юзер или кернел мода.<br>Для примера можно заюзать TCriticalSection клас. Создать 1 обект, перед изменением состояния общего ресурса (список) - захват (Acquire()), после работы - отдать назад (Release())<br><br><I>ToBad пишет:<br>По ходу появился ещё вопрос. </I><br>к индексам желательно не привязиваться (если гуи сортирует - тем более нельзя! индекс плавает, верно? <img src="img/smilies/s1.gif" alt=""><br>поетому вот ето - <br>ConAux:=PConnects(conn[ListView1.ItemIndex]<br>не есть хорошо, взамен надо запоминать в твоем ListView1 не только Caption, но и сам ConAux (Указатель на структуру клиента), как? вот так:<br>привязиваемся к реальным обьектам юзера - ConAux типа поинтер на структуру TConnects<br><br>ConAux:= PConnects(conn[i]);<br>it:=form1.listview1.Items.Add; // Добавили строку<br>it.Data := TObject(ConAux);     // &lt;-- теперь у нас есть уникальный ключ для каждого рядка в списке!<br>...<br><br>кстати - утебя уже был похожий подход с потоком - AThread.Data:= TObject(ConAux);<br>Вообще скажу тебе - в Дельфи такой дженерик подход - пихать свои юзер данные (как правило поинтер на чего то свое в такие вот проперти - Data, Tag, ... (називаються по разному в разных дельфи классах)<br><br><br>по вопросу - все верно, когда клиет умер - его ConAux уже уничтожен (в твоем методе IdTCPServer1Disconnect)<br><br>но! когда ты читаеш пропертю Data текущего выбранного елемента ты етого еще не знаешь (поинтер остался, а память под ним может быть уже тю-тю (FreeMem)<br>чтоб проверить жив ли клиент - можно например поискать его в списке клиентов, а-ля<br><br>if conn.IndexOf(currentConAux) &lt;&gt; -1 then<br>     //ура клиент жив!<br><br>не забываем, что даже простой поиск по списку через IndexOf()  - ето доступ к общему ресурсу, который надо защитить (см. выше)<br><br>удачи
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244292&amp;user=14629&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=8" class="addthx" data-post="244292"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 ноября 2009 03:36 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15310.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>sendersu</b> - Огромное спасибо за исчерпывающий ответ!!! Ты мне очень помог, теперь есть масса информации для размышления и варианты как это сделать!<br><br><I><b>progopis</b> пишет:<br>По многочисленным жалобам (обойдёмся без ников) </I><br><br>p.s. Топик закрываю дабы не сердить уважаемых модераторов и всех остальных многочисленных которые обходятся без ников, но очень не безразличны к порядку на форуме. ;)<br>Спасибо, что дали дорешить проблему и не забанили по ip весь мой регион, не изгнали с позором с форума и не набили морду... <img src="img/smilies/s1.gif" alt=""><br>Впредь буду тщательнее выбирать куда постить...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=244293&amp;user=702&amp;forum_n=7&amp;topic=15310.html&amp;page=0&amp;anchor=9" class="addthx" data-post="244293"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Как организовать синхронизацию сортированных записей в TList со списком в TListView?</span></td>
</tr></table>
</div>
<a name=newreply></a>
<center><h3>У вас должно быть 20 пунктов ранга, чтобы оставлять сообщения в  этом подфоруме, но у вас только 0</h3></center><script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=15310" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
