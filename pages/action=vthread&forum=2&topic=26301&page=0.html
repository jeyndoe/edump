<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Изменение адреса api в многопоточной задаче - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Есть обычный вызов: Code:       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;rcx,&nbsp;ss:[rsp+0x58]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;GetSystemTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=247'>NIKOLA</a>, <a target='_blank' href='?action=userinfo&amp;user=42610'>r0lka</a>, <a target='_blank' href='?action=userinfo&amp;user=19256'>johnniewalker</a>, <a target='_blank' href='?action=userinfo&amp;user=40607'>vsv1</a> (+4 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Изменение адреса api в многопоточной задаче</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 13:18 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Есть обычный вызов:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;GetSystemTime</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x5A<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li>        </ol>
    </div>
</div></div>
<br>И похожих вызовов по софту штук 50. Чтобы не патчить везде одно и то же, я сделал эмуляцию ответа после отработки api, предварительно запоминая адрес, находящийся в:<br>[rsp+0x58]<br>и далее подменял по тому адресу данные и все прекрасно работало. Но потом была обнова Windows 10, обнова софта, и мои костыли перестали быть точными. они работали как и прежде, но софт осуществляет также проверки во время выполнения многопоточных задач. и вот именно в этот момент путем отладки было выяснено, что патч код промазывает и пишет байты не по тому адресу. с виду все должно быть верно, и я проверил утилитой RunAsDate, которая также в многопоточной задаче облажалась и сработало внутреннее ограничение регистрации в софте. казалось бы, софт в rcx ставит указатель на записанные далее байты, но не так все просто. во время выполнения многопоточной задачи и кучи вызовов проверок времени лицухи, меняются страницы с данными, например:<br><br>lea rcx, ss:[rsp+0x58] &lt; в rcx допустим адрес в памяти 0015D000<br>но в какой то момент после отработки api в:<br>movzx eax, word ptr ss:[rsp+0x5A]<br>movzx ecx, word ptr ss:[rsp+0x58]<br><br>в [rsp+0x58] уже нет этого 0015D000 адреса и настоящих данных времени по этому адресу нет (кроме записанных патчем), но зато все данные той страницы оказываются по адресу:<br>001FA000.<br>И это не всегда, но в какой то определенный момент из 10-15 вызовов один-второй раз это случается.<br><br>То есть каким то образом именно внутри api происходит копирование или переназначение страницы стека, лежавшего в [rsp+0x58] до начала выполнения api. напомню, что это происходит только во время запуска многопоточной задачи, при этом проц и память могут грузиться до 100%. вопрос в том, с какого перепугу создается такая переадресация или как это называется? при этом софт работает правильно и ему по барабану, что входные выходные адреса перед обработкой api могли поменяться. проблемы с патчем нет, выкинул эмуляцию вместе с апи. но что это за момент и почему так происходит (или начало происходить после обнов)?
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402632&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=1" class="addthx" data-post="402632"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]ELF_7719116[/b]','')">ELF_7719116</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 419.0 (мудрец), 647thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 9.73'>Активность: 0.46<span style='color:green'>&nearr;</span>0.51</span><br>Статус: <a href="action=userinfo&amp;user=26651">Участник</a><br><font color=blue>&quotТибериумный реверсинг&quot</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 14:07 <br><script type="text/javascript">QU('ELF_7719116','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ELF_7719116" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
<I>Kindly пишет:<br>call GetSystemTime </I><br>Какая-то особая уличная магия <img src="img/smilies/s1.gif" alt=""><br>В Windows 7, Windows 10  реализация не отличается - вызывается сначала<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_number">00000000006AEE5F</span>&nbsp;&nbsp;<span class="hl_char">|</span>&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_char">&lt;</span><span class="hl_char">&amp;</span>RtlTimeToTimeFields<span class="hl_char">&gt;</span><span class="hl_char">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">|</span></li>        </ol>
    </div>
</div></div>
<br>внутри которой<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_number">00007FF850E42D1F</span>&nbsp;&nbsp;<span class="hl_char">|</span>&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;<span class="hl_char">&lt;</span>ntdll<span class="hl_char">.</span>RtlpTimeToTimeFieldsNoLeapSeconds<span class="hl_char">&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">|</span></li>        </ol>
    </div>
</div></div>
<br>Но там отсутсвуют всякие <i class=x>realloc</i>. Обычное чтение из PEB и цепочка из мат операций.<br><I>Kindly пишет:<br>но в какой то момент после отработки api </I><br>А если записывать данные по адресу перед выполнением RET из api?!
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402636&amp;user=26651&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=2" class="addthx" data-post="402636"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 14:19 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I>ELF_7719116 пишет:<br>А если записывать данные по адресу перед выполнением RET из api?!  </I><br>я не хукаю и не эмулирую апи внутри своей dll, если это имеется в виду. даю в коде отработать оригинальному вызову, поэтому перед самой RET именно в api я ничего не могу записать.<br>но если все 50 вызовов вынести на такой патч-код, убрав api, но записывая по rcx данные времени напрямую:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x01<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x02<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br>все работает прекрасно и ничего &quot;не сходит с ума&quot; <img src="img/smilies/s1.gif" alt=""><br>может быть это происходит из-за переполнения памяти и ресурсов пк, когда старые данные выгружаются и выделяется новое освободившееся пространство с новыми адресами? винда это учитывает и делает перераспределение, или не так?<br><br>я грешным делом подумал, что добавили проверок на триал в структурах присутствующих api:<br>GetFileInformationByHandle<br>FindFirstFile<br>потому как в защите и такой момент есть, когда создаются временные файлы с рандомными именами и текущими атрибутами.<br>но все оказалось &quot;проще&quot;, но такого еще не замечал. кстати, предыдущая версия софта работает нормально с прошлым методом. а счас уж если RunAsDate не справилась, то что про мои костыли говорить <img src="img/smilies/s2.gif" alt="">
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402638&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=3" class="addthx" data-post="402638"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]user99[/b]','')">user99</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 43.1 (посетитель), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.06'>Активность: 0.16<span style='color:green'>&nearr;</span>0.29</span><br>Статус: <a href="action=userinfo&amp;user=44014">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 15:43 &middot; Поправил: user99 <br><script type="text/javascript">QU('user99','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=user99" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Без кода сложно понять где проблемы.<br><br><I>Kindly пишет:<br>предварительно запоминая адрес </I><br>Может этот адрес запоминается в глобальную переменную? Тогда нет ничего удивительно в проблемах с многопоточностью.<br>А может быть десятки других косяков.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402642&amp;user=44014&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=4" class="addthx" data-post="402642"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=19260" title="04-02-2020 09:05, ранг:70.9" target="_blank">kunix</a>, <a href="action=userinfo&user=1883" title="04-02-2020 12:14, ранг:267.0" target="_blank">Kindly</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]kunix[/b]','')">kunix</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 71.2 (постоянный), 33thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.53'>Активность: 0.05<span style='color:green'>&nearr;</span>0.12</span><br>Статус: <a href="action=userinfo&amp;user=19260">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 15:47 &middot; Поправил: kunix <br><script type="text/javascript">QU('kunix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=kunix" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Вдруг там добавили отдельный поток, который мониторит момент перезаписи переменной и сразу же ремапит? Типа такая лайтовая защита от перехвата. Без залезания в дебри винды.<br>Звучит бредово, но вызывать напрямую GetSystemTime тоже так себе идея.<br>Или может это у вас некий проеб с перехватом вашим. Как перехват работает-то?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402643&amp;user=19260&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=5" class="addthx" data-post="402643"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]friend[/b]','')">friend</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 13.2 (новичок), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 0.43'>Активность: 0.28=0.28</span><br>Статус: <a href="action=userinfo&amp;user=52993">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 15:52 <br><script type="text/javascript">QU('friend','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=friend" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>Kindly пишет:<br>может быть это происходит из-за переполнения памяти и ресурсов пк</I><br>Имхо переполнение не обязательно.<br>Виндовс С++ memory management.<br>У каждого треда свой стэк и видать при конфликтах аллокации<br>происходит какой то вариат тактики аллокации.<br>Либо что бы было быстро или акуратно.<br>Copy constructors?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402644&amp;user=52993&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=6" class="addthx" data-post="402644"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 17:21 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>kunix пишет:<br>Вдруг там добавили отдельный поток, который мониторит момент перезаписи переменной и сразу же ремапит?</I><br>ну хз, или это связано с модулями, версией или настройками компиля C++<br><br><I>kunix пишет:<br>Как перехват работает-то?  </I><br>костыли точно записывают в свободное место адрес и точно восстанавливают. запоминаю адрес записи штампа времени и после выполнения api пишу по запомненному адресу свои данные. вообще я не хотел менять часы минуты секунды и достаточно было одного qword, где месяцы и год, но благо в расчетах времени софт юзает GetTickCount64.<br><br><I>friend пишет:<br>Виндовс С++ memory management. </I><br>вот это похоже ближе, надо изучить. софт как раз на нем. но самое интересное, что это в api windows выполняется и идут в нее одни параметры (адрес заполнения), а после выполнения данные переносятся на другой адрес памяти. причем так происходят в многопотоке не всегда, а именно &quot;когда надо&quot;, раз на 10-15 вызовов примерно или вообще похоже рандомно. в x64dbg многопоточные задачи отлаживать почти нельзя нормально, код коробит, трассировка толком не работает, непонятно бряки срабатывают, вобщем <img src="img/smilies/s16.gif" alt="">
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402648&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=7" class="addthx" data-post="402648"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]kunix[/b]','')">kunix</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 71.2 (постоянный), 33thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.53'>Активность: 0.05<span style='color:green'>&nearr;</span>0.12</span><br>Статус: <a href="action=userinfo&amp;user=19260">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 19:20 <br><script type="text/javascript">QU('kunix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=kunix" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
С ваших слов звучит так, что вы не синхронизируете два события - возврат из API и патч значения.<br>Тогда это вообще не обязано работать <img src="img/smilies/s1.gif" alt=""> Мне даже в голову поначалу не пришло, что так можно.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402654&amp;user=19260&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=8" class="addthx" data-post="402654"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 20:39 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>kunix</b><br>Костыль примерно следующий:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;@L00000001</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">-</span>0x8<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">+</span>0x10<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;<span class="hl_char">[</span>GetSystemTime&nbsp;address<span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x110001000B07E2</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rbx</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">+</span>0x10<span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">@L00000001<span class="hl_char">:</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">-</span>0x8<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rbx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rbx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">bl</span><span class="hl_char">,</span>&nbsp;0x0</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">rbx</span><span class="hl_char">,</span>&nbsp;0x200</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br><br>Здесь я извращаюсь и получаю адрес своей секции кода в случае применения релоков, добавляю длину  200 байт, чтобы физически записать RCX адрес в свободное пространство секции и потом записать по нему свои значения.<br>На эту прививку у меня устанавливаются 50 одинаковых вызовов GetSystemTime, так я их одним махом и обрабатываю. Вместо этих костылей, я могу просто влупить:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x01<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x02<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rax</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li>        </ol>
    </div>
</div></div>
<br>что сейчас и сделано.<br><br>Что я по вашему должен синхронизировать, если я запоминаю параметр передачи до вызова api и пишу свои байты после возврата. Вопрос только в том, что костыль при применении оригинальной api всегда корректно не работает в многопоточных задачах, также как не справляется и тулза от NirSoft, что намекает про некую магическую особенность. Но короткий томагавк без участия самой api работает безупречно, но небольшой минус в том, что часы минуты и секунды будут статичными, но в моем случае это по боку и на функционал не влияет, только на проверку даты лицухи.
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402658&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=9" class="addthx" data-post="402658"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]kunix[/b]','')">kunix</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 71.2 (постоянный), 33thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.53'>Активность: 0.05<span style='color:green'>&nearr;</span>0.12</span><br>Статус: <a href="action=userinfo&amp;user=19260">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 20:59 &middot; Поправил: kunix <br><script type="text/javascript">QU('kunix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=kunix" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
Костыль зачетный.<br>У вас там несколько потоков используют общий кусок памяти в секции кода (по адресу rbx). <br>Может поэтому?<br>Нужды в этом особой нет в данном костыле, все можно в стеке сделать.<br><br>&gt;Что я по вашему должен синхронизировать<br>По вашему описанию было непонятно, как все работает. <br>Я уже начинал думать, что вы отлаживаете треды из другого процесса и подменяете значения из другого треда.<br>Отсюда разговор про синхронизацию.<br><br>&gt; не справляется и тулза от NirSoft, что намекает про некую магическую особенность<br>Это может быть по другой причине. Банальный детект перехвата или может не все функции перехвачены.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402659&amp;user=19260&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=10" class="addthx" data-post="402659"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 21:08 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<I>kunix пишет:<br>Банальный детект перехвата или может не все функции перехвачены.<br> </I><br>нету там никакого детекта перехвата. акцентирую, что одна и та же функция с проверкой истечения триала вызывается софтом при запуске, при открытии проекта, при запуске многопоточной задачи. то есть исполнение идет одинаково корректно и данные успешно подменяются постоянно при работе софта. и вызывает &quot;сбой&quot; в многопоточной задаче не сама функция проверки триала, а именно исполнение api в недрах windows, и винда отдает результат уже с другой страницей памяти, которая понимается программой и принимается как родная, см. 1 пост. и я склоняюсь к тому, что RunAsDate также не умеет пока эмулировать свои api в многопотоке - а им в поддержку писать бесполезно (мне и не нужно), у них ответ мол &quot;мы не помогаем крякать софт, утилита для других целей&quot;
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402660&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=11" class="addthx" data-post="402660"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]kunix[/b]','')">kunix</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 71.2 (постоянный), 33thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.53'>Активность: 0.05<span style='color:green'>&nearr;</span>0.12</span><br>Статус: <a href="action=userinfo&amp;user=19260">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 03 февраля 2020 23:33 &middot; Поправил: kunix <br><script type="text/javascript">QU('kunix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=kunix" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
&gt; которая понимается программой и принимается как родная<br>Звучит совершенно фантастически. Как вы это себе представляете? <br>Это надо пропатчить все указатели на данный адрес в программе.<br><br>&gt; RunAsDate также не умеет пока эмулировать свои api в многопотоке<br>Ну, если честно, вы тоже пока не умеете. У вас там глобальные переменные без синхронизации.<br>Вы адрес переменной со временем сохраняете в одну и ту же переменную, для всех потоков.<br>Вполне может быть, что другой поток успеет перезаписать значение по адресу rbx+0x8.<br>И тогда вот эта хрень перепишет не то, что надо.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rbx</span><span class="hl_char">+</span>0x8<span class="hl_char">]</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x110001000B07E2</li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li>        </ol>
    </div>
</div></div>
<br>Как насчет соорудить spinlock в вашем костыле? Или убрать глобальные переменные вообще.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402662&amp;user=19260&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=12" class="addthx" data-post="402662"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=1883" title="04-02-2020 12:15, ранг:267.0" target="_blank">Kindly</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 00:42 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<I>kunix пишет:<br>Как вы это себе представляете?<br>Это надо пропатчить все указатели на данный адрес в программе. </I><br>да, все родные вызовы GetSystemTime меняются на вызов костыля, и там все новые обращения каждый раз входят с новыми адресами. но проблема не в костыле (в этом случае он уже неприменим), а в особенности исполнения api в многопоточной задаче. вопрос не в подмене данных. проблема понять, почему именно в api такое происходит, входят одни параметры, потом возвращаются другие, не совсем это понятно и отлаживать эту задачу не могу, начинает стопориться отладчик и невозможно дальше выполнять код.<br><br><I>kunix пишет:<br>Вполне может быть, что другой поток успеет перезаписать значение по адресу rbx+0x8. </I><br>да ничего он не перезаписывает, результат GetSystemTime оказывается вообще не по адресу сохраненного параметра в костыле. повторюсь, это не каждый раз так происходит, при выполнении многопоточной задачи подмена в основном срабатывает нормально раз 10, потом 11-ый раз мимо, на 12-ый раз - точно и далее вот так как то так через раз через 10. почему оно так работает на той же функции непонятно, когда в RCX всегда передается место для возвращаемого значения времени:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;GetSystemTime</li>        </ol>
    </div>
</div></div>
<br>почему иногда оно указывает один адрес, а возвращает в rsp+0x58 совсем другой. при этом копирует или формирует возврат данных на другой адрес внутри api, и прога подхватывает их как ни в чем не бывало.<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li>        </ol>
    </div>
</div></div>
<br><I>kunix пишет:<br>Как насчет соорудить spinlock в вашем костыле?  </I><br>не знаю что такое, мне не нужно оно. пишу патч код в теле софта же.
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402664&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=13" class="addthx" data-post="402664"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]kunix[/b]','')">kunix</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 71.2 (постоянный), 33thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.53'>Активность: 0.05<span style='color:green'>&nearr;</span>0.12</span><br>Статус: <a href="action=userinfo&amp;user=19260">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 00:57 &middot; Поправил: kunix <br><script type="text/javascript">QU('kunix','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=kunix" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
&gt; проблема понять, почему именно в api такое происходит, входят одни параметры, потом возвращаются другие, не совсем это понятно и отлаживать эту задачу не могу<br>Вы меня не поняли. Программа выделяет память  и передает указатель в GetSystemTime.<br>Как такое может быть, чтобы GetSystemTime вернула результат по другому адресу? Если программа ждет результат именно по тому, который она передала.<br>Это же лютая дичь.т<br><br>&gt; результат GetSystemTime оказывается вообще не по адресу сохраненного параметра в костыле<br>А что такое адрес сохраненного параметра в костыле? Это глобальная переменная. Ее может перезапивать другой тред, пока вы смотрите в отладчик.<br><br>&gt; срабатывает нормально раз 10, потом 11-ый раз мимо, на 12-ый раз <br>Выглядит как типичный race между несколькими тредами.<br><br>&gt; при этом копирует или формирует возврат данных на другой адрес внутри api, и прога подхватывает их как ни в чем не бывало.<br>Может, вы смотрите в отладчике на разные треды и не замечаете этого? Или просто глючный отладчик?<br><br>Короче, я бы на вашем месте переместил бы перехват GetSystemTime в loader.dll и добавил бы синхронизацию на входе и выходе. Потом убрал бы. И сравнил эти два варианта.<br>Вместо отладчика -  чисто логгинг через OutputDebugString. Все будет видно, чо и как.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402666&amp;user=19260&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=14" class="addthx" data-post="402666"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=3520" title="04-02-2020 08:55, ранг:665.1" target="_blank">mak</a>, <a href="action=userinfo&user=1883" title="20-02-2020 16:57, ранг:267.3" target="_blank">Kindly</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]user99[/b]','')">user99</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 43.1 (посетитель), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.06'>Активность: 0.16<span style='color:green'>&nearr;</span>0.29</span><br>Статус: <a href="action=userinfo&amp;user=44014">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 08:21 <br><script type="text/javascript">QU('user99','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=user99" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
Kindly, проблема не внутри WinApi&#039;шной функции (не нужно ошибки своих костыли валить на майкрософт), а в ваших глобальных переменных для хранения локальных данных. Я вам это написал практически сразу, kunix выдал тот же диагноз.<br>Либо делайте синхронизацию, как советует kunix, либо убирайте глобальный блок для данных и храните все в стеке, вообще не понятно зачем там эти навороты, т.к. обычный стек может спокойной сохранить ваши 3 переменные, к тому же это гарантированно потокобезопасный вариант.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402669&amp;user=44014&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=15" class="addthx" data-post="402669"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=1883" title="20-02-2020 16:58, ранг:267.3" target="_blank">Kindly</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 14:23 <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
ну блин, сделал так, код проги:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>lea</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;0x0000000141901126&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;тут&nbsp;был&nbsp;вызов&nbsp;api&nbsp;GetSystemTime</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x5A<span class="hl_char">]</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;0x000000014190114C&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;тут&nbsp;был&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;с&nbsp;годом</li>        </ol>
    </div>
</div></div>
<br>прыгнули на 0x0000000141901126:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span>0x0000000141901180<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr"><b>rcx</b></span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;сохранил&nbsp;в&nbsp;свою&nbsp;секцию&nbsp;<span class="hl_registr">RCX</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span>0x0000000140EE4770<span class="hl_char">]</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;выполнил&nbsp;GetSystemTime</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x110001000B07E3&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;записал&nbsp;свое&nbsp;значение</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rcx</span><span class="hl_char">,</span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span>0x0000000141901180<span class="hl_char">]</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;прочитал&nbsp;адрес</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr"><b>rax</b></span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;подменил</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;0x0000000140BFCA4B&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;вернулся</li>        </ol>
    </div>
</div></div>
<br>далее проверяем год, прыгнув сюда 0x000000014190114C<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;оригинальный&nbsp;код</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>cmp</b></span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;0x7E3&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;проверяем&nbsp;или&nbsp;тут&nbsp;год&nbsp;<span class="hl_number">2019</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>je</b></span>&nbsp;<span class="hl_function"><b>short</b></span>&nbsp;@lab1&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&lt;</span>&nbsp;если&nbsp;нет<span class="hl_char">,</span>&nbsp;то&nbsp;срабатывает&nbsp;бряк&nbsp;на&nbsp;<span class="hl_function">NOP</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">nop</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">@lab1<span class="hl_char">:</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>jmp</b></span>&nbsp;0x0000000140BFCA55</li>        </ol>
    </div>
</div></div>
<br>прикол в том, что бряк на NOP сработал и записался при сравнении в [rsp+0x58] год 2020.<br>я не юзал никаких PUSH POP, не записывался в ESP, не трогал EBP - все аккуратно.<br>когда сработал бряк на NOP я посмотрел, записано ли у меня по адресу мои данные, и да, считывание сохраненного адреса и запись нужных байт состоялась, но какого хера вот тут:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>movzx</b></span>&nbsp;<span class="hl_registr">ecx</span><span class="hl_char">,</span>&nbsp;<span class="hl_function"><b>word</b></span>&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ss</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rsp</span><span class="hl_char">+</span>0x58<span class="hl_char">]</span></li>        </ol>
    </div>
</div></div>
<br>не лежит мое значение?<br><br>я взял и сравнил адреса, при срабатывании бряка они остались. адрес RCX, который сохранялся это:<br><br>0000000025<b>C</b>CF638<br>E3 07<br><br>а это адрес [rsp+0x58] непосредственно при выполнении инструкции<br>movzx ecx, word ptr ss:[rsp+0x58]<br><br>и почему то по этому адрес лежит адресс:<br>0000000025<b>A</b>CF638<br>E4 07<br><br>какого хрена отличие адресов ровно на 200000 байт? какого хрена вообще так происходит - где криминал?
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402676&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=16" class="addthx" data-post="402676"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]user99[/b]','')">user99</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 43.1 (посетитель), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.06'>Активность: 0.16<span style='color:green'>&nearr;</span>0.29</span><br>Статус: <a href="action=userinfo&amp;user=44014">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 14:43 <br><script type="text/javascript">QU('user99','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=user99" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
Криминал в глобальной переменной, можно переписывать этот код хоть 100 раз, но если не решить проблему с глобальной переменной, патч потокобезопасным не станет.<br><br><b>Добавлено спустя 2 минуты</b><br>Почему нельзя сделать<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l1"><span class="hl_function"><b>sub</b></span>&nbsp;<span class="hl_registr">rsp</span><span class="hl_char">,</span>&nbsp;0x20</li><li class="hl_l0"><span class="hl_function"><b>call</b></span>&nbsp;GetSystemTime</li><li class="hl_l1"><span class="hl_function"><b>add</b></span>&nbsp;<span class="hl_registr">rsp</span><span class="hl_char">,</span>&nbsp;0x20</li><li class="hl_l0"><span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l1"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;свое_значение</li><li class="hl_l0"><span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li>        </ol>
    </div>
</div></div>
<br>?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402678&amp;user=44014&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=17" class="addthx" data-post="402678"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]Kindly[/b]','')">Kindly</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1883.jpg" alt=""><br><span class=txtSm>Ранг: 275.9 (наставник), 340thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.13'>Активность: 0.22=0.22</span><br>Статус: <a href="action=userinfo&amp;user=1883">Участник</a><br><font color=blue>RBC</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 15:11 &middot; Поправил: Kindly <br><script type="text/javascript">QU('Kindly','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Kindly" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
Все верно! Проблема оказалась <b>в использовании переменной для записи адреса</b>, потому как обычный push/pop RCX адреса решает проблему полностью, если использовать api:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;GetSystemTime</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">rax</span><span class="hl_char">,</span>&nbsp;0x110001000B07E3</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;<span class="hl_registr">rcx</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;qword&nbsp;<span class="hl_function"><b>ptr</b></span>&nbsp;<span class="hl_registr">ds</span><span class="hl_char">:</span><span class="hl_char">[</span><span class="hl_registr">rcx</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">rax</span></li>        </ol>
    </div>
</div></div>
<br><br>но получается, что также все работает при использовании глобальной переменной, если не использовать вызов api в патч-коде.<br><I>user99 пишет:<br>но если не решить проблему с глобальной переменной, патч потокобезопасным не станет. </I><br>именно, поэтому уберу нафиг этот костыль с переменной и по-людски запишу ) писал эту хрень давно и вроде работала, пока не попались мультитредовые приложения.<br><br><I>user99 пишет:<br>Почему нельзя сделать </I><br>именно, и да, отодвинуться на безопасное место в RSP также скорее всего стоит.<br><br>Всем спасибо! Отставлю еще пару лайков через 24 часа <img src="img/smilies/s3.gif" alt=""> Темку закрою вечером, может кто-что хочет что дополнить, хотя уже все ясно ))
<br><br><font size="1"><i>-----<br>Array[Login..Logout] of Life</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=402679&amp;user=1883&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=18" class="addthx" data-post="402679"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]user99[/b]','')">user99</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 43.1 (посетитель), 20thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 2.06'>Активность: 0.16<span style='color:green'>&nearr;</span>0.29</span><br>Статус: <a href="action=userinfo&amp;user=44014">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 февраля 2020 15:34 <br><script type="text/javascript">QU('user99','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=user99" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=2&amp;topic=26301.html&amp;page=0#19');return false;">#19</a> </span><div align=left><br>
<I>Kindly пишет:<br>но получается, что также все работает при использовании глобальной переменной, если не использовать вызов api в патч-коде </I><br>Работает потому что код выполняется очень быстро и вероятность одновременного вызова этой функции из двух потоков практически нулевая.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=402681&amp;user=44014&amp;forum_n=2&amp;topic=26301.html&amp;page=0&amp;anchor=19" class="addthx" data-post="402681"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/red.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=2&sortBy=0&page=0.html"><b>Крэки, обсуждения</b></a> <b class=bulletHead>&#8212;&#8250;</b> Изменение адреса api в многопоточной задаче</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=26301" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
