<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Висячая консоль и как с этим бороться - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="UPD. Под &quot;висячей&quot; консолью здесь имеется ввиду окно-консоль, адекватно обрабатывающее WM-сообщения, кроме как минимум WM_CLOSE, хотя процессов, к которым оно было присоединено, уже нет. UPD2. WinXP SP3 x86. csrss.exe и">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=1288'>UniSoft</a>, <a target='_blank' href='?action=userinfo&amp;user=55953'>laslo</a>, <a target='_blank' href='?action=userinfo&amp;user=26261'>bartolomeo</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Висячая консоль и как с этим бороться</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 18:13 &middot; Поправил: DenCoder <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
<b>UPD. Под &quot;висячей&quot; консолью здесь имеется ввиду окно-консоль, адекватно обрабатывающее WM-сообщения, кроме как минимум WM_CLOSE, хотя процессов, к которым оно было присоединено, уже нет.</b><br><br><b>UPD2. WinXP SP3 x86. csrss.exe и winsrv.dll 5.1.2600.5512. Не были использованы wowexec, ntvdm и какие-либо вообще эмуляторы</b><br><br>Вот уже полгода мой комп мучает проклятие консольного окна. Дело в том, что иногда мне нужно быстро проверить, если доступ к тем или иным ресурсам в сети или нет, динамика пинга и на протяжении какого-то времени. Создал я простой скрипт типа<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">@echo&nbsp;off</li><li class="hl_l1">goto&nbsp;run</li><li class="hl_l0"><span class="hl_char">:</span>run</li><li class="hl_l1">time&nbsp;<span class="hl_char">/</span>t</li><li class="hl_l0">ping&nbsp;<span class="hl_char">-</span>w&nbsp;<span class="hl_number">2</span>&nbsp;<span class="hl_char">-</span>l&nbsp;<span class="hl_number">1</span>&nbsp;<span class="hl_char">-</span>n&nbsp;<span class="hl_number">60</span>&nbsp;ya<span class="hl_char">.</span>ru</li><li class="hl_l1">goto&nbsp;run</li>        </ol>
    </div>
</div></div>
<br><br>Создал ярлык на него и... периодически, в 20-30% случаев, если консоль работает достаточно долго (может быть это с её буфером связано, который увеличен до 5000 строк), то её не закрыть. То ли это баг винды (WinXP SP3), то ли следствие кривой заплатки, но нажимаем на красный крестик консольного окна с пингами, cmd.exe и ping.exe завершаются, а окно висит. Да к тому же перезагрузиться после такого без резета не получается. Много раз хотел отладчиком как-нибудь подсоединиться в тот самый момент, когда окну шлётся WM_CLOSE, но чтобы при этом проявил себя как раз этот самый баг... Не представляю, как это осуществимо...<br><br>И вот вчера проявилось опять то же самое. Надоело терпеть глюки винды, поэтому взял Process Explorer. Как известно, у консольных окон процесс-владелец csrss.exe, значит у него должны быть оконные процедуры для консолек. Чуть позже я узнал, что обработка сообщений консолей в winsrv.dll. К тому же через csrss.exe происходит запуск/завершение процессов. Первое, что в голову пришло - какой-то из двух процессов (cmd или ping) до конца не завершился, не отсоединил консоль - вот и результат. Process Explorer&#039;ом навёл на csrss - полно хэндлов работающих процессов и среди них &lt;Non-existent process&gt;:pid... Чем хорош Process Explorer - это тем, что показывает адрес объекта в ядре(на lower pane в режиме Handles - меню View-&gt;Lower pane-&gt;Handles), для процесса - EPROCESS. Отладчиком WinDbg идём в local kernel debugging и смотрим, что по этому адресу... К сожалению, я так и научил его дружить нормально с символами, поэтому не всегда в нём могу получить описание нужной структуры. Поэтому пришлось для этого воспользоваться идой. Хотя, видно, символы не те, потому что ида из сети достаёт гораздо лучше, чем те, которые скачал когда-то(к примеру, nt!PspTerminateProcess в символах для ntoskrnl.exe нет, но ида достаёт те, в которых есть).<br><br>Итак, первое, что можно увидеть - в _EPROCESS._KPROCESS._DISPATCHER_HEADER.SignalState - 1. То есть тот самый Non-existent process, всё-таки завершился, но его EPROCESS почему-то не убрался из списка. По каким причинам, гадать можно долго. Ради интереса узнаём, что это был за процесс - в _EPROCESS.ImageFileName прописано ping.exe. Вероятно, это и есть виновник - не отсоединился вовремя от консоли... Вместе с коллегой придумывали разные варианты, теоретически, как исправить ситуацию. Но отсутствие у нас в символах PspTerminateProcess заставило изменить стратегию. Повисло ведь окно, значит надо выяснить почему... В winsrv.dll, чьё апи юзает csrss.exe, наткнулся на несколько интересных функций. Среди них ConsoleClientConnectRoutine, ConsoleClientDisconnectRoutine, RemoveConsole... ConsoleWindowProc - кажется то, что надо. Нашли, что у консольного окна сначала получается USER_DATA: pUserData = GetWindowLong(hWnd, GWL_USERDATA); которая является адресом какой-то структуры. Для WM_CLOSE по смещению 0x140 в ней сначала проверяются флаги, и если один из них false, то HandleCtrlEvent в конце концов добавляет флаг 4 по смещению 0x1B8... Мы ждали более логичного конца типа DestroyWindow, а тут... Искать и перебирать все возможные обращения к этому флагу с проверкой оказалось утомительным - их было много... Эксперименты с этим флагом тоже ничего не дали... Тогда может быть pUserData + 0x140 что-нибудь даст? Провёл пару экспериментов - установка тех или иных флагов вызывал глюки отображения окна консоли, сброс возвращал окно к прежнему виду... хм... Взведение всех флагов избавило от проблемы - консоль наконец закрылась<img src="img/smilies/s1.gif" alt=""> Ну на всякий случай вернул всё обратно, мало ли что. Таким образом, код завершения такого повисшего окна примерно такой:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">LONG&nbsp;pUserData&nbsp;<span class="hl_char">=</span>&nbsp;GetWindowLong<span class="hl_char">(</span>hWnd<span class="hl_char">,</span>&nbsp;GWL_USERDATA<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>DWORD</b></span>&nbsp;pid<span class="hl_comment">;</span></li><li class="hl_l0">GetWindowThreadProcessId<span class="hl_char">(</span>hWnd<span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>pid<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">HANDLE&nbsp;hProcess&nbsp;<span class="hl_char">=</span>&nbsp;OpenProcess<span class="hl_char">(</span>PROCESS_VM_OPERATION&nbsp;<span class="hl_char">|</span>&nbsp;PROCESS_VM_WRITE&nbsp;<span class="hl_char">|</span>&nbsp;PROCESS_VM_READ<span class="hl_char">,</span>&nbsp;<span class="hl_function">FALSE</span><span class="hl_char">,</span>&nbsp;pid<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>DWORD</b></span>&nbsp;dwOldFlags<span class="hl_char">,</span>&nbsp;dwNewFlags&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_char">-</span><span class="hl_number">1</span><span class="hl_comment">;</span></li><li class="hl_l1">ReadProcessMemory<span class="hl_char">(</span>hProcess<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">void</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>pUserData&nbsp;<span class="hl_char">+</span>&nbsp;0x140<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>dwOldFlags<span class="hl_char">,</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">WriteProcessMemory<span class="hl_char">(</span>hProcess<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">void</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>pUserData&nbsp;<span class="hl_char">+</span>&nbsp;0x140<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>dwNewFlags<span class="hl_char">,</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">SendMessage<span class="hl_char">(</span>hWnd<span class="hl_char">,</span>&nbsp;WM_CLOSE<span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">dwValue&nbsp;<span class="hl_char">=</span>&nbsp;0x090800<span class="hl_comment">;</span></li><li class="hl_l1">WriteProcessMemory<span class="hl_char">(</span>hProcess<span class="hl_char">,</span>&nbsp;<span class="hl_char">(</span><span class="hl_function">void</span><span class="hl_char">*</span><span class="hl_char">)</span><span class="hl_char">(</span>pUserData&nbsp;<span class="hl_char">+</span>&nbsp;0x140<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>dwOldFlags<span class="hl_char">,</span>&nbsp;<span class="hl_number">4</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">NULL</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">CloseHandle<span class="hl_char">(</span>hProcess<span class="hl_char">)</span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br>Единственное что - прозевал, нужен ли SendMessage... Дождусь очередного проявления бага - поисследую основательней... надеюсь <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289046&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=1" class="addthx" data-post="289046"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 18:22 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Интересное исследование. Я тоже встречался с висячей консолью, но руки не доходили разобраться. Встроить бы ваш код в <noindex><a href="http://processhacker.sourceforge.net/" rel="nofollow" target="_blank">--&gt; ProcessHacker &lt;--</a></noindex>, получилась бы полезная фича. Напишите его автору, возможность килять висячие консоли лишней не будет.<br><br>З.Ы. были бы все глюки винды такими безобидными...
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289048&amp;user=12867&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=2" class="addthx" data-post="289048"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 18:39 <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
Да пока неполные исследования. Самое главное - установить возможные причины более конкретно.
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289050&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=3" class="addthx" data-post="289050"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]mysterio[/b]','')">mysterio</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/1803.gif" alt=""><br><span class=txtSm>Ранг: 307.9 (мудрец), 196thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.17'>Активность: 0.18<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1803">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 19:06 <br><script type="text/javascript">QU('mysterio','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=mysterio" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
До кучи: http://www.nirsoft.net/utils/what_is_hang.html
<br><br><font size="1"><i>-----<br>Don_t hate the cracker - hate the code.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289051&amp;user=1803&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=4" class="addthx" data-post="289051"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 19:21 <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>mysterio пишет:<br>До кучи: http://www.nirsoft.net/utils/what_is_hang.html </I><br><br><I>На nirsoft пишут:<br>the user interface abruptly stops responding</I><br>В нашём случае консоль при этом реагирует адекватно почти на все действия. Кроме того, что её закрыть нельзя. &quot;Висячая&quot; консоль - не в смысле, что висит процесс, связанный с ней и консоль никак не реагирует, а наоборот, процессов уже нет, а консоль живёт своей жизнью. <img src="img/smilies/s1.gif" alt=""><br><br>P.S. Если б повесился csrss(здесь - в прямом, распространённом смысле), то только reset. <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289054&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=5" class="addthx" data-post="289054"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]mysterio[/b]','')">mysterio</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/1803.gif" alt=""><br><span class=txtSm>Ранг: 307.9 (мудрец), 196thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.17'>Активность: 0.18<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1803">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 19:31 <br><script type="text/javascript">QU('mysterio','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=mysterio" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<b>DenCoder</b><br>Еще один утиль не помешает ;) Хуже от него не будет - авось кому да пригодится.<br><br>P.S. Иногда когда &quot;висит&quot; консоль (cmd) то обычно еще муляет процесс &quot;wowexec.exe&quot;.
<br><br><font size="1"><i>-----<br>Don_t hate the cracker - hate the code.</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289056&amp;user=1803&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=6" class="addthx" data-post="289056"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 19:50 <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
Нашёл в реестре HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\SubSystems<br>Ключ Windows<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_char">%</span>SystemRoot<span class="hl_char">%</span><span class="hl_char">\</span>system32<span class="hl_char">\</span>csrss<span class="hl_char">.</span>exe&nbsp;ObjectDirectory<span class="hl_char">=</span><span class="hl_char">\</span>Windows&nbsp;SharedSection<span class="hl_char">=</span><span class="hl_number">1024</span><span class="hl_char">,</span><span class="hl_number">3072</span><span class="hl_char">,</span><span class="hl_number">512</span>&nbsp;Windows<span class="hl_char">=</span>On&nbsp;SubSystemType<span class="hl_char">=</span>Windows&nbsp;ServerDll<span class="hl_char">=</span>basesrv<span class="hl_char">,</span><span class="hl_number">1</span>&nbsp;ServerDll<span class="hl_char">=</span>winsrv<span class="hl_char">:</span>UserServerDllInitialization<span class="hl_char">,</span><span class="hl_number">3</span>&nbsp;ServerDll<span class="hl_char">=</span>winsrv<span class="hl_char">:</span>ConServerDllInitialization<span class="hl_char">,</span><span class="hl_number">2</span>&nbsp;ProfileControl<span class="hl_char">=</span>Off&nbsp;MaxRequestThreads<span class="hl_char">=</span><span class="hl_number">16</span></li>        </ol>
    </div>
</div></div>
<br><br>Вероятно, от некоторых значений параметров в ключе зависит работа консолей. А также вижу возможность заменить winsrv.dll заменить на другую... Только, похоже, она связана с basesrv.dll, так что там же менять и её... если, конечно, это имеет смысл...
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289058&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=7" class="addthx" data-post="289058"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 20:55 &middot; Поправил: reversecode <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
а пинг именно в такой комбинации time ping goto ? а просто ping ?<br>у меня просто ping -t google.com запускается каждый день  в течении нескольких лет подряд<br>и висит по 20 часов в день, и ничего подобно описаного не наблюдается вроде<br><br>ping правда запущен постоянно с окна far, а не с самой cmd<br>но в процессах он через cmd виден
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=289062&amp;user=15381&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=8" class="addthx" data-post="289062"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 августа 2011 21:20 <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
Да, именно в такой комбинации. Просто ping не проверял... Этот баг вообще трудно как поймать, так и спровоцировать. Пытаюсь, пытаюсь ))
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=289063&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=9" class="addthx" data-post="289063"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 222thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 августа 2011 07:32 &middot; Поправил: DenCoder <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=18866.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
Приём, описанный выше, хоть и грубый, но самый быстрый. Чего ещё? Вроде можно б было и закрыть темку... ан нет, упомяну две вещи:<br><br>1)<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">struct&nbsp;CSR_PROCESS</li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;CLIENT_ID&nbsp;ClientId<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;LIST_ENTRY&nbsp;ListLink<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LIST_ENTRY&nbsp;ThreadList<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;CSR_PROCESS&nbsp;<span class="hl_char">*</span>Parent<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;CSR_NT_SESSION&nbsp;<span class="hl_char">*</span>NtSession<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ExpectedVersion<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ClientPort<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ClientViewBase<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ClientViewBounds<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ProcessHandle<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;SequenceNumber<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;Flags<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;DebugFlags<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ProcessGroupId<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ProcessGroupSequence<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ReferenceCount<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;fVDM<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;LastMessageSequence<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;NumOutstandingMessages<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ThreadCount<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LUID&nbsp;Luid<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ShutdownFlags<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ShutdownLevel<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;ServerDllPerProcessData<span class="hl_char">[</span><span class="hl_number">4</span><span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l0">}<span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br>Это единственно близкая к правде структура для Windows XP SP3, которой нет в W2K и которая на реактос просто перетасована(как и некоторые другие структуры)...<br><br>2) В Windows время создания тредов назначается, оказывается, от 1 января 1601 года с точностью до 100 наносекунд... И если вдруг в _ETHREAD треда, пославшего LPC, время не сходится - то это достаточная причина, чтобы повесить консоль... Хотя по мере исследований ещё штук 5 насчитал <img src="img/smilies/s1.gif" alt="">
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=290182&amp;user=24257&amp;forum_n=6&amp;topic=18866.html&amp;page=0&amp;anchor=10" class="addthx" data-post="290182"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Висячая консоль и как с этим бороться</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#11" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="18866">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=18866" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
