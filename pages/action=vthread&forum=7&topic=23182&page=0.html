<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Winapi CreateService - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="предыстория мытарств чайника в поисках истины: жила была Windows XP. замечательная система, но некий гражданин Билли Г. решил что в новом виндовсе начальника безопасности не хватает и ввел такую бяку (благословение) как UAC. и">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55914'>Kybyx</a> (+3 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Winapi CreateService</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]SeregaZ[/b]','')">SeregaZ</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 29.3 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.4'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=19941">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 октября 2014 11:42 <br><script type="text/javascript">QU('SeregaZ','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SeregaZ" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=23182.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
предыстория мытарств чайника в поисках истины:<br><br>жила была Windows XP. замечательная система, но некий гражданин Билли Г. решил что в новом виндовсе начальника безопасности не хватает и ввел такую бяку (благословение) как UAC. и вот наш чайник установив свою программу на висте\семерке\восьмерке понял, что его шедевр работать не будет. он решил схитрить и добавил обязательно требование администраторских прав при запуске приложения. однако UAC его перехитрил и просто перестал запускать из автозапуска это приложение. наш чайник тогда придумал грабли - без прав администратора, но при клике мышкой на иконке программы в систем трее предлагает повысить права и перезапускает с администраторскими правами. однако наш чайник начал чуствовать, что мыши коляться, плачут но продолжают жрать кактус. и решил он им помочь.<br><br>чайник стал искать материалы как-же решить эту проблему и нашел статьи, что планировщик заданий позволяет запустить приложение с администраторскими правами при запуске системы. обрадовался, начал работать... и тут до него доперло, что планировщик заданий может быть отключен у некоторых пользователей. чайник приуныл... <br><br>однако он через какое-то время наткнулся на статьи о запуске своего приложения как сервисную службу. надежда затеплилась вновь! но увы... в описании http://msdn.microsoft.com/en-us/library/windows/desktop/ms682450(v=vs.85).aspx остался непонятным момент с использованием<br><b>lpServiceStartName</b> [in, optional]<br>The name of the account under which the service should run. If the service type is SERVICE_WIN32_OWN_PROCESS, use an account name in the form <b>DomainName\UserName</b>. The service process will be logged on as this user. If the account belongs to the built-in domain, you can specify .\UserName.<br><br>откуда брать этот самый <b>DomainName\UserName</b>? и правильно ли что я его ищу, а проблема в чем: приложение при запуске находит путь до моих документов, оттуда читает какие-то конфигурационные файлы. например путь до папки &quot;документс сеттингс\Администратор&quot;, однако если добавить службу с флагом NULL в команде CreateService - то само приложение запускается от LocalService чтоли... и соответственно путь до моих документов выглядит иначе - примерно &quot;документс сеттингс\LocalService&quot;, а там моих документов как бы и нет... и соответственно приложение работать не хочет. посему правильно ли надеяться на этот самый параметр <b>lpServiceStartName</b>? то есть запустить приложение от имени пользователя, а не системы, чтобы определение пути до моих документов был верен.<br><br>и второй момент - вист, семерок и восьмерок под рукой пока нет, для ХР это винапи CreateService работает, а будет ли работать на этих системах, а то может там какойнибудь сертификат нужен дополнительный и только время зазря теряю?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=348213&amp;user=19941&amp;forum_n=7&amp;topic=23182.html&amp;page=0&amp;anchor=1" class="addthx" data-post="348213"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 октября 2014 12:04 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=23182.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Будет работать в новых ОС. А что непонятного в DomainName\UserName? Брать и прописывать имя домена и имя админа на компе, чтобы от них запускать. Как вариант-запускать от LocalSystem и имперсонироваться потом в админа.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=348214&amp;user=1556&amp;forum_n=7&amp;topic=23182.html&amp;page=0&amp;anchor=2" class="addthx" data-post="348214"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]SeregaZ[/b]','')">SeregaZ</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 29.3 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.4'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=19941">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 октября 2014 12:37 <br><script type="text/javascript">QU('SeregaZ','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SeregaZ" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=23182.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
DomainName тоже самое что имя компьютера? с UserName вроде разобрался - GetUserName... в итоге вышло примерно так: &quot;MAIN\Администратор&quot;<br><br>а как теперь это значение указать в команде?<br>CreateService_(schSCManager, @ServiceName.s,@DisplayName.s, dwDesiredAccess,dwServiceType,dwStartType,dwErrorControl,@PathToServiceEXE.s,0,0,0,&quot;MAIN\Администратор&quot;,0)<br>ругается. пишет неверные параметры. если вместо &quot;MAIN\Администратор&quot; указать 0 - работает. предположим имя и домейн я получил не верно, то можно проверить это указав кошерное имя типа NT AUTHORITY\LocalService или NT AUTHORITY\NetworkService - но и с ними пишет неверные параметры. это должна быть текстовая переменная или указатель? в описании этого я не понял...<br><br><b>Добавлено спустя -42 минут</b><br>так... еще момент - если у пользователя был пароль, то получается я не смогу создать службу? опять грабли...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=348215&amp;user=19941&amp;forum_n=7&amp;topic=23182.html&amp;page=0&amp;anchor=3" class="addthx" data-post="348215"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]ntldr[/b]','')">ntldr</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 369.8 (мудрец), 400thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.89'>Активность: 0.39<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12867">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 октября 2014 13:48 <br><script type="text/javascript">QU('ntldr','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ntldr" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=23182.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<I>SeregaZ пишет:<br> однако UAC его перехитрил и просто перестал запускать из автозапуска </I><br>Есть воркараунд: запускаться из RunOnce и каждый раз пересоздавать параметр. Тогда запускается от админа и молча.
<br><br><font size="1"><i>-----<br>PGP key <noindex><a href="https://diskcryptor.net/storage/new_key.asc" rel="nofollow" target="_blank">&lt0x1B6A24550F33E44A&gt</a></noindex></i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=348217&amp;user=12867&amp;forum_n=7&amp;topic=23182.html&amp;page=0&amp;anchor=4" class="addthx" data-post="348217"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]SeregaZ[/b]','')">SeregaZ</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 29.3 (посетитель)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.4'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=19941">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 30 октября 2014 20:30 <br><script type="text/javascript">QU('SeregaZ','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SeregaZ" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=23182.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
на заметку взял, спасибо. но все-таки хотелось бы разобраться.<br><br>предварительно причина нашлась в совокупности параметров:<br>dwServiceType.l=#SERVICE_WIN32_OWN_PROCESS | #SERVICE_INTERACTIVE_PROCESS<br>If the service type specifies SERVICE_INTERACTIVE_PROCESS, the service must run in the LocalSystem account.<br><br>то есть получается когда сразу два параметра указаны - то можно запустить только под этим локалом. для DomainName\UserName получается можно использовать только один параметр #SERVICE_WIN32_OWN_PROCESS без второго.<br><br>в итоге служба в списке появляется, но стартануть не может. пишет <br>Ошибка 1069: Служба не запущена из-за ошибки входа в систему<br><br>в свойствах службы указан запуск с учетной записью .\Администратор - то есть вроде бы верно. пароля у меня вроде нет, а там куча звездочек. если их удалить и применить - все равно не запускает.<br><br>все упирается в пароль для учетной записи? нет пароля - не даст запустить под DomainName\UserName?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=348220&amp;user=19941&amp;forum_n=7&amp;topic=23182.html&amp;page=0&amp;anchor=5" class="addthx" data-post="348220"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Winapi CreateService</span></td>
</tr></table>
</div>
<a name=newreply></a>
<center><h3>У вас должно быть 20 пунктов ранга, чтобы оставлять сообщения в  этом подфоруме, но у вас только 0</h3></center><script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=23182" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
