<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>проверка PE-файла на валидность - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="помогите, плиз, с программой... она проверят PE-файлы на валидность.. и тут вроде ошибка с SEH... вот исходник: format PE GUI 4.0 entry start include &#039;%fasminc%\win32a.inc&#039; include &#039;%fasminc%\macro\masm.inc&#039;">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=40607'>vsv1</a>, <a target='_blank' href='?action=userinfo&amp;user=41701'>_MBK_</a> (+3 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> проверка PE-файла на валидность</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]Necromancer13[/b]','')">Necromancer13</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.8 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.92'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12724">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 23 октября 2007 22:54 &middot; Поправил: Necromancer13 <br><script type="text/javascript">QU('Necromancer13','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Necromancer13" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
помогите, плиз, с программой...<br>она проверят PE-файлы на валидность..<br>и тут вроде ошибка с SEH...<img src="img/smilies/s9.gif" alt=""><br><br>вот исходник:<br><br>format PE GUI 4.0<br>entry start <br>include &#039;%fasminc%\win32a.inc&#039; <br>include &#039;%fasminc%\macro\masm.inc&#039; <br>struct  SEH<br>  PrevLink        dd ?<br>  CurrentHandler  dd ?<br>  SafeOffset      dd ?<br>  PrevEsp         dd ?<br>  PrevEbp         dd ?<br>ends<br><br>struct FLOATING_SAVE_AREA<br>  ControlWord        dd ?<br>  StatusWord         dd ?<br>  TagWord            dd ?<br>  ErrorOffset        dd ?<br>  ErrorSelector      dd ?<br>  DataOffset         dd ?<br>  DataSelector       dd ?<br>  RegisterArea       rb SIZE_OF_80387_REGISTERS<br>  Cr0NpxStatedd      dd ?<br>ends<br><br>struct CONTEXT<br>  ContextFlags         dd ?<br>  Dr0                  dd ?<br>  Dr1                  dd ?<br>  Dr2                  dd ?<br>  Dr3                  dd ?<br>  Dr6                  dd ?<br>  Dr7                  dd ?<br>  FloatSave            FLOATING_SAVE_AREA<br>  SegGs                dd ?<br>  SegFs                dd ?<br>  SegEs                dd ?<br>  SegDs                dd ?<br>  Edi                  dd ?<br>  Esi                  dd ?<br>  Ebx                  dd ?<br>  Edx                  dd ?<br>  Ecx                  dd ?<br>  Eax                  dd ?<br>  Ebp                  dd ?<br>  Eip                  dd ?<br>  SegCs                dd ?<br>  EFlags               dd ?<br>  Esp                  dd ?<br>  SegSs                dd ?<br>  MAXIMUM_SUPPORTED_EXTENSION = 1 ; Because I have not this constant defined anywhere. You obviously have to solve this in another way<br>  ExtendedRegisters    rb MAXIMUM_SUPPORTED_EXTENSION<br>ends<br><br>SIZE_OF_80387_REGISTERS      = 80 <br>IDD_DLG1                     = 1 <br>MAXSIZE                      = 512 <br>ButtonID                     = 3 <br>section &#039;.data&#039; data readable writeable <br>hInstance       dd ? <br>CommandLine     dd ? <br>ofn             OPENFILENAME <br>FilterString    db &#039;EXE-files (*.exe), DLL-files (*.dll)&#039;,0,&#039;*.exe;*.dll&#039;,0 <br>                db &#039;All Files (*.*)&#039;,0,&#039;*.*&#039;,0,0 <br>buffer          rb MAXSIZE <br>hFileRead       dd ? <br>hMapFile        dd ? <br>pMemory         dd ? <br>seh             SEH <br>section &#039;.code&#039; code readable writeable executable <br>start: <br>        invoke  GetModuleHandle,0 <br>        mov     [hInstance],eax <br>        invoke  GetCommandLine <br>        mov     [CommandLine],eax <br>        invoke  DialogBoxParam,[hInstance],IDD_DLG1,HWND_DESKTOP,DlgProc,0 <br>        invoke  ExitProcess,eax <br>         <br>proc DlgProc hWnd,uMsg,wParam,lParam <br>        cmp     [uMsg],WM_INITDIALOG <br>        jz      .initdialog <br>        cmp     [uMsg],WM_CLOSE <br>        jz      .wmclose <br>        cmp     [uMsg],WM_COMMAND <br>        jz      .wmcommand <br>        mov     eax,FALSE <br>        ret <br>.initdialog: <br>        mov     [ofn.lStructSize],sizeof.OPENFILENAME <br>        push    [hWnd] <br>        pop     [ofn.hwndOwner] <br>        push    [hInstance] <br>        pop     [ofn.hInstance] <br>        mov     [ofn.lpstrFilter],FilterString <br>        mov     [ofn.lpstrFile],buffer <br>        mov     [ofn.nMaxFile],MAXSIZE <br>        jmp     _finish <br>.wmclose: <br>        cmp     [hMapFile],0 <br>        je      @f <br>        call    CloseMapFile <br>@@: <br>        invoke  EndDialog,[hWnd],0 <br>        jmp     _finish <br>.wmcommand: <br>        mov     eax,[wParam] <br>        mov     edx,eax <br>        shr     edx,16 <br>        cmp     dx,BN_CLICKED <br>        jne     _finish <br>        cmp     ax,ButtonID <br>        jne     _finish <br>        mov     [ofn.Flags],OFN_FILEMUSTEXIST or OFN_PATHMUSTEXIST or OFN_LONGNAMES or OFN_EXPLORER or OFN_HIDEREADONLY <br>        invoke  GetOpenFileName,ofn <br>        cmp     eax,TRUE <br>        jne     _finish <br>        invoke  CreateFile,buffer,GENERIC_READ,FILE_SHARE_READ,0,OPEN_EXISTING,FILE_AT TRIBUTE_NORMAL,0  <br>        test    eax,eax <br>        je      _erroropen <br>        mov     [hFileRead],eax <br>        invoke  CreateFileMapping,[hFileRead],0,PAGE_READONLY,0,0,0 <br>        test    eax,eax <br>        je      _errormap <br>        mov     [hMapFile],eax <br>         <br>        ;======================================= <br>        ;======================================= <br>        call    CheckFile <br>FinalExit: <br>        test    ecx,ecx <br>        jne     @next        <br>        jmp     @f <br>ValidText       db &#039;It&#039;&#039;s a valid PE file!&#039;,0 <br>AppName         db &#039;PE View&#039;,0 <br>@@: <br>        invoke  MessageBox,HWND_DESKTOP,ValidText,AppName,MB_ICONINFORMATION <br>        push    [seh.PrevLink] <br>        pop     dword[fs:0] <br>        invoke  UnmapViewOfFile,[pMemory]<br>        invoke  CloseHandle,[pMemory]<br>        invoke  CloseHandle,[hMapFile]<br>        jmp     _finish <br>@next: <br>        push    [seh.PrevLink] <br>        pop     dword[fs:0] <br>        invoke  UnmapViewOfFile,[pMemory] <br>        jmp     @f <br>InvalidText     db &#039;It&#039;&#039;s not a valid PE file!&#039;,0 <br>@@: <br>        invoke  MessageBox,HWND_DESKTOP,InvalidText,AppName,MB_ICONERROR <br>        push    [seh.PrevLink] <br>        pop     dword[fs:0] <br>        invoke  UnmapViewOfFile,[pMemory]<br>        invoke  CloseHandle,[pMemory]<br>        invoke  CloseHandle,[hMapFile]<br>        jmp     _finish <br>        ;======================================= <br>        ;======================================= <br>_finish: <br>        mov     eax,TRUE <br>        ret <br>errop           db &#039;Can not open file for reading&#039;,0 <br>errmp           db &#039;Can not map file&#039;,0 <br><br>_erroropen: <br>        invoke  MessageBox,HWND_DESKTOP,errop,AppName,MB_ICONERROR <br>        jmp     _finish <br>_errormap: <br>        invoke  MessageBox,HWND_DESKTOP,errmp,AppName,MB_ICONERROR <br>        jmp     _finish <br>endp <br><br>proc CloseMapFile <br>        invoke  CloseHandle,[hMapFile] <br>        mov     [hMapFile],0 <br>        invoke  CloseHandle,[hFileRead] <br>        ret <br>endp <br><br>proc CheckFile <br>        invoke  MapViewOfFile,[hMapFile],FILE_MAP_READ,0,0,0 <br>        test    eax,eax <br>        je      _mappingerror <br>        mov     [pMemory],eax <br>        push    dword[fs:0] <br>        pop     [seh.PrevLink] <br>        mov     [seh.CurrentHandler],SEHHandler <br>        mov     [seh.SafeOffset],FinalExit <br>        mov     eax,seh <br>        mov     [fs:0],eax <br>        mov     [seh.PrevEsp],esp <br>        mov     [seh.PrevEbp],ebp <br>        mov     edi,[pMemory] <br>        cmp     word[edi],&#039;MZ&#039; <br>        jne     .notmz <br>        add     edi,dword[edi+3Ch] <br>        cmp     dword[edi],00004550h <br>        je      _valid <br>        xor     ecx,ecx <br>        inc     ecx <br>        ret <br>.notmz: <br>        jmp     @f <br>NotMZ           db &#039;MZ-signature is not found!&#039;,0 <br>@@: <br>        invoke  MessageBox,HWND_DESKTOP,NotMZ,AppName,MB_ICONERROR         <br>        xor     ecx,ecx <br>        inc     ecx <br>        ret <br>_mappingerror: <br>        jmp     @f <br>MappingError    db &#039;Can not map file into memory!&#039;,0 <br>@@: <br>        invoke  MessageBox,HWND_DESKTOP,MappingError,AppName,MB_ICONERROR <br>        xor     ecx,ecx <br>        inc     ecx <br>        ret <br>_valid: <br>        xor     ecx,ecx <br>        ret <br>endp <br><br>proc SEHHandler pExcept,pFrame,pContext,pDispatch <br>        push    edx <br>        mov     edx,[pFrame] <br>        assume  edx:SEH <br>        mov     eax,[pContext] <br>        assume  eax:CONTEXT <br>        push    [edx.SafeOffset] <br>        pop     [eax.Eip] <br>        push    [edx.PrevEsp]<br>        pop     [eax.Esp] <br>        push    [edx.PrevEbp] <br>        pop     [eax.Ebp] <br>        xor     ecx,ecx <br>        inc     ecx <br>        pop     edx <br>        ret         <br>endp <br><br>section &#039;.idata&#039; import data readable writeable <br>        library user32,&#039;user32.dll&#039;,\ <br>                kernel32,&#039;kernel32.dll&#039;,\ <br>                comdlg32,&#039;comdlg32.dll&#039; <br>        include &#039;%fasminc%\api\user32.inc&#039; <br>        include &#039;%fasminc%\api\kernel32.inc&#039; <br>        include &#039;%fasminc%\api\comdlg32.inc&#039;<br>section &#039;.rsrc&#039; resource from &#039;PEView.res&#039; data readable<br><br><br><br>вот RC-файл:<br><br><br>#define IDD_DLG1 1<br>#define IDC_GRP1 2<br>#define IDC_BTN1 3<br>IDD_DLG1 DIALOGEX 150,88,192,118<br>CAPTION &quot;PE View&quot;<br>FONT 10,&quot;Comic Sans MS&quot;,400,0,204<br>STYLE 0x10CA0000<br>BEGIN<br>  CONTROL &quot;PE VIEW&quot;,IDC_GRP1,&quot;Button&quot;,0x50000007,0,0,192,119<br>  CONTROL &quot;Open File&quot;,IDC_BTN1,&quot;Button&quot;,0x50012F00,10,41,168,27<br>END<br><br><br>заранее огромное спасибо...<br><br>если при проверке правильного PE-файла, то все ок, а если проверить файл неправильный....<br>прога &quot;вылетает&quot;...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=164581&amp;user=12724&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=1" class="addthx" data-post="164581"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Ice-T[/b]','')">Ice-T</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/12329.jpg" alt=""><br><span class=txtSm>Ранг: 126.7 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.01'>Активность: 0.14<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12329">Участник</a><br><font color=blue>#CCh</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 06:43 <br><script type="text/javascript">QU('Ice-T','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ice-T" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
бряк на <code>push EDX</code> в SEHHandler и смотри че у тебя там за косяк..<br><br>з.ы. выделяй код следующий раз
<br><br><font size="1"><i>-----<br>invoke OpenFire</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=164611&amp;user=12329&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=2" class="addthx" data-post="164611"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Necromancer13[/b]','')">Necromancer13</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.8 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.92'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12724">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 07:33 <br><script type="text/javascript">QU('Necromancer13','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Necromancer13" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
вот как раз в том и странность, что прога не попадает в SEHHandler!<img src="img/smilies/s14.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=164616&amp;user=12724&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=3" class="addthx" data-post="164616"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]Ice-T[/b]','')">Ice-T</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/12329.jpg" alt=""><br><span class=txtSm>Ранг: 126.7 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.01'>Активность: 0.14<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12329">Участник</a><br><font color=blue>#CCh</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 09:51 <br><script type="text/javascript">QU('Ice-T','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ice-T" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
это не странность, это ошибка в установке SEH&#039;a или део вообще не в нем.. проверять твой код врядли кто очень захочет, так что посмотри структуру (или в фасме она стандартна?) и поглади на код внимательне.. установи СЕХ, потом просто подели на ноль и потрейси.. вот на всякий случай пример нормальной структуры:<br><br><code>   SEH struct                                 ; начало описания структуры<br>         pPrevSEH     dd ?                    ; адрес предыдущей структуры SEH      <br>         pHandler     dd ?                     ; адрес собственного обработчика исключения <br>         pSafeOffset  dd ?                    ; адрес, с которого продолжится выполнение после<br>         dPrevEsp     dd ?                     ; старое значение в ESP<br>         dPrevEbp     dd ?                     ; старое значение в EBP<br>       SEH ends                                   ; конец описания</code><br><br><br>и соответственно его установка:<br><br><code>; --------------------установка нового обработчика исключений--------------------------------------<br>   assume FS:nothing                                        ;fs необходимо отвязать<br>   push FS:[0]                                                    ;запишем в стек адрес предыдущего обработчика<br>   pop seh.pPrevSEH                                         ;выдернем в структуру  <br>   mov seh.pHandler,offset fHandler                 ;адрес обработчика в струтуру   <br>   mov seh.pSafeOffset,offset lFin                     ;адрес &quot;безопасного места&quot;<br>   lea EAX, seh                                                  ; в EAX адрес нашей SEH структуры<br>   mov FS:[0], EAX                                            ;чтобы она вступила в силу надо поместить ее в цепочку<br>   mov seh.dPrevEsp, ESP                                ;и сохраним в ней старые значения    <br>   mov seh.dPrevEbp, EBP                                ;ESP и EBP</code>
<br><br><font size="1"><i>-----<br>invoke OpenFire</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=164634&amp;user=12329&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=4" class="addthx" data-post="164634"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Necromancer13[/b]','')">Necromancer13</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.8 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.92'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12724">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 15:36 <br><script type="text/javascript">QU('Necromancer13','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Necromancer13" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
ASSUME fs:nothing в ФАСМе не требуется...<br><br>вот структура SEH:<br><br>struct SEH<br>PrevLink dd ?<br>CurrentHandler dd ?<br>SafeOffset dd ?<br>PrevEsp dd ?<br>PrevEbp dd ?<br>ends<br><br><br>прога открывает файл, мэппирует его в память..<br>в [EDI ] начало промэппированного файла...<br>проверяет на наличие MZ-сигнатуры...<br><br>добавляет до edi то, дворд с [EDI+3Ch]...<br>но если файл неправильный, в [EDI+3Ch] будет находиться не то число, и оно будет слишком  - слаживаются EDI + dword ptr [Edi+3Ch] и проверяется по адресу [EDI] есть ли PE-сигнатура... но с EDI (если файл неправильный) может оказатся такое, число, что чтение с памяти по этому адресу невозможное...<br><br>и тогда программа завершивается.. SEH не срабатывает... <br><br>вроде бы все с SEH&#039;ом делаю правильно...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=164721&amp;user=12724&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=5" class="addthx" data-post="164721"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Styx[/b]','')">Styx</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 103.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.97'>Активность: 0.07<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=12">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 16:07 <br><script type="text/javascript">QU('Styx','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Styx" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<b>Necromancer13</b><br>Лучше предупреждать возникновение ошибок, а не обрабатывать их (по возможности).<br>Можно ведь просто сравнить смещение с размером файла.
<br><br><font size="1"><i>-----<br>Crack your mind, save the planet</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=164729&amp;user=12&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=6" class="addthx" data-post="164729"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Necromancer13[/b]','')">Necromancer13</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.8 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.92'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12724">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 16:24 <br><script type="text/javascript">QU('Necromancer13','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Necromancer13" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
я вроде знаю, как это делать..<br>вроде IsBadReadPtr или что-то типа этого...<br><br>но на МАСМе я видел прогу с помощью SEH, а на ФАСМ ее перевести уже не могу((:<br><br><br><b>   .386<br>   .model flat,stdcall<br>   option casemap:none<br>   include \masm32\include\windows.inc<br>   include \masm32\include\kernel32.inc<br>   include \masm32\include\comdlg32.inc<br>   include \masm32\include\user32.inc<br>   includelib \masm32\lib\user32.lib<br>   includelib \masm32\lib\kernel32.lib<br>   includelib \masm32\lib\comdlg32.lib<br><br>   SEH struct<br>   PrevLink dd ?    ; the address of the previous seh structure<br>   CurrentHandler dd ?    ; the address of the exception handler<br>   SafeOffset dd ?    ; The offset where it&#039;s safe to continue execution<br>   PrevEsp dd ?      ; the old value in esp<br>   PrevEbp dd ?     ; The old value in ebp<br>   SEH ends<br><br>   .data<br>   AppName db &quot;PE tutorial no.2&quot;,0<br>   ofn OPENFILENAME &lt;&gt;<br>   FilterString db &quot;Executable Files (*.exe, *.dll)&quot;,0,&quot;*.exe;*.dll&quot;,0<br>                    db &quot;All Files&quot;,0,&quot;*.*&quot;,0,0<br>   FileOpenError db &quot;Cannot open the file for reading&quot;,0<br>   FileOpenMappingError db &quot;Cannot open the file for memory mapping&quot;,0<br>   FileMappingError db &quot;Cannot map the file into memory&quot;,0<br>   FileValidPE db &quot;This file is a valid PE&quot;,0<br>   FileInValidPE db &quot;This file is not a valid PE&quot;,0<br><br>   .data?<br>   buffer db 512 dup(?)<br>   hFile dd ?<br>   hMapping dd ?<br>   pMapping dd ?<br>   ValidPE dd ?<br><br>   .code<br>   start proc<br>   LOCAL seh:SEH<br>   mov ofn.lStructSize,SIZEOF ofn<br>   mov ofn.lpstrFilter, OFFSET FilterString<br>   mov ofn.lpstrFile, OFFSET buffer<br>   mov ofn.nMaxFile,512<br>   mov ofn.Flags, OFN_FILEMUSTEXIST or OFN_PATHMUSTEXIST or OFN_LONGNAMES or OFN_EXPLORER or OFN_HIDEREADONLY<br>   invoke GetOpenFileName, ADDR ofn<br>   .if eax==TRUE<br>       invoke CreateFile, addr buffer, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL<br>       .if eax!=INVALID_HANDLE_VALUE<br>          mov hFile, eax<br>          invoke CreateFileMapping, hFile, NULL, PAGE_READONLY,0,0,0<br>          .if eax!=NULL<br>             mov hMapping, eax<br>             invoke MapViewOfFile,hMapping,FILE_MAP_READ,0,0,0<br>             .if eax!=NULL<br>                mov pMapping,eax<br>                assume fs:nothing<br>                push fs:[0]<br>                pop seh.PrevLink<br>                mov seh.CurrentHandler,offset SEHHandler<br>                mov seh.SafeOffset,offset FinalExit<br>                lea eax,seh<br>                mov fs:[0], eax<br>                mov seh.PrevEsp,esp<br>                mov seh.PrevEbp,ebp<br>                mov edi, pMapping<br>                assume edi:ptr IMAGE_DOS_HEADER<br>                .if [edi].e_magic==IMAGE_DOS_SIGNATURE<br>                   add edi, [edi].e_lfanew<br>                   assume edi:ptr IMAGE_NT_HEADERS<br>                   .if [edi].Signature==IMAGE_NT_SIGNATURE<br>                      mov ValidPE, TRUE<br>                   .else<br>                      mov ValidPE, FALSE<br>                   .endif<br>                .else<br>                    mov ValidPE,FALSE<br>                .endif<br>   FinalExit:<br>                .if ValidPE==TRUE<br>                    invoke MessageBox, 0, addr FileValidPE, addr AppName, MB_OK+MB_ICONINFORMATION<br>                .else<br>                   invoke MessageBox, 0, addr FileInValidPE, addr AppName, MB_OK+MB_ICONINFORMATION<br>                .endif<br>                push seh.PrevLink<br>                pop fs:[0]<br>                invoke UnmapViewOfFile, pMapping<br>             .else<br>                invoke MessageBox, 0, addr FileMappingError, addr AppName, MB_OK+MB_ICONERROR<br>             .endif<br>             invoke CloseHandle,hMapping<br>          .else<br>             invoke MessageBox, 0, addr FileOpenMappingError, addr AppName, MB_OK+MB_ICONERROR<br>          .endif<br>          invoke CloseHandle, hFile<br>       .else<br>          invoke MessageBox, 0, addr FileOpenError, addr AppName,<br>   MB_OK+MB_ICONERROR<br>       .endif<br>   .endif<br>   invoke ExitProcess, 0<br>   start endp<br><br>   SEHHandler proc uses edx pExcept:DWORD, pFrame:DWORD, pContext:DWORD, pDispatch:DWORD<br>       mov edx,pFrame<br>       assume edx:ptr SEH<br>       mov eax,pContext<br>       assume eax:ptr CONTEXT<br>       push [edx].SafeOffset<br>       pop [eax].regEip<br>       push [edx].PrevEsp<br>       pop [eax].regEsp<br>       push [edx].PrevEbp<br>       pop [eax].regEbp<br>       mov ValidPE, FALSE<br>       mov eax,ExceptionContinueExecution<br>       ret<br>   SEHHandler endp<br>   end start<br></b><br><br><br>а перевести на ФАСМ это не могу(((
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=164732&amp;user=12724&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=7" class="addthx" data-post="164732"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Ice-T[/b]','')">Ice-T</a></b><br></div>
<img src="img/s5.gif" alt=""><br><img style="padding-top:3px;" src="av/12329.jpg" alt=""><br><span class=txtSm>Ранг: 126.7 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.01'>Активность: 0.14<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12329">Участник</a><br><font color=blue>#CCh</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 16:55 <br><script type="text/javascript">QU('Ice-T','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Ice-T" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
довы издеваетесь! для СЕХ&quot;а достаточно минимальной структуры, создайте новый проект, создайте структуру, установит его, поделите на ноль, загрузите все в отладчек и пиздец.. это вместо того, чтобы постить сюда огромные листинги при этом выделяя их жирным шрефтом (там кнпочка &quot;code&quot; есть)
<br><br><font size="1"><i>-----<br>invoke OpenFire</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=164736&amp;user=12329&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=8" class="addthx" data-post="164736"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Necromancer13[/b]','')">Necromancer13</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 9.8 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.92'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12724">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 октября 2007 17:33 <br><script type="text/javascript">QU('Necromancer13','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Necromancer13" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=10245.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
сорри, у меня кнопочка не подписана... больше так не буду...<br>да простые задачи с сехом у меня получались!.. мне надо чтоб эта программа работала..<br>короче, очень большая просьба для тех, кто хорошо знает АСМ - перевести прежний исходник (жирным выделенный) с МАСМа на ФАСМ<img src="img/smilies/s14.gif" alt=""><br>я уже вообще сейчас не уверен, что это возможно...<img src="img/smilies/s11.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=164745&amp;user=12724&amp;forum_n=5&amp;topic=10245.html&amp;page=0&amp;anchor=9" class="addthx" data-post="164745"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> проверка PE-файла на валидность</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#10" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="5">
<input type="hidden" name="topic" value="10245">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=10245" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
