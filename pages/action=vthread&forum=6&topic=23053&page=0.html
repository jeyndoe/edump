<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Странное поведение DirectSoundCreate - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Есть программа работающая с звуком и графикой, однако тупо не умеющая обрабатывать ошибки. Когда тот же DirectSoundCreate возвращает не 0 - всё тупо вылетает с ошибкой. Особенно не приятно то, что до этого переключается">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=8605'>Rio</a>, <a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a>, <a target='_blank' href='?action=userinfo&amp;user=42072'>zombi-vadim</a> (+7 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Странное поведение DirectSoundCreate</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 04 сентября 2014 23:16 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Есть программа работающая с звуком и графикой, однако тупо не умеющая обрабатывать ошибки. Когда тот же DirectSoundCreate возвращает не 0 - всё тупо вылетает с ошибкой. Особенно не приятно то, что до этого переключается видеорежим. Возникла идея реализовать это в отдельном модуле который будет запускаться до переключения видеорежима и выдавать ошибку.<br>Тестовое delphi приложение работает чётко, однако засунув всё в dll с удивлением заметил, что происходит вход в DirectSoundCreate, а вот выход нет. Всё зависает...<br>Мне кажется я тупо что-то не учёл, подскажите пожалуйста.<br>Гуглил безрезультатно, проблема похоже только у меня.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346145&amp;user=702&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=1" class="addthx" data-post="346145"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 05 сентября 2014 09:20 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Ну раз нет ни кода, ничего, будем гадать.<br>Ткну пальцем в небо, что первое пришло в голову: вызов запихал в DllMain?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346151&amp;user=1556&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=2" class="addthx" data-post="346151"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 05 сентября 2014 16:28 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I>Archer пишет:<br>Ну раз нет ни кода, ничего, будем гадать.<br>Ткну пальцем в небо, что первое пришло в голову: вызов запихал в DllMain? </I><br><br>Я код не выложил потому, что нормального кода не написал. Пробовал разные варианты:<br>1) Вызывал DirectSoundCreate(nil, DirectSound, nil) между begin/end. модуля без DllMain<br>2) Там же делал CreateThread и вызов DirectSoundCreate в потоке.<br>3) Тоже самое только с ожиданием завершения потока.<br>4) DirectSoundCreate из DllMain при Dll_Process_Attach<br>5) CreateThread и вызов DirectSoundCreate в потоке из  DllMain при Dll_Process_Attach<br>6) Тоже самое с WaitForSingleObject(Result,INFINITE);<br><br>Пробовал отладчиком. Уходит глубоко в недра DirectSoundCreate, там и остаётся...<br>Уверен, что большинство из моих попыток, если не все, ошибочны по сути. Буду благодарен если подскажите правильный путь, я его изображу в коде и выложу для более детального разбора ошибки.<br>p.s. Ещё в расширенном варианте был вызов DirectDrawCreate(nil,DD,nil); так вот с ним проблем никаких не было...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346178&amp;user=702&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=3" class="addthx" data-post="346178"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]microxa[/b]','')">microxa</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.8 (посетитель), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 8.79'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=30317">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 05 сентября 2014 19:42 &middot; Поправил: microxa <br><script type="text/javascript">QU('microxa','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=microxa" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
распихать всё в один или два модуля, т.е  обойтись без DLL,  инициализировать DS перед сменой режима, проверить типы данных/их выравнивание, откатится на старый вариант, перенести всё в тестовое приложение нормально отработавшему DS Create
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346186&amp;user=30317&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=4" class="addthx" data-post="346186"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 06 сентября 2014 19:48 &middot; Поправил: ToBad <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Проект не мой, для меня есть подгрузка мой длл в которой всё хотелось бы сделать.<br>По идее всё должно быть очень просто, не понятно почему один и тот же код работает в ЕХЕ, но не работает в DLL. Сделать какие то костыли типа из ресурсов длл вытаскивать ехе который проверит ответ от DirectSoundCreate и передаст через клиент\сервер назад в длл я бы мог, но не хочется. Тут теперь дело принципа понять в чём проблема. Я много вариантов directsound.pas скачивал, даже ZenGL прикручивал где тоже есть работа с DirectSoundCreate - результат один, виснет.<br>Вот простейший код который по идее должен был бы работать:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0"><span class="hl_function"><b>library</b></span>&nbsp;testlib<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_function"><b>uses</b></span>&nbsp;windows<span class="hl_char">,</span>&nbsp;directsound<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Var&nbsp;DirectSound<span class="hl_char">:</span>&nbsp;IDirectSound<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">begin</li><li class="hl_l1"><span class="hl_function"><b>if</b></span>&nbsp;DirectSoundCreate<span class="hl_char">(</span>&nbsp;nil<span class="hl_char">,</span>&nbsp;DirectSound<span class="hl_char">,</span>&nbsp;nil&nbsp;<span class="hl_char">)</span>&nbsp;<span class="hl_char">&lt;</span><span class="hl_char">&gt;</span>&nbsp;DS_OK&nbsp;Then&nbsp;messagebox<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'error'</span><span class="hl_char">,</span><span class="hl_quote">''</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;messagebox<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'ok'</span><span class="hl_char">,</span><span class="hl_quote">''</span><span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function">end</span><span class="hl_char">.</span></li>        </ol>
    </div>
</div></div>
<br><br>Ни один messagebox не появляется...<br>Вообще моя цель проверить минимальным кодом доступность DX и правильность установки аудио и видео драйвера. Как я писал ранее основное приложение которое работает с моей длл использует DirectSoundCreate + DirectDrawCreate и тупо не обрабатывает ошибок.<br><br>p.s. Сейчас проверил, если запихнуть DirectSoundCreate в экспортируемую функцию и вызвать её после загрузки библиотеки - работает. Но из мой длл никаких функций не вызывается, она просто прописана в импорте ЕХЕ. Как сделать что бы это сработало при загрузке DLL через LoadLibrary?<br><br><b>Добавлено спустя 3 часа 7 минут</b><br>Прочитал <noindex><a href="http://www.transl-gunsmoker.ru/2009/01/dllmain.html" rel="nofollow" target="_blank">статью</a></noindex> и понял, что вся проблема из за DllMain.<br>Можно ли это как то обойти без вызова экспортируемой функции? Какой нибудь таймер инициировать в DllMain что бы запускал функцию когда уже можно будет???
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346238&amp;user=702&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=5" class="addthx" data-post="346238"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 сентября 2014 03:24 &middot; Поправил: dosprog <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
Идиотизм конечно, всё равно обработка будет в DllMain,<br>но можно всякие телодвижения выполнять не в этой DLL по её LoadLibrary, а по FreeLibrary в другой, импортируемой этой первой. <br>То есть в  DllMain той второй по получении DLL_PROCESS_DETACH.<br>Тогда Dll&#039;ей две штуки, первая при загрузке делает free второй, которую она же и импортировала, ну и ...<br>Не знаю, что это даст. Врядли что-то путное.<br>Да и в <noindex><a href="http://www.transl-gunsmoker.ru/2009/01/dllmain.html" rel="nofollow" target="_blank"> <u>статье</u> </a></noindex> предостерегают от этого.<br><br>Во второй DLL:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">LibMain&nbsp;<span class="hl_function"><b>proc</b></span>&nbsp;instance<span class="hl_char">:</span><span class="hl_function">DWORD</span><span class="hl_char">,</span>reason<span class="hl_char">:</span><span class="hl_function">DWORD</span><span class="hl_char">,</span>unused<span class="hl_char">:</span><span class="hl_function"><b>DWORD</b></span>&nbsp;</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_function"><b>if</b></span>&nbsp;reason&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;DLL_PROCESS_ATTACH</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;instance</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>pop</b></span>&nbsp;hInstance</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;<span class="hl_function">TRUE</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_function"><b>elseif</b></span>&nbsp;reason&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;DLL_PROCESS_DETACH</li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">!</span>&nbsp;ЗДЕСЬ&nbsp;<span class="hl_char">!</span><span class="hl_char">!</span><span class="hl_char">!</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_function"><b>elseif</b></span>&nbsp;reason&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;DLL_THREAD_ATTACH</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_function"><b>elseif</b></span>&nbsp;reason&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;DLL_THREAD_DETACH</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">.</span><span class="hl_function">endif</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function">ret</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">LibMain&nbsp;<span class="hl_function">endp</span></li>        </ol>
    </div>
</div></div><br><br><span class="txtGoods"><a href="action=addthx&amp;post=346242&amp;user=35473&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=6" class="addthx" data-post="346242"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 сентября 2014 09:25 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>ToBad пишет:<br>Прочитал статью и понял, что вся проблема из за DllMain</I><br>Ну вообще это я сразу и написал. Не стоит туда пихать, что не попадя. А надо взять и почитать официальную документацию. И таймеры тут не помогут. http://msdn.microsoft.com/en-us/library/windows/desktop/ms682583(v=vs.85).aspx и http://msdn.microsoft.com/en-us/library/windows/desktop/dn633971(v=vs.85).aspx
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346244&amp;user=1556&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=7" class="addthx" data-post="346244"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]dosprog[/b]','')">dosprog</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 431.7 (мудрец), 390thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 6.95'>Активность: 0.73<span style='color:red'>&searr;</span>0.32</span><br>Статус: <a href="action=userinfo&amp;user=35473">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 сентября 2014 09:33 <br><script type="text/javascript">QU('dosprog','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=dosprog" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
Да оно ведь и не сильно усложится, если вствить в екзек дополнительно вызов экспортируемой функции..
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346246&amp;user=35473&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=8" class="addthx" data-post="346246"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 сентября 2014 17:06 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=23053.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<I>dosprog пишет:<br>То есть в DllMain той второй по получении DLL_PROCESS_DETACH. </I><br><br>Тоже самое получается, умирает на DirectSoundCreate.  [img]https://exelab.ruimg/smilies/s9.gif[/img]<br><br><I>Archer пишет:<br>Ну вообще это я сразу и написал. Не стоит туда пихать, что не попадя. А надо взять и почитать официальную документацию. И таймеры тут не помогут. </I><br><br>То есть без вызова экспортируемой функции вообще ничего не получится? Никакие костыли не сработают?<br><br><b>Добавлено спустя 1 час 42 минуты</b><br>Сработали вот какие костыли:<br>1) В DllMain моей библиотеки создаётся поток, который ожидает когда EXE подгружающий DLL будет распакован (проверяет наличие кода в определённом месте). Это работало и ранее, для небольшого патча ЕХЕ.<br>2) Когда можно патчить, делаю jmp на мою процедуру из DLL поблизости от EntryPoint EXE файла.<br>3) В этой функции делаю проверку на DirectSoundCreate и DirectDrawCreate, выдаю месседж и на выход если не ОК либо выполняю код который был под JMP и возвращаюсь на следующие инструкции в EXE.<br><br><b>Добавлено спустя 1 час 47 минут</b><br>То есть как и должно было бы быть в нормальном варианте если бы EXE вызывал функцию из моей DLL, а не просто её подгружал. Так как он этого не делал - пришлось из DllMain это добавить.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=346271&amp;user=702&amp;forum_n=6&amp;topic=23053.html&amp;page=0&amp;anchor=9" class="addthx" data-post="346271"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Странное поведение DirectSoundCreate</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#10" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="23053">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=23053" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
