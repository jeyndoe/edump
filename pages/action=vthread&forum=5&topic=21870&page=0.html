<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Некорректная передача управления из Sysenter. - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Хочу создать защиту для своей DLL. Для того, чтобы понять что делать взял пример защищенной DLL без исходного кода, только бинарник. Первое, что я решил сделать – загрузить ее через LoadLibrary. Загрузки не происходит,">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=28016'>asfa</a>, <a target='_blank' href='?action=userinfo&amp;user=8605'>Rio</a> (+6 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> Некорректная передача управления из Sysenter.</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]constant[/b]','')">constant</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 0.1 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.05'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=35221">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 июня 2013 23:48 &middot; Поправил: constant <br><script type="text/javascript">QU('constant','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=constant" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Хочу создать защиту для своей DLL.  Для того, чтобы понять что  делать взял пример защищенной DLL без исходного кода, только бинарник. <br>Первое, что я решил сделать – загрузить ее через LoadLibrary. Загрузки не происходит, выкидывается исключение. Загрузил в IDA, включил трассировку.<br><br>Трассировка доходит до следующего места:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_number">00002088</span>&nbsp;ntdll<span class="hl_char">:</span>ntdll_KiFastSystemCall&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>mov</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">edx</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr"><b>esp</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">EDX</span><span class="hl_char">=</span><span class="hl_number">001FF728</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li class="hl_l0"><span class="hl_number">00002088</span>&nbsp;ntdll<span class="hl_char">:</span>ntdll_KiFastSystemCall<span class="hl_char">+</span><span class="hl_number">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>sysenter</b></span>&nbsp;</li>        </ol>
    </div>
</div></div>
<br>     <br>После этого происходит передача управления сюда:<br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span class="hl_char">.</span>vmp1<span class="hl_char">:</span><span class="hl_number">5F30670E</span>&nbsp;<span class="hl_function"><b>in</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">eax</span><span class="hl_char">,</span>&nbsp;<span class="hl_registr">dx</span></li><li class="hl_l0"><span class="hl_char">.</span>vmp1<span class="hl_char">:</span><span class="hl_number">5F30670F</span>&nbsp;<span class="hl_function"><b>push</b></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_registr">ecx</span></li><li class="hl_l1"><span class="hl_char">.</span>vmp1<span class="hl_char">:</span><span class="hl_number">5F306710</span>&nbsp;<span class="hl_function"><b>call</b></span>&nbsp;&nbsp;&nbsp;&nbsp;sub_5F306FFC</li><li class="hl_l0">&nbsp;</li>        </ol>
    </div>
</div></div>
<br><br>При этом выводится сообщение:<br><br>«5F30670E: Priveleged instruction (exc.code c0000096, tid 8328  )»<br><br>Ну и исключение генерируется.<br>После этого я попробовал написать простенькую DLL, загрузить ее и также оттрассировать. В результате: выполнение кода почти что «один в один», но с той разницей, что sysenter передает управление обратно в вызывающую exe-программу (из которой загрузка DLL происходит), т.е. сразу после LoadLibrary, т.е. здесь все нормально.<br>Верны ли мои дальнейшие рассуждения ?<br>Инструкция sysenter обеспечивает быстрый доступ с прикладного уровня на уровень ядра (ринг 0). Инструкция принимает три скрытых аргумента из MSR регистров:  SYSENTER_CS_MSR (174h), SYSENTER_ESP_MSR (175h), SYSENTER_EIP_MSR,    по которым и будет передаваться управление. Однако, их можно и подменить. В этом случае, можно перенаправить поток выполнения на «левый» код. Что, возможно и произошло в моем случае. Если это так, то существуют ли способы мониторить эти MSR регистры, отследить, где искажение ? <br>Если мои рассуждения неверны, пожалуйста поправьте меня. Спасибо.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=326649&amp;user=35221&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=1" class="addthx" data-post="326649"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]ant_man[/b]','')">ant_man</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.7 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.58'>Активность: 0.01=0.01</span><br>Статус: <a href="action=userinfo&amp;user=921">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 07:59 <br><script type="text/javascript">QU('ant_man','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ant_man" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Да, MSR можно подменить, но длл это сделать не может, а только драйвер режима ядра. Тем более, что до sysenter исполняется только Ваш и системных длл код. Вы же не подменяли MSR, правда? <img src="img/smilies/s1.gif" alt=""> Копаете не в ту сторону.<br><br>Управление передается не на 5F30670E, а на точку входа dll. Почему она далее решает &quot;умереть&quot; - надо изучать алгоритм от точки входа.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=327044&amp;user=921&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=2" class="addthx" data-post="327044"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]reversecode[/b]','')">reversecode</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/15381.gif" alt=""><br><span class=txtSm>Ранг: 1053.6 <b><u>(!!!!)</u></b>, 1078thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.43'>Активность: 1.06<span style='color:red'>&searr;</span>0.81</span><br>Статус: <a href="action=userinfo&amp;user=15381">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 08:38 &middot; Поправил: reversecode <br><script type="text/javascript">QU('reversecode','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=reversecode" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
ему уже давно на rsdn ответили<br><br><noindex><a href="http://rsdn.ru/forum/asm/5210638.flat#5210638" rel="nofollow" target="_blank">--&gt; Link &lt;--</a></noindex>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=327046&amp;user=15381&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=3" class="addthx" data-post="327046"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:inline"> | Сообщение посчитали полезным: <span class="total_thx"><a href="action=userinfo&user=33253" title="02-07-2013 04:48, ранг:12.6" target="_blank">Abraham</a></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]DenCoder[/b]','')">DenCoder</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/24257.jpg" alt=""><br><span class=txtSm>Ранг: 324.3 (мудрец), 221thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 10.42'>Активность: 0.48<span style='color:red'>&searr;</span>0.37</span><br>Статус: <a href="action=userinfo&amp;user=24257">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 09:23 <br><script type="text/javascript">QU('DenCoder','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DenCoder" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<b>constant</b><br>Реально, не создаётся процесс перед этим? Поставьте бряк на NtCreateProcess/NtCreateProcessEx. Не мешало бы проверить несколько API на хуки/бряки. Проверку на хуки, используются ли они, быстрее можно установить бряком на VirtualProtect/VirtualProtectEx, NtProtectVirtualMemory, хотя может реально и напрямую соответсвующий сервис использоваться (через sysenter/int 2e), для чего для полной совместимости по идее должна бы ранее выполняться инструкция cpuid, а также GetVersion, чтобы определить возможности проца и ос.
<br><br><font size="1"><i>-----<br>IZ.RU</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=327048&amp;user=24257&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=4" class="addthx" data-post="327048"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]VodoleY[/b]','')">VodoleY</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 488.1 (мудрец), 272thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.01'>Активность: 0.35<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=17319">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 09:27 <br><script type="text/javascript">QU('VodoleY','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=VodoleY" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
.vmp1 это не вм_прот случаем?<img src="img/smilies/s1.gif" alt=""> там же на TLS код еще. если я не ошибаюсь.. а вы поймали антидебаг.. управление по SEH передаваться должно
<br><br><font size="1"><i>-----<br>Наша работа во тьме, Мы делаем, что умеем. Мы отдаем, что имеем, Наша работа во тьме....</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=327049&amp;user=17319&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=5" class="addthx" data-post="327049"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ant_man[/b]','')">ant_man</a></b><br></div>
<img src="img/s3.gif" alt=""><br><span class=txtSm>Ранг: 27.7 (посетитель), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.58'>Активность: 0.01=0.01</span><br>Статус: <a href="action=userinfo&amp;user=921">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 11:32 <br><script type="text/javascript">QU('ant_man','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ant_man" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>VodoleY пишет:<br>там же на TLS код еще. если я не ошибаюсь.. </I><br>а оно в DLL разве работает?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=327051&amp;user=921&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=6" class="addthx" data-post="327051"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 02 июля 2013 11:51 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=5&amp;topic=21870.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
TLS Callback в DLL работает, если она грузится статически.<br>Раз ответили на рсдн, то закрыто.<br>И по созданию защит-это не сюда, форумом ошиблись.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=327053&amp;user=1556&amp;forum_n=5&amp;topic=21870.html&amp;page=0&amp;anchor=7" class="addthx" data-post="327053"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/nub.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=5&sortBy=0&page=0.html"><b>Вопросы новичков</b></a> <b class=bulletHead>&#8212;&#8250;</b> Некорректная передача управления из Sysenter.</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=21870" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
