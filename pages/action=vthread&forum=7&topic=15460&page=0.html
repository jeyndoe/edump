<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Delphi. Глюки при частом обращении к функе. Помогите найти проблему. - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Столкнулся с проблемой одновременного вывода в лог файл из разных потоков. В силу задачи должен постоянно открывать и закрывать файл при записи строки. Соответственно, что бы не получать I/O error 103 использовал CriticalSection.">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b> (+2 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Delphi. Глюки при частом обращении к функе. Помогите найти проблему.</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 декабря 2009 19:46 &middot; Поправил: ToBad <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Столкнулся с проблемой одновременного вывода в лог файл из разных потоков. В силу задачи должен постоянно открывать и закрывать файл при записи строки. Соответственно, что бы  не получать I/O error 103 использовал CriticalSection. Эта ошибка пропала, но теперь возникают совершенно другие ошибки и чаще всего инвалид поинтер на goto rt. Ошибка происходит через определённое время, когда сразу, когда через пару минут, для того что бы скорее её узреть сделал 5 потоков и частое обращение. Заметил если в функе xlog закомментировать код после EnterCriticalSection и до result:=s то ошибка не возникает. Так же если оставить одну строку LogFileName:=&#039;data_&#039;+DateToStr(now)+&#039;.txt&#039;; - это уже приводит к ошибке. Как я понимаю где то подгаживается стек? Помогите пожалуйста устранить проблему.<br>Выкладываю код тут и в аттаче с exe вместе.<br> <br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">Function&nbsp;xlog<span class="hl_char">(</span>lb<span class="hl_char">:</span><span class="hl_function"><b>byte</b></span><span class="hl_comment">; pr,s:string):string;</span></li><li class="hl_l1">var</li><li class="hl_l0">&nbsp;&nbsp;F<span class="hl_char">:</span>TFileStream<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;PStr<span class="hl_char">:</span>&nbsp;PChar<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LengthLogString<span class="hl_char">:</span>&nbsp;integer<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;LogFileName<span class="hl_char">,</span>LogString<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">begin</li><li class="hl_l1">&nbsp;&nbsp;EnterCriticalSection<span class="hl_char">(</span>logsect<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LogFileName<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_quote">'data_'</span><span class="hl_char">+</span>DateToStr<span class="hl_char">(</span>now<span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_quote">'.txt'</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;lb<span class="hl_char">&gt;</span><span class="hl_number">0</span>&nbsp;then&nbsp;LogString<span class="hl_char">:</span><span class="hl_char">=</span>pr<span class="hl_char">+</span><span class="hl_quote">' '</span><span class="hl_char">+</span>TimeToStr<span class="hl_char">(</span>Now<span class="hl_char">)</span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_quote">': '</span><span class="hl_char">+</span>inttohex<span class="hl_char">(</span>lb<span class="hl_char">,</span><span class="hl_number">2</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_quote">' '</span><span class="hl_char">+</span>s<span class="hl_char">+</span>&nbsp;#13#10&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;LogString<span class="hl_char">:</span><span class="hl_char">=</span>pr<span class="hl_char">+</span><span class="hl_quote">' '</span><span class="hl_char">+</span>TimeToStr<span class="hl_char">(</span>Now<span class="hl_char">)</span>&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_quote">': '</span><span class="hl_char">+</span>s<span class="hl_char">+</span>&nbsp;#13#10<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LengthLogString<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;Length<span class="hl_char">(</span>LogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;PStr<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;StrAlloc<span class="hl_char">(</span>LengthLogString&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;StrPCopy<span class="hl_char">(</span>PStr<span class="hl_char">,</span>&nbsp;LogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;FileExists<span class="hl_char">(</span>LogFileName<span class="hl_char">)</span>&nbsp;then&nbsp;F<span class="hl_char">:</span><span class="hl_char">=</span>TFileStream<span class="hl_char">.</span>Create<span class="hl_char">(</span>LogFileName<span class="hl_char">,</span>&nbsp;fmOpenWrite<span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;F<span class="hl_char">:</span><span class="hl_char">=</span>TFileStream<span class="hl_char">.</span>Create<span class="hl_char">(</span>LogFileName<span class="hl_char">,</span>&nbsp;fmCreate<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;F<span class="hl_char">.</span>Position<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;F<span class="hl_char">.</span>Size<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;F<span class="hl_char">.</span>Write<span class="hl_char">(</span>PStr^<span class="hl_char">,</span>&nbsp;LengthLogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;StrDispose<span class="hl_char">(</span>PStr<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;F<span class="hl_char">.</span>Free<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;result<span class="hl_char">:</span><span class="hl_char">=</span>s<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;LeaveCriticalSection<span class="hl_char">(</span>logsect<span class="hl_char">)</span><span class="hl_comment">;  </span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr1<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Var&nbsp;s<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">Label&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Begin</li><li class="hl_l0">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">s<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'1'</span><span class="hl_char">,</span><span class="hl_quote">'1'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr2<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Var&nbsp;s<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">Label&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Begin</li><li class="hl_l0">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">s<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'2'</span><span class="hl_char">,</span><span class="hl_quote">'2'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr3<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Var&nbsp;s<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">Label&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Begin</li><li class="hl_l0">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">s<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'3'</span><span class="hl_char">,</span><span class="hl_quote">'3'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr4<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Var&nbsp;s<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">Label&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Begin</li><li class="hl_l0">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">s<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'4'</span><span class="hl_char">,</span><span class="hl_quote">'4'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr5<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Var&nbsp;s<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">Label&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Begin</li><li class="hl_l0">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">10</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">s<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">,</span><span class="hl_quote">'5'</span><span class="hl_char">,</span><span class="hl_quote">'5'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">procedure&nbsp;TForm1<span class="hl_char">.</span>Button1Click<span class="hl_char">(</span>Sender<span class="hl_char">:</span>&nbsp;TObject<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">begin</li><li class="hl_l0">Randomize<span class="hl_comment">;</span></li><li class="hl_l1">InitializeCriticalSection<span class="hl_char">(</span>logsect<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr1<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr2<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr3<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr4<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr5<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br><img src="img/attach.gif" alt=""> <a href="./files/02e0_11.12.2009_CRACKLAB.rU.tgz">02e0_11.12.2009_CRACKLAB.rU.tgz</a> - thrd.rar<br><br><b>p.s. Прошу модератора, если можно, подобрать наиболее подходящий раздел и перенести тему... Тут никто не читает...</b>
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246469&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=1" class="addthx" data-post="246469"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 декабря 2009 22:47 &middot; Поправил: <a href="action=stats#mods">Модератор</a> <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
Раздел самый подходящий. Ибо форум вообще не для этого, а форумов для дельфи и так пачка.<br>Да и код абзац, чего стоят только ГОТО, когда есть нормальные циклы while.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246500&amp;user=1556&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=2" class="addthx" data-post="246500"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 декабря 2009 23:18 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<I><b>Archer</b> пишет:<br>Да и код абзац, чего стоят только ГОТО, когда есть нормальные циклы while. </I><br><br>Да, я понимаю, что код некрасивый, но акцентирую внимание не на 5-ти потоках с готом внутри, а на функцию записи в файл, ибо ошибка возникает после её отработки.<br>Очень хочется услышать замечания по функции xlog которые возможно помогут избежать ошибок...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246502&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=3" class="addthx" data-post="246502"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]Isaev[/b]','')">Isaev</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6946.jpg" alt=""><br><span class=txtSm>Ранг: 756.3 <font color=magenta>(<b>! !</b>)</font>, 113thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.76'>Активность: 0.61<span style='color:red'>&searr;</span>0.05</span><br>Статус: <a href="action=userinfo&amp;user=6946">Участник</a><br><font color=blue>Student</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 11 декабря 2009 23:26 &middot; Поправил: Isaev <br><script type="text/javascript">QU('Isaev','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Isaev" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<I>ToBad пишет:<br>на функцию записи в файл, ибо ошибка возникает после её отработки. </I><br>в общем вроде относительно корректно написано<br>долго анализировал и не понял почему может падать<br>потом качнул, запустил... и правда не падает <img src="img/smilies/s5.gif" alt=""> (15000 записей по крайней мере подождал ~11min)<br>может от ос зависит? у меня xp sp2
<br><br><font size="1"><i>-----<br>z+Dw7uLu5+jqLCDq7vLu8PvpIPHs7uMh</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=246503&amp;user=6946&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=4" class="addthx" data-post="246503"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]_ruzmaz_[/b]','')">_ruzmaz_</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 114.8 (ветеран), 41thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.01'>Активность: 0.1<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=21589">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 01:32 <br><script type="text/javascript">QU('_ruzmaz_','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=_ruzmaz_" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>Isaev пишет:<br>потом качнул, запустил... и правда не падает  (15000 записей по крайней мере подождал ~11min)может от ос зависит? у меня xp sp2 </I><br>У меня наоборот - на sp2 и двух минут нормально не работает). А на sp3 пашет стабильно.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246509&amp;user=21589&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=5" class="addthx" data-post="246509"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 02:30 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
Странно всё это... У меня на sp3 раньше минуты слетает, а поставил на другой комп на sp2 - пашет уже более часа... И ещё на одном минут 20 тестировали, тоже sp2 и нормально...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246511&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=6" class="addthx" data-post="246511"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]Isaev[/b]','')">Isaev</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6946.jpg" alt=""><br><span class=txtSm>Ранг: 756.3 <font color=magenta>(<b>! !</b>)</font>, 113thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.76'>Активность: 0.61<span style='color:red'>&searr;</span>0.05</span><br>Статус: <a href="action=userinfo&amp;user=6946">Участник</a><br><font color=blue>Student</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 03:21 <br><script type="text/javascript">QU('Isaev','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Isaev" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
мда... забавно!<br>Всё-таки надо значит как-то по другому это реализовать, раз такая нестабильность<br>и ещё не понятно из-за чего<br><br>а когда слетает, лог в каком состоянии?<br>в смысле свободный/занятый или может на пол строки прерваный
<br><br><font size="1"><i>-----<br>z+Dw7uLu5+jqLCDq7vLu8PvpIPHs7uMh</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=246514&amp;user=6946&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=7" class="addthx" data-post="246514"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 05:04 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
<I><b>Isaev</b> пишет:<br>а когда слетает, лог в каком состоянии? </I><br><br>Когда как придётся. Когда нормально, а когда так:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">WR&nbsp;<span class="hl_number">3</span><span class="hl_char">:</span><span class="hl_number">55</span><span class="hl_char">:</span><span class="hl_number">58</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">1</span></li><li class="hl_l1">WR&nbsp;<span class="hl_number">3</span><span class="hl_char">:</span><span class="hl_number">55</span><span class="hl_char">:</span><span class="hl_number">58</span><span class="hl_char">:</span>&nbsp;<span class="hl_number">5</span></li><li class="hl_l0">WR&nbsp;и<span class="hl_char">$</span>Щ</li>        </ol>
    </div>
</div></div>
<br><br>А ещё интересно получается, если нажать второй раз - у меня на компе глюкает стабильно, а вот на втором тестовом где без слётов работало до 43Мб лога, потом нажал кнопку 10 раз, а значит общее кол-во потоков 50, дождался до 61 мб и просто прекратил тест. Это 3 часа 40 минут и 4099380 строк в логе без единого глюка. <br>Какой-то глюкотестер получился...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246518&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=8" class="addthx" data-post="246518"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]Av0id[/b]','')">Av0id</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 516.1 (<b>!</b>), 39thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.38'>Активность: 0.28<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1378">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 15:15 <br><script type="text/javascript">QU('Av0id','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Av0id" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
довольно часто стал наблюдать тенденцию, пишешь на дельфи - больше глюков, темы ToBad прямое тому подтверждение, может стоит уже юзать что-нибудь си-подобное?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246535&amp;user=1378&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=9" class="addthx" data-post="246535"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]Isaev[/b]','')">Isaev</a></b><br></div>
<img src="img/s8.gif" alt=""><br><img style="padding-top:3px;" src="av/6946.jpg" alt=""><br><span class=txtSm>Ранг: 756.3 <font color=magenta>(<b>! !</b>)</font>, 113thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.76'>Активность: 0.61<span style='color:red'>&searr;</span>0.05</span><br>Статус: <a href="action=userinfo&amp;user=6946">Участник</a><br><font color=blue>Student</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 12 декабря 2009 18:30 <br><script type="text/javascript">QU('Isaev','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Isaev" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>ToBad</b> задай вопрос на delphikingdom возможно там подскажут что путное
<br><br><font size="1"><i>-----<br>z+Dw7uLu5+jqLCDq7vLu8PvpIPHs7uMh</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=246557&amp;user=6946&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=10" class="addthx" data-post="246557"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 13 декабря 2009 14:39 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<b>Av0id</b> - Мои темы - это врядле вина дельфи. Скорее всего я плохой танцор... <img src="img/smilies/s1.gif" alt=""><br>Думаю и на Си я не избежал бы подобных тем...<br><br><I><b>Isaev</b> пишет:<br>задай вопрос на delphikingdom </I><br><br>Попробую.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=246580&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=11" class="addthx" data-post="246580"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 декабря 2009 19:54 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
Переделал по-другому, всё равно глючит.... Не пойму что за фигня... Наговорено может???<br>Подобная конструкция очень часто вылетает с разными ошибками, то инвалид поинтер, то обращение по адресу и память не может быть рид, на другой сборке windows просто молча закрывается. Ошибка происходит через неопределённое время, чаще всего в первые 5 минут работы. Для того, что бы в случае нарушения совместного доступа к файлу лога данные не терялись - реализовал работу со списком. Этот момент работает хорошо. Список не переполняется, ошибка не в этом. <br><br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">var</li><li class="hl_l1">&nbsp;&nbsp;Form1<span class="hl_char">:</span>&nbsp;TForm1<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;Dummy<span class="hl_char">:</span>&nbsp;<span class="hl_function"><b>dword</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;msgFlag<span class="hl_char">:</span>boolean<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;xlog<span class="hl_char">:</span>TStringList<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;LogThread<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; stdcall;</span></li><li class="hl_l1">var</li><li class="hl_l0">&nbsp;&nbsp;F<span class="hl_char">:</span>TFileStream<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;PStr<span class="hl_char">:</span>&nbsp;PChar<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LengthLogString<span class="hl_char">:</span>&nbsp;integer<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;LogFileName<span class="hl_char">,</span>LogString<span class="hl_char">:</span>string<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;fl<span class="hl_char">:</span>boolean<span class="hl_comment">;</span></li><li class="hl_l1">Label&nbsp;rt<span class="hl_char">,</span>rt2<span class="hl_comment">;</span></li><li class="hl_l0">Begin</li><li class="hl_l1">rt<span class="hl_char">:</span>Sleep<span class="hl_char">(</span><span class="hl_number">300</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">rt2<span class="hl_char">:</span><span class="hl_function"><b>if</b></span>&nbsp;xlog<span class="hl_char">.</span>Count<span class="hl_char">&gt;</span><span class="hl_number">0</span>&nbsp;then&nbsp;begin</li><li class="hl_l1">sleep<span class="hl_char">(</span><span class="hl_number">25</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">fl<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_function"><b>true</b></span><span class="hl_comment">;</span></li><li class="hl_l0">LogFileName<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_quote">'c:\testlog.txt'</span><span class="hl_comment">;</span></li><li class="hl_l1">LogString<span class="hl_char">:</span><span class="hl_char">=</span>xlog<span class="hl_char">.</span>Strings<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">+</span>#13#10<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;LengthLogString<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;Length<span class="hl_char">(</span>LogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;PStr<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;StrAlloc<span class="hl_char">(</span>LengthLogString&nbsp;<span class="hl_char">+</span>&nbsp;<span class="hl_number">1</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;StrPCopy<span class="hl_char">(</span>PStr<span class="hl_char">,</span>&nbsp;LogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;<span class="hl_function">try</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;FileExists<span class="hl_char">(</span>LogFileName<span class="hl_char">)</span>&nbsp;then&nbsp;F<span class="hl_char">:</span><span class="hl_char">=</span>TFileStream<span class="hl_char">.</span>Create<span class="hl_char">(</span>LogFileName<span class="hl_char">,</span>&nbsp;fmOpenWrite<span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;F<span class="hl_char">:</span><span class="hl_char">=</span>TFileStream<span class="hl_char">.</span>Create<span class="hl_char">(</span>LogFileName<span class="hl_char">,</span>&nbsp;fmCreate<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;F<span class="hl_char">.</span>Position&nbsp;<span class="hl_char">:</span><span class="hl_char">=</span>&nbsp;F<span class="hl_char">.</span>Size<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;F<span class="hl_char">.</span>Write<span class="hl_char">(</span>PStr^<span class="hl_char">,</span>&nbsp;LengthLogString<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;F<span class="hl_char">.</span>Free<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function">except</span></li><li class="hl_l1">&nbsp;&nbsp;fl<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_function"><b>not</b></span>&nbsp;fl<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;StrDispose<span class="hl_char">(</span>PStr<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;fl&nbsp;then&nbsp;xlog<span class="hl_char">.</span>Delete<span class="hl_char">(</span><span class="hl_number">0</span><span class="hl_char">)</span>&nbsp;<span class="hl_function"><b>else</b></span>&nbsp;goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;goto&nbsp;rt2<span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">goto&nbsp;rt<span class="hl_comment">;</span></li><li class="hl_l0">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">Function&nbsp;Thr1<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l0">Begin</li><li class="hl_l1"><span class="hl_function"><b>while</b></span>&nbsp;msgFlag&nbsp;do&nbsp;begin</li><li class="hl_l0">Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">100</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">50</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">xlog<span class="hl_char">.</span><span class="hl_function">Add</span><span class="hl_char">(</span><span class="hl_quote">'test1'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l0"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">Function&nbsp;Thr2<span class="hl_char">:</span><span class="hl_function"><b>dword</b></span><span class="hl_comment">; StdCall;</span></li><li class="hl_l1">Begin</li><li class="hl_l0"><span class="hl_function"><b>while</b></span>&nbsp;msgFlag&nbsp;do&nbsp;begin</li><li class="hl_l1">Sleep<span class="hl_char">(</span>random<span class="hl_char">(</span><span class="hl_number">100</span><span class="hl_char">)</span><span class="hl_char">+</span><span class="hl_number">50</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">xlog<span class="hl_char">.</span><span class="hl_function">Add</span><span class="hl_char">(</span><span class="hl_quote">'test2'</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">Result<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1">procedure&nbsp;TForm1<span class="hl_char">.</span>Button1Click<span class="hl_char">(</span>Sender<span class="hl_char">:</span>&nbsp;TObject<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">begin</li><li class="hl_l1">Randomize<span class="hl_comment">;</span></li><li class="hl_l0">msgFlag<span class="hl_char">:</span><span class="hl_char">=</span><span class="hl_function"><b>true</b></span><span class="hl_comment">;</span></li><li class="hl_l1">xlog<span class="hl_char">:</span><span class="hl_char">=</span>TStringList<span class="hl_char">.</span>Create<span class="hl_comment">;</span></li><li class="hl_l0">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@LogThread<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr1<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">CreateThread<span class="hl_char">(</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>@Thr2<span class="hl_char">,</span>nil<span class="hl_char">,</span><span class="hl_number">0</span><span class="hl_char">,</span>Dummy<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1"><span class="hl_function"><b>end</b></span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br><br>Выкладываю тест, там отображается кол-во записей не обработанных. Пишет в лог файл в корень С.<br><br><img src="img/attach.gif" alt=""> <a href="./files/c7dd_19.12.2009_CRACKLAB.rU.tgz">c7dd_19.12.2009_CRACKLAB.rU.tgz</a> - thrd_test_prj.exe
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=247082&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=12" class="addthx" data-post="247082"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]Av0id[/b]','')">Av0id</a></b><br></div>
<img src="img/s8.gif" alt=""><br><span class=txtSm>Ранг: 516.1 (<b>!</b>), 39thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.38'>Активность: 0.28<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1378">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 декабря 2009 20:07 <br><script type="text/javascript">QU('Av0id','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Av0id" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
попробуй синхронизировать потоки через CreateEvent, в msdn&#039;е прекрасный пример есть<br><br>msdn.microsoft.com/en-us/library/ms686915%28VS.85%29.aspx
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=247083&amp;user=1378&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=13" class="addthx" data-post="247083"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]SLV[/b]','')">SLV</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 309.8 (мудрец), 21thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.69'>Активность: 0.17<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=663">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 20 декабря 2009 07:04 <br><script type="text/javascript">QU('SLV','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=SLV" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
Всё не читал, но если нужна синхронизация с логер тредом быстрее и лучше в данном случае использовать критические секции со спином.
<br><br><font size="1"><i>-----<br>Shalom ebanats!</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=247138&amp;user=663&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=14" class="addthx" data-post="247138"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 апреля 2010 00:21 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
Всё было банально, не хватало этого: System.IsMultiThread:=true;
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=257045&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=15" class="addthx" data-post="257045"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]ProTeuS[/b]','')">ProTeuS</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 172.2 (ветеран)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.96'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=2281">Участник</a><br><font color=blue></font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 15 мая 2010 11:39 <br><script type="text/javascript">QU('ProTeuS','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ProTeuS" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
была схожая проблема в малтритредед делфовом же приложении, падения потоков были всегда &quot;в окресностях&quot; кода работы с данными типа string
<br><br><font size="1"><i>-----<br>HOW MUCH BLOOD WOULD YOU SHED TO STAY ALIVE</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=258027&amp;user=2281&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=16" class="addthx" data-post="258027"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]ToBad[/b]','')">ToBad</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/702.gif" alt=""><br><span class=txtSm>Ранг: 450.3 (мудрец), 13thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.67'>Активность: 0.2<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=702">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 18 мая 2010 18:36 <br><script type="text/javascript">QU('ToBad','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ToBad" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=7&amp;topic=15460.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
<I>ProTeuS пишет:<br>падения потоков были всегда &quot;в окресностях&quot; кода работы с данными типа string </I><br><br>Да, да, именно там и у меня...
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=258293&amp;user=702&amp;forum_n=7&amp;topic=15460.html&amp;page=0&amp;anchor=17" class="addthx" data-post="258293"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/mod.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=7&sortBy=0&page=0.html"><b>Оффтоп</b></a> <b class=bulletHead>&#8212;&#8250;</b> Delphi. Глюки при частом обращении к функе. Помогите найти проблему.</span></td>
</tr></table>
</div>
<a name=newreply></a>
<center><h3>У вас должно быть 20 пунктов ранга, чтобы оставлять сообщения в  этом подфоруме, но у вас только 0</h3></center><script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=15460" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
