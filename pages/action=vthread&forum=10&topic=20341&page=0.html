<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Image base address of foreign exe/dll or WTF? - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="I have a foreign process (exe-file DllProj.exe is running), that has SampleDll.dll linked to it (implicit linking). I can find the base address of the linked dll with the help of my function imageBase(), but not the base address">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/e.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=10&sortBy=0&page=0.html"><b>WorldWide</b></a> <b class=bulletHead>&#8212;&#8250;</b> Image base address of foreign exe/dll or WTF?</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]tguglanaklona[/b]','')">tguglanaklona</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.6 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.84'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=32856">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 15:39 <br><script type="text/javascript">QU('tguglanaklona','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tguglanaklona" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
I have a foreign process (exe-file DllProj.exe is running), that has SampleDll.dll linked to it (implicit linking). I can find the base address of the linked dll with the help of my function imageBase(), but not the base address of the process itself! What is the difference and why it&#039;s not working as is?<br><br>I mean, this code returns pBase with correct DOS/NT-headers:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;pBase&nbsp;<span class="hl_char">=</span>&nbsp;imageBase<span class="hl_char">(</span><span class="hl_quote">&quot;DllProj.exe&quot;</span><span class="hl_char">,</span>&nbsp;<span class="hl_quote">&quot;SampleDll.dll&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>pBase<span class="hl_char">)</span>&nbsp;return&nbsp;<span class="hl_function"><b>false</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;pDosHeader&nbsp;<span class="hl_char">=</span>&nbsp;PIMAGE_DOS_HEADER<span class="hl_char">(</span><span class="hl_char">(</span>HMODULE<span class="hl_char">)</span>pBase<span class="hl_char">)</span><span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">:</span><span class="hl_char">:</span>IsBadReadPtr<span class="hl_char">(</span>pDosHeader<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>IMAGE_DOS_HEADER<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">|</span><span class="hl_char">|</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_DOS_SIGNATURE&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;pDosHeader<span class="hl_char">-</span><span class="hl_char">&gt;</span>e_magic<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>false</b></span><span class="hl_comment">;</span></li>        </ol>
    </div>
</div></div>
<br>but this code return is FALSE:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_normal">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;pBase&nbsp;<span class="hl_char">=</span>&nbsp;imageBase<span class="hl_char">(</span><span class="hl_quote">&quot;DllProj.exe&quot;</span><span class="hl_char">,</span>&nbsp;<span class="hl_quote">&quot;DllProj.exe&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span><span class="hl_function"><b>and</b></span>&nbsp;so&nbsp;on<span class="hl_char">.</span><span class="hl_char">.</span><span class="hl_char">.</span></li>        </ol>
    </div>
</div></div>
<br>Here is my procedure:<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;imageBase<span class="hl_char">(</span>LPSTR&nbsp;szVictimProcess<span class="hl_char">,</span>&nbsp;LPSTR&nbsp;szVictim<span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>находим&nbsp;процесс&nbsp;szVictimProcess</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>DWORD</b></span>&nbsp;aProcesses<span class="hl_char">[</span><span class="hl_number">1024</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;cbNeeded<span class="hl_char">,</span>&nbsp;nProcesses<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;i<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_char">!</span>EnumProcesses<span class="hl_char">(</span>aProcesses<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>aProcesses<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>cbNeeded<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nProcesses&nbsp;<span class="hl_char">=</span>&nbsp;cbNeeded&nbsp;<span class="hl_char">/</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span><span class="hl_function">DWORD</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;ProcHandle&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;szProcessName<span class="hl_char">[</span>MAX_PATH<span class="hl_char">]</span>&nbsp;<span class="hl_char">=</span>&nbsp;TEXT<span class="hl_char">(</span><span class="hl_quote">&quot;&lt;unknown&gt;&quot;</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;<span class="hl_char">(</span>i&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">; i &lt; nProcesses; i++)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProcHandle&nbsp;<span class="hl_char">=</span>&nbsp;OpenProcess<span class="hl_char">(</span>PROCESS_QUERY_INFORMATION&nbsp;<span class="hl_char">|</span>&nbsp;PROCESS_VM_READ<span class="hl_char">,</span>&nbsp;<span class="hl_function">false</span><span class="hl_char">,</span>&nbsp;aProcesses<span class="hl_char">[</span>i<span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_function"><b>NULL</b></span>&nbsp;<span class="hl_char">!</span><span class="hl_char">=</span>&nbsp;ProcHandle<span class="hl_char">)</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;hMod<span class="hl_char">[</span><span class="hl_number">1024</span><span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>&nbsp;EnumProcessModules<span class="hl_char">(</span>ProcHandle<span class="hl_char">,</span>&nbsp;hMod<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>hMod<span class="hl_char">)</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>cbNeeded<span class="hl_char">)</span>&nbsp;<span class="hl_char">)</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetModuleBaseName</span><span class="hl_char">(</span>ProcHandle<span class="hl_char">,</span>&nbsp;hMod<span class="hl_char">[</span><span class="hl_number">0</span><span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;szProcessName<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>szProcessName<span class="hl_char">)</span><span class="hl_char">/</span><span class="hl_function">sizeof</span><span class="hl_char">(</span>TCHAR<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">; // Get the process name</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_number">0</span>&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;lstrcmpiA<span class="hl_char">(</span>szVictimProcess<span class="hl_char">,</span>&nbsp;szProcessName<span class="hl_char">)</span><span class="hl_char">)</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>находим&nbsp;модуль&nbsp;szVictim</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>DWORD</b></span>&nbsp;nModules&nbsp;<span class="hl_char">=</span>&nbsp;cbNeeded&nbsp;<span class="hl_char">/</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>HMODULE<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>char</b></span>&nbsp;szModName<span class="hl_char">[</span>MAX_PATH<span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;</span><span class="hl_char">(</span>unsigned&nbsp;<span class="hl_function"><b>int</b></span>&nbsp;j&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_number">0</span><span class="hl_comment">; j &lt; nModules; j++)</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span>GetModuleFileNameEx<span class="hl_char">(</span>ProcHandle<span class="hl_char">,</span>&nbsp;hMod<span class="hl_char">[</span>j<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;szModName<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>szModName<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>&nbsp;Get&nbsp;the&nbsp;module&nbsp;name</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shortName</span><span class="hl_char">(</span>szModName<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>if</b></span>&nbsp;<span class="hl_char">(</span><span class="hl_number">0</span>&nbsp;<span class="hl_char">=</span><span class="hl_char">=</span>&nbsp;lstrcmpiA<span class="hl_char">(</span>szModName<span class="hl_char">,</span>&nbsp;szVictim<span class="hl_char">)</span><span class="hl_char">)</span>&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODULEINFO&nbsp;info</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetModuleInformation</span><span class="hl_char">(</span>ProcHandle<span class="hl_char">,</span>&nbsp;hMod<span class="hl_char">[</span>j<span class="hl_char">]</span><span class="hl_char">,</span>&nbsp;<span class="hl_char">&amp;</span>info<span class="hl_char">,</span>&nbsp;<span class="hl_function">sizeof</span><span class="hl_char">(</span>info<span class="hl_char">)</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;info</span><span class="hl_char">.</span>lpBaseOfDll<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>Equal&nbsp;To<span class="hl_char">:</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>return&nbsp;hMod<span class="hl_char">[</span>j<span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;</li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>Debug<span class="hl_char">:</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>LPSTR&nbsp;string&nbsp;<span class="hl_char">=</span>&nbsp;<span class="hl_function"><b>new</b></span>&nbsp;<span class="hl_function">char</span><span class="hl_char">[</span><span class="hl_number">256</span><span class="hl_char">]</span><span class="hl_comment">;</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_char">/</span><span class="hl_char">/</span>wsprintf<span class="hl_char">(</span>string<span class="hl_char">,</span><span class="hl_quote">&quot;\t%s (0x%08X)\n&quot;</span><span class="hl_char">,</span>&nbsp;szModName<span class="hl_char">,</span>&nbsp;hMod<span class="hl_char">[</span>j<span class="hl_char">]</span><span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li><li class="hl_l0"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li><li class="hl_l1"><span style="word-break: break-all">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="hl_function"><b>break</b></span><span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l1">&nbsp;</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle<span class="hl_char">(</span>ProcHandle<span class="hl_char">)</span><span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hl_function"><b>NULL</b></span><span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;}</li>        </ol>
    </div>
</div></div>
<br>P.S.: My next goal is to get import-table of DllProj.exe (where Sample.dll is) and hiijack dll&#039;s function call
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311752&amp;user=32856&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=1" class="addthx" data-post="311752"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]HandMill[/b]','')">HandMill</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 222.2 (наставник), 115thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.21'>Активность: 0.14<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=4554">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 15:49 <br><script type="text/javascript">QU('HandMill','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HandMill" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
You can more easy find base address of loaded module:<br><br>GetModuleHandle(TEXT(&quot;SampleDll.dll&quot;)) - you will find the base of loaded DLL file<br>GetModuleHandle(NULL) - you will find the base of main executable file
<br><br><font size="1"><i>-----<br>все багрепорты - в личные сообщения</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=311753&amp;user=4554&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=2" class="addthx" data-post="311753"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]ajax[/b]','')">ajax</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/8830.gif" alt=""><br><span class=txtSm>Ранг: 337.6 (мудрец), 224thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.53'>Активность: 0.21<span style='color:red'>&searr;</span>0.1</span><br>Статус: <a href="action=userinfo&amp;user=8830">Участник</a><br><font color=blue>born to be evil</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 16:03 <br><script type="text/javascript">QU('ajax','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ajax" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
<b>HandMill</b><br><I>tguglanaklona пишет:<br>I have a foreign process</I>
<br><br><font size="1"><i>-----<br>От многой мудрости много скорби, и умножающий знание умножает печаль</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=311754&amp;user=8830&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=3" class="addthx" data-post="311754"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]tomac[/b]','')">tomac</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 65.3 (постоянный), 10thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.82'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=6470">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 19:25 <br><script type="text/javascript">QU('tomac','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tomac" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Isn&#039;t the process started as suspended and scanned before resuming?<br>If not, try to debug this line:<br>32.  shortName(szModName);<br>And look which modules it actually enumerates. Maybe shortName does not handle exe files properly.<br>Basically, the function is not intended to find process base address, it uses APIs that are designed to enumerate DLLs. For instance, msdn claims that you should pass NULL as module handle to GetModuleFileNameEx in order to obtain main executable file name. <br>You can modify the function to try and send NULL as the module handle.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311759&amp;user=6470&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=4" class="addthx" data-post="311759"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]tguglanaklona[/b]','')">tguglanaklona</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.6 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.84'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=32856">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 19:54 <br><script type="text/javascript">QU('tguglanaklona','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tguglanaklona" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
<I>HandMill writes:<br>You can more easy find base address of loaded module:<br><br>GetModuleHandle(TEXT(&quot;SampleDll.dll&quot;)) - you will find the base of loaded DLL file<br>GetModuleHandle(NULL) - you will find the base of main executable file  </I><br><br>?? ??? ?? ????? ?? ??? ??????? main, ? ?????, ??????????? ? ???????. ??? ? ???-?? ?? ??????? ? ?????? GetModuleHandle..<br><br><I>ajax writes:<br>HandMill<br>tguglanaklona ?????:<br>I have a foreign process  </I><br><br>?? ??-?? ??)) <img src="img/smilies/s14.gif" alt=""><br><br><I>tomac writes:<br>32. shortName(szModName); </I><br><br>short name - ??? ???????, ?????????? ??? ????? (??????, ?????? ????????):<br><br>void shortName(LPSTR strToChange)<br>{<br>	std::string path(strToChange);<br>	std::string filename;<br><br>	size_t pos = path.find_last_of(&quot;\&quot;);<br>	if (pos != std::string::npos)<br>		filename.assign(path.begin() + pos + 1, path.end());<br>	else<br>		filename = path;<br><br>	lstrcpy(strToChange, filename.data());<br>}<br><br>? ????????? <br>GetModuleFileNameEx(ProcHandle, hMod[j], szModName, sizeof(szModName))) // Get the module name<br>?????????? ?????? ??? exe-????????, ? DOS-????? ??? ????? ? ?????????? ????????????. ????? ??? ???????? ??? ?????? ?????? ??-???????? ?? ???????.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311760&amp;user=32856&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=5" class="addthx" data-post="311760"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]tguglanaklona[/b]','')">tguglanaklona</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.6 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.84'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=32856">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 20:06 <br><script type="text/javascript">QU('tguglanaklona','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tguglanaklona" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>HandMill writes:<br>You can more easy find base address of loaded module:<br><br>GetModuleHandle(TEXT(&quot;SampleDll.dll&quot;)) - you will find the base of loaded DLL file<br>GetModuleHandle(NULL) - you will find the base of main executable file  </I><br><br>No it&#039;s not my process, but another program (victim) process. And it states that GetModuleHandle(NULL) returns a handle to the file used to create the calling process... Or there s something I can&#039;t understand<br><br><I>ajax writes:<br>HandMill<br>tguglanaklona ?????:<br>I have a foreign process  </I><br><br>Yyyyyyes)) <img src="img/smilies/s14.gif" alt=""><br><br><I>tomac writes:<br>32. shortName(szModName); </I><br><br>short name - its my function, its return is OK:<br><br>void shortName(LPSTR strToChange)<br>{<br>	std::string path(strToChange);<br>	std::string filename;<br><br>	size_t pos = path.find_last_of(&quot;\&quot;);<br>	if (pos != std::string::npos)<br>		filename.assign(path.begin() + pos + 1, path.end());<br>	else<br>		filename = path;<br><br>	lstrcpy(strToChange, filename.data());<br>}<br><br>Also (see prog listing)<br><br>GetModuleFileNameEx(ProcHandle, hMod[j], szModName, sizeof(szModName))) // Get the module name<br><br>returns correct name of the victim exe-file. Perhaps some shifting inside <img src="img/smilies/s1.gif" alt="">??? Understand nothing - nothing already in my head <img src="img/smilies/s9.gif" alt=""> Please, help me, what to do <img src="img/smilies/s9.gif" alt=""> Must it works as an idea, or something wrong &#039;ideologically&#039;?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311761&amp;user=32856&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=6" class="addthx" data-post="311761"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]tguglanaklona[/b]','')">tguglanaklona</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.6 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.84'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=32856">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 20:08 <br><script type="text/javascript">QU('tguglanaklona','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tguglanaklona" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>tomac writes:<br>You can modify the function to try and send NULL as the module handle.  </I><br><br>If I sent NULL and for not victim but my procwss - everything is OK!
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311762&amp;user=32856&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=7" class="addthx" data-post="311762"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]HandMill[/b]','')">HandMill</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 222.2 (наставник), 115thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.21'>Активность: 0.14<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=4554">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 19 сентября 2012 20:25 <br><script type="text/javascript">QU('HandMill','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HandMill" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
So, may be this example will  help you: <noindex><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms686701(v=vs.85).aspx" rel="nofollow" target="_blank">http://msdn.microsoft.com/en-us/library/windows/desktop/ms686701(v=vs.85).aspx</a></noindex><br>Look to the <noindex><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684225(v=vs.85).aspx" rel="nofollow" target="_blank">MODULEENTRY32</a></noindex>.modBaseAddr<br>when you will list all modules you will also list main process module(exe)
<br><br><font size="1"><i>-----<br>все багрепорты - в личные сообщения</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=311764&amp;user=4554&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=8" class="addthx" data-post="311764"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]tomac[/b]','')">tomac</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 65.3 (постоянный), 10thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.82'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=6470">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 20 сентября 2012 00:36 <br><script type="text/javascript">QU('tomac','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tomac" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>HandMill</b><br>EnumProcessModules effectively uses CreateToolhelp32Snapshot. I do not think it will be much different from the used solution.<br><br><b>tguglanaklona</b><br>What if you send NULL as module handle for the foreign process? Does it work? <br><br>A few days ago I was solving a similar problem, I needed to inject a library into another process. But I created the process as suspended, and it was impossible to get modules info using CreateToolhelp32Snapshot for this process. You did not reply whether you create the process suspended and do not resume it before analyzing.<br><br><br><I>tguglanaklona writes:<br>short name - its my function, its return is OK: </I><br><br>I advised you to debug this line, not the function. Toggle a breakpoint at this line and look what names the program iterates through. If there is no exe file name, something&#039;s wrong with EnumProcessModules, consider using CreateToolhelp32Snapshot. If there is the exe file name, something wrong elsewhere. Maybe in GetModuleInformation. Consider using CreateToolhelp32Snapshot, again.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311780&amp;user=6470&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=9" class="addthx" data-post="311780"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]ajax[/b]','')">ajax</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/8830.gif" alt=""><br><span class=txtSm>Ранг: 337.6 (мудрец), 224thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.53'>Активность: 0.21<span style='color:red'>&searr;</span>0.1</span><br>Статус: <a href="action=userinfo&amp;user=8830">Участник</a><br><font color=blue>born to be evil</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 20 сентября 2012 11:28 &middot; Поправил: ajax <br><script type="text/javascript">QU('ajax','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=ajax" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>tguglanaklona</b><br>Check <noindex><a href="http://wiki.delphi-jedi.org/wiki/JCL_Download" rel="nofollow" target="_blank">--&gt; Link &lt;--</a></noindex>. Delphi code, but easy to port to C<br>function LoadedModulesList(const List: TStrings; ProcessID: DWORD; HandlesOnly: Boolean): Boolean;
<br><br><font size="1"><i>-----<br>От многой мудрости много скорби, и умножающий знание умножает печаль</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=311796&amp;user=8830&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=10" class="addthx" data-post="311796"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]tguglanaklona[/b]','')">tguglanaklona</a></b><br></div>
<img src="img/s1.gif" alt=""><br><span class=txtSm>Ранг: 1.6 (гость)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 7.84'>Активность: 0=0</span><br>Статус: <a href="action=userinfo&amp;user=32856">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 22 сентября 2012 18:20 <br><script type="text/javascript">QU('tguglanaklona','Цитата','writes');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=tguglanaklona" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=10&amp;topic=20341.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
<I>tomac writes:<br>A few days ago I was solving a similar problem, I needed to inject a library into another process. But I created the process as suspended, and it was impossible to get modules info using CreateToolhelp32Snapshot for this process. You did not reply whether you create the process suspended and do not resume it before analyzing. </I><br><br>I think it is the reason. I already come to the same thought. And exe file name and the image base address is really correct (I&#039;ve catched it with NULL handle), but this<br><I>tguglanaklona writes:<br>::IsBadReadPtr(pDosHeader, sizeof(IMAGE_DOS_HEADER)) ||<br>        IMAGE_DOS_SIGNATURE != pDosHeader-&gt;e_magic </I><br>is not.<br><br>Perhaps, the real possibility for the running exe-process is to make an assembler insertion, isn&#039;t it<br><br>Anyway I&#039;ll go to analyse it further <img src="img/smilies/s1.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=311889&amp;user=32856&amp;forum_n=10&amp;topic=20341.html&amp;page=0&amp;anchor=11" class="addthx" data-post="311889"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/e.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=10&sortBy=0&page=0.html"><b>WorldWide</b></a> <b class=bulletHead>&#8212;&#8250;</b> Image base address of foreign exe/dll or WTF?</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#12" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="10">
<input type="hidden" name="topic" value="20341">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=20341" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
