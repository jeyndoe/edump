<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Программное нахождение IAT - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Я тут задолбался уже с этим вопросом.Дело казалось бы тривиальное,но,когда PE-файл обработан протектором(переходники и всё остальное),всё оказывается как-то не просто. Собственно вот мой код,который пытается определить границы">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Программное нахождение IAT</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 14:19 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Я тут задолбался уже с этим вопросом.Дело казалось бы тривиальное,но,когда PE-файл обработан протектором(переходники и всё остальное),всё оказывается как-то не просто.<br>Собственно вот мой код,который пытается определить границы IAT.В функцию подаётся примерный OEP,а именно обратный адрес после перехвата вызова GetModuleHandleA,которая вызывается одной из первых после OEP.<br><code><br>; ########################################### ProcessIAT #########################################<br>ProcessIAT proc USES ebx edx esi dwApproxOEP:DWORD<br><br> local fResult:BOOL<br><br> local dwTempProtect:DWORD<br><br> local pBaseOfData:PVOID<br><br> local dwInitialIATAddress:DWORD<br> <br> local pIATStart:PVOID<br> local pIATEnd:PVOID<br> local dwIATSize:DWORD<br><br>      and    fResult, 0<br><br>      push   NULL<br>      call   GetModuleHandleA<br><br>      mov    ebx, eax<br>      add    ebx, dword ptr [ebx + IMAGE_DOS_HEADER.e_lfanew]<br>      mov    ebx, dword ptr [ebx + IMAGE_NT_HEADERS.OptionalHeader.BaseOfData]<br>      add    ebx, eax<br>      mov    pBaseOfData, ebx ; &lt;-- Дело в том,что часто это поле заголовка указывает именно на IAT<br><br>; /*<br>;  * Поиск границ IAT<br>;  */<br><br>; /* Нахождение адреса IAT, через который вызывалась функция GetModuleHandleA */ <br>      mov    eax, dwApproxOEP<br><br>@@seek_call_method:      <br>      dec    eax<br> <br>      cmp    word ptr [eax], 15FFh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 25FFh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 1D8Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 358Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 3D8Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 2D8Bh<br>      jz     @@call_method_found<br><br>      jmp    @@seek_call_method<br><br>@@call_method_found:<br><br>; /* В EDX кладём VA, по которому располагается одна из ячеек IAT */<br>      mov    edx, dword ptr [eax+02] <br>      mov    dwInitialIATAddress, edx<br><br>; /* Пытаемся определить начало IAT */<br><br>@@define_IAT_start:<br><br>      cmp    edx, pBaseOfData<br>      jz     @@IAT_start_reached<br><br>      sub    edx, sizeof DWORD<br>      <br>      cmp    dword ptr [edx], 0<br>      jnz    @@define_IAT_start<br><br>      sub    edx, sizeof DWORD<br><br>      cmp    dword ptr [edx], 0<br>      jz     @@IAT_start_reached<br><br>; /* Для проверки содержимого ячейки IAT ищем место в секции кода, где происходит обращение к этой ячейке */<br>      push   g_dwCodeEnd<br>      push   g_dwCodeStart<br>      push   edx<br>      call   SeekIATReference<br>      test   eax, eax<br>      jnz    @@define_IAT_start<br><br>@@IAT_start_reached:<br>      ; Тут я уже не знаю,как проверять,сколько нужно добавить к EDX<br>      mov    pIATStart, edx<br><br>; /* Пытаемся определить конец IAT */<br><br>      mov    edx, dwInitialIATAddress<br><br>@@define_IAT_end:<br>   <br>      add    edx, sizeof DWORD<br><br>      cmp    dword ptr [edx], 0<br>      jnz    @@define_IAT_end<br><br>      add    edx, sizeof DWORD<br><br>      cmp    dword ptr [edx], 0<br>      jz     @@IAT_end_reached    <br>     <br>; /* Для проверки содержимого ячейки IAT ищем место в секции кода, где происходит обращение к этой ячейке */<br>      push   g_dwCodeEnd<br>      push   g_dwCodeStart<br>      push   edx<br>      call   SeekIATReference<br>      test   eax, eax<br>      jnz    @@define_IAT_end<br><br>@@IAT_end_reached:<br>      mov    pIATEnd, edx<br>      sub    edx, pIATStart<br><br>      mov    dwIATSize, edx<br><br>...<br>ProcessIAT endp<br><br>; ####################################### SeekIATReference #######################################<br>SeekIATReference proc USES ebx edx dwIATVA:DWORD, dwCodeStart:DWORD, dwCodeEnd:DWORD<br><br> local fResult:BOOL<br><br>      and    fResult, 0<br><br>      mov    edx, dwIATVA<br>      mov    eax, dwCodeStart<br><br>@@seek_ref:<br>      cmp    word ptr [eax], 15FFh<br>      jz     @@ref_found<br><br>      cmp    word ptr [eax], 25FFh<br>      jz     @@ref_found<br><br>      cmp    word ptr [eax], 1D8Bh<br>      jz     @@ref_found<br><br>      cmp    word ptr [eax], 358Bh<br>      jz     @@ref_found<br><br>      cmp    word ptr [eax], 3D8Bh<br>      jz     @@ref_found<br><br>      cmp    word ptr [eax], 2D8Bh<br>      jz     @@ref_found<br><br>@@seeking_loop:<br>      inc    eax<br>      cmp    eax, dwCodeEnd<br>      jl     @@seek_ref<br><br>; /* Последняя попытка найти обращение к возможному адресу IAT в коде программы */<br><br>; ::::::::::::::::::::::::::::::::::::::::::::::::::::<br>      mov    eax, dwCodeStart<br><br>@@seek_ref_aux:<br>      cmp    dword ptr [eax], edx<br>      jnz    @@seeking_loop_aux<br><br>      or     fResult, 01<br><br>      jmp    @@ret<br><br>@@seeking_loop_aux:<br>      inc    eax<br>      cmp    eax, dwCodeEnd<br>      jl     @@seek_ref_aux<br><br>      jmp    @@ret<br><br>; ::::::::::::::::::::::::::::::::::::::::::::::::::::<br><br>@@ref_found:<br>      mov    ebx, dword ptr [eax+02]<br><br>      cmp    ebx, edx<br>      jnz    @@seeking_loop<br><br>      or     fResult, 01<br><br>@@ret:<br>      mov    eax, fResult<br>      ret<br><br>SeekIATReference endp </code><br><br>В общем,я совсем запустался с этим.Как ImpRec определяет границы IAT,когда нажимаешь кнопку &quot;IAT Autosearch&quot;??Ведь если ему дать правильный OEP,то в сишной программе он наверняка определит правильные границы.<br>Если проверять каждый адрес,находящийся в предполагаемой IAT,то моя функция SeeIATReference бывает не находит в секции кода обращения к какому-нибудь адресу IAT,хотя это должен быть 100% импорт.В итоге снова границы определяются неправильно.<br><br>Было бы здорово,если бы кто-то предложил какие-то конструктивные идеи по этому поводу.
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159241&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=1" class="addthx" data-post="159241"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:01 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
нет необходимости сохранять edx<br><br>часть исходников ImpRec&#039;а открыта
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159255&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=2" class="addthx" data-post="159255"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]Spirit[/b]','')">Spirit</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1419.gif" alt=""><br><span class=txtSm>Ранг: 271.6 (наставник), 2thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.35'>Активность: 0.3<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1419">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:16 <br><script type="text/javascript">QU('Spirit','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Spirit" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
А ссылку можно?<br>Никогда не видел.
<br><br><font size="1"><i>-----<br>iNTERNATiONAL CoDE CReW</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159259&amp;user=1419&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=3" class="addthx" data-post="159259"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:28 &middot; Поправил: __ <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
<b>Spirit</b><br>должно быть в архиве<br>wasm.ru/baixado.php?mode=tool&amp;id=64
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159262&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=4" class="addthx" data-post="159262"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:42 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Весьма конструктивные ответы...<br><br>Тут подумал,что можно было бы сделать следующим образом.<br>Определяем адрес в IAT с помощью примерной OEP,как я описал выше.Далее проверяем каждую ячейку кроме нулевых в такой последовательности:<br><br> 1. Сначала с помощью функции,которая определяет,лежит ли адрес предполагаемого импорта в диапазоне загруженных библиотек.Функция такая:<br><code><br>; #################################### SearchForTrueModuleReference ##############################<br>SearchForTrueModuleReference proc USES ebx ecx edx esi dwReference:DWORD<br><br> local fResult:BOOL<br><br> local adwModHandles[1024]:HANDLE<br> local cbNeeded:DWORD<br><br> local ModInfo:MODULEINFO<br><br>      and    fResult, 0<br><br>      mov    ebx, dwReference<br><br>      lea    esi, adwModHandles<br><br>      lea    eax, cbNeeded<br>      push   eax<br>      push   sizeof adwModHandles<br>      push   esi<br>      push   INVALID_HANDLE_VALUE<br>      call   EnumProcessModules<br>      test   eax, eax<br>      jz     @@ret<br><br>      mov    ecx, cbNeeded<br>      shr    ecx, 2<br>      <br>@@:<br>      dec    ecx<br>      jz     @@ret<br><br>; /* Мы не будем проверять первый элемент массива(ECX == 0), т.к. это и есть сам исполняемый модуль */<br><br>      push   ecx    ; Сохраняем регистр ECX, потому что GetModuleInformation наглым образом изменяет этот регистр<br><br>      push   sizeof MODULEINFO<br>      lea    eax, ModInfo<br>      push   eax<br>      push   dword ptr [esi + ecx * sizeof DWORD]<br>      push   INVALID_HANDLE_VALUE<br>      call   GetModuleInformation<br>      test   eax, eax<br>      jz     @@ret<br><br>      pop    ecx    ; Восстанавливаем регистр ECX<br><br>      mov    eax, [esi + ecx * sizeof DWORD]<br>      add    eax, dword ptr ModInfo.dwSizeOfImage<br><br>      cmp    ebx, [esi + ecx * sizeof DWORD]<br>      jl     @b<br>      <br>      cmp    ebx, eax<br>      ja     @b<br><br>      or     fResult, 01<br><br>      jmp    @@ret<br><br>@@ret:<br>      mov    eax, fResult<br>      ret<br><br>SearchForTrueModuleReference endp </code><br><br> 2. Если не лежит,то проверяем права доступа к адресу с помощью функции IsBadCodePtr.По идее переходник протектора(если это он) должен иметь read access.Таким образом мы попытаемся исключить мусорные адреса.На MSDN правда пишут,что функции IsBadXxxPtr -- это бомба замедленного действия,но я думаю,что SEH должен решить эту проблему.<br><br> 3. Если права доступа позволяют,то проверяем не адрес ли это в пределах исследуемого исполняемого модуля, т.е. ImageBase + SizeOfImage.Если это он,то значит это не адрес импорта.
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159265&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=5" class="addthx" data-post="159265"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:49 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<I>DillerInc пишет:<br>Сохраняем регистр ECX, потому что GetModuleInformation наглым образом изменяет этот регистр </I><br><br>чего наглым то? она вовсе не обязана его сохранять ;)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159269&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=6" class="addthx" data-post="159269"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 15:58 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>DillerInc пишет:<br>Весьма конструктивные ответы... </I><br><br>код плохо читается без форматирования, выглядит так будто откуда-то вырипан, почему не использовать invoke, неговоря о том что лучше переписать на С ?
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159270&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=7" class="addthx" data-post="159270"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 16:05 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
[offtop]<br><b>__</b><br>Может закончим флуд??Если сказать по делу нечего,то лучше просто промолчать.<br>[/offtop]
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159272&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=8" class="addthx" data-post="159272"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 16:10 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<b>DillerInc</b><br>хорошо буду молчать как партизан<br><br>неплохо было бы начинать топик с объяснения для чего это нужно, под какой протектор или это<br>плагин к ImpRec&#039;у или попытка написать свой ImpRec<br><br>все, далее не пишу в этом топе, отдыхайте =)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159274&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=9" class="addthx" data-post="159274"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="10" onfocus="this.blur()" href="JavaScript:di('[b]HoBleen[/b]','')">HoBleen</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/5110.jpg" alt=""><br><span class=txtSm>Ранг: 240.5 (наставник)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.09'>Активность: 0.19<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=5110">Участник</a><br><font color=blue>Author of ACKiller </font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 16:12 <br><script type="text/javascript">QU('HoBleen','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=HoBleen" target="_blank">Личное сообщение</a> &middot;  <a href="#10" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#10');return false;">#10</a> </span><div align=left><br>
<b>DillerInc</b><br>1) Не очень понял, что означает <i class=x>/* Последняя попытка найти обращение к возможному адресу IAT в коде программы */</i> ?<br><br>2) Откуда берутся g_dwCodeEnd и g_dwCodeStart? Если значения BaseOfCode и SizeOfCode из NT_HEADERS, то вообще-то они не надёжны...<br><br>3) Твой вариант поиска конца ИАТ можно легко обмануть, подсунув между модулями вместо нулей мусор. Поэтому нужно, например, считать за разделитель Н-ное кол-во мусора (в т.ч. нулей), и если после них ничего дельного нету, то тогда это конец. То же и с началом.<br><br>4) Лучше наверное сделать проверку на принадлежность функции данного модуля более жесткой - считать валидным адрес не просто из границ модуля, а еще и находящегося в таблице экспорта этого модуля.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159275&amp;user=5110&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=10" class="addthx" data-post="159275"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="11" onfocus="this.blur()" href="JavaScript:di('[b]Archer[/b]','')">Archer</a></b><br></div>
<img src="img/s9.gif" alt=""><br><img style="padding-top:3px;" src="av/1556.jpg" alt=""><br><span class=txtSm>Ранг: 2014.5 <b><u>(!!!!)</u></b>, 1278thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 1.34<span style='color:red'>&searr;</span>0.25</span><br>Статус: <a href="action=userinfo&amp;user=1556">Модератор</a><br><font color=blue>retired</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 19:23 <br><script type="text/javascript">QU('Archer','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Archer" target="_blank">Личное сообщение</a> &middot;  <a href="#11" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#11');return false;">#11</a> </span><div align=left><br>
А такое дело: надо найти именно саму ИАТ с границами? Потому что у меня в QuickUnpack при востановлении импорта ищутся переходники, похожие на импорт, и уже разбираются по отдельности. Имхо, для хитрожопых протов это понадёжней будет.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159326&amp;user=1556&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=11" class="addthx" data-post="159326"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="12" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 24 сентября 2007 20:18 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#12" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#12');return false;">#12</a> </span><div align=left><br>
<I>__ пишет:<br>неплохо было бы начинать топик с объяснения для чего это нужно, под какой протектор или это<br>плагин к ImpRec&#039;у или попытка написать свой ImpRec </I><br>...моё приложение(внедрённая библиотека) пытается восстановить импорт в приложении,защищённом StarForce.В принципе переходники,если их так можно назвать в данном случае,восстановлены.Требуется заодно и поправить оригинальную IAT.Проблема в правильном определении её границ. <br><br><I>HoBleen пишет:<br>1) Не очень понял, что означает /* Последняя попытка найти обращение к возможному адресу IAT в коде программы */ ? </I><br>...это когда не удаётся найти вызов импорта с помощью поиска опкодов команд: call [ref], jmp [ref], вызовы через регистры, то тогда я ищу просто VA IAT в коде как сигнатуру.<br><br><I>HoBleen пишет:<br>2) Откуда берутся g_dwCodeEnd и g_dwCodeStart? Если значения BaseOfCode и SizeOfCode из NT_HEADERS, то вообще-то они не надёжны...  </I><br>...именно они.Но как тогда более надёжно определить границы кода??По имени секции ведь не станешь искать...<br><br><I>HoBleen пишет:<br>3) Твой вариант поиска конца ИАТ можно легко обмануть, подсунув между модулями вместо нулей мусор. </I><br>...ну,пока такого изврата я даже у StarForce не видел.<br><br><I>Archer пишет:<br>надо найти именно саму ИАТ с границами? </I><br>...да.Я думаю,лучше сначала найти,где искать.А потом уже обрабатывать,что нашёл.<br><br>В общем,я тут ещё попробую реализовать ту задумку,где используется функция SeekForTrueModuleReference и далее.Может будет толк.Позже отпишусь.
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159355&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=12" class="addthx" data-post="159355"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="13" onfocus="this.blur()" href="JavaScript:di('[b]Faza[/b]','')">Faza</a></b><br></div>
<img src="img/s4.gif" alt=""><br><span class=txtSm>Ранг: 62.3 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 14.89'>Активность: 0.02<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=2450">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2007 06:20 <br><script type="text/javascript">QU('Faza','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Faza" target="_blank">Личное сообщение</a> &middot;  <a href="#13" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#13');return false;">#13</a> </span><div align=left><br>
<I>DillerInc пишет:<br>HoBleen пишет: <br>3) Твой вариант поиска конца ИАТ можно легко обмануть, подсунув между модулями вместо нулей мусор. <br>...ну,пока такого изврата я даже у StarForce не видел. </I><br><br>В следующей версии обязательно увидишь <img src="img/smilies/s1.gif" alt=""> ну а если без приколов,  то тот же стар  может в ИАТ врезать свой вызов вм , и не гаронтированно что там не будет 8 нулей, и еще один вариант стар может сделать так чтоб начало ИАТ лежит в одной секции а ее хвост в другой, я не помню как именно тогда заканчивается  ИАТ, но импереку длину ИАТ приходится вбивать ручками и в дампе править секции. (стар частенько так крутит секциями  рандомайзом, так что учти)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159408&amp;user=2450&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=13" class="addthx" data-post="159408"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="14" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2007 21:27 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#14" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#14');return false;">#14</a> </span><div align=left><br>
<b>Faza</b><br>Блин,таких приколов не хотелось бы...<br>Я смотрел UnpackMe с tuts4you, защищённое актуальным протектором.Так там первая секция называлась .TEXT, и в ней лежала IAT.Далее за ней шла sforce3.<br>Обе секции попадали под диапазон BaseOfCode+SizeofCode.<br>Но там мусора не было между модулями.<br><br>Я тут меж тем написал код,который у меня успешно отработал в двух случаях.Второй случай был замечателен тем,что IAT находилась в той же секции,что и код(sforce3), и между кодом и началом IAT не было ни одного нулевого байтика.Единственное,что указывало,что по такому-то адресу начинаются данные,было поле BaseOfData.<br><br>Код следующий:<br><br><code><br>; ########################################### ProcessIAT #########################################<br>ProcessIAT proc USES ebx ecx edx esi dwApproxOEP:DWORD<br><br> local fResult:BOOL<br><br> local dwTempProtect:DWORD<br><br> local pImageBase:PVOID<br> local pImageEdge:PVOID<br><br> local dwInitialIATAddress:DWORD<br> <br> local pIATStart:PVOID<br> local pIATEnd:PVOID<br> local dwIATSize:DWORD<br><br>      and    fResult, 0<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Устанавливаем SEH, перекрывающий всю функцию */<br>      assume fs:nothing<br><br>      push   offset ExceptionHandlerOuter<br>      push   fs:[0]<br>      mov    fs:[0], esp<br><br>      assume fs:error<br><br>      mov    g_seh_Outer.SafeEip, offset SafePlace_Outer<br>      mov    g_seh_Outer.PrevEsp, esp<br>      mov    g_seh_Outer.PrevEbp, ebp<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br><br>      push   NULL<br>      call   GetModuleHandleA<br>      mov    pImageBase, eax<br><br>      mov    ebx, eax<br>      add    ebx, dword ptr [ebx + IMAGE_DOS_HEADER.e_lfanew]<br>      mov    ebx, dword ptr [ebx + IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage]<br>      add    ebx, eax<br>      mov    pImageEdge, ebx<br><br>; /*<br>;  * Поиск границ IAT<br>;  */<br><br>; /* Нахождение адреса IAT, через который вызывалась функция GetModuleHandleA */ <br>      mov    eax, dwApproxOEP<br><br>@@seek_call_method:      <br>      dec    eax<br> <br>      cmp    word ptr [eax], 15FFh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 25FFh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 1D8Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 358Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 3D8Bh<br>      jz     @@call_method_found<br><br>      cmp    word ptr [eax], 2D8Bh<br>      jz     @@call_method_found<br><br>      jmp    @@seek_call_method<br><br>@@call_method_found:<br><br>; /* В EDX кладём адрес VA, по которому располагается одна из ячеек IAT */<br>      mov    edx, dword ptr [eax+02] <br>      mov    dwInitialIATAddress, edx<br><br>; /* Пытаемся определить начало IAT */<br><br>@@define_IAT_start:<br><br>; /* ECX используется как счётчик нулевых DWORD&#039;ов */<br>      xor    ecx, ecx<br><br>@@loop_towards_start:<br>      cmp    ecx, 02<br>      jz     @@IAT_start_reached<br><br>      sub    edx, sizeof DWORD<br><br>      inc    ecx<br>      <br>      cmp    dword ptr [edx], 0<br>      jz     @@loop_towards_start<br><br>; /*<br>;  * Первый этап проверки */<br>;  */<br>      mov    eax, dword ptr [edx]<br><br>; /* Принадлежит ли адрес, одной из загруженных библиотек?? */ <br>      push   eax<br>      call   SearchForTrueModuleReference<br>      test   eax, eax<br>      jnz    @@define_IAT_start<br><br>; /*<br>;  * Второй этап проверки */<br>;  */<br>      mov    eax, dword ptr [edx]<br><br>      add    eax, pImageBase<br>    <br>; /* Лежит ли адрес в пределах исследуемого модуля?? */<br>      cmp    eax, pImageBase<br>      jl     @f<br><br>      cmp    eax, pImageEdge<br>      ja     @f<br><br>; /* Если да, то это скорее всего какой-нибудь RVA, указывающий на название библиотеки, функции и т.д. */ <br>      jmp    @@IAT_start_reached<br><br>; /*<br>;  * Третий этап проверки */<br>;  */   <br><br>@@:   <br>      mov    eax, dword ptr [edx]<br><br>; /* Имеем ли мы права на чтение по текущему адресу */<br>      and    g_fIsBadPointer, 0<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Устанавливаем SEH, который защищает команду MOV */<br>      assume fs:nothing<br><br>      push   offset ExceptionHandlerInner<br>      push   fs:[0]<br>      mov    fs:[0], esp<br><br>      assume fs:error<br><br>      mov    g_seh_Inner.SafeEip, offset SafePlace_Inner_Start<br>      mov    g_seh_Inner.PrevEsp, esp<br>      mov    g_seh_Inner.PrevEbp, ebp<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::       <br><br>      mov    eax, dword ptr [eax]<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Место, с которого должно безопасно продолжиться выполнение после возможной ошибки */<br>SafePlace_Inner_Start:<br>   <br>      assume fs:nothing<br><br>      pop    fs:[0]<br>      add    esp, sizeof DWORD<br><br>      assume fs:error<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>      <br>; /* Если мы имеем права на чтение, то это скорее всего переходник протектора */<br>      cmp    g_fIsBadPointer, 01<br>      jnz    @@define_IAT_start<br>      <br>@@IAT_start_reached:<br>; /* Добавляем необходимое кол-во байт к EDX, чтобы установить его точно в начало IAT */<br>      shl    ecx, 2<br>      add    edx, ecx<br><br>      mov    pIATStart, edx<br><br>; /* Пытаемся определить конец IAT */<br><br>      mov    edx, dwInitialIATAddress<br><br>@@define_IAT_end:<br><br>; /* ECX используется как счётчик нулевых DWORD&#039;ов */<br>      xor    ecx, ecx<br><br>@@loop_towards_end:   <br>      cmp    ecx, 02<br>      jz     @@IAT_end_reached<br><br>      add    edx, sizeof DWORD<br><br>      inc    ecx<br>      <br>      cmp    dword ptr [edx], 0<br>      jz     @@loop_towards_end<br>     <br>; /*<br>;  * Первый этап проверки */<br>;  */<br>      mov    eax, dword ptr [edx]<br><br>; /* Принадлежит ли адрес, одной из загруженных библиотек?? */<br>      push   eax<br>      call   SearchForTrueModuleReference<br>      test   eax, eax<br>      jnz    @@define_IAT_end<br><br>; /*<br>;  * Второй этап проверки */<br>;  */<br>      mov    eax, dword ptr [edx]<br><br>      add    eax, pImageBase<br>    <br>; /* Лежит ли адрес в пределах исследуемого модуля?? */<br>      cmp    eax, pImageBase<br>      jl     @f<br><br>      cmp    eax, pImageEdge<br>      ja     @f<br><br>; /* Если да, то это скорее всего какой-нибудь RVA, указывающий на название библиотеки, функции и т.д. */<br>      jmp    @@IAT_end_reached<br><br>; /*<br>;  * Третий этап проверки */<br>;  */      <br><br>@@:<br>      mov    eax, dword ptr [edx]<br><br>; /* Имеем ли мы права на чтение по текущему адресу */<br>      and    g_fIsBadPointer, 0<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Устанавливаем SEH, который защищает команду MOV */<br>      assume fs:nothing<br><br>      push   offset ExceptionHandlerInner<br>      push   fs:[0]<br>      mov    fs:[0], esp<br><br>      assume fs:error<br><br>      mov    g_seh_Inner.SafeEip, offset SafePlace_Inner_End<br>      mov    g_seh_Inner.PrevEsp, esp<br>      mov    g_seh_Inner.PrevEbp, ebp<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::       <br><br>      mov    eax, dword ptr [eax]<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Место, с которого должно безопасно продолжиться выполнение после возможной ошибки */<br>SafePlace_Inner_End:<br>   <br>      assume fs:nothing<br><br>      pop    fs:[0]<br>      add    esp, sizeof DWORD<br><br>      assume fs:error<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>      <br>      cmp    g_fIsBadPointer, 01<br>      jnz    @@define_IAT_end<br>      <br>@@IAT_end_reached:<br>      mov    pIATEnd, edx<br>      sub    edx, pIATStart<br><br>      mov    dwIATSize, edx <br><br>      or     fResult, 01<br><br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br>; /* Место, с которого должно безопасно продолжиться выполнение после возможной ошибки */<br>SafePlace_Outer:<br>   <br>      assume fs:nothing<br><br>      pop    fs:[0]<br>      add    esp, sizeof DWORD<br><br>      assume fs:error<br>; :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::::::::::::::::::::::::::<br><br>@@ret:<br>      mov    eax, fResult<br>      ret<br><br>ProcessIAT endp </code>
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159573&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=14" class="addthx" data-post="159573"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="15" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2007 21:33 &middot; Поправил: DillerInc <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#15" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#15');return false;">#15</a> </span><div align=left><br>
Во,надо добавить следующее:<br><br><code><br> SEH STRUCT<br>      SafeEip    dd    ?    ; Точка, откуда будет продолжено выполнение программы<br>      PrevEsp    dd    ?    ; Предыдущее значение ESP<br>      PrevEbp    dd    ?    ; Предыдущее значение EBP<br> SEH ENDS<br><br>.data?<br><br> g_seh_Inner                       SEH          &lt;&gt;<br> g_seh_Outer                       SEH          &lt;&gt;<br><br>.code<br><br>; #################################### ExceptionHandlerInner #####################################<br>ExceptionHandlerInner proc C USES esi pExcept:DWORD, pFrame:DWORD, pContext:DWORD, pDispatch:DWORD<br><br>; /* Правим контекст, в котором произошло исключение */<br>      push   dword ptr g_seh_Inner.SafeEip<br>      push   dword ptr g_seh_Inner.PrevEsp<br>      push   dword ptr g_seh_Inner.PrevEbp<br><br>      mov    eax, pContext<br><br>      pop    dword ptr [eax+CONTEXT.regEbp]<br>      pop    dword ptr [eax+CONTEXT.regEsp]<br>      pop    dword ptr [eax+CONTEXT.regEip]<br><br>; /* Устанавливаем флаг, сигнализирующий, что произошло исключение из-за ошибки доступа */<br>      or     g_fIsBadPointer, 01<br><br>; /* Возвращаем значение ExceptionContinueExecution (0) */<br>      xor    eax, eax<br>      ret<br><br>ExceptionHandlerInner endp<br><br>; #################################### ExceptionHandlerOuter #####################################<br>ExceptionHandlerOuter proc C USES esi pExcept:DWORD, pFrame:DWORD, pContext:DWORD, pDispatch:DWORD<br><br>; /* Правим контекст, в котором произошло исключение */<br>      push   dword ptr g_seh_Outer.SafeEip<br>      push   dword ptr g_seh_Outer.PrevEsp<br>      push   dword ptr g_seh_Outer.PrevEbp<br><br>      mov    eax, pContext<br><br>      pop    dword ptr [eax+CONTEXT.regEbp]<br>      pop    dword ptr [eax+CONTEXT.regEsp]<br>      pop    dword ptr [eax+CONTEXT.regEip]<br><br>; /* Возвращаем значение ExceptionContinueExecution (0) */<br>      xor    eax, eax<br>      ret<br><br>ExceptionHandlerOuter endp </code>
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159575&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=15" class="addthx" data-post="159575"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="16" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 25 сентября 2007 23:14 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#16" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#16');return false;">#16</a> </span><div align=left><br>
не могу пройти мимо %)<br><br>функция SE Handler должна быть cdecl
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159594&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=16" class="addthx" data-post="159594"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="17" onfocus="this.blur()" href="JavaScript:di('[b]DillerInc[/b]','')">DillerInc</a></b><br></div>
<img src="img/s6.gif" alt=""><br><img style="padding-top:3px;" src="av/1613.gif" alt=""><br><span class=txtSm>Ранг: 283.6 (наставник), 56thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.25'>Активность: 0.13<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1613">Участник</a><br><font color=blue>Author of GeTaOEP</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2007 08:56 <br><script type="text/javascript">QU('DillerInc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=DillerInc" target="_blank">Личное сообщение</a> &middot;  <a href="#17" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#17');return false;">#17</a> </span><div align=left><br>
<I>__ пишет:<br>функция SE Handler должна быть cdecl </I><br>...ладно,ладно <img src="img/smilies/s1.gif" alt=""><br>Хотя и без того всё работает.Система-то,которая будет вызывать наш обработчик,наверно уж знает,где и что она должна за собой подчистить.
<br><br><font size="1"><i>-----<br>the Power of Reversing team</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=159644&amp;user=1613&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=17" class="addthx" data-post="159644"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="18" onfocus="this.blur()" href="JavaScript:di('[b]__[/b]','')">__</a></b><br></div>
<img src="img/s5.gif" alt=""><br><span class=txtSm>Ранг: 115.1 (ветеран), 3thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.73'>Активность: 0.07<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=7172">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2007 12:34 <br><script type="text/javascript">QU('__','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=__" target="_blank">Личное сообщение</a> &middot;  <a href="#18" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#18');return false;">#18</a> </span><div align=left><br>
в win9x не будет работать, в 2k/XP есть защита &quot;от дурака&quot; поэтому работает
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159662&amp;user=7172&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=18" class="addthx" data-post="159662"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="19" onfocus="this.blur()" href="JavaScript:di('[b]Bit-hack[/b]','')">Bit-hack</a></b><br></div>
<img src="img/s7.gif" alt=""><br><img style="padding-top:3px;" src="av/198.jpg" alt=""><br><span class=txtSm>Ранг: 303.7 (мудрец), 4thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.9'>Активность: 0.19<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=198">Участник</a><br><font color=blue>tPORt Manager</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 26 сентября 2007 17:47 <br><script type="text/javascript">QU('Bit-hack','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Bit-hack" target="_blank">Личное сообщение</a> &middot;  <a href="#19" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=10009.html&amp;page=0#19');return false;">#19</a> </span><div align=left><br>
<b>DillerInc</b><br>Диллер, ты псих. У старовцев есть чел, который шутшит все форумы реверсерские и докладывает разработчикам если что, если что, то защищает стар, лучше иди в приват.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=159722&amp;user=198&amp;forum_n=6&amp;topic=10009.html&amp;page=0&amp;anchor=19" class="addthx" data-post="159722"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Программное нахождение IAT</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#20" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="10009">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=10009" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
