<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>Перехват CreateProcess и внедрение с установкой перехватов - eXeL@B</title>
<meta NAME="DESCRIPTION" CONTENT="Реализовывал ли кто-нибудь? может сразу дадите наставления по поводу... Интересует вариант в юзермод. Перехват ZwCreateUserProcess, ZwCreateProcess, ZwCreateProcessEx сами по себе результата не дают (нормального). Вариант ждать">
<meta NAME="KEYWORDS" CONTENT="x64_dbg windbg ollydbg ida скачать взлом отладчик ассемблер дизассемблер крэкер cracker реверсер keygen кейген кодер патч патчер крэкми лоадер брутфорсер протектор распаковщик пароль ключ ключфайл шпион oep key защита программа winapi faq hiew windasm softice winhex">
<META NAME="Document-state" CONTENT="Dynamic">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
<link rel="SHORTCUT ICON" href="/favicon.ico">
<meta name="viewport" content="width=device-width">
<link href="./skin/s0.css" type="text/css" rel="STYLESHEET">
<link href="./skin/code.css" type="text/css" rel="STYLESHEET">
<script type="text/javascript" src="./js/jq.js"></script>
<link rel="alternate" type="application/rss+xml" title="eXeL@B" href="./rss.php">
<style type="text/css">.username div .dops{display:none;}</style>
<link href="../menu.css" type="text/css" rel="stylesheet">
</head>

<body>
<a id="to_top"></a>
<div id="wrapper">
 
<div class="mob-hamburger"><span></span></div>
 
</center></div><script type='text/javascript'>
function lst(){var i=0;var htm='';var a='';var timer=setInterval(function(){if(i<10){i=i+10;}else{clearInterval(timer);i=0;}document.getElementById('kurs_container').style.marginLeft='-'+i+'px';},100);}
document.addEventListener('DOMContentLoaded',function(event){setTimeout(lst,1500);setInterval(lst,10000);});
</script></div></div>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery(".mob-hamburger").on("click", function() {
        jQuery(".mob-hamburger").toggleClass("active");
        jQuery("#site-navigation").slideToggle();
		if (jQuery('.mob-hamburger').hasClass('active')) {
			var i = jQuery('#site-navigation').offset().top;
		} else { 
			var i = 0;
		}
			
		jQuery("html, body").animate({ scrollTop: i }, 600);
    });
	var btn = jQuery('#to_top');
	jQuery(window).scroll(function() {
		if (jQuery(window).scrollTop() > 300) {
			btn.addClass('show');
		} else {
			btn.removeClass('show');
		}
	});
	btn.on('click', function(e) {
		e.preventDefault();
		jQuery('html, body').animate({scrollTop:0}, '300');
	});
});
</script>
 
<div id="content">
<div align=center style="margin-top:15px">

<table class=tbTransparent>
<tr><td class=tbTransparent>
<span class=txtSm>Сейчас на форуме: <b><a target='_blank' href='?action=userinfo&amp;user=55995'>tyns777</a>, <a target='_blank' href='?action=userinfo&amp;user=31361'>zds</a>, <a target='_blank' href='?action=userinfo&amp;user=55802'>JustLife</a>, <a target='_blank' href='?action=userinfo&amp;user=2094'>2nd</a>, <a target='_blank' href='?action=userinfo&amp;user=33192'>morgot</a>, <a target='_blank' href='?action=userinfo&amp;user=8605'>Rio</a> (+5 невидимых)</b></span>
</td>
</tr>
</table>

<table class=forums>
 
</tr></table>

</div><br>
<script language="javascript" type="text/javascript" charset="windows-1251" src="templates/base.js"></script>

<div align=center><table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Перехват CreateProcess и внедрение с установкой перехватов</span></td>
</tr></table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width="15%" class=caption4><span class=txtSm><b>Посл.ответ</b></span></td>
<td width="85%" class=caption4><span class=txtSm><b>Сообщение</b></span></td></tr>
<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="1" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 03:46 &middot; Поправил: multiarc <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#1" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#1');return false;">#1</a> </span><div align=left><br>
Реализовывал ли кто-нибудь? может сразу дадите наставления по поводу... Интересует вариант в юзермод. Перехват ZwCreateUserProcess, ZwCreateProcess, ZwCreateProcessEx сами по себе результата не дают (нормального). Вариант ждать до самого вызова ZwResumeThread и прямо перед его вызовом делать внедрение. Но нет уверенности что именно тот ZwResumeThread который нам надо будет перехвачен, например из другого потока, при одновременном создании например 2 процессов из 2 разных потоков, или создание процесса в одном, а Resume в другом, или же вообще перехват ручного создания процесса... Подскажите если кто копал как быть, что перехватывать, что учитывать, чтобы сделать внедрение в новый только что созданные процесс. Интересует реализация в 2k8 (используется в основном ZwCreateUserProcess), XP (ZwCreateProcessEx), 2k3 (ZwCreateProcessEx), 2k0 (ZwCreateProcess).<br>Видел где-то статью по поводу, но очень давно, если кто знает дайте ссылку)
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236662&amp;user=12469&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=1" class="addthx" data-post="236662"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr><td class=caption4 colspan=2></td></tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="2" onfocus="this.blur()" href="JavaScript:di('[b]Hexxx[/b]','')">Hexxx</a></b><br></div>
<img src="img/s7.gif" alt=""><br><span class=txtSm>Ранг: 481.4 (мудрец), 109thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 13.37'>Активность: 0.18<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=10168">Участник</a><br><font color=blue>Тот самый :)</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 09:56 <br><script type="text/javascript">QU('Hexxx','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Hexxx" target="_blank">Личное сообщение</a> &middot;  <a href="#2" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#2');return false;">#2</a> </span><div align=left><br>
PsSetCreateProcessNotifyRoutine нет?
<br><br><font size="1"><i>-----<br>Реверсивная инженерия - написание кода идентичного натуральному</i></font><br><br><span class="txtGoods"><a href="action=addthx&amp;post=236675&amp;user=10168&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=2" class="addthx" data-post="236675"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="3" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 11:03 <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#3" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#3');return false;">#3</a> </span><div align=left><br>
Нужен юзермод и внедрение после инициализации всех библиотек, т.е. перед самым вызовом ZwResumeThread
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236679&amp;user=12469&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=3" class="addthx" data-post="236679"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="4" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 12:36 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#4" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#4');return false;">#4</a> </span><div align=left><br>
Контекст получаем, регистр <b>Eip</b> содержит указатель на <b>BaseProcessStartThunk()</b>, она передаёт управление на пользовательский код, указатель на который в регистре <b>Eax</b>.<br>Вот один из указателей заменяем на свой, загружаем свой модуль и возвращаем управление обратно.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236690&amp;user=17964&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=4" class="addthx" data-post="236690"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="5" onfocus="this.blur()" href="JavaScript:di('[b]Nowar[/b]','')">Nowar</a></b><br></div>
<img src="img/s2.gif" alt=""><br><span class=txtSm>Ранг: 13.7 (новичок)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 15.27'>Активность: 0.01<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=1543">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 17:34 <br><script type="text/javascript">QU('Nowar','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Nowar" target="_blank">Личное сообщение</a> &middot;  <a href="#5" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#5');return false;">#5</a> </span><div align=left><br>
Есть подозрение, что проблемы возникают с загрузкой библиотек. Т.е., скажем, вешаемся на LoadLibrary.<br>Но, если на процедуре инициализации (DllMain или как оно там) куда-то сохраняются адреса автоматически импортируемых функций, то дальше возникнут ошибки, если мы в импорте подменим эти функции. В LoadLibrary система подгружает библиотеку, заполняет таблицу импорта и сразу выполняет код инициализации.<br>Если внимательно покопаться в исходниках (windows 2000), можно обнаружить, что в конечном итоге вызывается функция LdrLoadDll из ntdll.dll<br>Да простит меня Майкрософт:<br><i class=x>NTSTATUS<br>LdrLoadDll (<br>    IN PWSTR DllPath OPTIONAL,<br>    IN PULONG DllCharacteristics OPTIONAL,<br>    IN PUNICODE_STRING DllName,<br>    OUT PVOID *DllHandle<br>    )<br><br>/*++<br><br>Routine Description:<br><br>    This function loads a DLL into the calling process address space.<br><br>Arguments:<br><br>    DllPath - Supplies the search path to be used to locate the DLL.<br><br>    DllCharacteristics - Supplies an optional DLL characteristics flag,<br>        that if specified is used to match against the dll being loaded.<br><br>    DllName - Supplies the name of the DLL to load.<br><br>    DllHandle - Returns a handle to the loaded DLL.<br><br>Return Value:<br><br>    TBD<br><br>--*/<br>{<br>    return LdrpLoadDll(DllPath,DllCharacteristics,DllName,DllHandle,TRUE);<br>}<br></i><br>Видно, что вызывается некоторая (внутренняя, неэкспортируемая) функция LdrpLoadDll, имеющая заголовок:<br><br>NTSTATUS<br>NTAPI<br>LdrpLoadDll(<br>    IN PWSTR DllPath OPTIONAL,<br>    IN PULONG DllCharacteristics OPTIONAL,<br>    IN PUNICODE_STRING DllName,<br>    OUT PVOID *DllHandle,<br>    IN BOOLEAN RunInitRoutines<br>    )<br><br>Последний параметр - выполнять ли процедуру инициализации после  загрузки.<br>В вызываемой функции LdrpLoadDll нужно найти место, где этот параметр проверяется, туда и внедряться. Это будет происходить после загрузки Dll, когда уже можно править адреса импортируемых функций  для перехвата, но до того, как будет вызвана процедура, которая иначе сработала бы с неправленными адресами.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236729&amp;user=1543&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=5" class="addthx" data-post="236729"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="6" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 27 июля 2009 21:56 <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#6" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#6');return false;">#6</a> </span><div align=left><br>
<b>Nowar</b><br>&gt; В вызываемой функции LdrpLoadDll нужно найти место, где этот параметр проверяется, туда и внедряться.<br>Таких мест два(без учёта вызова тлс) - <b>LdrpCallInitRoutine()</b>, или выполняющая нотификацию модулей <b>LdrpRunInitializeRoutines()</b>. Только вот попадёте вы на дедлок, когда тред будет ждать сам себя, критические секции никто не отменял.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236766&amp;user=17964&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=6" class="addthx" data-post="236766"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="7" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 28 июля 2009 14:17 <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#7" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#7');return false;">#7</a> </span><div align=left><br>
<I>Clerk пишет:<br>Контекст получаем, регистр Eip содержит указатель на BaseProcessStartThunk(), она передаёт управление на пользовательский код, указатель на который в регистре Eax.Вот один из указателей заменяем на свой, загружаем свой модуль и возвращаем управление обратно. </I><br>будет не мало танцев с бубном, ибо надо ждать загрузки, передавать управление обратно, менять контекст опять и запускать на выполнение вновь, лучше всего всё таки использовать APC для нотификации готовности процесса к внедрению. И ещё вопрос, если сразу кто знает, лень ковыряться в документации : если процессоров больше, чем 1, то APC будет выполняться вместе с потоком или всё таки поток подождёт выполнения APC и потом выполниться сам? По логике вещей он должен ждать выполнения APC. ??
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236804&amp;user=12469&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=7" class="addthx" data-post="236804"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel2>
<td width="17%" class=caption1>
<div class=username><div><b><a name="8" onfocus="this.blur()" href="JavaScript:di('[b]Clerk[/b]','')">Clerk</a></b><br></div>
<img src="img/s6.gif" alt=""><br><span class=txtSm>Ранг: 255.8 (наставник), 19thx<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 11.86'>Активность: 0.15<span style='color:red'>&searr;</span>0.01</span><br>Статус: <a href="action=userinfo&amp;user=17964">Участник</a><br><font color=blue>vx</font></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 28 июля 2009 21:24 &middot; Поправил: Clerk <br><script type="text/javascript">QU('Clerk','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=Clerk" target="_blank">Личное сообщение</a> &middot;  <a href="#8" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#8');return false;">#8</a> </span><div align=left><br>
&gt; будет не мало танцев с бубном<br>Не вижу никаких проблем. Получаем контекст, записываем в Eax указатель на обработчик, оригинальный сохраняем например в Ebx, сохраняем контекст и всё.<br>&gt; если процессоров больше, чем 1, то APC будет выполняться вместе с потоком или всё таки поток подождёт выполнения APC и потом выполниться сам?<br>&gt; По логике вещей он должен ждать выполнения APC. ??<br>Поток не должен знать ничего о числе процессоров.<br>Поток выполняет выполняет доставленную апк, комуже есчо её выполнять <img src="img/smilies/s11.gif" alt="">
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236825&amp;user=17964&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=8" class="addthx" data-post="236825"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>

<tr valign=top class=tbCel1>
<td width="17%" class=caption1>
<div class=username><div><b><a name="9" onfocus="this.blur()" href="JavaScript:di('[b]multiarc[/b]','')">multiarc</a></b><br></div>
<img src="img/s4.gif" alt=""><br><img style="padding-top:3px;" src="av/12469.jpg" alt=""><br><span class=txtSm>Ранг: 58.1 (постоянный)<br><span title='Сообщений в день (с регистрации) / За последний год / Лет с регистрации: 12.98'>Активность: 0.03<span style='color:red'>&searr;</span>0</span><br>Статус: <a href="action=userinfo&amp;user=12469">Участник</a></span></div>
<br>
</td>
<td width="83%" class="caption1 post"><span class=txtSm>Создано: 28 июля 2009 22:00 &middot; Поправил: multiarc <br><script type="text/javascript">QU('multiarc','Цитата','пишет');</script> &middot; <a href="?step=sendmsg&amp;action=pmail&amp;userto=multiarc" target="_blank">Личное сообщение</a> &middot;  <a href="#9" onClick="prompt('Ссылка на сообщение', 'https://exelab.ru/f/action=vthread&amp;forum=6&amp;topic=14791.html&amp;page=0#9');return false;">#9</a> </span><div align=left><br>
<I>Clerk пишет:<br>Не вижу никаких проблем. Получаем контекст, записываем в Eax указатель на обработчик, оригинальный сохраняем например в Ebx, сохраняем контекст и всё. </I><br>Я о том, что проще будет хукать ZwResumeThread, проверять тот ли поток, который нам надо, перед её выполнением делать внедрение, затем позволить выполниться ZwResumeThread. что-то вроде того :<br>
<div class="hl_container">
<div class="hl_header">Code:</div>
<div class="hl_scroll_part_large">
    <div class="hl_normal"> 
        <ol class="hl_main"><li class="hl_l0">typedef&nbsp;struct{</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Length<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown1<span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown2<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PWSTR&nbsp;pwsImageFileName<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown4<span class="hl_comment">;</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown5<span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown6<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;PCLIENT_ID&nbsp;pcidClient<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown8<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown9<span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown10<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown11<span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown12<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown13<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown14<span class="hl_comment">; </span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown15<span class="hl_comment">; </span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Unknown16<span class="hl_comment">;</span></li><li class="hl_l0">}PROCESS_UNKNOWN<span class="hl_char">,</span>&nbsp;<span class="hl_char">*</span>PPROCESS_UNKNOWN<span class="hl_comment">;</span></li><li class="hl_l1">&nbsp;</li><li class="hl_l0">CallBackHook_ZwCreateUserProcess<span class="hl_char">(</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PHANDLE&nbsp;ProcessHandle<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter1<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter2<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter3<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;ProcessSecurityDescriptor<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;ThreadSecurityDescriptor<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter6<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter7<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRTL_USER_PROCESS_PARAMETERS&nbsp;ProcessParameters<span class="hl_char">,</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Parameter9<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PPROCESS_UNKNOWN&nbsp;ppuUnknown</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>ZwCreateUserProcess&nbsp;сама&nbsp;создаёт&nbsp;ещё&nbsp;и&nbsp;поток<span class="hl_char">.</span>&nbsp;Тут&nbsp;сохраняем&nbsp;CLIENT_ID&nbsp;ентого&nbsp;процесса</li><li class="hl_l1">}</li><li class="hl_l0">&nbsp;</li><li class="hl_l1">Hook_ZwResumeThread<span class="hl_char">(</span></li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;ThreadHandle<span class="hl_char">,</span></li><li class="hl_l1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PULONG&nbsp;&nbsp;SuspendCount</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl_char">)</span></li><li class="hl_l1">{</li><li class="hl_l0">&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>получаем&nbsp;TID<span class="hl_char">,</span>&nbsp;смотрим&nbsp;в&nbsp;списке<span class="hl_char">,</span>&nbsp;если&nbsp;таковой&nbsp;имеется<span class="hl_char">,</span>&nbsp;</li><li class="hl_l1">&nbsp;&nbsp;&nbsp;<span class="hl_char">/</span><span class="hl_char">/</span>внедряемся<span class="hl_char">,</span><span style="word-break: break-all">&nbsp;удаляем&nbsp;CLIENT_ID&nbsp;из&nbsp;списка&nbsp;и&nbsp;позволяем&nbsp;затем&nbsp;выполниться&nbsp;настоящей&nbsp;ZwResumeThread</span></li><li class="hl_l0">}</li>        </ol>
    </div>
</div></div>
<br>Вот что я имел ввиду про отсутсвие танцев с бубном... по-моему это немного проще, да и мало ли кому вздумается чего сделать с контекстом потока до того как он начал выполняться но после того как мы его например изменим похучив ZwCreateUserProcess.
<br><br><span class="txtGoods"><a href="action=addthx&amp;post=236828&amp;user=12469&amp;forum_n=6&amp;topic=14791.html&amp;page=0&amp;anchor=9" class="addthx" data-post="236828"><img src="img/tu.png" border=0 title="Полезное сообщение"></a><span class="have_thx" style="display:none"> | Сообщение посчитали полезным: <span class="total_thx"></span></span></span><br></div></td>
</tr>


</table>
<table class=tbTransparent><tr><td class=tbTransparent><span class=txtSm><b></b></span></td></tr></table>
<table class=forums><tr>
<td width=16 valign=top class=caption3><img src="./img/forum_icons/p.gif" width=16 height=16 alt=""></td>
<td width="100%" class=caption3><span class=header>&nbsp;<a href="../index.html"><b>eXeL@B</b></a> <b class=bulletHead>&#8212;&#8250;</b> <a href="action=vtopic&amp;forum=6&sortBy=0&page=0.html"><b>Программирование</b></a> <b class=bulletHead>&#8212;&#8250;</b> Перехват CreateProcess и внедрение с установкой перехватов</span></td>
</tr></table>
</div>
<a name=newreply></a>
<script type="text/javascript">
function check_form(f)
{
  f.elements['b1'].value = 'Отправка...';
  f.elements['b1'].disabled = true;
  return true;
}
</script>

<div align="center">
<form name="postMsg" action="#10" method="post" class="formStyle" enctype="multipart/form-data" onsubmit="return check_form(this);" onkeydown="ctrle(event, this)">
<table class="forums">

<tr>
<td class="caption2">
<span class="txtSm"><b>:: Ваш ответ</b></span>
</td>
</tr>
<tr>
<td class="caption7">

<img class="toolButton" src="./img/button_bold.gif" width="23" height="22" border="0" title="Жирный" alt="Жирный" onmouseover="window.status='Жирный'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[b]','[/b]');">&nbsp;
<img class="toolButton" src="./img/button_italic.gif" width="23" height="22" border="0" title="Курсив" alt="Курсив" onmouseover="window.status='Курсив'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[t]','[/t]');">&nbsp;
<img class="toolButton" src="./img/button_underlined.gif" width="23" height="22" border="0" title="Подчеркнутый" alt="Подчеркнутый" onmouseover="window.status='Подчеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[u]','[/u]');">&nbsp;
<img class="toolButton" src="./img/button_strike.gif" width="23" height="22" border="0" title="Перечеркнутый" alt="Перечеркнутый" onmouseover="window.status='Перечеркнутый'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[s]','[/s]');">&nbsp;
<img class="toolButton" src="./img/button_code.gif" width="23" height="22" border="0" title="Код" alt="{mpf5}" onmouseover="window.status='Код'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[ASM]','[/ASM]');">&nbsp;
<img class="toolButton" src="./img/button_image.gif" width="23" height="22" border="0" title="Ссылка на картинку" alt="Код" onmouseover="window.status='Ссылка на картинку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[img]','[/img]');">&nbsp;
<img class="toolButton" src="./img/button_url.gif" width="23" height="22" border="0" title="Вставить ссылку" alt="Вставить ссылку" onmouseover="window.status='Вставить ссылку'; return true" onmouseout="window.status=''; return true" onclick="JavaScript:di('[url=',']--&gt; Link &lt;--[/url]');">&nbsp;

<!-- mod by arnix start 
<select style="position: relative; top: -7; width: 150px;" id="addHighlightedCode" onchange="insertHl(this);">
<option value="0">Подсветка кода...</option>
<option value="asm">Assembler</option>
<option value="c">C</option>
<option value="cpp">C++</option>
<option value="pascal">Pascal</option>
<option value="delphi">Delphi</option>
<option value="php">PHP</option>
<option value="vb">Visual Basic</option>
</select>&nbsp;
 mod by arnix end -->

<br>
<a href="JavaScript:di(':s1:','');"><img src="./img/smilies/s1.gif" border="0" alt=":s1:"></a>
<a href="JavaScript:di(':s2:','');"><img src="./img/smilies/s2.gif" border="0" alt=":s2:"></a>
<a href="JavaScript:di(':s3:','');"><img src="./img/smilies/s3.gif" border="0" alt=":s3:"></a>
<a href="JavaScript:di(':s4:','');"><img src="./img/smilies/s4.gif" border="0" alt=":s4:"></a>
<a href="JavaScript:di(':s5:','');"><img src="./img/smilies/s5.gif" border="0" alt=":s5:"></a>
<a href="JavaScript:di(':s6:','');"><img src="./img/smilies/s6.gif" border="0" alt=":s6:"></a>
<a href="JavaScript:di(':s7:','');"><img src="./img/smilies/s7.gif" border="0" alt=":s7:"></a>
<a href="JavaScript:di(':s8:','');"><img src="./img/smilies/s8.gif" border="0" alt=":s8:"></a>
<a href="JavaScript:di(':s9:','');"><img src="./img/smilies/s9.gif" border="0" alt=":s9:"></a>
<a href="JavaScript:di(':s10:','');"><img src="./img/smilies/s10.gif" border="0" alt=":s10:"></a>
<a href="JavaScript:di(':s11:','');"><img src="./img/smilies/s11.gif" border="0" alt=":s11:"></a>
<a href="JavaScript:di(':s12:','');"><img src="./img/smilies/s12.gif" border="0" alt=":s12:"></a>
<a href="JavaScript:di(':s13:','');"><img src="./img/smilies/s13.gif" border="0" alt=":s13:"></a>
<a href="JavaScript:di(':s14:','');"><img src="./img/smilies/s14.gif" border="0" alt=":s14:"></a>
<a href="JavaScript:di(':s15:','');"><img src="./img/smilies/s15.gif" border="0" alt=":s15:"></a>
<a href="JavaScript:di(':s16:','');"><img src="./img/smilies/s16.gif" border="0" alt=":s16:"></a>
</td></tr>
<tr>
<td class="caption5"><textarea name="postText" rows="10" class="textForm" tabindex="2" style="width:100%"></textarea>
<BR><INPUT class="textForm" type="file" name="fileAttach"><BR><SMALL>Максимальный размер аттача: <b>500KB</b>.</SMALL>
<br><span class="txtSm"> </span>
</td>
</tr>
<tr>
<td class="caption7">
<table class=tbTransparent>
<tr valign=middle>
<td class=tbTransparent><span class=txtSm>Ваш логин: <b><a href="https://exelab.ru/f/action=userinfo&amp;user=55973">german1505</a></b>  &raquo; <a href="mode=logout">Выход</a> &raquo; <a href="?action=pmail"><b>ЛС</b></a></span></td>
</tr>
</table>

</td>
</tr>


<tr>
<td class="caption5"><input type="submit" value="Отправить сообщение" class="inputButton" name="b1" tabindex="5"></td>
</tr>
</table>
<input type="hidden" name="action" value="pthread">
<input type="hidden" name="forum" value="6">
<input type="hidden" name="topic" value="14791">
</form>
</div>
<script type="text/javascript" src="templates/vthread_logged.js"></script>
<div align=center><table class=tbTransparent><tr>
<td class=tbTransparent><span class=txtSm>      &nbsp;&nbsp;&nbsp;<a href="/f/forprint.php?topic_id=14791" title="Версия для печати"><img src="img/forprint.gif" border="0" alt="Для печати"> Для печати</a>&nbsp;</span></td>
</tr></table></div>
<br>
 
<br><br><br></center>

</div>
<div id="footer">Вы находитесь на EXELAB.rU</div>
<div id="footer_btns">
<a href="http://www.reactos.org" rel="nofollow" target="_blank"><img src="./images/react.png" height="31" width="88" border="0" title="" alt=""></a> <script type="text/javascript"><!--
document.write("<img src='//counter.yadro.ru/hit?t44.2;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";h"+escape(document.title.substring(0,80))+";"+Math.random()+
"' "+
"border='0' width='31' height='31'>")
//--></script>
</div>
</div>

</body></html>
